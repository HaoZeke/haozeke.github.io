<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="[Rohit Goswami]"><meta name=description content="Explorations of object oriented Fortran with bind(c) derived types for representations generated by F2PY
Background Derived types are easily one of the most visible of the modern Fortran (post-F90) features and are central to object oriented programming paradigms in Fortarn.
For those new to the language, a rough guide to some terminology:
Fortran Closest C/C++ equivalent derived type struct extends type inherited class final destructor not standard conforming undefined behaviour Only the first of these are actually covered in terms of interoperability with C as of the F2018 draft standard."><meta name=keywords content=",python,fortran,numpy,f2py,rambling"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=/posts/fortran-oop-python/><title>Fortran OOP and Python :: Rohit Goswami — Reflections</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.min.b6dbce0fdf6c61563a0c2226e857d5dadd8e5afa2c4f73ec9ea55abd831f9a72.css><meta itemprop=name content="Fortran OOP and Python"><meta itemprop=description content="Explorations of object oriented Fortran with bind(c) derived types for representations generated by F2PY
Background Derived types are easily one of the most visible of the modern Fortran (post-F90) features and are central to object oriented programming paradigms in Fortarn.
For those new to the language, a rough guide to some terminology:
Fortran Closest C/C++ equivalent derived type struct extends type inherited class final destructor not standard conforming undefined behaviour Only the first of these are actually covered in terms of interoperability with C as of the F2018 draft standard."><meta itemprop=datePublished content="2022-05-09T03:39:00+00:00"><meta itemprop=dateModified content="2022-05-09T03:39:00+00:00"><meta itemprop=wordCount content="2210"><meta itemprop=image content="/images/RG.png"><meta itemprop=keywords content="python,fortran,numpy,f2py,rambling,"><meta property="og:title" content="Fortran OOP and Python"><meta property="og:description" content="Explorations of object oriented Fortran with bind(c) derived types for representations generated by F2PY
Background Derived types are easily one of the most visible of the modern Fortran (post-F90) features and are central to object oriented programming paradigms in Fortarn.
For those new to the language, a rough guide to some terminology:
Fortran Closest C/C++ equivalent derived type struct extends type inherited class final destructor not standard conforming undefined behaviour Only the first of these are actually covered in terms of interoperability with C as of the F2018 draft standard."><meta property="og:type" content="article"><meta property="og:url" content="/posts/fortran-oop-python/"><meta property="og:image" content="/images/RG.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-05-09T03:39:00+00:00"><meta property="article:modified_time" content="2022-05-09T03:39:00+00:00"><meta property="og:site_name" content="Rohit Goswami"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="/images/RG.png"><meta name=twitter:title content="Fortran OOP and Python"><meta name=twitter:description content="Explorations of object oriented Fortran with bind(c) derived types for representations generated by F2PY
Background Derived types are easily one of the most visible of the modern Fortran (post-F90) features and are central to object oriented programming paradigms in Fortarn.
For those new to the language, a rough guide to some terminology:
Fortran Closest C/C++ equivalent derived type struct extends type inherited class final destructor not standard conforming undefined behaviour Only the first of these are actually covered in terms of interoperability with C as of the F2018 draft standard."><meta property="article:section" content="notes"><meta property="article:published_time" content="2022-05-09 03:39:00 +0000 UTC"></head><body class=dark-theme><div class=container><header class=header><div class=header__inner><div class=header__left><div class=logo><a href=/ style=text-decoration:none><img src=/images/home.png alt></a></div></div><div class=header__mid><button class=button><div class=button__text><a href=/search>Search</a></div></button></div><div class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about>About</a></li><li><a href=/posts>Blog</a></li></ul><ul class=menu__inner><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></nav><button id=toggleMenu><div class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></div></button>
<button class=theme-toggle id=toggleTheme><svg class="theme-toggler" width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></button></div></div></header><script src=js/mathjax-config.js></script>
<script id=MathJax-script async src=https://unpkg.com/mathjax@3/es5/tex-chtml.js></script><aside class=sidebar><div class=hideTOC><button id=tocTog>TOC</button><div class="sideTOC m-fadeOut"><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#series>Series</a></li></ul></li><li><a href=#premise>Premise</a></li><li><a href=#representations>Representations</a></li><li><a href=#pythonic-equivalent>Pythonic Equivalent</a></li><li><a href=#c-python-fortran-implementation>C-Python-Fortran Implementation</a><ul><li><a href=#instance-variables-and-initialization>Instance Variables and Initialization</a></li><li><a href=#class-methods>Class Methods</a></li><li><a href=#boilerplate-and-builds>Boilerplate and Builds</a></li><li><a href=#usage>Usage</a></li></ul></li><li><a href=#conclusions>Conclusions</a><ul><li><a href=#addendum-and-future-directions>Addendum and Future Directions</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></div></div></aside><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>11 minutes<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Written: 2022-05-09 03:39 +0000</p></p></div><article class=h-entry><h1 class="post-title p-name"><a class=u-url href=/posts/fortran-oop-python/>Fortran OOP and Python</a></h1><div class=post-info><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pen-tool"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg><span class="author u-author p-author"><a href=author/rohit-goswami>Rohit Goswami</a></span></div><hr><aside id=toc class=sidebar><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#series>Series</a></li></ul></li><li><a href=#premise>Premise</a></li><li><a href=#representations>Representations</a></li><li><a href=#pythonic-equivalent>Pythonic Equivalent</a></li><li><a href=#c-python-fortran-implementation>C-Python-Fortran Implementation</a><ul><li><a href=#instance-variables-and-initialization>Instance Variables and Initialization</a></li><li><a href=#class-methods>Class Methods</a></li><li><a href=#boilerplate-and-builds>Boilerplate and Builds</a></li><li><a href=#usage>Usage</a></li></ul></li><li><a href=#conclusions>Conclusions</a><ul><li><a href=#addendum-and-future-directions>Addendum and Future Directions</a></li></ul></li><li><a href=#references>References</a></li></ul></nav></aside><hr><div class="post-content e-content"><blockquote><p>Explorations of object oriented Fortran with <code>bind(c)</code> derived types
for representations generated by F2PY</p></blockquote><h2 id=background>Background</h2><p>Derived types are easily one of the most visible of the modern Fortran
(post-F90) features and are central to object oriented programming
paradigms in Fortarn.</p><p>For those new to the language, a rough guide to some terminology:</p><table><thead><tr><th><strong>Fortran</strong></th><th><strong>Closest C/C++ equivalent</strong></th></tr></thead><tbody><tr><td>derived type</td><td>struct</td></tr><tr><td>extends type</td><td>inherited class</td></tr><tr><td>final</td><td>destructor</td></tr><tr><td>not standard conforming</td><td>undefined behaviour</td></tr></tbody></table><p>Only the first of these are actually covered in terms of
interoperability with <code>C</code> as of the <a href=https://gitlab.com/lfortran/lfortran/uploads/973db2bfcc64cd2a397f823c32718b39/18-007r1.pdf>F2018 draft
standard</a>.</p><p>For F2PY within <code>numpy</code>, however, although there are no direct
equivalents in <code>C</code> for the more OOP specific derived types, there are
plenty of equivalent structures in <code>Python</code>. This post will bridge
Fortran derived types to their logically equivalent Python class
definitions.</p><h3 id=series>Series</h3><p>Thoughts relating to interoperability of Fortran with things can be
vaguely collated into the following series.</p><ol><li><a href=/posts/numpy-meson-f2py/>NumPy Meson Fortran</a></li><li><a href=/posts/cython-derivedtype-f2py/>Simple Fortran Derived Types and Python</a></li><li><a href=/posts/iso-c-type-bound-fortran/>Exploring <code>ISO_C_BINDING</code> and type-bound procedures</a></li><li><strong>Fortran OOP and Python</strong> &lt;&ndash; You are here!</li></ol><h2 id=premise>Premise</h2><p>As in <a href=/posts/cython-derivedtype-f2py/>the previous posts</a>, we will be interested in a <code>bind(c)</code> derived type.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln>1</span><span class=cl><span class=k>type</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>cartesian</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>  </span><span class=k>real</span><span class=p>(</span><span class=k>c_double</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=n>z</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=n>cartesian</span><span class=w>
</span></span></span></code></pre></div><p>Along with a simple function which uses an instance of such a derived
type.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln>1</span><span class=cl><span class=k>subroutine</span><span class=w> </span><span class=n>unit_step</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>  </span><span class=k>type</span><span class=p>(</span><span class=n>cartesian</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>inout</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>arg</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>  </span><span class=n>arg</span><span class=p>%</span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arg</span><span class=p>%</span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>  </span><span class=n>arg</span><span class=p>%</span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arg</span><span class=p>%</span><span class=n>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>  </span><span class=n>arg</span><span class=p>%</span><span class=n>z</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arg</span><span class=p>%</span><span class=n>z</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>unit_step</span><span class=w>
</span></span></span></code></pre></div><p>To make the discussion and conversion into Python more concrete, we will
start with an overview of possible representations.</p><h2 id=representations>Representations</h2><p>The elements of the Python programming language which can be best used
to emulate a derived type are (in order of relative complexity):</p><dl><dt><strong>Lists</strong></dt><dd>In theory, a record type can be represented and constructed from a
list, with the members of the type specified in order of appearance
or lexicographically. However, this is a lossy, incomplete
representation as it would remove the ability to refer to and
operate on the member variables by name.</dd><dt><strong>Dictionaries</strong></dt><dd>These have the benefit of being relatively simple to implement, and
retain member addressable semantics.</dd><dt><strong>Named Tuples</strong></dt><dd>As immutable data structures with labels, these make good return
types, however, they are poor representations for objects which may
be modified in place (e.g. in a Fortran <code>subroutine</code>).</dd><dt><strong>Dataclasses</strong></dt><dd>These make sense from a logical perspective, however, they are hard
to programmatically generate and use in C-extensions, limiting their
utility for inter-operability with Fortran.</dd><dt><strong>Classes</strong></dt><dd>The most general and arguably the most flexible construct is to
generate code for a <code>PyTypeObject</code>, which can be fleshed out to
contain both attributes, as well as memory allocation rules.</dd></dl><p>Of the representations described, the first approximation covered in [a
previous post](/posts/cython-derivedtype-f2py/) was the
<code>dictionary</code>. A major concern <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup> is that of lineage and
extensibility; <code>python</code> users would expect that a dictionary can be
extended with keys, which would not make much sense if the dictionary is
meant to represent a derived type. Additionally, it is difficult to
programmatically ascertain which dictionaries are meant to be
interoperable with Fortran functions or subroutines. Note that the
dictionary representation code is also <a href=https://github.com/HaoZeke/f2py_derived_nep/tree/main/examples/bindc/pydict>present
here</a>
with usage examples.</p><p>The rest of this post will enumerate the construction and usage of a
<code>bind(c)</code> derived type represented as a Python class.</p><h2 id=pythonic-equivalent>Pythonic Equivalent</h2><p>For a more pedagogical understanding, the derived type will be emulated
(from within a Python-C exention) by the following class definition:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=k>class</span> <span class=nc>fakecart</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=k>def</span> <span class=fm>__new__</span><span class=p>(</span><span class=bp>cls</span><span class=p>,</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=o>**</span><span class=n>kwargs</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=n>obj</span> <span class=o>=</span> <span class=nb>object</span><span class=o>.</span><span class=fm>__new__</span><span class=p>(</span><span class=bp>cls</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=n>obj</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=n>obj</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=n>obj</span><span class=o>.</span><span class=n>z</span> <span class=o>=</span> <span class=mi>0</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=k>return</span> <span class=n>obj</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl>  <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span><span class=p>):</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>x</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=n>y</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>z</span> <span class=o>=</span> <span class=n>z</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl>  <span class=k>def</span> <span class=fm>__repr__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=k>return</span> <span class=sa>f</span><span class=s2>&#34;fakecart(x: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>x</span><span class=si>}</span><span class=s2>, y: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>y</span><span class=si>}</span><span class=s2>, z: </span><span class=si>{</span><span class=bp>self</span><span class=o>.</span><span class=n>z</span><span class=si>}</span><span class=s2>)&#34;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>
</span></span><span class=line><span class=ln>17</span><span class=cl>  <span class=k>def</span> <span class=nf>unitstep</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>x</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>y</span> <span class=o>+</span> <span class=mi>1</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=bp>self</span><span class=o>.</span><span class=n>z</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>z</span> <span class=o>+</span><span class=mi>1</span>
</span></span></code></pre></div><p>Note that apart from the members which mimic the those in the derived
type, for illustration&rsquo;s sake we will implement the <code>unit_step</code> free
function as a member function.</p><h2 id=c-python-fortran-implementation>C-Python-Fortran Implementation</h2><p>For <code>bind(c)</code> types, we will focus on implementing the member data in
terms of <code>C</code> structs, and rely on <code>bind(c)</code> to ensure that symbols are
mangled in a compatible manner, i.e. we will not need to hardcode any
compiler specific name mangling conventions for the functions we call
from Fortran. The complete Fortran code of interest is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln> 1</span><span class=cl><span class=c>! vec.f90
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c></span><span class=w>  </span><span class=k>module</span><span class=w> </span><span class=n>vec</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>    </span><span class=k>use</span><span class=p>,</span><span class=w> </span><span class=k>intrinsic</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=nb>iso_c_binding</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>    </span><span class=k>implicit</span><span class=w> </span><span class=k>none</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>    </span><span class=k>type</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>cartesian</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>       </span><span class=k>real</span><span class=p>(</span><span class=k>c_double</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=n>z</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=k>end</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=n>cartesian</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>    </span><span class=k>contains</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>      </span><span class=k>subroutine</span><span class=w> </span><span class=n>unit_step</span><span class=p>(</span><span class=n>arg</span><span class=p>)</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>        </span><span class=k>type</span><span class=p>(</span><span class=n>cartesian</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>inout</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>arg</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>         </span><span class=n>arg</span><span class=p>%</span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arg</span><span class=p>%</span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>         </span><span class=n>arg</span><span class=p>%</span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arg</span><span class=p>%</span><span class=n>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>         </span><span class=n>arg</span><span class=p>%</span><span class=n>z</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>arg</span><span class=p>%</span><span class=n>z</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>      </span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>unit_step</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>module</span><span class=w> </span><span class=n>vec</span><span class=w>
</span></span></span></code></pre></div><p>For a source to source translation from the <code>Python</code> code, we will start
with a header file containing the basic C-Fortran structures and
function declarations:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// vecf.h
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1></span><span class=cp>#ifndef VECF_H_
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=cp>#define VECF_H_
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=cp></span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=cp>#include</span><span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=cp>#include</span><span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=cp></span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=c1>// bind(c) compatible struct declaration
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=kt>double</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=p>}</span> <span class=n>cartesian</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1>// In Fortran
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=c1></span><span class=kt>void</span> <span class=nf>unit_step</span><span class=p>(</span><span class=n>cartesian</span> <span class=o>*</span><span class=n>arg</span><span class=p>);</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=cp>#endif </span><span class=c1>// VECF_H_
</span></span></span></code></pre></div><p>Now for the class declaration itself.</p><h3 id=instance-variables-and-initialization>Instance Variables and Initialization</h3><p>Rather than declaring <code>double</code> variables in the Python class, we will
opt to use the <code>struct</code> defined earlier.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=c1>// CPython compatible declaration
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>  <span class=n>PyObject_HEAD</span>        <span class=cm>/* Do not move */</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>  <span class=n>cartesian</span> <span class=n>ccart</span><span class=p>;</span> <span class=cm>/* totally interoperable */</span>
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=p>}</span> <span class=n>pycart</span><span class=p>;</span>
</span></span></code></pre></div><p>This means we can initialize an object of this class by writing the
equivalent of the <code>__init__()</code> as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>pycart_init</span><span class=p>(</span><span class=n>pycart</span> <span class=o>*</span><span class=n>self</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>kwds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>  <span class=k>static</span> <span class=kt>char</span> <span class=o>*</span><span class=n>kwlist</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=s>&#34;x&#34;</span><span class=p>,</span> <span class=s>&#34;y&#34;</span><span class=p>,</span> <span class=s>&#34;x&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>};</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>PyArg_ParseTupleAndKeywords</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=n>kwds</span><span class=p>,</span> <span class=s>&#34;|ddd&#34;</span><span class=p>,</span> <span class=n>kwlist</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>                                   <span class=o>&amp;</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>y</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>z</span><span class=p>))</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>7</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Finally we have to declare the instance variables to be exposed from the
class.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=k>static</span> <span class=n>PyMemberDef</span> <span class=n>pycart_members</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=p>{</span><span class=s>&#34;x&#34;</span><span class=p>,</span> <span class=n>T_DOUBLE</span><span class=p>,</span> <span class=nf>offsetof</span><span class=p>(</span><span class=n>pycart</span><span class=p>,</span> <span class=n>ccart</span><span class=p>.</span><span class=n>x</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;x coordinate&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=p>{</span><span class=s>&#34;y&#34;</span><span class=p>,</span> <span class=n>T_DOUBLE</span><span class=p>,</span> <span class=nf>offsetof</span><span class=p>(</span><span class=n>pycart</span><span class=p>,</span> <span class=n>ccart</span><span class=p>.</span><span class=n>y</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;y coordinate&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>    <span class=p>{</span><span class=s>&#34;z&#34;</span><span class=p>,</span> <span class=n>T_DOUBLE</span><span class=p>,</span> <span class=nf>offsetof</span><span class=p>(</span><span class=n>pycart</span><span class=p>,</span> <span class=n>ccart</span><span class=p>.</span><span class=n>z</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;z coordinate&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>    <span class=p>{</span><span class=nb>NULL</span><span class=p>}</span> <span class=cm>/* Sentinel */</span>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>Note that in each of the snippets above, we leverage the <code>cartesian</code>
structure.</p><h3 id=class-methods>Class Methods</h3><p>The heavy lifting of the function itself is in Fortran, while the <code>C</code>
struct can be used inter-operably with a derived type, leaving us with
an extremely light definition:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=k>static</span> <span class=n>PyObject</span> <span class=o>*</span><span class=nf>pycart_unitstep</span><span class=p>(</span><span class=n>pycart</span> <span class=o>*</span><span class=n>self</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>  <span class=c1>// Call Fortran on the internal representation
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=c1></span>  <span class=nf>unit_step</span><span class=p>(</span><span class=o>&amp;</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>);</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>  <span class=n>Py_RETURN_NONE</span><span class=p>;</span>
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We will also define a <code>__repr()__</code> function for ease of interactive use:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=k>static</span> <span class=n>PyObject</span> <span class=o>*</span><span class=nf>pycart_repr</span><span class=p>(</span><span class=n>pycart</span> <span class=o>*</span><span class=n>self</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>  <span class=kt>char</span> <span class=n>x</span><span class=p>[</span><span class=mi>50</span><span class=p>],</span> <span class=n>y</span><span class=p>[</span><span class=mi>50</span><span class=p>],</span> <span class=n>z</span><span class=p>[</span><span class=mi>50</span><span class=p>];</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>  <span class=nf>sprintf</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=s>&#34;%f&#34;</span><span class=p>,</span> <span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>  <span class=nf>sprintf</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=s>&#34;%f&#34;</span><span class=p>,</span> <span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>  <span class=nf>sprintf</span><span class=p>(</span><span class=n>z</span><span class=p>,</span> <span class=s>&#34;%f&#34;</span><span class=p>,</span> <span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>z</span><span class=p>);</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>  <span class=n>PyObject</span> <span class=o>*</span><span class=n>repr</span> <span class=o>=</span> <span class=nf>PyUnicode_FromFormat</span><span class=p>(</span><span class=s>&#34;pycart(x: %s, y: %s, z: %s)&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span><span class=p>);</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>  <span class=k>return</span> <span class=n>repr</span><span class=p>;</span>
</span></span><span class=line><span class=ln>8</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Finally we can register the methods.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=k>static</span> <span class=n>PyMethodDef</span> <span class=n>pycart_methods</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=p>{</span><span class=s>&#34;unitstep&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>PyCFunction</span><span class=p>)</span><span class=n>pycart_unitstep</span><span class=p>,</span> <span class=n>METH_NOARGS</span><span class=p>,</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>     <span class=s>&#34;Modify the class members with the Fortran unit_step function&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>    <span class=p>{</span><span class=nb>NULL</span><span class=p>}</span> <span class=cm>/* Sentinel */</span>
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>Before rounding out our definition:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln> 1</span><span class=cl><span class=c1>// Definition of type
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1></span><span class=k>static</span> <span class=n>PyTypeObject</span> <span class=n>t_pycart</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=nf>PyVarObject_HEAD_INIT</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=cm>/* tp_head */</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>        <span class=p>.</span><span class=n>tp_name</span> <span class=o>=</span> <span class=s>&#34;pycart.pycart&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=p>.</span><span class=n>tp_doc</span> <span class=o>=</span> <span class=nf>PyDoc_STR</span><span class=p>(</span><span class=s>&#34;One coordinate (x, y, z)&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=p>.</span><span class=n>tp_basicsize</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>pycart</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=p>.</span><span class=n>tp_itemsize</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=p>.</span><span class=n>tp_dealloc</span> <span class=o>=</span> <span class=n>pycart_dealloc</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=p>.</span><span class=n>tp_repr</span> <span class=o>=</span> <span class=n>pycart_repr</span><span class=p>,</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=p>.</span><span class=n>tp_getattro</span> <span class=o>=</span> <span class=n>PyObject_GenericGetAttr</span><span class=p>,</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=p>.</span><span class=n>tp_setattro</span> <span class=o>=</span> <span class=n>PyObject_GenericSetAttr</span><span class=p>,</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=p>.</span><span class=n>tp_flags</span> <span class=o>=</span> <span class=n>Py_TPFLAGS_DEFAULT</span> <span class=o>|</span> <span class=n>Py_TPFLAGS_BASETYPE</span><span class=p>,</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=p>.</span><span class=n>tp_members</span> <span class=o>=</span> <span class=n>pycart_members</span><span class=p>,</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=p>.</span><span class=n>tp_methods</span> <span class=o>=</span> <span class=n>pycart_methods</span><span class=p>,</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=p>.</span><span class=n>tp_init</span> <span class=o>=</span> <span class=n>pycart_init</span><span class=p>,</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=p>.</span><span class=n>tp_alloc</span> <span class=o>=</span> <span class=n>PyType_GenericAlloc</span><span class=p>,</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=p>.</span><span class=n>tp_new</span> <span class=o>=</span> <span class=n>PyType_GenericNew</span><span class=p>,</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=p>.</span><span class=n>tp_free</span> <span class=o>=</span> <span class=n>PyObject_Del</span><span class=p>,</span>
</span></span><span class=line><span class=ln>19</span><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>Where we have additionally defined and bound machinery to declare
<code>__new__()</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln> 1</span><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>pycart_dealloc</span><span class=p>(</span><span class=n>pycart</span> <span class=o>*</span><span class=n>self</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=c1>// Also free the pointer here
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=c1></span>  <span class=nf>Py_TYPE</span><span class=p>(</span><span class=n>self</span><span class=p>)</span><span class=o>-&gt;</span><span class=nf>tp_free</span><span class=p>((</span><span class=n>PyObject</span> <span class=o>*</span><span class=p>)</span><span class=n>self</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=k>static</span> <span class=n>PyObject</span> <span class=o>*</span><span class=nf>pycart_new</span><span class=p>(</span><span class=n>PyTypeObject</span> <span class=o>*</span><span class=n>type</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>                            <span class=n>PyObject</span> <span class=o>*</span><span class=n>kwds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>  <span class=c1>// Allocate and create the cartesian object here
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=c1></span>  <span class=n>pycart</span> <span class=o>*</span><span class=n>self</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>  <span class=n>self</span> <span class=o>=</span> <span class=p>(</span><span class=n>pycart</span> <span class=o>*</span><span class=p>)</span><span class=n>type</span><span class=o>-&gt;</span><span class=nf>tp_alloc</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>self</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>z</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=p>)</span><span class=n>self</span><span class=p>;</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=boilerplate-and-builds>Boilerplate and Builds</h3><p>We round off the extension by adding some doc-strings and also setting
up the module itself. The code for the module itself is then:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>  1</span><span class=cl><span class=cp>#ifndef PY_SSIZE_T_CLEAN
</span></span></span><span class=line><span class=ln>  2</span><span class=cl><span class=cp>#define PY_SSIZE_T_CLEAN
</span></span></span><span class=line><span class=ln>  3</span><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=ln>  4</span><span class=cl><span class=cp>#endif </span><span class=cm>/* PY_SSIZE_T_CLEAN */</span><span class=cp>
</span></span></span><span class=line><span class=ln>  5</span><span class=cl><span class=cp></span>
</span></span><span class=line><span class=ln>  6</span><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;Python.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=ln>  7</span><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;structmember.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=ln>  8</span><span class=cl><span class=cp></span>
</span></span><span class=line><span class=ln>  9</span><span class=cl><span class=c1>// Fortran-C stuff
</span></span></span><span class=line><span class=ln> 10</span><span class=cl><span class=c1></span><span class=cp>#include</span> <span class=cpf>&#34;vecf.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=ln> 11</span><span class=cl><span class=cp></span>
</span></span><span class=line><span class=ln> 12</span><span class=cl><span class=c1>// Python-C stuff
</span></span></span><span class=line><span class=ln> 13</span><span class=cl><span class=c1></span>
</span></span><span class=line><span class=ln> 14</span><span class=cl><span class=c1>// CPython compatible declaration
</span></span></span><span class=line><span class=ln> 15</span><span class=cl><span class=c1></span><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 16</span><span class=cl>  <span class=n>PyObject_HEAD</span>        <span class=cm>/* Do not move */</span>
</span></span><span class=line><span class=ln> 17</span><span class=cl>  <span class=n>cartesian</span> <span class=n>ccart</span><span class=p>;</span> <span class=cm>/* totally interoperable */</span>
</span></span><span class=line><span class=ln> 18</span><span class=cl><span class=p>}</span> <span class=n>pycart</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 19</span><span class=cl>
</span></span><span class=line><span class=ln> 20</span><span class=cl><span class=c1>// Almost everything in the class must be static
</span></span></span><span class=line><span class=ln> 21</span><span class=cl><span class=c1></span><span class=k>static</span> <span class=kt>void</span> <span class=nf>pycart_dealloc</span><span class=p>(</span><span class=n>pycart</span> <span class=o>*</span><span class=n>self</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 22</span><span class=cl>  <span class=nf>Py_TYPE</span><span class=p>(</span><span class=n>self</span><span class=p>)</span><span class=o>-&gt;</span><span class=nf>tp_free</span><span class=p>((</span><span class=n>PyObject</span> <span class=o>*</span><span class=p>)</span><span class=n>self</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 23</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 24</span><span class=cl>
</span></span><span class=line><span class=ln> 25</span><span class=cl><span class=k>static</span> <span class=n>PyObject</span> <span class=o>*</span><span class=nf>pycart_new</span><span class=p>(</span><span class=n>PyTypeObject</span> <span class=o>*</span><span class=n>type</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 26</span><span class=cl>                            <span class=n>PyObject</span> <span class=o>*</span><span class=n>kwds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 27</span><span class=cl>  <span class=n>pycart</span> <span class=o>*</span><span class=n>self</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 28</span><span class=cl>  <span class=n>self</span> <span class=o>=</span> <span class=p>(</span><span class=n>pycart</span> <span class=o>*</span><span class=p>)</span><span class=n>type</span><span class=o>-&gt;</span><span class=nf>tp_alloc</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 29</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>self</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 30</span><span class=cl>    <span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>x</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 31</span><span class=cl>    <span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>y</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 32</span><span class=cl>    <span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>z</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 33</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 34</span><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=p>)</span><span class=n>self</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 35</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 36</span><span class=cl>
</span></span><span class=line><span class=ln> 37</span><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>pycart_init</span><span class=p>(</span><span class=n>pycart</span> <span class=o>*</span><span class=n>self</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>kwds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 38</span><span class=cl>  <span class=k>static</span> <span class=kt>char</span> <span class=o>*</span><span class=n>kwlist</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span><span class=s>&#34;x&#34;</span><span class=p>,</span> <span class=s>&#34;y&#34;</span><span class=p>,</span> <span class=s>&#34;x&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>};</span>
</span></span><span class=line><span class=ln> 39</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>PyArg_ParseTupleAndKeywords</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=n>kwds</span><span class=p>,</span> <span class=s>&#34;|ddd&#34;</span><span class=p>,</span> <span class=n>kwlist</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 40</span><span class=cl>                                   <span class=o>&amp;</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>y</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>z</span><span class=p>))</span>
</span></span><span class=line><span class=ln> 41</span><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 42</span><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 43</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 44</span><span class=cl>
</span></span><span class=line><span class=ln> 45</span><span class=cl><span class=k>static</span> <span class=n>PyMemberDef</span> <span class=n>pycart_members</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 46</span><span class=cl>    <span class=p>{</span><span class=s>&#34;x&#34;</span><span class=p>,</span> <span class=n>T_DOUBLE</span><span class=p>,</span> <span class=nf>offsetof</span><span class=p>(</span><span class=n>pycart</span><span class=p>,</span> <span class=n>ccart</span><span class=p>.</span><span class=n>x</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;x coordinate&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln> 47</span><span class=cl>    <span class=p>{</span><span class=s>&#34;y&#34;</span><span class=p>,</span> <span class=n>T_DOUBLE</span><span class=p>,</span> <span class=nf>offsetof</span><span class=p>(</span><span class=n>pycart</span><span class=p>,</span> <span class=n>ccart</span><span class=p>.</span><span class=n>y</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;y coordinate&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln> 48</span><span class=cl>    <span class=p>{</span><span class=s>&#34;z&#34;</span><span class=p>,</span> <span class=n>T_DOUBLE</span><span class=p>,</span> <span class=nf>offsetof</span><span class=p>(</span><span class=n>pycart</span><span class=p>,</span> <span class=n>ccart</span><span class=p>.</span><span class=n>z</span><span class=p>),</span> <span class=mi>0</span><span class=p>,</span> <span class=s>&#34;z coordinate&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln> 49</span><span class=cl>    <span class=p>{</span><span class=nb>NULL</span><span class=p>}</span> <span class=cm>/* Sentinel */</span>
</span></span><span class=line><span class=ln> 50</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln> 51</span><span class=cl>
</span></span><span class=line><span class=ln> 52</span><span class=cl><span class=k>static</span> <span class=n>PyObject</span> <span class=o>*</span><span class=nf>pycart_repr</span><span class=p>(</span><span class=n>pycart</span> <span class=o>*</span><span class=n>self</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 53</span><span class=cl>  <span class=kt>char</span> <span class=n>x</span><span class=p>[</span><span class=mi>50</span><span class=p>],</span> <span class=n>y</span><span class=p>[</span><span class=mi>50</span><span class=p>],</span> <span class=n>z</span><span class=p>[</span><span class=mi>50</span><span class=p>];</span>
</span></span><span class=line><span class=ln> 54</span><span class=cl>  <span class=nf>sprintf</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=s>&#34;%f&#34;</span><span class=p>,</span> <span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 55</span><span class=cl>  <span class=nf>sprintf</span><span class=p>(</span><span class=n>y</span><span class=p>,</span> <span class=s>&#34;%f&#34;</span><span class=p>,</span> <span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 56</span><span class=cl>  <span class=nf>sprintf</span><span class=p>(</span><span class=n>z</span><span class=p>,</span> <span class=s>&#34;%f&#34;</span><span class=p>,</span> <span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>.</span><span class=n>z</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 57</span><span class=cl>  <span class=n>PyObject</span> <span class=o>*</span><span class=n>repr</span> <span class=o>=</span> <span class=nf>PyUnicode_FromFormat</span><span class=p>(</span><span class=s>&#34;pycart(x: %s, y: %s, z: %s)&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>,</span> <span class=n>z</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 58</span><span class=cl>  <span class=k>return</span> <span class=n>repr</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 59</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 60</span><span class=cl>
</span></span><span class=line><span class=ln> 61</span><span class=cl><span class=k>static</span> <span class=n>PyObject</span> <span class=o>*</span><span class=nf>pycart_unitstep</span><span class=p>(</span><span class=n>pycart</span> <span class=o>*</span><span class=n>self</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 62</span><span class=cl>  <span class=c1>// Call Fortran on the internal representation
</span></span></span><span class=line><span class=ln> 63</span><span class=cl><span class=c1></span>  <span class=nf>unit_step</span><span class=p>(</span><span class=o>&amp;</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>ccart</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 64</span><span class=cl>  <span class=n>Py_RETURN_NONE</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 65</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 66</span><span class=cl>
</span></span><span class=line><span class=ln> 67</span><span class=cl><span class=k>static</span> <span class=n>PyMethodDef</span> <span class=n>pycart_methods</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 68</span><span class=cl>    <span class=p>{</span><span class=s>&#34;unitstep&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>PyCFunction</span><span class=p>)</span><span class=n>pycart_unitstep</span><span class=p>,</span> <span class=n>METH_NOARGS</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 69</span><span class=cl>     <span class=s>&#34;Modify the class members with the Fortran unit_step function&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln> 70</span><span class=cl>    <span class=p>{</span><span class=nb>NULL</span><span class=p>}</span> <span class=cm>/* Sentinel */</span>
</span></span><span class=line><span class=ln> 71</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln> 72</span><span class=cl>
</span></span><span class=line><span class=ln> 73</span><span class=cl><span class=c1>// Definition of type
</span></span></span><span class=line><span class=ln> 74</span><span class=cl><span class=c1></span><span class=k>static</span> <span class=n>PyTypeObject</span> <span class=n>t_pycart</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 75</span><span class=cl>    <span class=nf>PyVarObject_HEAD_INIT</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span> <span class=cm>/* tp_head */</span>
</span></span><span class=line><span class=ln> 76</span><span class=cl>        <span class=p>.</span><span class=n>tp_name</span> <span class=o>=</span> <span class=s>&#34;pycart.pycart&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 77</span><span class=cl>    <span class=p>.</span><span class=n>tp_doc</span> <span class=o>=</span> <span class=nf>PyDoc_STR</span><span class=p>(</span><span class=s>&#34;One coordinate (x, y, z)&#34;</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 78</span><span class=cl>    <span class=p>.</span><span class=n>tp_basicsize</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>pycart</span><span class=p>),</span>
</span></span><span class=line><span class=ln> 79</span><span class=cl>    <span class=p>.</span><span class=n>tp_itemsize</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 80</span><span class=cl>    <span class=p>.</span><span class=n>tp_dealloc</span> <span class=o>=</span> <span class=n>pycart_dealloc</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 81</span><span class=cl>    <span class=p>.</span><span class=n>tp_repr</span> <span class=o>=</span> <span class=n>pycart_repr</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 82</span><span class=cl>    <span class=p>.</span><span class=n>tp_getattro</span> <span class=o>=</span> <span class=n>PyObject_GenericGetAttr</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 83</span><span class=cl>    <span class=p>.</span><span class=n>tp_setattro</span> <span class=o>=</span> <span class=n>PyObject_GenericSetAttr</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 84</span><span class=cl>    <span class=p>.</span><span class=n>tp_flags</span> <span class=o>=</span> <span class=n>Py_TPFLAGS_DEFAULT</span> <span class=o>|</span> <span class=n>Py_TPFLAGS_BASETYPE</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 85</span><span class=cl>    <span class=p>.</span><span class=n>tp_members</span> <span class=o>=</span> <span class=n>pycart_members</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 86</span><span class=cl>    <span class=p>.</span><span class=n>tp_methods</span> <span class=o>=</span> <span class=n>pycart_methods</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 87</span><span class=cl>    <span class=p>.</span><span class=n>tp_init</span> <span class=o>=</span> <span class=n>pycart_init</span><span class=p>,</span>          <span class=cm>/* tp_init */</span>
</span></span><span class=line><span class=ln> 88</span><span class=cl>    <span class=p>.</span><span class=n>tp_alloc</span> <span class=o>=</span> <span class=n>PyType_GenericAlloc</span><span class=p>,</span> <span class=cm>/* tp_alloc */</span>
</span></span><span class=line><span class=ln> 89</span><span class=cl>    <span class=p>.</span><span class=n>tp_new</span> <span class=o>=</span> <span class=n>PyType_GenericNew</span><span class=p>,</span>     <span class=cm>/* tp_new */</span>
</span></span><span class=line><span class=ln> 90</span><span class=cl>    <span class=p>.</span><span class=n>tp_free</span> <span class=o>=</span> <span class=n>PyObject_Del</span><span class=p>,</span>         <span class=cm>/* tp_free */</span>
</span></span><span class=line><span class=ln> 91</span><span class=cl>    <span class=c1>// Add an attribute to show this is from Fortran
</span></span></span><span class=line><span class=ln> 92</span><span class=cl><span class=c1></span><span class=p>};</span>
</span></span><span class=line><span class=ln> 93</span><span class=cl>
</span></span><span class=line><span class=ln> 94</span><span class=cl><span class=k>static</span> <span class=kt>char</span> <span class=n>pycart_docs</span><span class=p>[]</span> <span class=o>=</span> <span class=s>&#34;pycart: data type with x,y,z elements</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 95</span><span class=cl>
</span></span><span class=line><span class=ln> 96</span><span class=cl><span class=k>static</span> <span class=n>PyModuleDef</span> <span class=n>pycartmodule</span> <span class=o>=</span> <span class=p>{</span><span class=n>PyModuleDef_HEAD_INIT</span><span class=p>,</span> <span class=p>.</span><span class=n>m_name</span> <span class=o>=</span> <span class=s>&#34;pycart&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 97</span><span class=cl>                                   <span class=p>.</span><span class=n>m_doc</span> <span class=o>=</span> <span class=n>pycart_docs</span><span class=p>,</span> <span class=p>.</span><span class=n>m_size</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>};</span>
</span></span><span class=line><span class=ln> 98</span><span class=cl>
</span></span><span class=line><span class=ln> 99</span><span class=cl><span class=n>PyMODINIT_FUNC</span> <span class=nf>PyInit_pycart</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>100</span><span class=cl>  <span class=n>PyObject</span> <span class=o>*</span><span class=n>this_module</span><span class=p>;</span>
</span></span><span class=line><span class=ln>101</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>PyType_Ready</span><span class=p>(</span><span class=o>&amp;</span><span class=n>t_pycart</span><span class=p>))</span>
</span></span><span class=line><span class=ln>102</span><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln>103</span><span class=cl>  <span class=n>this_module</span> <span class=o>=</span> <span class=nf>PyModule_Create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pycartmodule</span><span class=p>);</span>
</span></span><span class=line><span class=ln>104</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>this_module</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>105</span><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln>106</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>107</span><span class=cl>  <span class=nf>Py_INCREF</span><span class=p>(</span><span class=o>&amp;</span><span class=n>t_pycart</span><span class=p>);</span>
</span></span><span class=line><span class=ln>108</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>PyModule_AddObject</span><span class=p>(</span><span class=n>this_module</span><span class=p>,</span> <span class=s>&#34;pycart&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>t_pycart</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>109</span><span class=cl>    <span class=nf>Py_DECREF</span><span class=p>(</span><span class=o>&amp;</span><span class=n>t_pycart</span><span class=p>);</span>
</span></span><span class=line><span class=ln>110</span><span class=cl>    <span class=nf>Py_DECREF</span><span class=p>(</span><span class=n>this_module</span><span class=p>);</span>
</span></span><span class=line><span class=ln>111</span><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln>112</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>113</span><span class=cl>  <span class=k>return</span> <span class=n>this_module</span><span class=p>;</span>
</span></span><span class=line><span class=ln>114</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Which is coupled with a <code>meson.build</code> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-meson data-lang=meson><span class=line><span class=ln> 1</span><span class=cl><span class=nb>project</span><span class=p>(</span><span class=s>&#39;pyclass_bindc&#39;</span><span class=p>,</span><span class=w> </span><span class=s>&#39;c&#39;</span><span class=p>,</span><span class=w> </span><span class=s>&#39;fortran&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>        </span><span class=n>version</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&#39;0.1&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>        </span><span class=n>default_options</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s>&#39;warning_level=2&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>                           </span><span class=s>&#39;buildtype=debug&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>                           </span><span class=s>&#39;debug=true&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>                          </span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w></span><span class=n>py_mod</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nn>import</span><span class=p>(</span><span class=s>&#39;python&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w></span><span class=n>py3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>py_mod</span><span class=p>.</span><span class=n>find_installation</span><span class=p>(</span><span class=s>&#39;python3&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w></span><span class=n>py3_dep</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>py3</span><span class=p>.</span><span class=n>dependency</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w></span><span class=nb>message</span><span class=p>(</span><span class=n>py3</span><span class=p>.</span><span class=n>path</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w></span><span class=nb>message</span><span class=p>(</span><span class=n>py3</span><span class=p>.</span><span class=n>get_install_dir</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w></span><span class=c># Python Class Representation</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w></span><span class=n>py3</span><span class=p>.</span><span class=n>extension_module</span><span class=p>(</span><span class=s>&#39;pycart&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>           </span><span class=s>&#39;vec.f90&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>           </span><span class=s>&#39;pyclassderived.c&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>           </span><span class=n>dependencies</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>py3_dep</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>           </span><span class=n>install</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><h3 id=usage>Usage</h3><p>This can built and used as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>meson setup bbdir
</span></span><span class=line><span class=ln>2</span><span class=cl>meson compile -C bbdir
</span></span><span class=line><span class=ln>3</span><span class=cl>python -c <span class=s2>&#34;import bbdir.pycart as pycart; aak = pycart.pycart(1,10,2); print(aak); aak.unitstep(); print(aak)&#34;</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>pycart<span class=o>(</span>x: 1.000000, y: 10.000000, z: 2.000000<span class=o>)</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>pycart<span class=o>(</span>x: 2.000000, y: 11.000000, z: 3.000000<span class=o>)</span>
</span></span></code></pre></div><h2 id=conclusions>Conclusions</h2><p>One of the best aspects of this approach is that the language pairs and
representations line up nicely to prevent any extraneous copy
operations. Representing the module subroutine as a class member
function is a design choice unlikely to be made when generating bindings
from <code>f2py</code>, but this was more for exploratory purposes.</p><p>To end on a rather provocative note <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>, consider the timings for
the wrapped derived type <code>pycart</code> and its equivalent pure-Python
<code>fakecart</code> in Fig. 1 below:</p><figure><img src=/ox-hugo/fdtclasstimings.png alt="Figure 1: Results of comparing the pure-python class (fakecart) to the C-extension class backed by a Fortran derived type (pycart)"><figcaption><p><span class=figure-number>Figure 1: </span>Results of comparing the pure-python class (<code>fakecart</code>) to the C-extension class backed by a Fortran derived type (<code>pycart</code>)</p></figcaption></figure><p>All the code for this post, along with other Fortran derived type
representations is present <a href=https://github.com/HaoZeke/f2py_derived_nep/tree/main/>in this
repository</a>
under the examples folder.</p><h3 id=addendum-and-future-directions>Addendum and Future Directions</h3><p>I had the pleasure of demonstrating part of this logic to fellow NumPy
maintainers Dr. Pearu Peterson and Dr. Melissa Weber Mendonça and we
were in agreement that the class strategy is the most flexible <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.
Pearu suggested leveraging pointers passed between Fortran and C in an
attempt to cover more than <code>bind(c)</code> compatible code, by generating
simpler Fortran wrapper functions as well, and those will likely be
among the next steps forward. The work of Pletzer et al.
(<a href=#ref-pletzerExposingFortranDerived2008>2008</a>) is also of interest,
although their focus was on exposing a series of <code>C</code> functions which
call <code>Fortran</code> methods.</p><h2 id=references>References</h2><div id=refs class="references csl-bib-body hanging-indent"><div id=ref-pletzerExposingFortranDerived2008 class=csl-entry><p>Pletzer, Alexander, Douglas McCune, Stefan Muszala, Srinath Vadlamani,
and Scott Kruger. 2008. &ldquo;Exposing Fortran Derived Types to C and Other
Languages.&rdquo; <em>Computing in Science Engineering</em> 10 (4): 86&ndash;92.
<a href=https://doi.org/10.1109/MCSE.2008.94>https://doi.org/10.1109/MCSE.2008.94</a>.</p></div></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Noted by <a href=https://github.com/cthulahoops>Adam Kelly</a>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Benchmarks are notoriously <a href=https://pythonspeed.com/articles/consistent-benchmarking-in-ci/>divisive and
finicky</a>,
and no attempt was made to ensure statistical stability of the
results nor were the plotted points obtained on machines dedicated
and isolated from spurious loads&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>I also discussed this at a few NumPy meetings and also
informally mentioned this during some LFortran meetings as well&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=tags/python>python</a></span><span class=tag><a href=tags/fortran>fortran</a></span><span class=tag><a href=tags/numpy>numpy</a></span><span class=tag><a href=tags/f2py>f2py</a></span><span class=tag><a href=tags/rambling>rambling</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>2210 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Posted: <time class=dt-published>2022-05-09 03:39 +0000</time></p><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=%2fposts%2ffortran-oop-python%2f" target=_blank rel=noopener aria-label=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15.84 9.5H13.5V8.48c0-.53.35-.65.6-.65h1.4v-2.3h-2.35c-2.3.0-2.65 1.7-2.65 2.8V9.5h-2v2h2v7h3v-7h2.1l.24-2z"/></svg></div>Facebook</div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=%22Fortran%20OOP%20and%20Python%22%20seems%20like%20an%20interesting%20read%20from%20%40rg0swami&amp;url=%2fposts%2ffortran-oop-python%2f" target=_blank rel=noopener aria-label=Twitter><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.5 7.4l-2 .2c-.4-.5-1-.8-2-.8C13.3 6.8 12 8 12 9.4v.6c-2 0-4-1-5.4-2.7-.2.4-.3.8-.3 1.3.0 1 .4 1.7 1.2 2.2-.5.0-1 0-1.2-.3.0 1.3 1 2.3 2 2.6-.3.4-.7.4-1 0 .2 1.4 1.2 2 2.3 2-1 1-2.5 1.4-4 1 1.3 1 2.7 1.4 4.2 1.4 4.8.0 7.5-4 7.5-7.5v-.4c.5-.4.8-1.5 1.2-2z"/><circle cx="12" cy="12" r="11.5"/></svg></div>Twitter</div></a><a class=resp-sharing-button__link href="mailto:?subject=%22Fortran%20OOP%20and%20Python%22%20seems%20interesting...&amp;body=%2fposts%2ffortran-oop-python%2f" target=_self rel=noopener aria-label=E-Mail><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.5 16c0 .8-.7 1.5-1.5 1.5H6c-.8.0-1.5-.7-1.5-1.5V8c0-.8.7-1.5 1.5-1.5h12c.8.0 1.5.7 1.5 1.5v8zm-2-7.5L12 13 6.5 8.5m11 6-4-2.5m-7 2.5 4-2.5"/><circle cx="12" cy="12" r="11.5"/></svg></div>E-Mail</div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&amp;url=%2fposts%2ffortran-oop-python%2f&amp;title=%22Fortran%20OOP%20and%20Python%22%20seems%20interesting...&amp;summary=%22Fortran%20OOP%20and%20Python%22%20seems%20interesting...&amp;source=%2fposts%2ffortran-oop-python%2f" target=_blank rel=noopener aria-label=LinkedIn><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15 12.5c-.28.0-.5.22-.5.5v3.5h-3s.03-6.48.0-7h3v.83s.46-.75 1.7-.75c1.56.0 2.3 1.12 2.3 3.3v3.62h-3V13c0-.28-.23-.5-.5-.5zm-7.5-3h2v7h-2z"/><circle cx="8.5" cy="6.5" r="1"/></svg></div>LinkedIn</div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=%2fposts%2ffortran-oop-python%2f&amp;resubmit=true&amp;title=%22Fortran%20OOP%20and%20Python%22%20seems%20interesting..." target=_blank rel=noopener aria-label=Reddit><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><ellipse cx="12" cy="14.37" rx="6.2" ry="4.24"/><path d="M14.3 16.25c-.62.36-1.42.57-2.3.57s-1.7-.2-2.32-.58"/><circle cx="14.61" cy="13.39" r=".98"/><circle cx="9.39" cy="13.39" r=".98"/><path d="M16.4 11.38c.26-.55.82-.92 1.47-.92.9.0 1.63.73 1.63 1.63.0.8-.6 1.47-1.38 1.6"/><circle cx="17.22" cy="7.52" r="1.63"/><path d="M7.6 11.38c-.26-.54-.82-.92-1.47-.92-.9.0-1.63.73-1.63 1.63.0.8.6 1.47 1.38 1.6M12 10.12s-.08-4.82 3.6-2.6"/></svg></div>Reddit</div></a><a class=resp-sharing-button__link href="whatsapp://send?text=%22Fortran%20OOP%20and%20Python%22%20seems%20interesting...%20%2fposts%2ffortran-oop-python%2f" target=_blank rel=noopener aria-label=WhatsApp><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle xmlns="http://www.w3.org/2000/svg" cx="12" cy="12" r="11.5"/><path stroke-width="1" d="M17.6 6.2c-1.5-1.5-3.4-2.3-5.5-2.3-4.3.0-7.8 3.5-7.8 7.8.0 1.4.4 2.7 1 3.9l-1.1 4 4.1-1.1c1.1.6 2.4.9 3.7.9 4.3.0 7.8-3.5 7.8-7.8.1-2-.7-3.9-2.2-5.4zm-5.5 11.9c-1.2.0-2.3-.3-3.3-.9l-.2-.1-2.4.6.7-2.4-.2-.2c-.6-1-1-2.2-1-3.4.0-3.6 2.9-6.5 6.5-6.5 1.7.0 3.3.7 4.6 1.9 1.2 1.2 1.9 2.8 1.9 4.6-.1 3.5-3 6.4-6.6 6.4zm3.5-4.8c-.2-.1-1.1-.6-1.3-.6-.2-.1-.3-.1-.4.1s-.5.6-.6.8c-.1.1-.2.1-.4.0s-.8-.3-1.6-1c-.6-.5-1-1.2-1.1-1.3-.1-.2.0-.3.1-.4l.3-.3s.1-.2.2-.3c.1-.1.0-.2.0-.3s-.4-1.1-.6-1.4c-.2-.4-.3-.3-.4-.3h-.4s-.3.0-.5.2-.7.7-.7 1.6c0 1 .7 1.9.8 2s1.4 2.1 3.3 2.9c.5.2.8.3 1.1.4.5.1.9.1 1.2.1.4-.1 1.1-.5 1.3-.9.2-.5.2-.8.1-.9.0-.2-.2-.3-.4-.4z"/></svg></div>WhatsApp</div></a></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=/posts/scipycon-2022-meta/><span class=button__icon>←</span>
<span class=button__text>Supplements for SciPy 2022</span></a></span>
<span class="button next"><a href=/posts/spack-pytorch-dev-workflow/><span class=button__text>Spack and PyTorch Development Workflows</span>
<span class=button__icon>→</span></a></span></div></div><div id=comments class=thin><div class=pagination__title><span class=pagination__title-h>Comments</span><hr></div><script src=https://utteranc.es/client.js repo=haozeke/haozeke.github.io issue-term=pathname theme=photon-dark label="Utterance 💬" crossorigin=anonymous async></script></div></main><footer class=footer><p>&copy; 2023
<span><a href>Rohit Goswami (HaoZeke)</a></span>
<a href=posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a><br><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a>.
Powered by <a href=http://gohugo.io><u>Hugo</u></a> and <a href=https://github.com/HaoZeke/hugo-theme-hello-friend-ng-hz><u>this theme</u></a>.</br>Hosted with <u><a href=https://www.netlify.com/>Netlify</a></u>.</br><script src=https://liberapay.com/rohit/widgets/button.js></script><noscript><a href=https://liberapay.com/rohit/donate><img alt="Donate using Liberapay" src=https://liberapay.com/assets/widgets/donate.svg></a></noscript></p></footer></div><script src=/bundle.min.5fae9992ea406007408dc33b0b3a8376d61e2f1d6ac50ba1dad7580ac50afb5199bcef3bbc3677e77553a9980bf882cf71edc2f755687dd7725f12ece4304ac2.js></script>
<script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-109503488-16","auto"),ga("send","pageview")</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","3z2xvwqu4u")</script><script data-goatcounter=https://rgoswami.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<script>var clicky_site_ids=clicky_site_ids||[];clicky_site_ids.push("101265002")</script><script async src=https://static.getclicky.com/js></script>
<script src=https://cdn.jsdelivr.net/npm/readmore-js@3.0.0-beta-1/dist/readmore.min.js></script>
<script src=/js/codefold.min.f0790269b87613b3bcff64022840fe1991eee3ea384e874c78a24022c9936bd888a3c14a05a10955881eebb1558e4fcf37576dac120cd0bf4ebaf7aca27b35b1.js></script></body></html>