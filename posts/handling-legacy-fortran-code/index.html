<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="[Rohit Goswami]"><meta name=description content="A short pseudo-tutorial post on working with inherited Fortran.
Background In-spite of the many claims by upper management (e.g. at LANL) regarding the death of Fortran, most people with even a passing interest in academic research within STEM fields will interact with Fortran code, and the community has only been improving with time Kedward et al. (2022). Rewriting is not typically an option, or a good use of time. This set of posts should be applicable to any blackbox legacy fortran code, though the specific example here is one from my own field (computational chemistry)."><meta name=keywords content="personal,fortran,f2py"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://rgoswami.me/posts/handling-legacy-fortran-code/><title>Handling Legacy Fortran Code :: Rohit Goswami — Reflections</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.min.178e8de5d28422900cb56f847dd37a8bfa7e1b99944ff2baf0ae86c9f4a4e825.css><meta itemprop=name content="Handling Legacy Fortran Code"><meta itemprop=description content="A short pseudo-tutorial post on working with inherited Fortran.
Background In-spite of the many claims by upper management (e.g. at LANL) regarding the death of Fortran, most people with even a passing interest in academic research within STEM fields will interact with Fortran code, and the community has only been improving with time Kedward et al. (2022). Rewriting is not typically an option, or a good use of time. This set of posts should be applicable to any blackbox legacy fortran code, though the specific example here is one from my own field (computational chemistry)."><meta itemprop=datePublished content="2023-04-27T16:09:00+00:00"><meta itemprop=dateModified content="2023-04-27T16:09:00+00:00"><meta itemprop=wordCount content="1044"><meta itemprop=image content="https://rgoswami.me/images/RG.png"><meta itemprop=keywords content="fortran,f2py,"><meta property="og:title" content="Handling Legacy Fortran Code"><meta property="og:description" content="A short pseudo-tutorial post on working with inherited Fortran.
Background In-spite of the many claims by upper management (e.g. at LANL) regarding the death of Fortran, most people with even a passing interest in academic research within STEM fields will interact with Fortran code, and the community has only been improving with time Kedward et al. (2022). Rewriting is not typically an option, or a good use of time. This set of posts should be applicable to any blackbox legacy fortran code, though the specific example here is one from my own field (computational chemistry)."><meta property="og:type" content="article"><meta property="og:url" content="https://rgoswami.me/posts/handling-legacy-fortran-code/"><meta property="og:image" content="https://rgoswami.me/images/RG.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-04-27T16:09:00+00:00"><meta property="article:modified_time" content="2023-04-27T16:09:00+00:00"><meta property="og:site_name" content="Rohit Goswami"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rgoswami.me/images/RG.png"><meta name=twitter:title content="Handling Legacy Fortran Code"><meta name=twitter:description content="A short pseudo-tutorial post on working with inherited Fortran.
Background In-spite of the many claims by upper management (e.g. at LANL) regarding the death of Fortran, most people with even a passing interest in academic research within STEM fields will interact with Fortran code, and the community has only been improving with time Kedward et al. (2022). Rewriting is not typically an option, or a good use of time. This set of posts should be applicable to any blackbox legacy fortran code, though the specific example here is one from my own field (computational chemistry)."><meta property="article:section" content="notes"><meta property="article:published_time" content="2023-04-27 16:09:00 +0000 UTC"></head><body class=dark-theme><div class=container><header class=header><div class=header__inner><div class=header__left><div class=logo><a href=/ style=text-decoration:none><img src=/images/home.png alt></a></div></div><div class=header__mid><button class=button><div class=button__text><a href=https://rgoswami.me//search>Search</a></div></button></div><div class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about>About</a></li><li><a href=/posts>Blog</a></li></ul><ul class=menu__inner><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></nav><button id=toggleMenu><div class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></div></button>
<button class=theme-toggle id=toggleTheme><svg class="theme-toggler" width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></button></div></div></header><script src=/js/mathjax-config.js></script>
<script id=MathJax-script async src=https://unpkg.com/mathjax@3/es5/tex-chtml.js></script><aside class=sidebar><div class=hideTOC><button id=tocTog>TOC</button><div class="sideTOC m-fadeOut"><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#series>Series</a></li></ul></li><li><a href=#the-code>The Code</a><ul><li><a href=#initial-cleanup>Initial Cleanup</a></li></ul></li><li><a href=#python-usage>Python Usage</a></li><li><a href=#iso-c-binding-wrappers-for-c-plus-plus-and-c><code>ISO_C_BINDING</code> wrappers for <code>C++</code> and <code>C</code></a><ul><li><a href=#matlab-interfaces>MATLAB Interfaces</a></li></ul></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#references>References</a></li></ul></nav></div></div></aside><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>5 minutes<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Written: 2023-04-27 16:09 +0000</p></p></div><article class=h-entry><h1 class="post-title p-name"><a class=u-url href=https://rgoswami.me/posts/handling-legacy-fortran-code/>Handling Legacy Fortran Code</a></h1><div class=post-info><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pen-tool"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg><span class="author u-author p-author"><a href=/author/rohit-goswami>Rohit Goswami</a></span></div><hr><aside id=toc class=sidebar><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#series>Series</a></li></ul></li><li><a href=#the-code>The Code</a><ul><li><a href=#initial-cleanup>Initial Cleanup</a></li></ul></li><li><a href=#python-usage>Python Usage</a></li><li><a href=#iso-c-binding-wrappers-for-c-plus-plus-and-c><code>ISO_C_BINDING</code> wrappers for <code>C++</code> and <code>C</code></a><ul><li><a href=#matlab-interfaces>MATLAB Interfaces</a></li></ul></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#references>References</a></li></ul></nav></aside><hr><div class="post-content e-content"><blockquote><p>A short pseudo-tutorial post on working with inherited Fortran.</p></blockquote><h2 id=background>Background</h2><p>In-spite of the many claims by upper management (e.g. <a href="https://fortran-lang.discourse.group/t/an-evaluation-of-risks-associated-with-relying-on-fortran-for-mission-critical-codes-for-the-next-15-years/5644?u=rgoswami">at
LANL</a>)
regarding the death of Fortran, most people with even a passing interest
in academic research within STEM fields will interact with Fortran code,
and the community has only been improving with time Kedward et al.
(<a href=#ref-kedwardStateFortran2022>2022</a>). Rewriting <strong>is not</strong> typically
an option, or a good use of time. This set of posts should be applicable
to any blackbox legacy fortran code, though the specific example here is
one from my own field (computational chemistry).</p><h3 id=series>Series</h3><p>This is a series of posts centered around &ldquo;things to do with old fortran
code&rdquo;. To be very exact, there&rsquo;s only this post, but related articles
are:</p><ol><li><strong>Handling Legacy Fortran Code</strong> &lt;&ndash; You are here</li><li>MATLAB bindings for Fortran Libraries through <code>C</code></li><li><code>cibuildwheel</code> for C++ libraries with thin Python wrappers</li></ol><p>The third post lays out design guidelines and build practicalities for
C++ libraries which may have embedded Fortran code.</p><h2 id=the-code>The Code</h2><p>As an exemplary example, we will consider an implicitly typed Fortran-77
program for generating the potential energy surface (and forces) of a
system containing Copper and Hydrogen atoms. The group I&rsquo;m associated
with has a rather nice Embedded Atom Model parameterized for this
particular system <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. The source can be obtained from here:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>git clone https://github.com/TheochemUI/fortran_cuh2_src
</span></span></code></pre></div><p>Since it was initially meant to work with <code>con</code> files, the salient
points of the implementation are:</p><ul><li><code>main.f90</code> uses file I/O to read <code>tmp.con</code> and write to <code>energy.out</code>
and <code>forces.out</code>, and signals that it is ready by writing \(1\) to
<code>eam.tmp</code></li><li><code>eamroutines.f90</code> reads in <code>pot.par</code>, which has parameters used in a
space separated file:</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl> 6.10000   6.30000
</span></span><span class=line><span class=ln>2</span><span class=cl>  .000000E+00  .000000E+00  .000000E+00
</span></span><span class=line><span class=ln>3</span><span class=cl> 2862.30      79.5013      86.1495
</span></span><span class=line><span class=ln>4</span><span class=cl> 3.51236      2.47961      4.21154
</span></span><span class=line><span class=ln>5</span><span class=cl>-109.107     -107.555      15355.5
</span></span><span class=line><span class=ln>6</span><span class=cl>....
</span></span></code></pre></div><p>Additionally the code is in FORTRAN 77, and uses features no longer in
vogue including implicit typing and <code>common</code> blocks.</p><h3 id=initial-cleanup>Initial Cleanup</h3><p>Rather than hard-coding a path (<code>pot.par</code>) it is best to store these
values in the source code itself.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln>1</span><span class=cl><span class=n>potpar</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>loadtxt</span><span class=p>(</span><span class=s2>&#34;pot.par&#34;</span><span class=p>,</span> <span class=n>skiprows</span><span class=o>=</span><span class=mi>1</span><span class=p>)</span> <span class=c1># first row has 2 values</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=k>for</span> <span class=n>idx</span><span class=p>,</span> <span class=n>val</span> <span class=ow>in</span> <span class=nb>enumerate</span><span class=p>(</span><span class=n>aa</span><span class=p>,</span> <span class=n>start</span><span class=o>=</span><span class=mi>1</span><span class=p>):</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>    <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;potpar(</span><span class=si>{</span><span class=n>idx</span><span class=si>}</span><span class=s2>, 1) = </span><span class=si>{</span><span class=n>val</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>potpar(</span><span class=si>{</span><span class=n>idx</span><span class=si>}</span><span class=s2>, 2) = </span><span class=si>{</span><span class=n>val</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span><span class=si>}</span><span class=se>\n</span><span class=s2>potpar(</span><span class=si>{</span><span class=n>idx</span><span class=si>}</span><span class=s2>, 3) = </span><span class=si>{</span><span class=n>val</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
</span></span></code></pre></div><p>There are many more possible optimizations which can be done on the
Fortran side, but this is the bare minimum we need to move on. The state
of the project can be seen in
<a href=https://github.com/TheochemUI/fortran_cuh2_src/commit/1461cdf927f69f2da75a5da75e566faa66b88267>1461cdf</a>.
The <code>main.f90</code> issues regarding the file I/O can be handled from
different languages.</p><h2 id=python-usage>Python Usage</h2><p>When confronted by a Fortran 77 code, or any Fortran code in general, it
is never a bad idea to start out with <code>f2py</code>. In this instance, we would
like to call the <code>force_eam</code> function without all the file I/O:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>f2py -c -m cuh2 eamroutines.f90
</span></span></code></pre></div><p>Now we can use this from Python:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=kn>import</span> <span class=nn>cuh2</span> <span class=c1># Compiled module</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=n>R</span> <span class=o>=</span> <span class=p>[</span><span class=mf>0.63940268750835</span><span class=p>,</span> <span class=mf>0.90484742551374</span><span class=p>,</span> <span class=mf>6.97516498544584</span><span class=p>,</span> <span class=mf>3.19652040936288</span><span class=p>,</span> <span class=mf>0.90417430354811</span><span class=p>,</span> <span class=mf>6.97547796369474</span><span class=p>,</span> <span class=mf>8.98363230369760</span><span class=p>,</span> <span class=mf>9.94703496017833</span><span class=p>,</span> <span class=mf>7.83556854923689</span><span class=p>,</span> <span class=mf>7.64080177576300</span><span class=p>,</span> <span class=mf>9.94703114803832</span><span class=p>,</span> <span class=mf>7.83556986121272</span><span class=p>]</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=n>box</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mf>15.34</span><span class=p>,</span> <span class=mf>21.702</span><span class=p>,</span> <span class=mi>100</span><span class=p>])</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=n>natms</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>array</span><span class=p>([</span><span class=mi>2</span><span class=p>,</span> <span class=mi>2</span><span class=p>])</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=n>u</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=n>F</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros_like</span><span class=p>(</span><span class=n>R</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=n>cuh2</span><span class=o>.</span><span class=n>force_eam</span><span class=p>(</span><span class=n>natms</span><span class=p>,</span> <span class=n>box</span><span class=p>,</span> <span class=n>R</span><span class=o>.</span><span class=n>ravel</span><span class=p>(),</span> <span class=n>F</span><span class=o>.</span><span class=n>ravel</span><span class=p>(),</span> <span class=n>u</span><span class=p>)</span> <span class=c1># Call!</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=nb>print</span><span class=p>(</span><span class=n>u</span><span class=p>)</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=p>[</span><span class=o>-</span><span class=mf>2.71140933</span><span class=p>]</span>
</span></span></code></pre></div><p>This works very well, and in-fact, if this use case (flexibly calling a
function) is all that is needed, then nothing more needs to be done.
<code>f2py</code> also generates correct signatures, and doc-strings:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=err>??</span><span class=n>cuh2</span><span class=o>.</span><span class=n>force_eam</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=n>force_eam</span><span class=p>(</span><span class=n>natms</span><span class=p>,</span><span class=n>box</span><span class=p>,</span><span class=n>r</span><span class=p>,</span><span class=n>f</span><span class=p>,</span><span class=n>u</span><span class=p>,[</span><span class=n>ndim</span><span class=p>])</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=n>Wrapper</span> <span class=k>for</span> <span class=err>``</span><span class=n>force_eam</span><span class=err>``</span><span class=o>.</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=n>Parameters</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=o>----------</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=n>natms</span> <span class=p>:</span> <span class=nb>input</span> <span class=n>rank</span><span class=o>-</span><span class=mi>1</span> <span class=n>array</span><span class=p>(</span><span class=s1>&#39;i&#39;</span><span class=p>)</span> <span class=k>with</span> <span class=n>bounds</span> <span class=p>(</span><span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=n>box</span> <span class=p>:</span> <span class=nb>input</span> <span class=n>rank</span><span class=o>-</span><span class=mi>1</span> <span class=n>array</span><span class=p>(</span><span class=s1>&#39;d&#39;</span><span class=p>)</span> <span class=k>with</span> <span class=n>bounds</span> <span class=p>(</span><span class=mi>3</span><span class=p>)</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=n>r</span> <span class=p>:</span> <span class=nb>input</span> <span class=n>rank</span><span class=o>-</span><span class=mi>1</span> <span class=n>array</span><span class=p>(</span><span class=s1>&#39;d&#39;</span><span class=p>)</span> <span class=k>with</span> <span class=n>bounds</span> <span class=p>(</span><span class=n>ndim</span><span class=p>)</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=n>f</span> <span class=p>:</span> <span class=nb>input</span> <span class=n>rank</span><span class=o>-</span><span class=mi>1</span> <span class=n>array</span><span class=p>(</span><span class=s1>&#39;d&#39;</span><span class=p>)</span> <span class=k>with</span> <span class=n>bounds</span> <span class=p>(</span><span class=n>ndim</span><span class=p>)</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=n>u</span> <span class=p>:</span> <span class=nb>input</span> <span class=n>rank</span><span class=o>-</span><span class=mi>1</span> <span class=n>array</span><span class=p>(</span><span class=s1>&#39;d&#39;</span><span class=p>)</span> <span class=k>with</span> <span class=n>bounds</span> <span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=n>Other</span> <span class=n>Parameters</span>
</span></span><span class=line><span class=ln>15</span><span class=cl><span class=o>----------------</span>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=n>ndim</span> <span class=p>:</span> <span class=nb>input</span> <span class=nb>int</span><span class=p>,</span> <span class=n>optional</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=n>Default</span><span class=p>:</span> <span class=n>shape</span><span class=p>(</span><span class=n>r</span><span class=p>,</span> <span class=mi>0</span><span class=p>)</span>
</span></span></code></pre></div><p>The resulting compiled extensions can also be published to PyPI as SciPy
does.</p><h2 id=iso-c-binding-wrappers-for-c-plus-plus-and-c><code>ISO_C_BINDING</code> wrappers for <code>C++</code> and <code>C</code></h2><p>An <code>iso_c_binding</code> is essential for rational interfacing to C++ or other
languages with a well-defined C-API. Since here there is only one
function which needs to be called it can be as simple as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln> 1</span><span class=cl><span class=k>module</span><span class=w> </span><span class=n>eam_wrap</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>  </span><span class=k>use</span><span class=w> </span><span class=nb>iso_c_binding</span><span class=p>,</span><span class=w> </span><span class=k>only</span><span class=p>:</span><span class=w> </span><span class=k>c_double</span><span class=p>,</span><span class=w> </span><span class=k>c_int</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>    </span><span class=k>implicit</span><span class=w> </span><span class=k>none</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=k>contains</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>  </span><span class=k>subroutine</span><span class=w> </span><span class=n>c_force_eam</span><span class=w> </span><span class=p>(</span><span class=n>natms</span><span class=p>,</span><span class=w> </span><span class=n>ndim</span><span class=p>,</span><span class=w> </span><span class=n>box</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=p>,</span><span class=w> </span><span class=n>F</span><span class=p>,</span><span class=w> </span><span class=n>U</span><span class=p>)</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>    </span><span class=k>integer</span><span class=p>(</span><span class=k>c_int</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>natms</span><span class=p>(</span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>    </span><span class=k>integer</span><span class=p>(</span><span class=k>c_int</span><span class=p>),</span><span class=w> </span><span class=k>value</span><span class=p>,</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>ndim</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>    </span><span class=k>real</span><span class=p>(</span><span class=k>c_double</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>box</span><span class=p>(</span><span class=mi>3</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>    </span><span class=k>real</span><span class=p>(</span><span class=k>c_double</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>inout</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>U</span><span class=p>(</span><span class=mi>1</span><span class=p>),</span><span class=w> </span><span class=n>R</span><span class=p>(</span><span class=n>ndim</span><span class=p>),</span><span class=w> </span><span class=n>F</span><span class=p>(</span><span class=n>ndim</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>    </span><span class=k>call</span><span class=w> </span><span class=n>force_eam</span><span class=p>(</span><span class=n>natms</span><span class=p>,</span><span class=w> </span><span class=n>ndim</span><span class=p>,</span><span class=w> </span><span class=n>box</span><span class=p>,</span><span class=w> </span><span class=n>R</span><span class=p>,</span><span class=w> </span><span class=n>F</span><span class=p>,</span><span class=w> </span><span class=n>U</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>  </span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>c_force_eam</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>module</span><span class=w> </span><span class=n>eam_wrap</span><span class=w>
</span></span></span></code></pre></div><p>Which, can be mapped to the following function in any <code>C</code> header file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=k>extern</span> <span class=kt>void</span> <span class=nf>c_force_eam</span><span class=p>(</span><span class=kt>int</span> <span class=o>*</span><span class=n>natms</span><span class=p>,</span> <span class=kt>int</span> <span class=n>ndim</span><span class=p>,</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>                        <span class=kt>double</span> <span class=o>*</span><span class=n>box</span><span class=p>,</span> <span class=kt>double</span> <span class=o>*</span><span class=n>R</span><span class=p>,</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>                        <span class=kt>double</span> <span class=o>*</span><span class=n>F</span><span class=p>,</span> <span class=kt>double</span> <span class=o>*</span><span class=n>U</span><span class=p>);</span>
</span></span></code></pre></div><p>We can always check that the right functions are where they should be:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>gfortran -c eam_isoc.f90 eamroutines.f90
</span></span><span class=line><span class=ln> 2</span><span class=cl>nm eam_isoc.o
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=m>0000000000000000</span> T c_force_eam
</span></span><span class=line><span class=ln> 4</span><span class=cl>                 U force_eam_
</span></span><span class=line><span class=ln> 5</span><span class=cl>nm eamroutines.o
</span></span><span class=line><span class=ln> 6</span><span class=cl>000000000000000c C counters_
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=m>0000000000000050</span> C cutoff_values_
</span></span><span class=line><span class=ln> 8</span><span class=cl>00000000000065c8 C eam_
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=m>0000000000000130</span> C eamdblexp_
</span></span><span class=line><span class=ln>10</span><span class=cl>00000000000025e8 T eamfcu_
</span></span><span class=line><span class=ln>11</span><span class=cl>000000000000249b T eamfh_
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=m>0000000000000000</span> T eamh2cu_
</span></span><span class=line><span class=ln>13</span><span class=cl>00000000000029ef T eamphicucu_
</span></span><span class=line><span class=ln>14</span><span class=cl>00000000000028f8 T eamphihcu_
</span></span><span class=line><span class=ln>15</span><span class=cl><span class=m>0000000000002801</span> T eamphihh_
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=m>0000000000002331</span> T eamrhocu_
</span></span><span class=line><span class=ln>17</span><span class=cl>00000000000021c7 T eamrhoh_
</span></span><span class=line><span class=ln>18</span><span class=cl>                 U exp
</span></span><span class=line><span class=ln>19</span><span class=cl><span class=m>0000000000003210</span> T force_eam_
</span></span><span class=line><span class=ln>20</span><span class=cl>                 U _gfortran_stop_string
</span></span><span class=line><span class=ln>21</span><span class=cl>                 U _gfortran_st_write
</span></span><span class=line><span class=ln>22</span><span class=cl>                 U _gfortran_st_write_done
</span></span><span class=line><span class=ln>23</span><span class=cl>                 U _gfortran_transfer_character_write
</span></span><span class=line><span class=ln>24</span><span class=cl>                 U _gfortran_transfer_integer_write
</span></span><span class=line><span class=ln>25</span><span class=cl>                 U _gfortran_transfer_real_write
</span></span><span class=line><span class=ln>26</span><span class=cl>0000000000002ae6 T potinit_
</span></span><span class=line><span class=ln>27</span><span class=cl>                 U __powidf2
</span></span><span class=line><span class=ln>28</span><span class=cl>                 U __stack_chk_fail
</span></span></code></pre></div><h3 id=matlab-interfaces>MATLAB Interfaces</h3><p>Nominally, MATLAB has a <a href=https://www.mathworks.com/help/matlab/call-mex-fortran.html>Fortran
API</a>.
However, it isn&rsquo;t great. The <code>C++</code> API is &ldquo;modern&rdquo; to the <a href=https://www.mathworks.com/help/matlab/matlab_external/c-mex-functions.html>extent of of
C++11</a>,
which is practically useless. So the <code>C</code> <a href=https://www.mathworks.com/help/matlab/cc-mx-matrix-library.html>MEX
API</a> is
the best way forward here, though <strong>input arrays need to be transposed</strong>
if they are passed to Fortran routines.</p><h2 id=conclusions>Conclusions</h2><p>This was a first pass at what to do when confronted with Fortran code,
short of running away, or rewriting entirely. Follow up posts handle
integrating into larger C++ codes, or distributing said libraries with
<code>pip</code> <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><h2 id=references>References</h2><div id=refs class="references csl-bib-body hanging-indent"><div id=ref-kedwardStateFortran2022 class=csl-entry><p>Kedward, Laurence J., Bálint Aradi, Ondřej Čertík, Milan Curcic,
Sebastian Ehlert, Philipp Engel, Rohit Goswami, et al. 2022. &ldquo;The State
of Fortran.&rdquo; <em>Computing in Science & Engineering</em> 24 (2): 63&ndash;72.
<a href=https://doi.org/10.1109/MCSE.2022.3159862>https://doi.org/10.1109/MCSE.2022.3159862</a>.</p></div></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>For a copper slab and hydrogen molecule, the potential is
qualitatively correct. It captures the fact that when the slab is
fixed, there are effectively only two degrees of freedom, the
distance between the hydrogen atoms, and the distance to the slab.&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Most of the issues which crop up in embedding and distribution
are largely build system related, and require no changes to the
Fortran code other than a compatible <code>iso_c_binding</code> wrapper so they
are extracted away.&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=/tags/fortran>fortran</a></span><span class=tag><a href=/tags/f2py>f2py</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1044 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Posted: <time class=dt-published>2023-04-27 16:09 +0000</time></p><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frgoswami.me%2fposts%2fhandling-legacy-fortran-code%2f" target=_blank rel=noopener aria-label=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15.84 9.5H13.5V8.48c0-.53.35-.65.6-.65h1.4v-2.3h-2.35c-2.3.0-2.65 1.7-2.65 2.8V9.5h-2v2h2v7h3v-7h2.1l.24-2z"/></svg></div>Facebook</div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=%22Handling%20Legacy%20Fortran%20Code%22%20seems%20like%20an%20interesting%20read%20from%20%40rg0swami&amp;url=https%3a%2f%2frgoswami.me%2fposts%2fhandling-legacy-fortran-code%2f" target=_blank rel=noopener aria-label=Twitter><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.5 7.4l-2 .2c-.4-.5-1-.8-2-.8C13.3 6.8 12 8 12 9.4v.6c-2 0-4-1-5.4-2.7-.2.4-.3.8-.3 1.3.0 1 .4 1.7 1.2 2.2-.5.0-1 0-1.2-.3.0 1.3 1 2.3 2 2.6-.3.4-.7.4-1 0 .2 1.4 1.2 2 2.3 2-1 1-2.5 1.4-4 1 1.3 1 2.7 1.4 4.2 1.4 4.8.0 7.5-4 7.5-7.5v-.4c.5-.4.8-1.5 1.2-2z"/><circle cx="12" cy="12" r="11.5"/></svg></div>Twitter</div></a><a class=resp-sharing-button__link href="mailto:?subject=%22Handling%20Legacy%20Fortran%20Code%22%20seems%20interesting...&amp;body=https%3a%2f%2frgoswami.me%2fposts%2fhandling-legacy-fortran-code%2f" target=_self rel=noopener aria-label=E-Mail><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.5 16c0 .8-.7 1.5-1.5 1.5H6c-.8.0-1.5-.7-1.5-1.5V8c0-.8.7-1.5 1.5-1.5h12c.8.0 1.5.7 1.5 1.5v8zm-2-7.5L12 13 6.5 8.5m11 6-4-2.5m-7 2.5 4-2.5"/><circle cx="12" cy="12" r="11.5"/></svg></div>E-Mail</div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frgoswami.me%2fposts%2fhandling-legacy-fortran-code%2f&amp;title=%22Handling%20Legacy%20Fortran%20Code%22%20seems%20interesting...&amp;summary=%22Handling%20Legacy%20Fortran%20Code%22%20seems%20interesting...&amp;source=https%3a%2f%2frgoswami.me%2fposts%2fhandling-legacy-fortran-code%2f" target=_blank rel=noopener aria-label=LinkedIn><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15 12.5c-.28.0-.5.22-.5.5v3.5h-3s.03-6.48.0-7h3v.83s.46-.75 1.7-.75c1.56.0 2.3 1.12 2.3 3.3v3.62h-3V13c0-.28-.23-.5-.5-.5zm-7.5-3h2v7h-2z"/><circle cx="8.5" cy="6.5" r="1"/></svg></div>LinkedIn</div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2frgoswami.me%2fposts%2fhandling-legacy-fortran-code%2f&amp;resubmit=true&amp;title=%22Handling%20Legacy%20Fortran%20Code%22%20seems%20interesting..." target=_blank rel=noopener aria-label=Reddit><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><ellipse cx="12" cy="14.37" rx="6.2" ry="4.24"/><path d="M14.3 16.25c-.62.36-1.42.57-2.3.57s-1.7-.2-2.32-.58"/><circle cx="14.61" cy="13.39" r=".98"/><circle cx="9.39" cy="13.39" r=".98"/><path d="M16.4 11.38c.26-.55.82-.92 1.47-.92.9.0 1.63.73 1.63 1.63.0.8-.6 1.47-1.38 1.6"/><circle cx="17.22" cy="7.52" r="1.63"/><path d="M7.6 11.38c-.26-.54-.82-.92-1.47-.92-.9.0-1.63.73-1.63 1.63.0.8.6 1.47 1.38 1.6M12 10.12s-.08-4.82 3.6-2.6"/></svg></div>Reddit</div></a><a class=resp-sharing-button__link href="whatsapp://send?text=%22Handling%20Legacy%20Fortran%20Code%22%20seems%20interesting...%20https%3a%2f%2frgoswami.me%2fposts%2fhandling-legacy-fortran-code%2f" target=_blank rel=noopener aria-label=WhatsApp><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle xmlns="http://www.w3.org/2000/svg" cx="12" cy="12" r="11.5"/><path stroke-width="1" d="M17.6 6.2c-1.5-1.5-3.4-2.3-5.5-2.3-4.3.0-7.8 3.5-7.8 7.8.0 1.4.4 2.7 1 3.9l-1.1 4 4.1-1.1c1.1.6 2.4.9 3.7.9 4.3.0 7.8-3.5 7.8-7.8.1-2-.7-3.9-2.2-5.4zm-5.5 11.9c-1.2.0-2.3-.3-3.3-.9l-.2-.1-2.4.6.7-2.4-.2-.2c-.6-1-1-2.2-1-3.4.0-3.6 2.9-6.5 6.5-6.5 1.7.0 3.3.7 4.6 1.9 1.2 1.2 1.9 2.8 1.9 4.6-.1 3.5-3 6.4-6.6 6.4zm3.5-4.8c-.2-.1-1.1-.6-1.3-.6-.2-.1-.3-.1-.4.1s-.5.6-.6.8c-.1.1-.2.1-.4.0s-.8-.3-1.6-1c-.6-.5-1-1.2-1.1-1.3-.1-.2.0-.3.1-.4l.3-.3s.1-.2.2-.3c.1-.1.0-.2.0-.3s-.4-1.1-.6-1.4c-.2-.4-.3-.3-.4-.3h-.4s-.3.0-.5.2-.7.7-.7 1.6c0 1 .7 1.9.8 2s1.4 2.1 3.3 2.9c.5.2.8.3 1.1.4.5.1.9.1 1.2.1.4-.1 1.1-.5 1.3-.9.2-.5.2-.8.1-.9.0-.2-.2-.3-.4-.4z"/></svg></div>WhatsApp</div></a></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://rgoswami.me/posts/scipycon-2022-meta/><span class=button__text>Supplements for SciPy 2022</span>
<span class=button__icon>→</span></a></span></div></div><div id=comments class=thin><div class=pagination__title><span class=pagination__title-h>Comments</span><hr></div><script src=https://utteranc.es/client.js repo=haozeke/haozeke.github.io issue-term=pathname theme=photon-dark label="Utterance 💬" crossorigin=anonymous async></script></div></main><footer class=footer><p>&copy; 2023
<span><a href=https://rgoswami.me/>Rohit Goswami (HaoZeke)</a></span>
<a href=/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a><br><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a>.
Powered by <a href=http://gohugo.io><u>Hugo</u></a> and <a href=https://github.com/HaoZeke/hugo-theme-hello-friend-ng-hz><u>this theme</u></a>.</br>Hosted with <u><a href=https://www.netlify.com/>Netlify</a></u>.</br><script src=https://liberapay.com/rohit/widgets/button.js></script><noscript><a href=https://liberapay.com/rohit/donate><img alt="Donate using Liberapay" src=https://liberapay.com/assets/widgets/donate.svg></a></noscript></p></footer></div><script src=/bundle.min.5fae9992ea406007408dc33b0b3a8376d61e2f1d6ac50ba1dad7580ac50afb5199bcef3bbc3677e77553a9980bf882cf71edc2f755687dd7725f12ece4304ac2.js></script>
<script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-109503488-16","auto"),ga("send","pageview")</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","3z2xvwqu4u")</script><script data-goatcounter=https://rgoswami.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<script>var clicky_site_ids=clicky_site_ids||[];clicky_site_ids.push("101265002")</script><script async src=https://static.getclicky.com/js></script>
<script src=https://cdn.jsdelivr.net/npm/readmore-js@3.0.0-beta-1/dist/readmore.min.js></script>
<script src=/js/codefold.min.f0790269b87613b3bcff64022840fe1991eee3ea384e874c78a24022c9936bd888a3c14a05a10955881eebb1558e4fcf37576dac120cd0bf4ebaf7aca27b35b1.js></script></body></html>