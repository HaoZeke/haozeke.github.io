<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="[Rohit Goswami]"><meta name=description content="A closer look at the standard Fortran C compatibility layer by exploring objects and linkers
Background Derived types and their interoperability have been covered previously in the context of usage from Python. However, much of the focus of the previous approach revolved around the iso_c_binding intrinsic module. A closer inspection of the functionality provided therein is the first step towards extending beyond the standards to support calling type bound procedures."><meta name=keywords content="personal,fortran,f2py,rambling"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://rgoswami.me/posts/iso-c-type-bound-fortran/><meta name=generator content="Wooframework"><title>Exploring ISO_C_BINDING and type-bound procedures :: Rohit Goswami — Reflections</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.min.4e8ce7e7af2bec7b91ece9a3e7bb9bb1c6f41c4ff8098e2138ae6300ab555dc6.css><meta itemprop=name content="Exploring ISO_C_BINDING and type-bound procedures"><meta itemprop=description content="A closer look at the standard Fortran C compatibility layer by exploring objects and linkers
Background Derived types and their interoperability have been covered previously in the context of usage from Python. However, much of the focus of the previous approach revolved around the iso_c_binding intrinsic module. A closer inspection of the functionality provided therein is the first step towards extending beyond the standards to support calling type bound procedures."><meta itemprop=datePublished content="2021-12-19T16:25:00+00:00"><meta itemprop=dateModified content="2021-12-19T16:25:00+00:00"><meta itemprop=wordCount content="1974"><meta itemprop=image content="https://rgoswami.me/images/RG.png"><meta itemprop=keywords content="fortran,f2py,rambling,"><meta property="og:title" content="Exploring ISO_C_BINDING and type-bound procedures"><meta property="og:description" content="A closer look at the standard Fortran C compatibility layer by exploring objects and linkers
Background Derived types and their interoperability have been covered previously in the context of usage from Python. However, much of the focus of the previous approach revolved around the iso_c_binding intrinsic module. A closer inspection of the functionality provided therein is the first step towards extending beyond the standards to support calling type bound procedures."><meta property="og:type" content="article"><meta property="og:url" content="https://rgoswami.me/posts/iso-c-type-bound-fortran/"><meta property="og:image" content="https://rgoswami.me/images/RG.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-12-19T16:25:00+00:00"><meta property="article:modified_time" content="2021-12-19T16:25:00+00:00"><meta property="og:see_also" content="https://rgoswami.me/posts/fortran-oop-python/"><meta property="og:see_also" content="https://rgoswami.me/posts/cython-derivedtype-f2py/"><meta property="og:see_also" content="https://rgoswami.me/posts/numpy-meson-f2py/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rgoswami.me/images/RG.png"><meta name=twitter:title content="Exploring ISO_C_BINDING and type-bound procedures"><meta name=twitter:description content="A closer look at the standard Fortran C compatibility layer by exploring objects and linkers
Background Derived types and their interoperability have been covered previously in the context of usage from Python. However, much of the focus of the previous approach revolved around the iso_c_binding intrinsic module. A closer inspection of the functionality provided therein is the first step towards extending beyond the standards to support calling type bound procedures."><meta property="article:section" content="notes"><meta property="article:published_time" content="2021-12-19 16:25:00 +0000 UTC"></head><body class=dark-theme><div class=container><header class=header><div class=header__inner><div class=header__left><div class=logo><a href=/ style=text-decoration:none><img src=/images/home.png alt></a></div></div><div class=header__mid><button class=button><div class=button__text><a href=https://rgoswami.me//search>Search</a></div></button></div><div class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about>About</a></li><li><a href=/posts>Blog</a></li></ul><ul class=menu__inner><li><a href=/categories>Categories</a></li><li><a href=/tags>Tags</a></li></ul></nav><button id=toggleMenu><div class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></div></button>
<button class=theme-toggle id=toggleTheme><svg class="theme-toggler" width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></button></div></div></header><script src=/js/mathjax-config.js></script>
<script id=MathJax-script async src=https://unpkg.com/mathjax@3/es5/tex-chtml.js></script><aside class=sidebar><div class=hideTOC><button id=tocTog>TOC</button><div class="sideTOC m-fadeOut"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#setup>Setup</a></li><li><a href=#compilation>Compilation</a><ul><li><a href=#symbol-renaming>Symbol renaming</a></li><li><a href=#switching-compilers>Switching compilers</a></li><li><a href=#simplifying-labels>Simplifying labels</a></li></ul></li><li><a href=#type-bound-procedures>Type-bound procedures</a></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#references>References</a></li></ul></nav></div></div></aside><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>10 minutes<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Written: 2021-12-19 16:25 +0000</p></p></div><article class=h-entry><h1 class="post-title p-name"><a class=u-url href=https://rgoswami.me/posts/iso-c-type-bound-fortran/>Exploring ISO_C_BINDING and type-bound procedures</a></h1><div class=post-info><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pen-tool"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg><span class="author u-author p-author"><a href=/author/rohit-goswami>Rohit Goswami</a></span></div><hr><aside id=toc class=sidebar><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#setup>Setup</a></li><li><a href=#compilation>Compilation</a><ul><li><a href=#symbol-renaming>Symbol renaming</a></li><li><a href=#switching-compilers>Switching compilers</a></li><li><a href=#simplifying-labels>Simplifying labels</a></li></ul></li><li><a href=#type-bound-procedures>Type-bound procedures</a></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#references>References</a></li></ul></nav></aside><hr><div class="post-content e-content"><div class="notice--info post-series-top"><p>This post is part of the <a href=https://rgoswami.me/series/bridging-fortran-python/>Bridging Fortran & Python</a> series.</p></div><blockquote><p>A closer look at the standard Fortran C compatibility layer by
exploring objects and linkers</p></blockquote><h2 id=background>Background</h2><p><a href=/posts/cython-derivedtype-f2py/>Derived types and their interoperability</a> have been covered previously in the
context of usage from Python. However, much of the focus of the previous
approach revolved around the <code>iso_c_binding</code> intrinsic module. A closer
inspection of the functionality provided therein is the first step
towards extending beyond the standards to support calling type bound
procedures. This is an often overlooked aspect of the derived type usage
pattern, in terms of interoperability.</p><h2 id=setup>Setup</h2><p>We would like to understand the effect of the intrinsic <code>iso_c_binding</code>
module. So, we will re-use at first, the basic cartesian type of the
previous post, along with a <strong>non-type-bound</strong> procedure which is to be
called from <code>C</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln> 1</span><span class=cl><span class=c>! vec.f90
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c></span><span class=k>module</span><span class=w> </span><span class=n>vec</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>  </span><span class=k>implicit</span><span class=w> </span><span class=k>none</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=k>integer</span><span class=p>,</span><span class=w> </span><span class=k>parameter</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>dd</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>selected_real_kind</span><span class=p>(</span><span class=mi>15</span><span class=p>,</span><span class=mi>9</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>  </span><span class=k>type</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>cartesian</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>    </span><span class=k>real</span><span class=p>(</span><span class=nb>kind</span><span class=o>=</span><span class=n>dd</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>z</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>  </span><span class=k>end</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=n>cartesian</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w></span><span class=k>contains</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>  </span><span class=k>subroutine</span><span class=w> </span><span class=n>unit_move</span><span class=p>(</span><span class=n>vec</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>    </span><span class=k>type</span><span class=p>(</span><span class=n>cartesian</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>inout</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>vec</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>    </span><span class=k>print</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Modifying from Fortran&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=n>vec</span><span class=p>%</span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vec</span><span class=p>%</span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>    </span><span class=n>vec</span><span class=p>%</span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vec</span><span class=p>%</span><span class=n>y</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=n>vec</span><span class=p>%</span><span class=n>z</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>vec</span><span class=p>%</span><span class=n>z</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>  </span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>unit_move</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>module</span><span class=w> </span><span class=n>vec</span><span class=w>
</span></span></span></code></pre></div><p>There isn&rsquo;t a whole lot going on, except that the <code>iso_c_binding</code> labels
have been dropped, and correspondingly, instead of <code>c_double</code> we now
have an approximate <code>kind</code> mapping.</p><p>The associated <code>C</code> driver is exactly the same, though in this particular
situation the function signature is optional.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=ln> 1</span><span class=cl><span class=cm>/* vecfc.c */</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=cp>#include</span><span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=cp>#include</span><span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=cp>#include</span><span class=cpf>&lt;vecfc.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=cp></span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=kt>void</span><span class=o>*</span> <span class=nf>unit_move</span><span class=p>(</span><span class=n>cartesian</span> <span class=o>*</span><span class=n>word</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[</span><span class=n>argc</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;Initializing the struct&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=n>cartesian</span> <span class=n>a</span><span class=o>=</span><span class=p>{</span><span class=mf>3.0</span><span class=p>,</span> <span class=mf>2.5</span><span class=p>,</span> <span class=mf>6.2</span><span class=p>};</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%f %f %f&#34;</span><span class=p>,</span><span class=n>a</span><span class=p>.</span><span class=n>x</span><span class=p>,</span><span class=n>a</span><span class=p>.</span><span class=n>y</span><span class=p>,</span><span class=n>a</span><span class=p>.</span><span class=n>z</span><span class=p>);</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Fortran function with derived type from C:&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=n>unit_move</span><span class=p>(</span><span class=o>&amp;</span><span class=n>a</span><span class=p>);</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Returned from Fortran&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%f %f %f&#34;</span><span class=p>,</span><span class=n>a</span><span class=p>.</span><span class=n>x</span><span class=p>,</span><span class=n>a</span><span class=p>.</span><span class=n>y</span><span class=p>,</span><span class=n>a</span><span class=p>.</span><span class=n>z</span><span class=p>);</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=k>return</span> <span class=n>EXIT_SUCCESS</span><span class=p>;</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>To complete the translation unit, our header contains the <code>struct</code>
definition.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=ln>1</span><span class=cl><span class=cp>#ifndef VECFC_H
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=cp>#define VECFC_H
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=cp></span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>  <span class=kt>double</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>z</span><span class=p>;</span>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=p>}</span> <span class=n>cartesian</span><span class=p>;</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>
</span></span><span class=line><span class=ln>8</span><span class=cl><span class=cp>#endif </span><span class=cm>/* VECFC_H */</span><span class=cp>
</span></span></span></code></pre></div><p>So as to not detract from the main focus of the post, instead of using
<code>meson</code> or another build system, we will compile everything by hand.</p><h2 id=compilation>Compilation</h2><p>We will attempt to follow along the same logical process as in the
<code>bind(c)</code> situation:</p><ol><li>Compile and assemble the Fortran module</li><li>Compile, assemble and link the C driver with the module</li></ol><p>A very literal attempt at satisfying the two step process above is
perhaps as simple as:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>gfortran -c vec.f90 <span class=c1># generates vec.o</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>gcc vec.o vecfc.c -I./ -lgfortran -o gf_vec
</span></span><span class=line><span class=ln>3</span><span class=cl>/usr/bin/ld: /tmp/ccOOdInK.o: in <span class=k>function</span> <span class=sb>`</span>main<span class=s1>&#39;:
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=s1>vecfc.c:(.text+0x9a): undefined reference to `unit_move&#39;</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>collect2: error: ld returned <span class=m>1</span> <span class=nb>exit</span> status
</span></span></code></pre></div><p>Naturally, the linker will fail at this point. Recall that we can check
which symbols are actually part of <code>vec.o</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>nm vec.o
</span></span><span class=line><span class=ln> 2</span><span class=cl>                 U _gfortran_st_write
</span></span><span class=line><span class=ln> 3</span><span class=cl>                 U _gfortran_st_write_done
</span></span><span class=line><span class=ln> 4</span><span class=cl>                 U _gfortran_transfer_character_write
</span></span><span class=line><span class=ln> 5</span><span class=cl>                 U _GLOBAL_OFFSET_TABLE_
</span></span><span class=line><span class=ln> 6</span><span class=cl>                 U __stack_chk_fail
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=m>0000000000000000</span> T __vec_MOD___copy_vec_Cartesian
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=m>0000000000000000</span> B __vec_MOD___def_init_vec_Cartesian
</span></span><span class=line><span class=ln> 9</span><span class=cl>000000000000002c T __vec_MOD_unit_move
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=m>0000000000000000</span> D __vec_MOD___vtab_vec_Cartesian
</span></span></code></pre></div><p>Where the first few undefined functions are to be resolved by
<code>-lgfortran</code> directive to the linker <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. Note that the function we
care to call is actually called <code>__vec_MOD_unit_move</code>. We can also check
the symbols required by our program.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>gcc -c vecfc.c -I./ -o gf_vec.o
</span></span><span class=line><span class=ln>2</span><span class=cl>nm -u gf_vec.o
</span></span><span class=line><span class=ln>3</span><span class=cl>                 U _GLOBAL_OFFSET_TABLE_
</span></span><span class=line><span class=ln>4</span><span class=cl>                 U <span class=nb>printf</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>                 U puts
</span></span><span class=line><span class=ln>6</span><span class=cl>                 U __stack_chk_fail
</span></span><span class=line><span class=ln>7</span><span class=cl>                 U unit_move
</span></span></code></pre></div><p>So our problem is essentially one of renaming to the right symbol.</p><h3 id=symbol-renaming>Symbol renaming</h3><p>A first approximation towards a solution is then evident, we will
forcibly rename the symbol in our Fortran code, thus allowing us to link
and call the function. <code>objcopy</code> is fantastic for this.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>gfortran -c vec.f90 <span class=c1># get vec.o</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c1># Rename symbol</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>objcopy --redefine-sym<span class=o>=</span><span class=nv>__vec_MOD_unit_move</span><span class=o>=</span>unit_move vec.o
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=c1># Compile and link in one shot</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>gcc vec.o vecfc.c -I./ -lgfortran -o gf_vec
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=c1># Profit</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>./gf_vec
</span></span><span class=line><span class=ln> 8</span><span class=cl>Initializing the struct
</span></span><span class=line><span class=ln> 9</span><span class=cl>3.000000 2.500000 6.200000
</span></span><span class=line><span class=ln>10</span><span class=cl>Fortran <span class=k>function</span> with derived <span class=nb>type</span> from C:
</span></span><span class=line><span class=ln>11</span><span class=cl> Modifying the derived <span class=nb>type</span> now!
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl>Returned from Fortran
</span></span><span class=line><span class=ln>14</span><span class=cl>4.000000 3.500000 7.200000
</span></span></code></pre></div><p>Indeed, apart from this very satisfying result, we can verify that our
symbols are not undefined as well.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>nm -u gf_vec
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=c1># nothing but library functions</span>
</span></span></code></pre></div><h3 id=switching-compilers>Switching compilers</h3><p>There are a number of caveats with the approach described so far, but
perhaps one of the more striking ones has to do with changing the
compiler. Consider the symbols generated by the Intel compiler.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>ifort -c vec.f90
</span></span><span class=line><span class=ln>2</span><span class=cl>nm vec.f90
</span></span><span class=line><span class=ln>3</span><span class=cl>                 U for_write_seq_lis
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=m>0000000000000000</span> r __STRLITPACK_0
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=m>0000000000000000</span> r __STRLITPACK_1.0.2
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=m>0000000000000000</span> T vec._
</span></span><span class=line><span class=ln>7</span><span class=cl><span class=m>0000000000000010</span> T vec_mp_unit_move_
</span></span></code></pre></div><p>As Fortran remains one of the few languages to have a rich and varied
set of compilers with varying levels of support and standardisation, it
would be rather a tall order to keep track of the symbol mangling
approaches used by every compiler. Indeed, problematically, it is not
just that the symbols mangled differently, the code generated is
quantitatively different as well.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>ifort vec.o vecfc.o -lc
</span></span><span class=line><span class=ln>2</span><span class=cl>ld: vecfc.o: in <span class=k>function</span> <span class=sb>`</span>main<span class=s1>&#39;:
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=s1>vecfc.c:(.text+0x0): multiple definition of `main&#39;</span><span class=p>;</span> /opt/intel/oneapi/compiler/2021.2.0/linux/bin/intel64/../../compiler/lib/intel64_lin/for_main.o:for_main.c:<span class=o>(</span>.text+0x0<span class=o>)</span>: first defined here
</span></span><span class=line><span class=ln>4</span><span class=cl>ld: cannot find -lirng
</span></span><span class=line><span class=ln>5</span><span class=cl>ifort -c vec.f90 -fPIE
</span></span><span class=line><span class=ln>6</span><span class=cl>gcc vec.o vecfc.c -I./ -o gf_vec
</span></span><span class=line><span class=ln>7</span><span class=cl>/usr/bin/ld: vec.o: in <span class=k>function</span> <span class=sb>`</span>unit_move<span class=s1>&#39;:
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=s1>vec.f90:(.text+0x55): undefined reference to `for_write_seq_lis&#39;</span>
</span></span><span class=line><span class=ln>9</span><span class=cl>collect2: error: ld returned <span class=m>1</span> <span class=nb>exit</span> status
</span></span></code></pre></div><p>In any case, we recall from the <code>info</code> pages of <code>gfortran</code> that:</p><blockquote><p>Note that just because the names match does
<span class=underline>not</span> mean that the interface implemented
by GNU Fortran for an external name matches the interface implemented
by some other language for that same name. That is, getting code
produced by GNU Fortran to link to code produced by some other
compiler using this or any other method can be only a small part of
the overall solution&ndash;getting the code generated by both compilers to
agree on issues other than naming can require significant effort, and,
unlike naming disagreements, linkers normally cannot detect
disagreements in these other areas.</p></blockquote><h3 id=simplifying-labels>Simplifying labels</h3><p>The first functionality of the <code>iso_c_binding</code> is actually rather easy
to implement from a vendor perspective, but vastly simplifying for the
end-user, the ability to provide a single binding label. Recall the
<code>bind(c)</code> variant of the <a href=/posts/cython-derivedtype-f2py/>previous post</a>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln> 1</span><span class=cl><span class=c>! vec_bind.f90
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c></span><span class=k>module</span><span class=w> </span><span class=n>vec</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>  </span><span class=k>use</span><span class=p>,</span><span class=w> </span><span class=k>intrinsic</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=nb>iso_c_binding</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=k>implicit</span><span class=w> </span><span class=k>none</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>  </span><span class=k>type</span><span class=p>,</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>cartesian</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>     </span><span class=k>real</span><span class=p>(</span><span class=k>c_double</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>z</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>  </span><span class=k>end</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=n>cartesian</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>  </span><span class=k>contains</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>  </span><span class=k>subroutine</span><span class=w> </span><span class=n>unit_move</span><span class=p>(</span><span class=k>array</span><span class=p>)</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>    </span><span class=k>type</span><span class=p>(</span><span class=n>cartesian</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>inout</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=k>array</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>    </span><span class=k>print</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Modifying the derived type now!&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=k>array</span><span class=p>%</span><span class=n>x</span><span class=o>=</span><span class=k>array</span><span class=p>%</span><span class=n>x</span><span class=o>+</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>    </span><span class=k>array</span><span class=p>%</span><span class=n>y</span><span class=o>=</span><span class=k>array</span><span class=p>%</span><span class=n>y</span><span class=o>+</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=k>array</span><span class=p>%</span><span class=n>z</span><span class=o>=</span><span class=k>array</span><span class=p>%</span><span class=n>z</span><span class=o>+</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>  </span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>unit_move</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>module</span><span class=w> </span><span class=n>vec</span><span class=w>
</span></span></span></code></pre></div><p>Which generates the following symbols.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>gfortran -o vec.o -c vec_bind.f90
</span></span><span class=line><span class=ln> 2</span><span class=cl>nm vec.o
</span></span><span class=line><span class=ln> 3</span><span class=cl>                 U _gfortran_st_write
</span></span><span class=line><span class=ln> 4</span><span class=cl>                 U _gfortran_st_write_done
</span></span><span class=line><span class=ln> 5</span><span class=cl>                 U _gfortran_transfer_character_write
</span></span><span class=line><span class=ln> 6</span><span class=cl>                 U _GLOBAL_OFFSET_TABLE_
</span></span><span class=line><span class=ln> 7</span><span class=cl>                 U __stack_chk_fail
</span></span><span class=line><span class=ln> 8</span><span class=cl>000000000000002c T unit_move
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=m>0000000000000000</span> T __vec_MOD___copy_vec_Cartesian
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=m>0000000000000000</span> B __vec_MOD___def_init_vec_Cartesian
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=m>0000000000000000</span> D __vec_MOD___vtab_vec_Cartesian
</span></span></code></pre></div><p>This true across compilers as well, all without any invocations of
<code>objcopy</code> and other approaches.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>ifort -c vec.f90 -o vec.o
</span></span><span class=line><span class=ln>2</span><span class=cl>nm vec.o
</span></span><span class=line><span class=ln>3</span><span class=cl>                 U for_write_seq_lis
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=m>0000000000000000</span> r __STRLITPACK_1
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=m>0000000000000000</span> r __STRLITPACK_2.0.2
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=m>0000000000000010</span> T unit_move
</span></span><span class=line><span class=ln>7</span><span class=cl><span class=m>0000000000000000</span> T vec._
</span></span></code></pre></div><h2 id=type-bound-procedures>Type-bound procedures</h2><p>We would like to extend the discussion to beyond where the light of the
standard reaches, that is to consider calling type-bound procedures,
which are not supported by the standard. We will begin by a suitable
modification of our code. In an ideal world, we would simply annotate
the type-bound procedure.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln> 1</span><span class=cl><span class=c>! vec_typeb.f90
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c></span><span class=k>module</span><span class=w> </span><span class=n>vec</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>  </span><span class=k>use</span><span class=p>,</span><span class=w> </span><span class=k>intrinsic</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=nb>iso_c_binding</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>  </span><span class=k>implicit</span><span class=w> </span><span class=k>none</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>  </span><span class=k>type</span><span class=p>,</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>cartesian</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>     </span><span class=k>real</span><span class=p>(</span><span class=k>c_double</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>z</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>     </span><span class=k>contains</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>       </span><span class=k>procedure</span><span class=p>,</span><span class=w> </span><span class=k>pass</span><span class=p>(</span><span class=n>self</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>unitmv</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>  </span><span class=k>end</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=n>cartesian</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>  </span><span class=k>contains</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>  </span><span class=k>subroutine</span><span class=w> </span><span class=n>unit_move</span><span class=p>(</span><span class=n>self</span><span class=p>)</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=k>class</span><span class=p>(</span><span class=n>cartesian</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>self</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>    </span><span class=k>print</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Modifying the derived type now!&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=n>self</span><span class=p>%</span><span class=n>x</span><span class=o>=</span><span class=n>self</span><span class=p>%</span><span class=n>x</span><span class=o>+</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>    </span><span class=n>self</span><span class=p>%</span><span class=n>y</span><span class=o>=</span><span class=n>self</span><span class=p>%</span><span class=n>y</span><span class=o>+</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>    </span><span class=n>self</span><span class=p>%</span><span class=n>z</span><span class=o>=</span><span class=n>self</span><span class=p>%</span><span class=n>z</span><span class=o>+</span><span class=mi>1</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>  </span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>unit_move</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>module</span><span class=w> </span><span class=n>vec</span><span class=w>
</span></span></span></code></pre></div><p>However, this understandably does not go very well.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>ifort -c vec_typeb.f90
</span></span><span class=line><span class=ln> 2</span><span class=cl>vec_typeb.f90<span class=o>(</span>7<span class=o>)</span>: error <span class=c1>#8575: A derived type with the BIND attribute shall not have a type bound procedure part.</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>     contains
</span></span><span class=line><span class=ln> 4</span><span class=cl>-----^
</span></span><span class=line><span class=ln> 5</span><span class=cl>vec_typeb.f90<span class=o>(</span>14<span class=o>)</span>: error <span class=c1>#8224: A derived type used with the CLASS keyword shall not have the BIND attribute or SEQUENCE property.   [CARTESIAN]</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    class<span class=o>(</span>cartesian<span class=o>)</span>, intent<span class=o>(</span>in<span class=o>)</span> :: self
</span></span><span class=line><span class=ln> 7</span><span class=cl>gfortran -c vec.f90
</span></span><span class=line><span class=ln> 8</span><span class=cl>vec.f90:7:13:
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=m>7</span> <span class=p>|</span>      contains
</span></span><span class=line><span class=ln>11</span><span class=cl>      <span class=p>|</span>             <span class=m>1</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>Error: Derived-type ‘cartesian’ with BIND<span class=o>(</span>C<span class=o>)</span> must not have a CONTAINS section at <span class=o>(</span>1<span class=o>)</span>
</span></span></code></pre></div><p>Removing the attribute, from both the type and the subroutine and
rearranging slightly, we get the following.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln> 1</span><span class=cl><span class=k>module</span><span class=w> </span><span class=n>vec</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>  </span><span class=k>use</span><span class=p>,</span><span class=w> </span><span class=k>intrinsic</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=nb>iso_c_binding</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>  </span><span class=k>implicit</span><span class=w> </span><span class=k>none</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>  </span><span class=k>type</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>cartesian</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>     </span><span class=k>real</span><span class=p>(</span><span class=nb>kind</span><span class=o>=</span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>z</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>     </span><span class=k>contains</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>       </span><span class=k>procedure</span><span class=p>,</span><span class=w> </span><span class=k>pass</span><span class=p>(</span><span class=n>self</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>unitmv</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>  </span><span class=k>end</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=n>cartesian</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>  </span><span class=k>contains</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>  </span><span class=k>subroutine</span><span class=w> </span><span class=n>unitmv</span><span class=p>(</span><span class=n>self</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>    </span><span class=k>class</span><span class=p>(</span><span class=n>cartesian</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>inout</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>self</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>    </span><span class=k>print</span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Modifying the derived type now!&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>    </span><span class=n>self</span><span class=p>%</span><span class=n>x</span><span class=o>=</span><span class=n>self</span><span class=p>%</span><span class=n>x</span><span class=o>+</span><span class=mf>1.0</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>    </span><span class=n>self</span><span class=p>%</span><span class=n>y</span><span class=o>=</span><span class=n>self</span><span class=p>%</span><span class=n>y</span><span class=o>+</span><span class=mf>1.0</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>    </span><span class=n>self</span><span class=p>%</span><span class=n>z</span><span class=o>=</span><span class=n>self</span><span class=p>%</span><span class=n>z</span><span class=o>+</span><span class=mf>1.0</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>  </span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>unitmv</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>module</span><span class=w> </span><span class=n>vec</span><span class=w>
</span></span></span></code></pre></div><p>The <code>class</code> attribute is required here instead of <code>type</code> since,</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># ifort</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>error <span class=c1>#8264: The passed-object dummy argument must be a polymorphic dummy data object if the type being defined is extensible.</span>
</span></span></code></pre></div><p>In any case, we are now in a position to inspect the generated object.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>gfortran -c vec_typeb.f90
</span></span><span class=line><span class=ln> 2</span><span class=cl>nm vec_typeb.o
</span></span><span class=line><span class=ln> 3</span><span class=cl>                 U _gfortran_st_write
</span></span><span class=line><span class=ln> 4</span><span class=cl>                 U _gfortran_st_write_done
</span></span><span class=line><span class=ln> 5</span><span class=cl>                 U _gfortran_transfer_character_write
</span></span><span class=line><span class=ln> 6</span><span class=cl>                 U _GLOBAL_OFFSET_TABLE_
</span></span><span class=line><span class=ln> 7</span><span class=cl>                 U __stack_chk_fail
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=m>0000000000000000</span> T __vec_MOD___copy_vec_Cartesian
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=m>0000000000000000</span> B __vec_MOD___def_init_vec_Cartesian
</span></span><span class=line><span class=ln>10</span><span class=cl>000000000000002c T __vec_MOD_unitmv
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=m>0000000000000000</span> D __vec_MOD___vtab_vec_Cartesian
</span></span></code></pre></div><p>Which does not seem to be very different at all. We will make an attempt
to directly modify the symbol-table as before.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>objcopy --redefine-sym<span class=o>=</span><span class=nv>__vec_MOD_unitmv</span><span class=o>=</span>unit_move vec_typeb.o
</span></span></code></pre></div><p>An attempt to call this is bound for failure, a segmentation fault to be
exact. In order to be able to call the type bound procedure then, we can
begin by writing a wrapper subroutine.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln>1</span><span class=cl><span class=k>subroutine</span><span class=w> </span><span class=n>unit_move</span><span class=p>(</span><span class=n>cartobj</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>  </span><span class=k>type</span><span class=p>(</span><span class=n>cartesian</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>inout</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>cartobj</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>  </span><span class=k>call</span><span class=w> </span><span class=n>cartobj</span><span class=p>%</span><span class=n>unitmv</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w>
</span></span></span></code></pre></div><p>This does allow for the existing <code>C</code> interface to work.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>gfortran -c vec_typeb.f90
</span></span><span class=line><span class=ln> 2</span><span class=cl>objcopy --redefine-sym<span class=o>=</span><span class=nv>__vec_MOD_unit_move</span><span class=o>=</span>unit_move vec_typeb.o
</span></span><span class=line><span class=ln> 3</span><span class=cl>gcc vec_typeb.o vecfc.c -I./ -o gf_vec -lgfortran
</span></span><span class=line><span class=ln> 4</span><span class=cl>./gf_vec
</span></span><span class=line><span class=ln> 5</span><span class=cl>Initializing the struct
</span></span><span class=line><span class=ln> 6</span><span class=cl>3.000000 2.500000 6.200000
</span></span><span class=line><span class=ln> 7</span><span class=cl>Fortran <span class=k>function</span> with derived <span class=nb>type</span> from C:
</span></span><span class=line><span class=ln> 8</span><span class=cl> Modifying the derived <span class=nb>type</span> now!
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>Returned from Fortran
</span></span><span class=line><span class=ln>11</span><span class=cl>4.000000 3.500000 7.200000%
</span></span></code></pre></div><p>It is useful to at this point, that Fortran passes arguments by
reference and not by value, so there are no additional copy related
overheads incurred by this &ldquo;wrapper&rdquo; approach.</p><blockquote><p>It was correctly pointed out on the <a href="https://fortran-lang.discourse.group/t/exploring-iso-c-binding-and-type-bound-procedures/2447/6?u=rgoswami">Fortran
Discourse</a>
that the pass-by-reference calling convention is not mandated by the
standards, though <a href=https://gcc.gnu.org/onlinedocs/gfortran/Argument-passing-conventions.html>in
practice</a>
many compilers do pass by reference when the <code>VALUE</code> attribute is
missing.</p></blockquote><p>On the other hand, it does leave the programmer in a world bereft of the
<code>iso_c_binding</code>, which means also that the mapping of types and
precisions become rather fluid.</p><h2 id=conclusions>Conclusions</h2><p>This brief interlude on derived types and functions is more relevant in
the context of automated binding generators like <code>f2py</code> Peterson
(<a href=#ref-petersonF2PYToolConnecting2009>2009</a>).</p><p>Perhaps a more formal approach to wrapper generation is the one
elaborated upon in great detail in the literature Gray, Roberts, and
Evans (<a href=#ref-grayShadowobjectInterfaceFortran1999>1999</a>) which details
the concept of a logical interface and a physical interface.</p><p>A similar but more pragmatic approach is the opaque pointer method used
for derived types with pointers in Pletzer et al.
(<a href=#ref-pletzerExposingFortranDerived2008>2008</a>) and forms the basis for
the implementation in <code>f90wrap</code> Kermode
(<a href=#ref-kermodeF90wrapAutomatedTool2020>2020</a>).</p><p>The (ab)use of type-bound procedures in the context of these binding
generation methodologies is to follow at some point since none of them
make any explicit mention of the same. Given that type-bound procedures
were not introduced before 2003 Reid
(<a href=#ref-reidNewFeaturesFortran2003>2003</a>), it is not surprising they
have been overlooked, however their usage is foundational for
long-lasting, sustainable Fortran code.</p><h2 id=references>References</h2><div id=refs class="references csl-bib-body hanging-indent"><div id=ref-grayShadowobjectInterfaceFortran1999 class=csl-entry><p>Gray, M. G., R. M. Roberts, and T. M. Evans. 1999. &ldquo;Shadow-Object
Interface Between Fortran 95 and C++.&rdquo; <em>Computing in Science
Engineering</em> 1 (2): 63&ndash;70. <a href=https://doi.org/10.1109/5992.753048>https://doi.org/10.1109/5992.753048</a>.</p></div><div id=ref-kermodeF90wrapAutomatedTool2020 class=csl-entry><p>Kermode, James R. 2020. &ldquo;F90wrap: An Automated Tool for Constructing
Deep Python Interfaces to Modern Fortran Codes.&rdquo; <em>Journal of Physics:
Condensed Matter</em> 32 (30): 305901.
<a href=https://doi.org/10.1088/1361-648X/ab82d2>https://doi.org/10.1088/1361-648X/ab82d2</a>.</p></div><div id=ref-petersonF2PYToolConnecting2009 class=csl-entry><p>Peterson, Pearu. 2009. &ldquo;F2PY: A Tool for Connecting Fortran and Python
Programs.&rdquo; <em>International Journal of Computational Science and
Engineering</em> 4 (4): 296. <a href=https://doi.org/10.1504/IJCSE.2009.029165>https://doi.org/10.1504/IJCSE.2009.029165</a>.</p></div><div id=ref-pletzerExposingFortranDerived2008 class=csl-entry><p>Pletzer, Alexander, Douglas McCune, Stefan Muszala, Srinath Vadlamani,
and Scott Kruger. 2008. &ldquo;Exposing Fortran Derived Types to C and Other
Languages.&rdquo; <em>Computing in Science Engineering</em> 10 (4): 86&ndash;92.
<a href=https://doi.org/10.1109/MCSE.2008.94>https://doi.org/10.1109/MCSE.2008.94</a>.</p></div><div id=ref-reidNewFeaturesFortran2003 class=csl-entry><p>Reid, John. 2003. &ldquo;The New Features of Fortran 2003,&rdquo; 38.
<a href=https://wg5-fortran.org/N1551-N1600/N1579.pdf>https://wg5-fortran.org/N1551-N1600/N1579.pdf</a>.</p></div></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>As in all things, <code>info nm</code> provides the details on
interpreting the remaining symbols&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><hr><div class=post-series-bottom><h2>Series info</h2><h3>Bridging Fortran & Python series</h3><ol><li><a href=https://rgoswami.me/posts/numpy-meson-f2py/>NumPy, Meson and f2py</a></li><li><a href=https://rgoswami.me/posts/cython-derivedtype-f2py/>Simple Fortran Derived Types and Python</a></li><li><b>Exploring ISO_C_BINDING and type-bound procedures</b> &lt;-- You are here!</li><li><a href=https://rgoswami.me/posts/fortran-oop-python/>Fortran OOP and Python</a></li></ol></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=/tags/fortran>fortran</a></span><span class=tag><a href=/tags/f2py>f2py</a></span><span class=tag><a href=/tags/rambling>rambling</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1974 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Posted: <time class=dt-published>2021-12-19 16:25 +0000</time></p><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frgoswami.me%2fposts%2fiso-c-type-bound-fortran%2f" target=_blank rel=noopener aria-label=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15.84 9.5H13.5V8.48c0-.53.35-.65.6-.65h1.4v-2.3h-2.35c-2.3.0-2.65 1.7-2.65 2.8V9.5h-2v2h2v7h3v-7h2.1l.24-2z"/></svg></div>Facebook</div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=%22Exploring%20ISO_C_BINDING%20and%20type-bound%20procedures%22%20seems%20like%20an%20interesting%20read%20from%20%40rg0swami&amp;url=https%3a%2f%2frgoswami.me%2fposts%2fiso-c-type-bound-fortran%2f" target=_blank rel=noopener aria-label=Twitter><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.5 7.4l-2 .2c-.4-.5-1-.8-2-.8C13.3 6.8 12 8 12 9.4v.6c-2 0-4-1-5.4-2.7-.2.4-.3.8-.3 1.3.0 1 .4 1.7 1.2 2.2-.5.0-1 0-1.2-.3.0 1.3 1 2.3 2 2.6-.3.4-.7.4-1 0 .2 1.4 1.2 2 2.3 2-1 1-2.5 1.4-4 1 1.3 1 2.7 1.4 4.2 1.4 4.8.0 7.5-4 7.5-7.5v-.4c.5-.4.8-1.5 1.2-2z"/><circle cx="12" cy="12" r="11.5"/></svg></div>Twitter</div></a><a class=resp-sharing-button__link href="mailto:?subject=%22Exploring%20ISO_C_BINDING%20and%20type-bound%20procedures%22%20seems%20interesting...&amp;body=https%3a%2f%2frgoswami.me%2fposts%2fiso-c-type-bound-fortran%2f" target=_self rel=noopener aria-label=E-Mail><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.5 16c0 .8-.7 1.5-1.5 1.5H6c-.8.0-1.5-.7-1.5-1.5V8c0-.8.7-1.5 1.5-1.5h12c.8.0 1.5.7 1.5 1.5v8zm-2-7.5L12 13 6.5 8.5m11 6-4-2.5m-7 2.5 4-2.5"/><circle cx="12" cy="12" r="11.5"/></svg></div>E-Mail</div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frgoswami.me%2fposts%2fiso-c-type-bound-fortran%2f&amp;title=%22Exploring%20ISO_C_BINDING%20and%20type-bound%20procedures%22%20seems%20interesting...&amp;summary=%22Exploring%20ISO_C_BINDING%20and%20type-bound%20procedures%22%20seems%20interesting...&amp;source=https%3a%2f%2frgoswami.me%2fposts%2fiso-c-type-bound-fortran%2f" target=_blank rel=noopener aria-label=LinkedIn><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15 12.5c-.28.0-.5.22-.5.5v3.5h-3s.03-6.48.0-7h3v.83s.46-.75 1.7-.75c1.56.0 2.3 1.12 2.3 3.3v3.62h-3V13c0-.28-.23-.5-.5-.5zm-7.5-3h2v7h-2z"/><circle cx="8.5" cy="6.5" r="1"/></svg></div>LinkedIn</div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2frgoswami.me%2fposts%2fiso-c-type-bound-fortran%2f&amp;resubmit=true&amp;title=%22Exploring%20ISO_C_BINDING%20and%20type-bound%20procedures%22%20seems%20interesting..." target=_blank rel=noopener aria-label=Reddit><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><ellipse cx="12" cy="14.37" rx="6.2" ry="4.24"/><path d="M14.3 16.25c-.62.36-1.42.57-2.3.57s-1.7-.2-2.32-.58"/><circle cx="14.61" cy="13.39" r=".98"/><circle cx="9.39" cy="13.39" r=".98"/><path d="M16.4 11.38c.26-.55.82-.92 1.47-.92.9.0 1.63.73 1.63 1.63.0.8-.6 1.47-1.38 1.6"/><circle cx="17.22" cy="7.52" r="1.63"/><path d="M7.6 11.38c-.26-.54-.82-.92-1.47-.92-.9.0-1.63.73-1.63 1.63.0.8.6 1.47 1.38 1.6M12 10.12s-.08-4.82 3.6-2.6"/></svg></div>Reddit</div></a><a class=resp-sharing-button__link href="whatsapp://send?text=%22Exploring%20ISO_C_BINDING%20and%20type-bound%20procedures%22%20seems%20interesting...%20https%3a%2f%2frgoswami.me%2fposts%2fiso-c-type-bound-fortran%2f" target=_blank rel=noopener aria-label=WhatsApp><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle xmlns="http://www.w3.org/2000/svg" cx="12" cy="12" r="11.5"/><path stroke-width="1" d="M17.6 6.2c-1.5-1.5-3.4-2.3-5.5-2.3-4.3.0-7.8 3.5-7.8 7.8.0 1.4.4 2.7 1 3.9l-1.1 4 4.1-1.1c1.1.6 2.4.9 3.7.9 4.3.0 7.8-3.5 7.8-7.8.1-2-.7-3.9-2.2-5.4zm-5.5 11.9c-1.2.0-2.3-.3-3.3-.9l-.2-.1-2.4.6.7-2.4-.2-.2c-.6-1-1-2.2-1-3.4.0-3.6 2.9-6.5 6.5-6.5 1.7.0 3.3.7 4.6 1.9 1.2 1.2 1.9 2.8 1.9 4.6-.1 3.5-3 6.4-6.6 6.4zm3.5-4.8c-.2-.1-1.1-.6-1.3-.6-.2-.1-.3-.1-.4.1s-.5.6-.6.8c-.1.1-.2.1-.4.0s-.8-.3-1.6-1c-.6-.5-1-1.2-1.1-1.3-.1-.2.0-.3.1-.4l.3-.3s.1-.2.2-.3c.1-.1.0-.2.0-.3s-.4-1.1-.6-1.4c-.2-.4-.3-.3-.4-.3h-.4s-.3.0-.5.2-.7.7-.7 1.6c0 1 .7 1.9.8 2s1.4 2.1 3.3 2.9c.5.2.8.3 1.1.4.5.1.9.1 1.2.1.4-.1 1.1-.5 1.3-.9.2-.5.2-.8.1-.9.0-.2-.2-.3-.4-.4z"/></svg></div>WhatsApp</div></a></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://rgoswami.me/posts/revisiting-wayland-2021-archlinux/><span class=button__icon>←</span>
<span class=button__text>Revisiting Wayland for ArchLinux</span></a></span>
<span class="button next"><a href=https://rgoswami.me/posts/cython-derivedtype-f2py/><span class=button__text>Simple Fortran Derived Types and Python</span>
<span class=button__icon>→</span></a></span></div></div><div id=comments class=thin><div class=pagination__title><span class=pagination__title-h>Comments</span><hr></div><script src=https://utteranc.es/client.js repo=haozeke/haozeke.github.io issue-term=pathname theme=photon-dark label="Utterance 💬" crossorigin=anonymous async></script></div></main><footer class=footer><p>&copy; 2023
<span><a href=https://rgoswami.me/>Rohit Goswami (HaoZeke)</a></span>
<a href=/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a><br><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a>.
Powered by <a href=http://gohugo.io><u>Hugo</u></a> and <a href=https://github.com/HaoZeke/hugo-theme-hello-friend-ng-hz><u>this theme</u></a>.</br>Hosted with <u><a href=https://www.netlify.com/>Netlify</a></u>.</br><script src=https://liberapay.com/rohit/widgets/button.js></script><noscript><a href=https://liberapay.com/rohit/donate><img alt="Donate using Liberapay" src=https://liberapay.com/assets/widgets/donate.svg></a></noscript></p></footer></div><script src=/bundle.min.5fae9992ea406007408dc33b0b3a8376d61e2f1d6ac50ba1dad7580ac50afb5199bcef3bbc3677e77553a9980bf882cf71edc2f755687dd7725f12ece4304ac2.js></script>
<script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-109503488-16","auto"),ga("send","pageview")</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","3z2xvwqu4u")</script><script data-goatcounter=https://rgoswami.goatcounter.com/count async src=//gc.zgo.at/count.js></script>
<script>var clicky_site_ids=clicky_site_ids||[];clicky_site_ids.push("101265002")</script><script async src=https://static.getclicky.com/js></script>
<script src=https://cdn.jsdelivr.net/npm/readmore-js@3.0.0-beta-1/dist/readmore.min.js></script>
<script src=/js/codefold.min.f0790269b87613b3bcff64022840fe1991eee3ea384e874c78a24022c9936bd888a3c14a05a10955881eebb1558e4fcf37576dac120cd0bf4ebaf7aca27b35b1.js></script></body></html>