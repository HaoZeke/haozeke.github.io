<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="[Rohit Goswami]"><meta name=description content="Migrating Imap, Gmail and Exchange, mail accounts from GUI clients to Astroid
 Background Initially, I had planned this post to start with a brief history of the decline of email clients for Linux. That quickly got out of hand, and was therefore spun out into a post of its own (TBD). To keep things brief. Thanks to the incredible ineptitude of the Thunderbird steering committee, I ended up requiring a new mail client."><meta name=keywords content=",rant,tools,email,workflow"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://rgoswami.me/posts/reclaim-email-astroid/><title>Reclaiming Email with Astroid :: Rohit Goswami — Reflections</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.min.b6dbce0fdf6c61563a0c2226e857d5dadd8e5afa2c4f73ec9ea55abd831f9a72.css><meta itemprop=name content="Reclaiming Email with Astroid"><meta itemprop=description content="Migrating Imap, Gmail and Exchange, mail accounts from GUI clients to Astroid
 Background Initially, I had planned this post to start with a brief history of the decline of email clients for Linux. That quickly got out of hand, and was therefore spun out into a post of its own (TBD). To keep things brief. Thanks to the incredible ineptitude of the Thunderbird steering committee, I ended up requiring a new mail client."><meta itemprop=datePublished content="2020-12-30T06:37:00+00:00"><meta itemprop=dateModified content="2020-12-30T06:37:00+00:00"><meta itemprop=wordCount content="1354"><meta itemprop=image content="https://rgoswami.me/images/RG.png"><meta itemprop=keywords content="rant,tools,email,workflow,"><meta property="og:title" content="Reclaiming Email with Astroid"><meta property="og:description" content="Migrating Imap, Gmail and Exchange, mail accounts from GUI clients to Astroid
 Background Initially, I had planned this post to start with a brief history of the decline of email clients for Linux. That quickly got out of hand, and was therefore spun out into a post of its own (TBD). To keep things brief. Thanks to the incredible ineptitude of the Thunderbird steering committee, I ended up requiring a new mail client."><meta property="og:type" content="article"><meta property="og:url" content="https://rgoswami.me/posts/reclaim-email-astroid/"><meta property="og:image" content="https://rgoswami.me/images/RG.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-12-30T06:37:00+00:00"><meta property="article:modified_time" content="2020-12-30T06:37:00+00:00"><meta property="og:site_name" content="Rohit Goswami"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rgoswami.me/images/RG.png"><meta name=twitter:title content="Reclaiming Email with Astroid"><meta name=twitter:description content="Migrating Imap, Gmail and Exchange, mail accounts from GUI clients to Astroid
 Background Initially, I had planned this post to start with a brief history of the decline of email clients for Linux. That quickly got out of hand, and was therefore spun out into a post of its own (TBD). To keep things brief. Thanks to the incredible ineptitude of the Thunderbird steering committee, I ended up requiring a new mail client."><meta property="article:section" content="personal"><meta property="article:published_time" content="2020-12-30 06:37:00 +0000 UTC"></head><body><div class=container><header class=header><div class=header__inner><div class=header__left><div class=logo><a href=/ style=text-decoration:none><img src=/images/home.png alt></a></div></div><div class=header__mid><button class=button><div class=button__text><a href=https://rgoswami.me//search>Search</a></div></button></div><div class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://rgoswami.me/about>About</a></li><li><a href=https://rgoswami.me/posts>Blog</a></li></ul><ul class=menu__inner><li><a href=https://rgoswami.me/categories>Categories</a></li><li><a href=https://rgoswami.me/tags>Tags</a></li></ul></nav><button id=toggleMenu><div class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></div></button>
<button class=theme-toggle id=toggleTheme><svg class="theme-toggler" width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></button></div></div></header><script src=https://rgoswami.me/js/mathjax-config.js></script><script id=MathJax-script async src=https://unpkg.com/mathjax@3/es5/tex-chtml.js></script><aside class=sidebar><div class=hideTOC><button id=tocTog>TOC</button><div class="sideTOC m-fadeOut"><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#series>Series</a></li></ul></li><li><a href=#the-accounts>The Accounts</a></li><li><a href=#insync>InSync</a><ul><li><a href=#general-imap>General IMAP</a></li><li><a href=#exchange-accounts>Exchange Accounts</a></li></ul></li><li><a href=#gmaileer>Gmaileer</a><ul><li><a href=#ieee>IEEE</a></li></ul></li><li><a href=#notmuch>Notmuch</a></li><li><a href=#sending-email>Sending Email</a></li><li><a href=#astroid>Astroid</a><ul><li><a href=#nix-python-poll-script>Nix Python Poll Script</a></li><li><a href=#navigation>Navigation</a></li></ul></li><li><a href=#conclusions>Conclusions</a><ul><li><a href=#update>Update</a></li></ul></li></ul></nav></div></div></aside><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>7 minutes<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Written: 2020-12-30 06:37 +0000</p></p></div><article class=h-entry><h1 class="post-title p-name"><a class=u-url href=https://rgoswami.me/posts/reclaim-email-astroid/>Reclaiming Email with Astroid</a></h1><div class=post-info><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pen-tool"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg><span class="author u-author p-author"><a href=https://rgoswami.me/author/rohit-goswami>Rohit Goswami</a></span></div><hr><aside id=toc class=sidebar><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#series>Series</a></li></ul></li><li><a href=#the-accounts>The Accounts</a></li><li><a href=#insync>InSync</a><ul><li><a href=#general-imap>General IMAP</a></li><li><a href=#exchange-accounts>Exchange Accounts</a></li></ul></li><li><a href=#gmaileer>Gmaileer</a><ul><li><a href=#ieee>IEEE</a></li></ul></li><li><a href=#notmuch>Notmuch</a></li><li><a href=#sending-email>Sending Email</a></li><li><a href=#astroid>Astroid</a><ul><li><a href=#nix-python-poll-script>Nix Python Poll Script</a></li><li><a href=#navigation>Navigation</a></li></ul></li><li><a href=#conclusions>Conclusions</a><ul><li><a href=#update>Update</a></li></ul></li></ul></nav></aside><hr><div class="post-content e-content"><blockquote><p>Migrating Imap, Gmail and Exchange, mail accounts from GUI clients to <a href=https://astroidmail.github.io/>Astroid</a></p></blockquote><h2 id=background>Background</h2><p>Initially, I had planned this post to start with a brief history of the decline of email clients for Linux. That quickly got out of hand, and was therefore spun out into a post of its own (TBD). To keep things brief. Thanks to the incredible ineptitude of the Thunderbird steering committee, I ended up requiring a new mail client. Having despaired of the GUI based bloat heavy approaches of most clients, I decided to go the old fashioned route and build one up in a modular manner.</p><h3 id=series>Series</h3><p>This post is part of a series on email.</p><ol><li>The Decline of Linux Email (TBD)</li><li><strong>Reclaiming Email with Astroid</strong> &lt;&ndash; You are here!</li><li>Emacs and Email (TBD)</li></ol><h2 id=the-accounts>The Accounts</h2><p>In no order of preference, for a variety of reasons, I have 23 distinct email accounts. However, these are actually broken down into a few basic types and associated mail fetching software.</p><dl><dt>Generic IMAP</dt><dd>Yahoo, Mail.ru and the rest are managed with <a href=https://isync.sourceforge.io/>isync</a></dd><dt>Exchange</dt><dd>A school account of mine uses Office 365, and will be handled with <a href=http://davmail.sourceforge.net/>davmail</a> in conjunction with <code>isync</code></dd><dt>Gmail</dt><dd>There are a few of these, two personal, and two institutional, all of which are handled with <a href=http://lieer.gaute.vetsj.com/>lieer</a></dd></dl><h2 id=insync>InSync</h2><p>For general IMAP accounts (anything which isn&rsquo;t backed by <code>gmail</code> or <code>outlook</code>) an <code>mbsync</code> approach works best. Exhange accounts need <code>davmail</code> and are described in a separate sub-section. Before we get to the <code>poll.sh</code> script and <code>astroid</code>, it is a good idea to run each of these as we set them up, especially as the first run can take quite a long time (around an hour for 9205 messages).</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mbsync -V blah
</code></pre></div><h3 id=general-imap>General IMAP</h3><p>For a standard IMAP account (anything which isn&rsquo;t Exchange or Gmail) the only thing we need to keep track of is a good way to obfuscate passwords. We will use <code>pass</code> for this <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>pass git init <span class=nv>$GPG_KEY</span> <span class=c1># Optional, use a secure private git repo</span>
pass init <span class=nv>$GPG_KEY</span>
pass add mail/rgoswami.iitk
</code></pre></div><p>With this, we can configure a general IMAP account (an IITK webmail in this instance, but it could be anything).</p><div class=highlight><pre class=chroma><code class=language-tcl data-lang=tcl><span class=nv>IMAPAccount</span> rgoswami.iitk
<span class=nv>Host</span> qasid.iitk.ac.in
<span class=nv>User</span> rgoswami
<span class=nv>PassCmd</span> <span class=s2>&#34;pass show mail/rgoswami.iitk&#34;</span>
<span class=nv>AuthMechs</span> LOGIN
<span class=nv>SSLType</span> IMAPS

<span class=nv>IMAPStore</span> rgoswami.iitk-remote
<span class=nv>Account</span> rgoswami.iitk

<span class=nv>MaildirStore</span> rgoswami.iitk-local
<span class=nv>SubFolders</span> Verbatim
<span class=nv>Path</span> <span class=o>/</span>run<span class=o>/</span>media<span class=o>/</span>Storage<span class=o>/</span>.mail<span class=o>/</span>rgoswami_iitk<span class=o>/</span>
<span class=nv>INBOX</span> <span class=o>/</span>run<span class=o>/</span>media<span class=o>/</span>Storage<span class=o>/</span>.mail<span class=o>/</span>rgoswami_iitk<span class=o>/</span>Inbox
<span class=nv>Trash</span> trash:<span class=o>///</span>

<span class=nv>Channel</span> rgoswami.iitk
<span class=nv>Master</span> <span class=o>:</span>rgoswami.iitk-remote:
<span class=nv>Slave</span> <span class=o>:</span>rgoswami.iitk-local:
<span class=nv>Patterns</span> <span class=o>*</span>
<span class=nv>Create</span> Both
<span class=nv>SyncState</span> <span class=o>*</span>
</code></pre></div><h3 id=exchange-accounts>Exchange Accounts</h3><p>For Exchange accounts we need to setup <code>davmail</code>. Thankfully the process is actually excessively simple for a single account. For each account, a <code>.properties</code> file needs to be generated. The password section is kept blank in this case, since we will authenticate with the <code>O365Interactive</code> protocol.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=c1># The default setup</span>
davmail ~/.davmail.properties
</code></pre></div><p>Use the following properties in the <code>.davemail.properties</code> file to prevent timeout errors:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>davmail.folderSizeLimit<span class=o>=</span><span class=m>50</span>
davmail.clientSoTimeout<span class=o>=</span><span class=m>0</span>
davmail.enableKeepAlive<span class=o>=</span><span class=nb>true</span>
</code></pre></div><p>Further information is available at <a href=http://davmail.sourceforge.net/faq.html>the official docs</a>.</p><figure><img src=/ox-hugo/2020-12-29_21-54-39_screenshot.png alt="Figure 1: davmail setup"><figcaption><p>Figure 1: <code>davmail</code> setup</p></figcaption></figure><figure><img src=/ox-hugo/2020-12-29_21-54-20_screenshot.png alt="Figure 2: Interactive login workflow"><figcaption><p>Figure 2: Interactive login workflow</p></figcaption></figure><p>Now we can configure the <code>.mbsyncrc</code> in a manner analogous to the standard IMAP setup, but with the port and host where <code>davmail</code> is running.</p><div class=highlight><pre class=chroma><code class=language-tcl data-lang=tcl><span class=nv>IMAPAccount</span> rog32
<span class=nv>Host</span> localhost
<span class=nv>User</span> rog32<span class=err>@</span>hi.is
<span class=nv>Pass</span> dummy
<span class=nv>Port</span> <span class=mi>1143</span>
<span class=nv>SSLType</span> None
<span class=nv>AuthMechs</span> LOGIN

<span class=nv>IMAPStore</span> rog32-remote
<span class=nv>Account</span> rog32
<span class=nv>MaildirStore</span> rog32-local
<span class=nv>SubFolders</span> Verbatim
<span class=nv>Path</span> <span class=o>/</span>run<span class=o>/</span>media<span class=o>/</span>Storage<span class=o>/</span>.mail<span class=o>/</span>rog32<span class=o>/</span>
<span class=nv>Inbox</span> <span class=o>/</span>run<span class=o>/</span>media<span class=o>/</span>Storage<span class=o>/</span>.mail<span class=o>/</span>rog32<span class=o>/</span>Inbox

<span class=nv>Channel</span> rog32
<span class=nv>Master</span> <span class=o>:</span>rog32-remote:
<span class=nv>Slave</span> <span class=o>:</span>rog32-local:
<span class=nv>Patterns</span> <span class=o>*</span>
<span class=nv>Create</span> Both
<span class=nv>SyncState</span> <span class=o>*</span>
</code></pre></div><p>The <code>SSLType</code> and <code>AuthMechs</code> are important parameters. Note that the <code>Pass</code> is truly not important since we an OAuth token is stored in the <code>properties</code> file.</p><figure><img src=/ox-hugo/2020-12-29_23-51-10_screenshot.png alt="Figure 3: First run of a large inbox with davmail and isync"><figcaption><p>Figure 3: First run of a large inbox with <code>davmail</code> and <code>isync</code></p></figcaption></figure><h2 id=gmaileer>Gmaileer</h2><p>The general setup <code>gmi init blah@gmail.com</code> works well for personal accounts. However, there was an additional step for the IEEE account.</p><h3 id=ieee>IEEE</h3><p>Some issues with tags led to the following changes in the <code>.gmaileer.json</code> file</p><div class=highlight><pre class=chroma><code class=language-js data-lang=js><span class=p>{</span><span class=s2>&#34;replace_slash_with_dot&#34;</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=s2>&#34;account&#34;</span><span class=o>:</span> <span class=s2>&#34;rgoswami@ieee.org&#34;</span><span class=p>,</span> <span class=s2>&#34;timeout&#34;</span><span class=o>:</span> <span class=mi>600</span><span class=p>,</span> <span class=s2>&#34;drop_non_existing_label&#34;</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=s2>&#34;ignore_empty_history&#34;</span><span class=o>:</span> <span class=kc>false</span><span class=p>,</span> <span class=s2>&#34;ignore_tags&#34;</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;TODO&#34;</span><span class=p>,</span><span class=s2>&#34;new&#34;</span><span class=p>],</span> <span class=s2>&#34;ignore_remote_labels&#34;</span><span class=o>:</span> <span class=p>[</span><span class=s2>&#34;CATEGORY_SOCIAL&#34;</span><span class=p>,</span> <span class=s2>&#34;CATEGORY_FORUMS&#34;</span><span class=p>,</span> <span class=s2>&#34;CATEGORY_PROMOTIONS&#34;</span><span class=p>,</span> <span class=s2>&#34;CATEGORY_PERSONAL&#34;</span><span class=p>,</span> <span class=s2>&#34;CATEGORY_UPDATES&#34;</span><span class=p>],</span> <span class=s2>&#34;remove_local_messages&#34;</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span> <span class=s2>&#34;file_extension&#34;</span><span class=o>:</span> <span class=s2>&#34;&#34;</span><span class=p>}</span>
</code></pre></div><p>Essentially just the addition of two new <code>ignore_tags</code>.</p><h2 id=notmuch>Notmuch</h2><p>At this point, we have all mail synced into local directories, but we have no access to view or interact with them. We will start by setting up <code>notmuch</code> to search and index our mail. This is pretty basic for now.</p><div class=highlight><pre class=chroma><code class=language-toml data-lang=toml><span class=p>[</span><span class=nx>database</span><span class=p>]</span>
<span class=nx>path</span><span class=p>=</span><span class=err>/</span><span class=nx>run</span><span class=err>/</span><span class=nx>media</span><span class=err>/</span><span class=nx>Storage</span><span class=err>/</span><span class=p>.</span><span class=nx>mail</span><span class=err>/</span>
<span class=p>[</span><span class=nx>user</span><span class=p>]</span>
<span class=nx>name</span><span class=p>=</span><span class=nx>Person</span>
<span class=nx>primary_email</span><span class=p>=</span><span class=nx>primary</span><span class=err>@</span><span class=nx>domain</span><span class=p>.</span><span class=nx>com</span>
<span class=nx>other_email</span><span class=p>=</span><span class=nx>one</span><span class=err>@</span><span class=nx>domain</span><span class=p>.</span><span class=nx>com</span><span class=err>;</span><span class=nx>two</span><span class=err>@</span><span class=nx>domain</span><span class=p>.</span><span class=nx>com</span>
<span class=p>[</span><span class=nx>new</span><span class=p>]</span>
<span class=nx>tags</span><span class=p>=</span><span class=nx>new</span><span class=err>;</span><span class=nx>unread</span><span class=err>;</span><span class=nx>inbox</span><span class=err>;</span><span class=nx>TODO</span><span class=err>;</span>
<span class=nx>ignore</span><span class=p>=</span><span class=err>/</span><span class=p>.</span><span class=err>*</span><span class=p>[.]</span><span class=err>(</span><span class=nx>json</span><span class=err>|</span><span class=nx>lock</span><span class=err>|</span><span class=nx>bak</span><span class=err>)$/</span>
<span class=p>[</span><span class=nx>search</span><span class=p>]</span>
<span class=nx>exclude_tags</span><span class=p>=</span><span class=nx>deleted</span><span class=err>;</span><span class=nx>spam</span><span class=err>;</span>
<span class=p>[</span><span class=nx>maildir</span><span class=p>]</span>
<span class=nx>synchronize_flags</span><span class=p>=</span><span class=kc>true</span>
</code></pre></div><p>There are a lot more options which may be configured, but this is enough to get started.</p><h2 id=sending-email>Sending Email</h2><p>At this stage we need a way to actually send email. A simple configuration can be setup in <code>/.config/msmtp/config</code> is given below (where we use <code>pass</code> again):</p><div class=highlight><pre class=chroma><code class=language-tcl data-lang=tcl><span class=nv>defaults</span>
<span class=nv>port</span> <span class=mi>587</span>
<span class=nv>tls</span> on
<span class=nv>auth</span> on
<span class=nv>logfile</span> <span class=o>~/</span>.config<span class=o>/</span>msmtp<span class=o>/</span>.msmtp.log
<span class=nv>tls_trust_file</span> <span class=o>/</span>etc<span class=o>/</span>ssl<span class=o>/</span>certs<span class=o>/</span>ca-certificates.crt

<span class=nv>account</span> r95g10
<span class=nv>host</span> smtp.gmail.com
<span class=nv>from</span> r95g10<span class=err>@</span>gmail.com
<span class=nv>user</span> r95g10<span class=err>@</span>gmail.com
<span class=nv>tls_starttls</span> on
<span class=nv>tls</span> on
<span class=nv>auth</span> on
<span class=nv>port</span> <span class=mi>587</span>
<span class=nv>passwordeval</span> pass show mail<span class=o>/</span>r95g10.gmail

<span class=nv>account</span> rog32
<span class=nv>host</span> localhost
<span class=nv>from</span> rog32<span class=err>@</span>hi.is
<span class=nv>user</span> rog32<span class=err>@</span>hi.is
<span class=nv>tls_starttls</span> off
<span class=nv>tls</span> off
<span class=nv>auth</span> plain
<span class=nv>port</span> <span class=mi>1025</span>
<span class=nv>password</span> dummy
</code></pre></div><p>Note that the exchange account again uses a dummy password, and the real password will be prompted for on the first run. The permissions of the file above should be <code>600</code>. It is prudent to test at-least the exchange section to login.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=nb>echo</span> <span class=s2>&#34;Hello world&#34;</span> <span class=p>|</span> msmtp --account<span class=o>=</span>rog32 r95g10@gmail.com
</code></pre></div><h2 id=astroid>Astroid</h2><p>The bulk of this setup is <a href=https://github.com/astroidmail/astroid/wiki/Astroid-setup>by the numbers</a>, with the exception of the poll script. However, minimally configure <code>astroid</code> with the location of our <code>notmuch</code> configuration.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>astroid --new-config
vim ~/.config/astroid/config
</code></pre></div><p>The relevant sections are:</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=s2>&#34;notmuch_config&#34;</span><span class=err>:</span> <span class=s2>&#34;\/home\/whoever\/.notmuch-config&#34;</span><span class=err>,</span>
</code></pre></div><p>The accounts section is fairly self explanatory, but we will need to use the following <code>sendmail</code> line as well:</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=s2>&#34;sendmail&#34;</span><span class=err>:</span> <span class=s2>&#34;msmtp --read-envelope-from -i -t&#34;</span><span class=err>,</span>
</code></pre></div><h3 id=nix-python-poll-script>Nix Python Poll Script</h3><p>Natively only bash appears to be supported. However, with <code>nix</code>, we can use a reproducible python script with <a href=https://amoffat.github.io/sh>the sh library</a> to call system functions instead.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>pathlib</span> <span class=kn>import</span> <span class=n>Path</span>
<span class=kn>import</span> <span class=nn>sh</span>

<span class=c1># For generic IMAP maildirs</span>

<span class=n>ISYNC_LABELS</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;rgoswami.iitk&#34;</span><span class=p>,</span> <span class=s2>&#34;rog32&#34;</span><span class=p>]</span>

<span class=k>for</span> <span class=n>isync</span> <span class=ow>in</span> <span class=n>ISYNC_LABELS</span><span class=p>:</span>
    <span class=n>sh</span><span class=o>.</span><span class=n>mbsync</span><span class=p>(</span><span class=s2>&#34;-V&#34;</span><span class=p>,</span><span class=n>isync</span><span class=p>,</span><span class=n>_bg</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>


<span class=c1># Gmaileer</span>
<span class=n>GMAIL_IDENTIFIERS</span> <span class=o>=</span> <span class=p>[</span><span class=s2>&#34;gmail&#34;</span><span class=p>,</span> <span class=s2>&#34;univ&#34;</span><span class=p>,</span> <span class=s2>&#34;ieee&#34;</span><span class=p>]</span>

<span class=n>path</span> <span class=o>=</span> <span class=n>Path</span><span class=p>(</span><span class=sa>r</span><span class=s2>&#34;/run/media/haozeke/Storage/.mail/&#34;</span><span class=p>)</span>

<span class=k>for</span> <span class=n>dirs</span> <span class=ow>in</span> <span class=n>path</span><span class=o>.</span><span class=n>iterdir</span><span class=p>():</span>
    <span class=k>if</span> <span class=n>dirs</span><span class=o>.</span><span class=n>is_dir</span><span class=p>():</span>
        <span class=k>for</span> <span class=n>gmi</span> <span class=ow>in</span> <span class=n>GMAIL_IDENTIFIERS</span><span class=p>:</span>
            <span class=k>if</span> <span class=n>gmi</span> <span class=ow>in</span> <span class=n>dirs</span><span class=o>.</span><span class=n>name</span><span class=p>:</span>
                <span class=nb>print</span><span class=p>(</span><span class=sa>f</span><span class=s2>&#34;Syncing </span><span class=si>{</span><span class=n>dirs</span><span class=o>.</span><span class=n>name</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>)</span>
                <span class=n>sh</span><span class=o>.</span><span class=n>gmi</span><span class=p>(</span><span class=s2>&#34;sync&#34;</span><span class=p>,</span> <span class=n>_cwd</span><span class=o>=</span><span class=n>dirs</span><span class=p>,</span> <span class=n>_fg</span><span class=o>=</span><span class=kc>True</span><span class=p>)</span>
</code></pre></div><p>This needs to be coupled with the standard <code>nix</code> shebang in the <code>poll.sh</code> file:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash><span class=cp>#!/usr/bin/env nix-shell
</span><span class=cp></span><span class=c1>#!nix-shell -i python3 -p &#34;python38.withPackages(ps: [ ps.numpy ps.sh ])&#34;</span>
</code></pre></div><h3 id=navigation>Navigation</h3><p>For working with HTML emails, we need to highlight the notice about potentially sketchy HTML using (defaults) <code>j</code> or <code>k</code> and then hit <code>enter</code> or <code>o</code>.</p><figure><img src=/ox-hugo/2020-12-30_01-07-09_screenshot.png alt="Figure 4: Unhelpful default"><figcaption><p>Figure 4: Unhelpful default</p></figcaption></figure><figure><img src=/ox-hugo/2020-12-30_01-08-45_screenshot.png alt="Figure 5: After viewing the sketchy bit" width=600><figcaption><p>Figure 5: After viewing the sketchy bit</p></figcaption></figure><p>Note that since most email is actually sent with <code>text/html</code> it might make more sense to configure the <code>thread_view</code> in the configuration file.</p><div class=highlight><pre class=chroma><code class=language-json data-lang=json><span class=s2>&#34;thread_view&#34;</span><span class=err>:</span> <span class=p>{</span>
    <span class=nt>&#34;open_html_part_external&#34;</span><span class=p>:</span> <span class=s2>&#34;false&#34;</span><span class=p>,</span>
<span class=hl>    <span class=nt>&#34;preferred_type&#34;</span><span class=p>:</span> <span class=s2>&#34;html&#34;</span><span class=p>,</span>
</span>    <span class=nt>&#34;preferred_html_only&#34;</span><span class=p>:</span> <span class=s2>&#34;false&#34;</span><span class=p>,</span>
    <span class=nt>&#34;allow_remote_when_encrypted&#34;</span><span class=p>:</span> <span class=s2>&#34;false&#34;</span><span class=p>,</span>
    <span class=nt>&#34;open_external_link&#34;</span><span class=p>:</span> <span class=s2>&#34;xdg-open&#34;</span><span class=p>,</span>
    <span class=nt>&#34;default_save_directory&#34;</span><span class=p>:</span> <span class=s2>&#34;~&#34;</span><span class=p>,</span>
    <span class=nt>&#34;indent_messages&#34;</span><span class=p>:</span> <span class=s2>&#34;false&#34;</span><span class=p>,</span>
    <span class=nt>&#34;gravatar&#34;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&#34;enable&#34;</span><span class=p>:</span> <span class=s2>&#34;true&#34;</span>
    <span class=p>},</span>
    <span class=nt>&#34;mark_unread_delay&#34;</span><span class=p>:</span> <span class=s2>&#34;0.5&#34;</span><span class=p>,</span>
    <span class=nt>&#34;expand_flagged&#34;</span><span class=p>:</span> <span class=s2>&#34;true&#34;</span>
<span class=p>}</span><span class=err>,</span></code></pre></div><h4 id=deletion>Deletion</h4><p>There are again, two different approaches to deletion.</p><dl><dt>Gmail</dt><dd>For <code>gmail</code> accounts it is simple, just adding a <code>trash</code> tag will do the trick, so we can select multiple emails with <code>t</code> and then hit <code>+</code> to add <code>trash</code> and everything works out</dd><dt>Other Accounts</dt><dd>We can <strong>delete mail</strong> forever (from the server as well), by using a safe-tag and then using <code>notmuch</code></dd></dl><p>The generic non-<code>lieer</code> method requires:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>notmuch search --output<span class=o>=</span>files --format<span class=o>=</span>text0 tag:killed <span class=p>|</span> xargs -r0 rm
</code></pre></div><p>A <code>pre-new</code> hook will work.</p><h4 id=composition>Composition</h4><p>Thankfully, <code>astroid</code> supports GPG encryption as well as markdown support. This makes for simple integration with any popular editor.</p><figure><img src=/ox-hugo/2020-12-30_06-27-38_screenshot.png alt="Figure 6: Composition with emacs and astroid"><figcaption><p>Figure 6: Composition with <code>emacs</code> and <code>astroid</code></p></figcaption></figure><h2 id=conclusions>Conclusions</h2><p>This is enough to get started for a while, but it isn&rsquo;t yet at the stage where I can replace <code>thunderbird</code> unfortunately. However, there are several pain points to be addressed, which will be covered in a future post. Some of these are essentially related to network fluctuations, and the awkward deletion setup.</p><h3 id=update>Update</h3><ul><li><code>astroid</code> appears to be having a <a href=https://github.com/astroidmail/astroid/issues/669>bit of a development crisis</a><ul><li>The <a href=https://github.com/gauteh/ragnarok>sequel (ragnarok)</a> unfortunately seems to have gone towards a <a href=https://github.com/gauteh/ragnarok/tree/master/astroid>browser frontend</a>, which is quite unacceptable to me<ul><li>This makes it far too similar to (in principle) Mailspring (though with less problematic connectivity issues)</li><li>This means I won&rsquo;t be moving forward with the next set of posts regarding <code>astroid</code> and will move towards <code>emacs</code> again</li></ul></li></ul></li><li><a href=https://mehl.mx/>Max Mehl</a> has a <a href=https://src.mehl.mx/mxmehl/mail-config/src/branch/master/astroid/scripts>good collection of scripts</a> for <code>astroid</code></li></ul><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>The GPG key itself can be stored with <code>keybase</code>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://rgoswami.me/tags/rant>rant</a></span><span class=tag><a href=https://rgoswami.me/tags/tools>tools</a></span><span class=tag><a href=https://rgoswami.me/tags/email>email</a></span><span class=tag><a href=https://rgoswami.me/tags/workflow>workflow</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1354 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Posted: <time class=dt-published>2020-12-30 06:37 +0000</time></p><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frgoswami.me%2fposts%2freclaim-email-astroid%2f" target=_blank rel=noopener aria-label=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15.84 9.5H13.5V8.48c0-.53.35-.65.6-.65h1.4v-2.3h-2.35c-2.3.0-2.65 1.7-2.65 2.8V9.5h-2v2h2v7h3v-7h2.1l.24-2z"/></svg></div>Facebook</div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=%22Reclaiming%20Email%20with%20Astroid%22%20seems%20like%20an%20interesting%20read%20from%20%40rg0swami&url=https%3a%2f%2frgoswami.me%2fposts%2freclaim-email-astroid%2f" target=_blank rel=noopener aria-label=Twitter><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.5 7.4l-2 .2c-.4-.5-1-.8-2-.8C13.3 6.8 12 8 12 9.4v.6c-2 0-4-1-5.4-2.7-.2.4-.3.8-.3 1.3.0 1 .4 1.7 1.2 2.2-.5.0-1 0-1.2-.3.0 1.3 1 2.3 2 2.6-.3.4-.7.4-1 0 .2 1.4 1.2 2 2.3 2-1 1-2.5 1.4-4 1 1.3 1 2.7 1.4 4.2 1.4 4.8.0 7.5-4 7.5-7.5v-.4c.5-.4.8-1.5 1.2-2z"/><circle cx="12" cy="12" r="11.5"/></svg></div>Twitter</div></a><a class=resp-sharing-button__link href="mailto:?subject=%22Reclaiming%20Email%20with%20Astroid%22%20seems%20interesting...&body=https%3a%2f%2frgoswami.me%2fposts%2freclaim-email-astroid%2f" target=_self rel=noopener aria-label=E-Mail><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.5 16c0 .8-.7 1.5-1.5 1.5H6c-.8.0-1.5-.7-1.5-1.5V8c0-.8.7-1.5 1.5-1.5h12c.8.0 1.5.7 1.5 1.5v8zm-2-7.5L12 13 6.5 8.5m11 6-4-2.5m-7 2.5 4-2.5"/><circle cx="12" cy="12" r="11.5"/></svg></div>E-Mail</div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2frgoswami.me%2fposts%2freclaim-email-astroid%2f&title=%22Reclaiming%20Email%20with%20Astroid%22%20seems%20interesting...&summary=%22Reclaiming%20Email%20with%20Astroid%22%20seems%20interesting...&source=https%3a%2f%2frgoswami.me%2fposts%2freclaim-email-astroid%2f" target=_blank rel=noopener aria-label=LinkedIn><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15 12.5c-.28.0-.5.22-.5.5v3.5h-3s.03-6.48.0-7h3v.83s.46-.75 1.7-.75c1.56.0 2.3 1.12 2.3 3.3v3.62h-3V13c0-.28-.23-.5-.5-.5zm-7.5-3h2v7h-2z"/><circle cx="8.5" cy="6.5" r="1"/></svg></div>LinkedIn</div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2frgoswami.me%2fposts%2freclaim-email-astroid%2f&resubmit=true&title=%22Reclaiming%20Email%20with%20Astroid%22%20seems%20interesting..." target=_blank rel=noopener aria-label=Reddit><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><ellipse cx="12" cy="14.37" rx="6.2" ry="4.24"/><path d="M14.3 16.25c-.62.36-1.42.57-2.3.57s-1.7-.2-2.32-.58"/><circle cx="14.61" cy="13.39" r=".98"/><circle cx="9.39" cy="13.39" r=".98"/><path d="M16.4 11.38c.26-.55.82-.92 1.47-.92.9.0 1.63.73 1.63 1.63.0.8-.6 1.47-1.38 1.6"/><circle cx="17.22" cy="7.52" r="1.63"/><path d="M7.6 11.38c-.26-.54-.82-.92-1.47-.92-.9.0-1.63.73-1.63 1.63.0.8.6 1.47 1.38 1.6M12 10.12s-.08-4.82 3.6-2.6"/></svg></div>Reddit</div></a><a class=resp-sharing-button__link href="whatsapp://send?text=%22Reclaiming%20Email%20with%20Astroid%22%20seems%20interesting...%20https%3a%2f%2frgoswami.me%2fposts%2freclaim-email-astroid%2f" target=_blank rel=noopener aria-label=WhatsApp><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle xmlns="http://www.w3.org/2000/svg" cx="12" cy="12" r="11.5"/><path stroke-width="1" d="M17.6 6.2c-1.5-1.5-3.4-2.3-5.5-2.3-4.3.0-7.8 3.5-7.8 7.8.0 1.4.4 2.7 1 3.9l-1.1 4 4.1-1.1c1.1.6 2.4.9 3.7.9 4.3.0 7.8-3.5 7.8-7.8.1-2-.7-3.9-2.2-5.4zm-5.5 11.9c-1.2.0-2.3-.3-3.3-.9l-.2-.1-2.4.6.7-2.4-.2-.2c-.6-1-1-2.2-1-3.4.0-3.6 2.9-6.5 6.5-6.5 1.7.0 3.3.7 4.6 1.9 1.2 1.2 1.9 2.8 1.9 4.6-.1 3.5-3 6.4-6.6 6.4zm3.5-4.8c-.2-.1-1.1-.6-1.3-.6-.2-.1-.3-.1-.4.1s-.5.6-.6.8c-.1.1-.2.1-.4.0s-.8-.3-1.6-1c-.6-.5-1-1.2-1.1-1.3-.1-.2.0-.3.1-.4l.3-.3s.1-.2.2-.3c.1-.1.0-.2.0-.3s-.4-1.1-.6-1.4c-.2-.4-.3-.3-.4-.3h-.4s-.3.0-.5.2-.7.7-.7 1.6c0 1 .7 1.9.8 2s1.4 2.1 3.3 2.9c.5.2.8.3 1.1.4.5.1.9.1 1.2.1.4-.1 1.1-.5 1.3-.9.2-.5.2-.8.1-.9.0-.2-.2-.3-.4-.4z"/></svg></div>WhatsApp</div></a></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://rgoswami.me/posts/my-life-in-eink/><span class=button__icon>←</span>
<span class=button__text>My Life in E-ink</span></a></span>
<span class="button next"><a href=https://rgoswami.me/posts/priv-gh-actions/><span class=button__text>Private Github Actions without PAT</span>
<span class=button__icon>→</span></a></span></div></div><div id=comments class=thin><div class=pagination__title><span class=pagination__title-h>Comments</span><hr></div><div id=remarkbox-div><noscript><iframe id=remarkbox-iframe src="https://my.remarkbox.com/embed?nojs=true" style=height:600px;width:100%;border:none!important tabindex=0></iframe></noscript></div><script src=https://my.remarkbox.com/static/js/iframe-resizer/iframeResizer.min.js></script><script>var rb_owner_key="8e660759-e7e6-11ea-9711-040140774501",thread_uri=window.location.href,thread_title=window.document.title,thread_fragment=window.location.hash,rb_src="https://my.remarkbox.com/embed?rb_owner_key="+rb_owner_key+"&thread_title="+encodeURI(thread_title)+"&thread_uri="+encodeURIComponent(thread_uri)+thread_fragment;function create_remarkbox_iframe(){var a=document.createElement("iframe");a.setAttribute("id","remarkbox-iframe"),a.setAttribute("scrolling","no"),a.setAttribute("src",rb_src),a.setAttribute("frameborder","0"),a.setAttribute("tabindex","0"),a.setAttribute("title","Remarkbox"),a.style.width="100%",document.getElementById("remarkbox-div").appendChild(a)}create_remarkbox_iframe(),iFrameResize({checkOrigin:["https://my.remarkbox.com"],inPageLinks:!0,initCallback:function(a){a.iFrameResizer.moveToAnchor(thread_fragment)}},document.getElementById("remarkbox-iframe"))</script></div></main><footer class=footer><p>&copy; 2021
<span><a href=https://rgoswami.me/>Rohit Goswami (HaoZeke)</a></span>
<a href=https://rgoswami.me/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a><br><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a>.
Powered by <a href=http://gohugo.io><u>Hugo</u></a> and <a href=https://github.com/HaoZeke/hugo-theme-hello-friend-ng-hz><u>this theme</u></a>.</br>Hosted with <u><a href=https://www.netlify.com/>Netlify</a></u>.</br><script src=https://liberapay.com/rohit/widgets/button.js></script><noscript><a href=https://liberapay.com/rohit/donate><img alt="Donate using Liberapay" src=https://liberapay.com/assets/widgets/donate.svg></a></noscript></p></footer></div><script src=/bundle.min.5fae9992ea406007408dc33b0b3a8376d61e2f1d6ac50ba1dad7580ac50afb5199bcef3bbc3677e77553a9980bf882cf71edc2f755687dd7725f12ece4304ac2.js></script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-109503488-16','auto'),ga('send','pageview')</script><script type=text/javascript>(function(a,e,b,f,g,c,d){a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},c=e.createElement(f),c.async=1,c.src="https://www.clarity.ms/tag/"+g,d=e.getElementsByTagName(f)[0],d.parentNode.insertBefore(c,d)})(window,document,"clarity","script","3z2xvwqu4u")</script><script data-goatcounter=https://rgoswami.goatcounter.com/count async src=//gc.zgo.at/count.js></script><script>var clicky_site_ids=clicky_site_ids||[];clicky_site_ids.push("101265002")</script><script async src=https://static.getclicky.com/js></script><script src=https://cdn.jsdelivr.net/npm/readmore-js@3.0.0-beta-1/dist/readmore.min.js></script><script src=/js/codefold.min.4a43062cb83308b55227adf937c91be79ff6d95df8bb821dfd71805ce54629ff8cffed3ae81d70fdee5f324fa0f39c5280ae785f165801885db074551a993a21.js></script></body></html>