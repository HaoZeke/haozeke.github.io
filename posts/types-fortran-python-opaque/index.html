<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="[Rohit Goswami]"><meta name=description content="An exploration of the opaque object and pointer interface approach to unleash more modern features than those offered by the ISO Fortran standard.
Background Since this has been covered a few times before, just some quick pointers1. The ultimate context is to be able take nice, modern Fortran code with derived types and generate equally nice, user friendly, efficient Python wrappers via f2py.
Why? Where the last post (and the test implementation in f2py) left off, the type shadowing approach for having exactly interoperable bind(c) derived types (and functions) was covered."><meta name=keywords content="personal,python,fortran,numpy,f2py,ramblings"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://rgoswami.me/posts/types-fortran-python-opaque/><meta name=generator content="Wooframework"><title>Types from Fortran to Python via Opaque Pointers :: Rohit Goswami — Reflections
</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.min.054e30538b054b321af6575a7659f551cec63e1cef6bbd674acccadf856d3aff.css><meta itemprop=name content="Types from Fortran to Python via Opaque Pointers"><meta itemprop=description content="An exploration of the opaque object and pointer interface approach to unleash more modern features than those offered by the ISO Fortran standard.
Background Since this has been covered a few times before, just some quick pointers1. The ultimate context is to be able take nice, modern Fortran code with derived types and generate equally nice, user friendly, efficient Python wrappers via f2py.
Why? Where the last post (and the test implementation in f2py) left off, the type shadowing approach for having exactly interoperable bind(c) derived types (and functions) was covered."><meta itemprop=datePublished content="2023-11-12T23:36:00+00:00"><meta itemprop=dateModified content="2023-11-12T23:36:00+00:00"><meta itemprop=wordCount content="3562"><meta itemprop=image content="https://rgoswami.me/images/RG.png"><meta itemprop=keywords content="python,fortran,numpy,f2py,ramblings,"><meta property="og:title" content="Types from Fortran to Python via Opaque Pointers"><meta property="og:description" content="An exploration of the opaque object and pointer interface approach to unleash more modern features than those offered by the ISO Fortran standard.
Background Since this has been covered a few times before, just some quick pointers1. The ultimate context is to be able take nice, modern Fortran code with derived types and generate equally nice, user friendly, efficient Python wrappers via f2py.
Why? Where the last post (and the test implementation in f2py) left off, the type shadowing approach for having exactly interoperable bind(c) derived types (and functions) was covered."><meta property="og:type" content="article"><meta property="og:url" content="https://rgoswami.me/posts/types-fortran-python-opaque/"><meta property="og:image" content="https://rgoswami.me/images/RG.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-11-12T23:36:00+00:00"><meta property="article:modified_time" content="2023-11-12T23:36:00+00:00"><meta property="og:see_also" content="https://rgoswami.me/posts/fortran-oop-python/"><meta property="og:see_also" content="https://rgoswami.me/posts/iso-c-type-bound-fortran/"><meta property="og:see_also" content="https://rgoswami.me/posts/cython-derivedtype-f2py/"><meta property="og:see_also" content="https://rgoswami.me/posts/numpy-meson-f2py/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rgoswami.me/images/RG.png"><meta name=twitter:title content="Types from Fortran to Python via Opaque Pointers"><meta name=twitter:description content="An exploration of the opaque object and pointer interface approach to unleash more modern features than those offered by the ISO Fortran standard.
Background Since this has been covered a few times before, just some quick pointers1. The ultimate context is to be able take nice, modern Fortran code with derived types and generate equally nice, user friendly, efficient Python wrappers via f2py.
Why? Where the last post (and the test implementation in f2py) left off, the type shadowing approach for having exactly interoperable bind(c) derived types (and functions) was covered."><meta property="article:section" content="notes"><meta property="article:published_time" content="2023-11-12 23:36:00 +0000 UTC"></head><body class=dark-theme><div class=container><header class=header><div class=header__inner><div class=header__left><div class=logo><a href=/ style=text-decoration:none><img src=/images/home.png alt></a></div></div><div class=header__mid><button class=button><div class=button__text><a href=https://rgoswami.me//search>Search</a></div></button></div><div class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about>About</a></li><li><a href=/posts>Blog</a></li><li><a href=/series>Series</a></li></ul><ul class=menu__inner><li><a href=/categories>Categories</a></li><li><a href=/snippets>Snippets</a></li><li><a href=/tags>Tags</a></li></ul></nav><button id=toggleMenu><div class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></div></button>
<button class=theme-toggle id=toggleTheme><svg class="theme-toggler" width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></button></div></div></header><script src=/js/mathjax-config.js></script><script id=MathJax-script async src=https://unpkg.com/mathjax@3/es5/tex-chtml.js></script><aside class=sidebar><div class=hideTOC><button id=tocTog>TOC</button><div class="sideTOC m-fadeOut"><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#why>Why?</a></li><li><a href=#scope>Scope</a></li></ul></li><li><a href=#approaches-to-an-automated-method>Approaches to an automated method</a></li><li><a href=#point-with-pointers><code>point</code> with pointers</a><ul><li><a href=#fortran-baseline>Fortran baseline</a></li><li><a href=#c-wrappers><code>C</code>-Wrappers</a></li><li><a href=#python-c-interface>Python-C Interface</a></li></ul></li><li><a href=#binding-type-bound-proceedures>Binding type bound proceedures</a></li><li><a href=#towards-allocatable-components-and-f2py-support>Towards allocatable components and <code>f2py</code> support</a></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#references>References</a></li></ul></nav></div></div></aside><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>17 minutes<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Written: 2023-11-12 23:36 +0000</p></p></div><article class=h-entry><h1 class="post-title p-name"><a class=u-url href=https://rgoswami.me/posts/types-fortran-python-opaque/>Types from Fortran to Python via Opaque Pointers</a></h1><div class=post-info><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pen-tool"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg><span class="author u-author p-author"><a href=/author/rohit-goswami>Rohit Goswami</a></span></div><hr><aside id=toc class=sidebar><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#why>Why?</a></li><li><a href=#scope>Scope</a></li></ul></li><li><a href=#approaches-to-an-automated-method>Approaches to an automated method</a></li><li><a href=#point-with-pointers><code>point</code> with pointers</a><ul><li><a href=#fortran-baseline>Fortran baseline</a></li><li><a href=#c-wrappers><code>C</code>-Wrappers</a></li><li><a href=#python-c-interface>Python-C Interface</a></li></ul></li><li><a href=#binding-type-bound-proceedures>Binding type bound proceedures</a></li><li><a href=#towards-allocatable-components-and-f2py-support>Towards allocatable components and <code>f2py</code> support</a></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#references>References</a></li></ul></nav></aside><hr><div class="post-content e-content"><div class="notice--info post-series-top"><p>This post is part of the <a href=https://rgoswami.me/series/bridging-fortran-python/>Bridging Fortran & Python</a> series.</p></div><blockquote><p>An exploration of the opaque object and pointer interface approach to
unleash more modern features than those offered by the ISO Fortran
standard.</p></blockquote><h2 id=background>Background</h2><p>Since this has been covered a few times before, just some quick
pointers<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. The ultimate context is to be able take nice, modern
Fortran code with derived types and generate equally nice, user
friendly, efficient Python wrappers via <code>f2py</code>.</p><h3 id=why>Why?</h3><p>Where the last post (and <a href=https://github.com/numpy/numpy/pull/20770>the test
implementation</a> in <code>f2py</code>)
left off, the type shadowing approach for having exactly interoperable
<code>bind(c)</code> derived types (and
<a href=https://github.com/numpy/numpy/pull/24555>functions</a>) was covered.
However, there are several aspects of derived types which cannot be
covered (&ldquo;deep&rdquo; types in the nomenclature of Pletzer et al.
(<a href=#ref-pletzerExposingFortranDerived2008>2008</a>)). A brief list:</p><ul><li>Types with allocatable members</li><li>Types with other types as members</li><li>Types which have bound proceedures</li><li>Pointer elements</li><li>Child types, in an inheritance hierarchy</li></ul><p>Of these, the first three are probably the most common use cases, which
need to be addressed by any serious attempt to bride Fortran and Python.</p><h3 id=scope>Scope</h3><p>This post is just going to cover the development of Python examples
facilitated by the pointer implementation where:</p><ul><li>A simple derived type, <code>point</code>, is manipulated via pointers</li></ul><p>We will first demonstrate a Fortran example, followed by its call from
<code>C</code>, before demonstrating its bridging <code>Python-C</code> code and finally a
user-facing <code>python</code> example. The full code may be found in the examples
folder and pull requests
<a href=https://github.com/HaoZeke/f2py_derived_nep>here</a>. Typically the
snippets here will have elided error handling to drive home the approach
over the boilerplate / best practices <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>.</p><h2 id=approaches-to-an-automated-method>Approaches to an automated method</h2><p>The main idea here is a separation of concerns at three levels:</p><ul><li>Fortran code handles its own memory / functionality<ul><li>Wrappers are exposed at two levels:<ul><li>One layer to provide pointer &ldquo;handles&rdquo; to each part of the
type.</li><li>Another outer layer connecting to <code>bind(c)</code> proceedures.</li></ul></li></ul></li><li><code>C</code> bindings call the <code>bind(c)</code> proceedures and pass handles (opaque
pointers) as <code>void*</code>.</li><li>At the <code>python</code> level, these are stored in <code>PyCapsule</code> instances,
and exposed to the user as a standard Python class.</li></ul><p>The <code>bind(c)</code> proceedures are meant to separate the implementation from
the <code>C</code>-interface in a manner which can be automated (eventually) by
<code>f2py</code>. Similarly, the <code>Python-C</code> code is eventually to be generated as
well.</p><h2 id=point-with-pointers><code>point</code> with pointers</h2><p>We will start with the prototypical class in applications, a <code>point</code>,
with 2 dimensions.</p><h3 id=fortran-baseline>Fortran baseline</h3><p>The <code>type</code> we want is very minimal:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln>1</span><span class=cl><span class=k>type</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>Point</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>   </span><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>   </span><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=n>Point</span><span class=w>
</span></span></span></code></pre></div><p>However, since we need to use this via pointers, we need a more involved
set of helpers for this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln>1</span><span class=cl><span class=k>subroutine</span><span class=w> </span><span class=n>create_point</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>   </span><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>   </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>pointer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>   </span><span class=k>allocate</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>   </span><span class=n>p</span><span class=p>%</span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w>   </span><span class=n>p</span><span class=p>%</span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>create_point</span><span class=w>
</span></span></span></code></pre></div><p>There isn&rsquo;t much to say about these, and they are rather mechanically
derived.</p><h4 id=building-and-testing>Building and testing</h4><p>For the toy point we have:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln> 1</span><span class=cl><span class=k>module</span><span class=w> </span><span class=n>point_module</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>   </span><span class=k>implicit</span><span class=w> </span><span class=k>none</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>   </span><span class=k>type</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>Point</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>      </span><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>      </span><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=n>Point</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=k>contains</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>   </span><span class=k>subroutine</span><span class=w> </span><span class=n>create_point</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>alloc_stat</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>      </span><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>pointer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>      </span><span class=k>integer</span><span class=p>,</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>out</span><span class=p>),</span><span class=w> </span><span class=k>optional</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>alloc_stat</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>      </span><span class=k>allocate</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=nb>stat</span><span class=o>=</span><span class=n>alloc_stat</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nb>present</span><span class=p>(</span><span class=n>alloc_stat</span><span class=p>)</span><span class=w> </span><span class=p>.</span><span class=nb>and</span><span class=p>.</span><span class=w> </span><span class=n>alloc_stat</span><span class=w> </span><span class=o>/=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>then</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>         </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>      </span><span class=k>end</span><span class=w> </span><span class=k>if</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>      </span><span class=n>p</span><span class=p>%</span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>      </span><span class=n>p</span><span class=p>%</span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>create_point</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>   </span><span class=k>subroutine</span><span class=w> </span><span class=n>destroy_point</span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>pointer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nb>associated</span><span class=p>(</span><span class=n>p</span><span class=p>))</span><span class=w> </span><span class=k>then</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>         </span><span class=k>deallocate</span><span class=w> </span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>         </span><span class=n>p</span><span class=w> </span><span class=o>=&gt;</span><span class=w> </span><span class=nb>null</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>      </span><span class=k>end</span><span class=w> </span><span class=k>if</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>destroy_point</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>   </span><span class=k>function</span><span class=w> </span><span class=n>get_x</span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=w> </span><span class=k>result</span><span class=p>(</span><span class=n>x_value</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>      </span><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x_value</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>      </span><span class=n>x_value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>%</span><span class=n>x</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>function</span><span class=w> </span><span class=n>get_x</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>   </span><span class=k>subroutine</span><span class=w> </span><span class=n>set_x</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>inout</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>      </span><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=w>
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=w>      </span><span class=n>p</span><span class=p>%</span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=w>
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>set_x</span><span class=w>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=w>   </span><span class=k>function</span><span class=w> </span><span class=n>get_y</span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=w> </span><span class=k>result</span><span class=p>(</span><span class=n>y_value</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=w>      </span><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>y_value</span><span class=w>
</span></span></span><span class=line><span class=ln>43</span><span class=cl><span class=w>      </span><span class=n>y_value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p</span><span class=p>%</span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln>44</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>function</span><span class=w> </span><span class=n>get_y</span><span class=w>
</span></span></span><span class=line><span class=ln>45</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>46</span><span class=cl><span class=w>   </span><span class=k>subroutine</span><span class=w> </span><span class=n>set_y</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>47</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>inout</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln>48</span><span class=cl><span class=w>      </span><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln>49</span><span class=cl><span class=w>      </span><span class=n>p</span><span class=p>%</span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln>50</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>set_y</span><span class=w>
</span></span></span><span class=line><span class=ln>51</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>module</span><span class=w> </span><span class=n>point_module</span><span class=w>
</span></span></span></code></pre></div><p>Now these can be tested from a simple driver:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln> 1</span><span class=cl><span class=k>program</span><span class=w> </span><span class=n>test_point_module</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>   </span><span class=k>use</span><span class=w> </span><span class=n>point_module</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w>   </span><span class=k>implicit</span><span class=w> </span><span class=k>none</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>   </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>pointer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>pt</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>   </span><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x_val</span><span class=p>,</span><span class=w> </span><span class=n>y_val</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>   </span><span class=k>integer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>alloc_status</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>   </span><span class=c>! Test creating a new point
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=c></span><span class=w>   </span><span class=k>call</span><span class=w> </span><span class=n>create_point</span><span class=p>(</span><span class=mf>1.0d0</span><span class=p>,</span><span class=w> </span><span class=mf>2.0d0</span><span class=p>,</span><span class=w> </span><span class=n>pt</span><span class=p>,</span><span class=w> </span><span class=n>alloc_status</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(.</span><span class=nb>not</span><span class=p>.</span><span class=w> </span><span class=nb>associated</span><span class=p>(</span><span class=n>pt</span><span class=p>))</span><span class=w> </span><span class=k>then</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>      </span><span class=k>print</span><span class=w> </span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Point creation failed with status &#34;</span><span class=p>,</span><span class=w> </span><span class=n>alloc_status</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>      </span><span class=k>stop</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>   </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>      </span><span class=k>print</span><span class=w> </span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Point created: (&#34;</span><span class=p>,</span><span class=w> </span><span class=n>pt</span><span class=p>%</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;, &#34;</span><span class=p>,</span><span class=w> </span><span class=n>pt</span><span class=p>%</span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;)&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>if</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>   </span><span class=c>! Test setters and getters
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=c></span><span class=w>   </span><span class=k>call</span><span class=w> </span><span class=n>set_x</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=w> </span><span class=mf>5.0d0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>   </span><span class=k>call</span><span class=w> </span><span class=n>set_y</span><span class=p>(</span><span class=n>pt</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=mf>0.0d0</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>   </span><span class=n>x_val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_x</span><span class=p>(</span><span class=n>pt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>   </span><span class=n>y_val</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_y</span><span class=p>(</span><span class=n>pt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>   </span><span class=k>print</span><span class=w> </span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;After setting new values:&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>   </span><span class=k>print</span><span class=w> </span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;x =&#34;</span><span class=p>,</span><span class=w> </span><span class=n>x_val</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;y =&#34;</span><span class=p>,</span><span class=w> </span><span class=n>y_val</span><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>x_val</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mf>5.0d0</span><span class=w> </span><span class=p>.</span><span class=nb>and</span><span class=p>.</span><span class=w> </span><span class=n>y_val</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=mi>1</span><span class=mf>0.0d0</span><span class=p>)</span><span class=w> </span><span class=k>then</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>      </span><span class=k>print</span><span class=w> </span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Point values updated correctly.&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>   </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>      </span><span class=k>print</span><span class=w> </span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Error in updating point values.&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>if</span><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>   </span><span class=c>! Test destruction
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=c></span><span class=w>   </span><span class=k>call</span><span class=w> </span><span class=n>destroy_point</span><span class=p>(</span><span class=n>pt</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(.</span><span class=nb>not</span><span class=p>.</span><span class=w> </span><span class=nb>associated</span><span class=p>(</span><span class=n>pt</span><span class=p>))</span><span class=w> </span><span class=k>then</span><span class=w>
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=w>      </span><span class=k>print</span><span class=w> </span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Point destroyed successfully.&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=w>   </span><span class=k>else</span><span class=w>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=w>      </span><span class=k>print</span><span class=w> </span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Error in destroying point.&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>if</span><span class=w>
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>program</span><span class=w> </span><span class=n>test_point_module</span><span class=w>
</span></span></span></code></pre></div><p>Personally I use <code>meson</code> for everything, but this is trivially compiled
anyway:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>❯ gfortran point.f90 ftest.f90
</span></span><span class=line><span class=ln>2</span><span class=cl>❯ ./a.out
</span></span><span class=line><span class=ln>3</span><span class=cl> Point created: <span class=o>(</span>   1.0000000000000000      ,    2.0000000000000000      <span class=o>)</span>
</span></span><span class=line><span class=ln>4</span><span class=cl> After setting new values:
</span></span><span class=line><span class=ln>5</span><span class=cl> <span class=nv>x</span> <span class=o>=</span>   5.0000000000000000      <span class=nv>y</span> <span class=o>=</span>   10.000000000000000
</span></span><span class=line><span class=ln>6</span><span class=cl> Point values updated correctly.
</span></span><span class=line><span class=ln>7</span><span class=cl> Point destroyed successfully.
</span></span></code></pre></div><p>Just to build on for when it gets less trivial, the <code>meson</code> equivalent
is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-meson data-lang=meson><span class=line><span class=ln>1</span><span class=cl><span class=nb>project</span><span class=p>(</span><span class=s>&#39;pyclass_bindc&#39;</span><span class=p>,</span><span class=w> </span><span class=s>&#39;c&#39;</span><span class=p>,</span><span class=w> </span><span class=s>&#39;fortran&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>        </span><span class=n>version</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=s>&#39;0.1&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>        </span><span class=n>default_options</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=p>[</span><span class=s>&#39;warning_level=2&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>                           </span><span class=s>&#39;buildtype=debug&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>                           </span><span class=s>&#39;debug=true&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w>                          </span><span class=p>])</span><span class=w>
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=w></span><span class=nb>executable</span><span class=p>(</span><span class=s>&#39;ftest&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=w>           </span><span class=s>&#39;ftest.f90&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>9</span><span class=cl><span class=w>           </span><span class=s>&#39;point.f90&#39;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>Which can be used with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>meson setup bbdir
</span></span><span class=line><span class=ln>2</span><span class=cl>meson compile -C bbdir
</span></span><span class=line><span class=ln>3</span><span class=cl>❯ ./bbdir/ftest
</span></span><span class=line><span class=ln>4</span><span class=cl> Point created: <span class=o>(</span>   1.0000000000000000      ,    2.0000000000000000      <span class=o>)</span>
</span></span><span class=line><span class=ln>5</span><span class=cl> After setting new values:
</span></span><span class=line><span class=ln>6</span><span class=cl> <span class=nv>x</span> <span class=o>=</span>   5.0000000000000000      <span class=nv>y</span> <span class=o>=</span>   10.000000000000000
</span></span><span class=line><span class=ln>7</span><span class=cl> Point values updated correctly.
</span></span><span class=line><span class=ln>8</span><span class=cl> Point destroyed successfully.
</span></span></code></pre></div><h3 id=c-wrappers><code>C</code>-Wrappers</h3><p>Lets focus a bit on what we need to do, creation and destruction are
fairly straightforward since we just need to remember to return a
<code>c_ptr</code> and create interface it to our existing functions..</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln> 1</span><span class=cl><span class=k>function</span><span class=w> </span><span class=n>c_new_point</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=k>result</span><span class=p>(</span><span class=n>cnewpt</span><span class=p>)</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w>   </span><span class=k>real</span><span class=p>(</span><span class=k>c_double</span><span class=p>),</span><span class=w> </span><span class=k>value</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=c>!! important
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=c></span><span class=w>   </span><span class=k>type</span><span class=p>(</span><span class=k>c_ptr</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>cnewpt</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>   </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>pointer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>   </span><span class=k>integer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=nb>stat</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>   </span><span class=k>call</span><span class=w> </span><span class=n>create_point</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=nb>stat</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>   </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nb>stat</span><span class=w> </span><span class=o>/=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>then</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>      </span><span class=k>print</span><span class=w> </span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Allocation failed&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>      </span><span class=n>cnewpt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>C_NULL_PTR</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>      </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>if</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>   </span><span class=n>cnewpt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>c_loc</span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>function</span><span class=w> </span><span class=n>c_new_point</span><span class=w>
</span></span></span></code></pre></div><p>Note the use of the <code>c_loc</code> intrinsic which is used to get a pointer
compatible with <code>C</code> as required by the return type too. For bindings, it
is never a good idea to neglect error handling, so we do guard for
allocation failures, using the NULL helper in the <code>iso_c</code> intrinsic. The
<code>value</code> attribute is important enough (and a recurring theme) so it is
relegated to the box.</p><div class="warning-alert alert"><div class=alert-heading><p><strong>Warning</strong></p></div><p>The <code>value</code> attribute is <strong>required</strong> in the to ensure data is copied
and interpreted correctly from <code>C</code> to Fortran.</p></div><p>Similar considerations apply to the rest of the bindings, the full
source of which is reproduced at the end of this section.</p><p>To call these from <code>C</code> we need to remember that we want to grab a
pointer to a pointer, that is, the signatures will be <code>void**</code>. So we
have:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=k>extern</span> <span class=kt>void</span> <span class=o>*</span><span class=nf>c_new_point</span><span class=p>(</span><span class=kt>double</span> <span class=n>x</span><span class=p>,</span> <span class=kt>double</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=k>extern</span> <span class=kt>void</span> <span class=nf>c_delete_point</span><span class=p>(</span><span class=kt>void</span> <span class=o>**</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=k>extern</span> <span class=kt>double</span> <span class=nf>c_get_x</span><span class=p>(</span><span class=kt>void</span> <span class=o>**</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=k>extern</span> <span class=kt>void</span> <span class=nf>c_set_x</span><span class=p>(</span><span class=kt>void</span> <span class=o>**</span><span class=n>p</span><span class=p>,</span> <span class=kt>double</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=k>extern</span> <span class=kt>double</span> <span class=nf>c_get_y</span><span class=p>(</span><span class=kt>void</span> <span class=o>**</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=k>extern</span> <span class=kt>void</span> <span class=nf>c_set_y</span><span class=p>(</span><span class=kt>void</span> <span class=o>**</span><span class=n>p</span><span class=p>,</span> <span class=kt>double</span> <span class=n>y</span><span class=p>);</span>
</span></span></code></pre></div><p><code>bind(C)</code> is on the Fortran side is used to ensure no name mangling.</p><h4 id=building-and-testing>Building and testing</h4><p>The additional wrapper file is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln> 1</span><span class=cl><span class=c>! cwrappers.f90
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=c>! C interoperable wrappers
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=c></span><span class=k>module</span><span class=w> </span><span class=n>c_wrappers</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w>   </span><span class=k>use</span><span class=p>,</span><span class=w> </span><span class=k>intrinsic</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=nb>iso_c_binding</span><span class=p>,</span><span class=w> </span><span class=k>only</span><span class=p>:</span><span class=w> </span><span class=k>c_ptr</span><span class=p>,</span><span class=w> </span><span class=k>c_double</span><span class=p>,</span><span class=w> </span><span class=nb>c_null_ptr</span><span class=p>,</span><span class=w> </span><span class=p>&amp;</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w>                                                                             </span><span class=nb>c_loc</span><span class=p>,</span><span class=w> </span><span class=nb>c_associated</span><span class=p>,</span><span class=w> </span><span class=nb>c_f_pointer</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>   </span><span class=k>use</span><span class=w> </span><span class=n>point_module</span><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w>   </span><span class=k>implicit</span><span class=w> </span><span class=k>none</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w></span><span class=k>contains</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>   </span><span class=c>! Wrapper for creating a new point
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=c></span><span class=w>   </span><span class=k>function</span><span class=w> </span><span class=n>c_new_point</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=k>result</span><span class=p>(</span><span class=n>cnewpt</span><span class=p>)</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>      </span><span class=k>real</span><span class=p>(</span><span class=k>c_double</span><span class=p>),</span><span class=w> </span><span class=k>value</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=k>c_ptr</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>cnewpt</span><span class=w>
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>pointer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=w>      </span><span class=k>integer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=nb>stat</span><span class=w>
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=w>      </span><span class=k>call</span><span class=w> </span><span class=n>create_point</span><span class=p>(</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=nb>stat</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=nb>stat</span><span class=w> </span><span class=o>/=</span><span class=w> </span><span class=mi>0</span><span class=p>)</span><span class=w> </span><span class=k>then</span><span class=w>
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=w>         </span><span class=k>print</span><span class=w> </span><span class=o>*</span><span class=p>,</span><span class=w> </span><span class=s2>&#34;Allocation failed&#34;</span><span class=w>
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=w>         </span><span class=n>cnewpt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>C_NULL_PTR</span><span class=w>
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=w>         </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=w>      </span><span class=k>end</span><span class=w> </span><span class=k>if</span><span class=w>
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=w>      </span><span class=n>cnewpt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>c_loc</span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>25</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>function</span><span class=w> </span><span class=n>c_new_point</span><span class=w>
</span></span></span><span class=line><span class=ln>26</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=w>   </span><span class=c>! Wrapper to set the x value of a point
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=c></span><span class=w>   </span><span class=k>subroutine</span><span class=w> </span><span class=n>c_set_x</span><span class=p>(</span><span class=n>p_cptr</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=k>c_ptr</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p_cptr</span><span class=w>
</span></span></span><span class=line><span class=ln>30</span><span class=cl><span class=w>      </span><span class=k>real</span><span class=p>(</span><span class=k>c_double</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>),</span><span class=w> </span><span class=k>value</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=w>
</span></span></span><span class=line><span class=ln>31</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>pointer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln>32</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=w>      </span><span class=k>call</span><span class=w> </span><span class=nb>c_f_pointer</span><span class=p>(</span><span class=n>p_cptr</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=w>      </span><span class=k>call</span><span class=w> </span><span class=n>set_x</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>c_set_x</span><span class=w>
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=w>   </span><span class=c>! Wrapper to get the x value of a point
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=c></span><span class=w>   </span><span class=k>function</span><span class=w> </span><span class=n>c_get_x</span><span class=p>(</span><span class=n>p_cptr</span><span class=p>)</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=k>result</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=k>c_ptr</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p_cptr</span><span class=w>
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=w>      </span><span class=k>real</span><span class=p>(</span><span class=k>c_double</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=w>
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>pointer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>43</span><span class=cl><span class=w>      </span><span class=k>call</span><span class=w> </span><span class=nb>c_f_pointer</span><span class=p>(</span><span class=n>p_cptr</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>44</span><span class=cl><span class=w>      </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_x</span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>45</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>function</span><span class=w> </span><span class=n>c_get_x</span><span class=w>
</span></span></span><span class=line><span class=ln>46</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>47</span><span class=cl><span class=w>   </span><span class=c>! Wrapper to set the y value of a point
</span></span></span><span class=line><span class=ln>48</span><span class=cl><span class=c></span><span class=w>   </span><span class=k>subroutine</span><span class=w> </span><span class=n>c_set_y</span><span class=p>(</span><span class=n>p_cptr</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;c_set_y&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>49</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=k>c_ptr</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p_cptr</span><span class=w>
</span></span></span><span class=line><span class=ln>50</span><span class=cl><span class=w>      </span><span class=k>real</span><span class=p>(</span><span class=k>c_double</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>),</span><span class=w> </span><span class=k>value</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln>51</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>pointer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln>52</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>53</span><span class=cl><span class=w>      </span><span class=k>call</span><span class=w> </span><span class=nb>c_f_pointer</span><span class=p>(</span><span class=n>p_cptr</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>54</span><span class=cl><span class=w>      </span><span class=k>call</span><span class=w> </span><span class=n>set_y</span><span class=p>(</span><span class=n>p</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>55</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>c_set_y</span><span class=w>
</span></span></span><span class=line><span class=ln>56</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>57</span><span class=cl><span class=w>   </span><span class=c>! Wrapper to get the y value of a point
</span></span></span><span class=line><span class=ln>58</span><span class=cl><span class=c></span><span class=w>   </span><span class=k>function</span><span class=w> </span><span class=n>c_get_y</span><span class=p>(</span><span class=n>p_cptr</span><span class=p>)</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;c_get_y&#39;</span><span class=p>)</span><span class=w> </span><span class=k>result</span><span class=p>(</span><span class=n>y</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>59</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=k>c_ptr</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p_cptr</span><span class=w>
</span></span></span><span class=line><span class=ln>60</span><span class=cl><span class=w>      </span><span class=k>real</span><span class=p>(</span><span class=k>c_double</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln>61</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>pointer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln>62</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>63</span><span class=cl><span class=w>      </span><span class=k>call</span><span class=w> </span><span class=nb>c_f_pointer</span><span class=p>(</span><span class=n>p_cptr</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>64</span><span class=cl><span class=w>      </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>get_y</span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>65</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>function</span><span class=w> </span><span class=n>c_get_y</span><span class=w>
</span></span></span><span class=line><span class=ln>66</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>67</span><span class=cl><span class=w>   </span><span class=c>! Wrapper for deallocating a point
</span></span></span><span class=line><span class=ln>68</span><span class=cl><span class=c></span><span class=w>   </span><span class=k>subroutine</span><span class=w> </span><span class=n>c_delete_point</span><span class=p>(</span><span class=n>p_cptr</span><span class=p>)</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=w> </span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;c_delete_point&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>69</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=k>c_ptr</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>inout</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p_cptr</span><span class=w>
</span></span></span><span class=line><span class=ln>70</span><span class=cl><span class=w>      </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>pointer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p</span><span class=w>
</span></span></span><span class=line><span class=ln>71</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>72</span><span class=cl><span class=w>      </span><span class=k>if</span><span class=w> </span><span class=p>(.</span><span class=nb>not</span><span class=p>.</span><span class=w> </span><span class=nb>c_associated</span><span class=p>(</span><span class=n>p_cptr</span><span class=p>))</span><span class=w> </span><span class=k>return</span><span class=w>
</span></span></span><span class=line><span class=ln>73</span><span class=cl><span class=w>      </span><span class=k>call</span><span class=w> </span><span class=nb>c_f_pointer</span><span class=p>(</span><span class=n>p_cptr</span><span class=p>,</span><span class=w> </span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>74</span><span class=cl><span class=w>      </span><span class=k>call</span><span class=w> </span><span class=n>destroy_point</span><span class=p>(</span><span class=n>p</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>75</span><span class=cl><span class=w>      </span><span class=n>p_cptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>c_null_ptr</span><span class=w>
</span></span></span><span class=line><span class=ln>76</span><span class=cl><span class=w>   </span><span class=k>end</span><span class=w> </span><span class=k>subroutine</span><span class=w> </span><span class=n>c_delete_point</span><span class=w>
</span></span></span><span class=line><span class=ln>77</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln>78</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>module</span><span class=w> </span><span class=n>c_wrappers</span><span class=w>
</span></span></span></code></pre></div><p>With the corresponding <code>C</code> file to test:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln> 1</span><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=cp></span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=cm>/* Declarations of Fortran functions */</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=k>extern</span> <span class=kt>void</span> <span class=o>*</span><span class=nf>c_new_point</span><span class=p>(</span><span class=kt>double</span> <span class=n>x</span><span class=p>,</span> <span class=kt>double</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=k>extern</span> <span class=kt>void</span> <span class=nf>c_delete_point</span><span class=p>(</span><span class=kt>void</span> <span class=o>**</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=k>extern</span> <span class=kt>double</span> <span class=nf>c_get_x</span><span class=p>(</span><span class=kt>void</span> <span class=o>**</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=k>extern</span> <span class=kt>void</span> <span class=nf>c_set_x</span><span class=p>(</span><span class=kt>void</span> <span class=o>**</span><span class=n>p</span><span class=p>,</span> <span class=kt>double</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=k>extern</span> <span class=kt>double</span> <span class=nf>c_get_y</span><span class=p>(</span><span class=kt>void</span> <span class=o>**</span><span class=n>p</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=k>extern</span> <span class=kt>void</span> <span class=nf>c_set_y</span><span class=p>(</span><span class=kt>void</span> <span class=o>**</span><span class=n>p</span><span class=p>,</span> <span class=kt>double</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=kt>int</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>point</span> <span class=o>=</span> <span class=nf>c_new_point</span><span class=p>(</span><span class=mf>3.0</span><span class=p>,</span> <span class=mf>4.0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>point</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=nf>fprintf</span><span class=p>(</span><span class=n>stderr</span><span class=p>,</span> <span class=s>&#34;Failed to create point</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=k>return</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>  <span class=cm>/* Retrieve the x and y values using the Fortran function */</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>  <span class=kt>double</span> <span class=n>x</span> <span class=o>=</span> <span class=nf>c_get_x</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>);</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>  <span class=kt>double</span> <span class=n>y</span> <span class=o>=</span> <span class=nf>c_get_y</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>);</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>
</span></span><span class=line><span class=ln>21</span><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Point coordinates: x = %f, y = %f</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>
</span></span><span class=line><span class=ln>23</span><span class=cl>  <span class=cm>/* Set the x and y values using the Fortran function */</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>  <span class=nf>c_set_x</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>,</span> <span class=mf>5.0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>  <span class=nf>c_set_y</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>,</span> <span class=mf>6.0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>
</span></span><span class=line><span class=ln>27</span><span class=cl>  <span class=nf>printf</span><span class=p>(</span><span class=s>&#34;Point coordinates after set: x = %f, y = %f</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>,</span> <span class=nf>c_get_x</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>),</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>         <span class=nf>c_get_y</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>));</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>
</span></span><span class=line><span class=ln>30</span><span class=cl>  <span class=cm>/* Clean up and delete the point using the Fortran function */</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>  <span class=nf>c_delete_point</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>);</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>
</span></span><span class=line><span class=ln>33</span><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>34</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Which can be compiled and run with the following addition to the
existing <code>meson.build</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>executable<span class=o>(</span><span class=s1>&#39;ctestf&#39;</span>,
</span></span><span class=line><span class=ln>2</span><span class=cl>           <span class=s1>&#39;testc.c&#39;</span>,
</span></span><span class=line><span class=ln>3</span><span class=cl>           <span class=s1>&#39;point.f90&#39;</span>,
</span></span><span class=line><span class=ln>4</span><span class=cl>           <span class=s1>&#39;cwrappers.f90&#39;</span><span class=o>)</span>
</span></span></code></pre></div><p>With:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>meson compile -C bbdir
</span></span><span class=line><span class=ln>2</span><span class=cl>./bbdir/ctestf
</span></span><span class=line><span class=ln>3</span><span class=cl>Point coordinates: <span class=nv>x</span> <span class=o>=</span> 3.000000, <span class=nv>y</span> <span class=o>=</span> 4.000000
</span></span><span class=line><span class=ln>4</span><span class=cl>Point coordinates after set: <span class=nv>x</span> <span class=o>=</span> 5.000000, <span class=nv>y</span> <span class=o>=</span> 6.000000
</span></span></code></pre></div><h3 id=python-c-interface>Python-C Interface</h3><p>The key take-away here is to use a
<a href=https://docs.python.org/3/c-api/capsule.html>PyCapsule</a> object which:</p><blockquote><p>represents an opaque value, useful for C extension modules who need to
pass an opaque value (as a void* pointer) through Python code to
other C code.</p></blockquote><p>In our case the opaque value needs to travel a bit further along and go
through to Fortran and back, but the principle (and implementation) is
the same. The <code>C</code> function calls will be the same, the only difference
being the structure used, unlike in &ldquo;shadowing&rdquo; approaches, the <code>struct</code>
will have neither <code>C</code> interop nor <code>Fortran</code> information. So we start
with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=cm>/* Point object definition */</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>  <span class=n>PyObject_HEAD</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>  <span class=n>PyObject</span> <span class=o>*</span><span class=n>capsule</span><span class=p>;</span>
</span></span><span class=line><span class=ln>5</span><span class=cl><span class=p>}</span> <span class=n>PyPointObject</span><span class=p>;</span>
</span></span></code></pre></div><p>This is simplicity itself. Naturally we need to actually grab the right
object from the capsule before use. Additionally, there are a few
nuances, e.g. before defining creation we need to define cleanup:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=kt>void</span> <span class=nf>point_capsule_destructor</span><span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=n>capsule</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>point</span> <span class=o>=</span> <span class=nf>PyCapsule_GetPointer</span><span class=p>(</span><span class=n>capsule</span><span class=p>,</span> <span class=s>&#34;point._Point&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>point</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>    <span class=nf>c_delete_point</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>);</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Creation is simply via <code>PyCapsule_New</code> once appropriate steps
(unpacking, error handling) are taken.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln> 1</span><span class=cl><span class=k>static</span> <span class=n>PyObject</span> <span class=o>*</span><span class=nf>PyPoint_new</span><span class=p>(</span><span class=n>PyTypeObject</span> <span class=o>*</span><span class=n>type</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>                             <span class=n>PyObject</span> <span class=o>*</span><span class=n>kwds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=kt>double</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>PyArg_ParseTuple</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=s>&#34;dd&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>x</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>y</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl>  <span class=n>PyPointObject</span> <span class=o>*</span><span class=n>self</span> <span class=o>=</span> <span class=p>(</span><span class=n>PyPointObject</span> <span class=o>*</span><span class=p>)</span><span class=n>type</span><span class=o>-&gt;</span><span class=nf>tp_alloc</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>self</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>point</span> <span class=o>=</span> <span class=nf>c_new_point</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>point</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>      <span class=nf>Py_DECREF</span><span class=p>(</span><span class=n>self</span><span class=p>);</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>      <span class=k>return</span> <span class=nf>PyErr_NoMemory</span><span class=p>();</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=n>self</span><span class=o>-&gt;</span><span class=n>capsule</span> <span class=o>=</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>        <span class=nf>PyCapsule_New</span><span class=p>(</span><span class=n>point</span><span class=p>,</span> <span class=s>&#34;point._Point&#34;</span><span class=p>,</span> <span class=n>point_capsule_destructor</span><span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>capsule</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>      <span class=nf>c_delete_point</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>);</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>      <span class=nf>Py_DECREF</span><span class=p>(</span><span class=n>self</span><span class=p>);</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>      <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=p>)</span><span class=n>self</span><span class=p>;</span>
</span></span><span class=line><span class=ln>24</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Since the rest of this is standard, including <code>PyFloat_FromDouble</code> and
the rest of the C-Python API, we will move onto the building and testing
phase.</p><h4 id=building-and-testing>Building and testing</h4><p>The full file, including boilerplate defining the module (detailed in
earlier posts) is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>  1</span><span class=cl><span class=cp>#ifndef PY_SSIZE_T_CLEAN
</span></span></span><span class=line><span class=ln>  2</span><span class=cl><span class=cp>#define PY_SSIZE_T_CLEAN
</span></span></span><span class=line><span class=ln>  3</span><span class=cl><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span></span></span><span class=line><span class=ln>  4</span><span class=cl><span class=cp>#endif </span><span class=cm>/* PY_SSIZE_T_CLEAN */</span><span class=cp>
</span></span></span><span class=line><span class=ln>  5</span><span class=cl><span class=cp></span>
</span></span><span class=line><span class=ln>  6</span><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;Python.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=ln>  7</span><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;point.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=ln>  8</span><span class=cl><span class=cp>#include</span> <span class=cpf>&#34;structmember.h&#34;</span><span class=cp>
</span></span></span><span class=line><span class=ln>  9</span><span class=cl><span class=cp></span>
</span></span><span class=line><span class=ln> 10</span><span class=cl><span class=kt>void</span> <span class=nf>point_capsule_destructor</span><span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=n>capsule</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 11</span><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>point</span> <span class=o>=</span> <span class=nf>PyCapsule_GetPointer</span><span class=p>(</span><span class=n>capsule</span><span class=p>,</span> <span class=s>&#34;point._Point&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 12</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>point</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 13</span><span class=cl>    <span class=nf>c_delete_point</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 14</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 15</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 16</span><span class=cl>
</span></span><span class=line><span class=ln> 17</span><span class=cl><span class=cm>/* Point object definition */</span>
</span></span><span class=line><span class=ln> 18</span><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 19</span><span class=cl>  <span class=n>PyObject_HEAD</span>
</span></span><span class=line><span class=ln> 20</span><span class=cl>  <span class=n>PyObject</span> <span class=o>*</span><span class=n>capsule</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 21</span><span class=cl><span class=p>}</span> <span class=n>PyPointObject</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 22</span><span class=cl>
</span></span><span class=line><span class=ln> 23</span><span class=cl><span class=cm>/* Deallocates the PyPointObject */</span>
</span></span><span class=line><span class=ln> 24</span><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>PyPoint_dealloc</span><span class=p>(</span><span class=n>PyPointObject</span> <span class=o>*</span><span class=n>self</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 25</span><span class=cl>  <span class=nf>Py_XDECREF</span><span class=p>(</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>capsule</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 26</span><span class=cl>  <span class=nf>Py_TYPE</span><span class=p>(</span><span class=n>self</span><span class=p>)</span><span class=o>-&gt;</span><span class=nf>tp_free</span><span class=p>((</span><span class=n>PyObject</span> <span class=o>*</span><span class=p>)</span><span class=n>self</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 27</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 28</span><span class=cl>
</span></span><span class=line><span class=ln> 29</span><span class=cl><span class=cm>/* Creates a new PyPointObject */</span>
</span></span><span class=line><span class=ln> 30</span><span class=cl><span class=k>static</span> <span class=n>PyObject</span> <span class=o>*</span><span class=nf>PyPoint_new</span><span class=p>(</span><span class=n>PyTypeObject</span> <span class=o>*</span><span class=n>type</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>args</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 31</span><span class=cl>                             <span class=n>PyObject</span> <span class=o>*</span><span class=n>kwds</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 32</span><span class=cl>  <span class=kt>double</span> <span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 33</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>PyArg_ParseTuple</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=s>&#34;dd&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>x</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>y</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 34</span><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 35</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 36</span><span class=cl>
</span></span><span class=line><span class=ln> 37</span><span class=cl>  <span class=n>PyPointObject</span> <span class=o>*</span><span class=n>self</span> <span class=o>=</span> <span class=p>(</span><span class=n>PyPointObject</span> <span class=o>*</span><span class=p>)</span><span class=n>type</span><span class=o>-&gt;</span><span class=nf>tp_alloc</span><span class=p>(</span><span class=n>type</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 38</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>self</span> <span class=o>!=</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 39</span><span class=cl>    <span class=kt>void</span> <span class=o>*</span><span class=n>point</span> <span class=o>=</span> <span class=nf>c_new_point</span><span class=p>(</span><span class=n>x</span><span class=p>,</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 40</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>point</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 41</span><span class=cl>      <span class=nf>Py_DECREF</span><span class=p>(</span><span class=n>self</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 42</span><span class=cl>      <span class=k>return</span> <span class=nf>PyErr_NoMemory</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 43</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 44</span><span class=cl>    <span class=n>self</span><span class=o>-&gt;</span><span class=n>capsule</span> <span class=o>=</span>
</span></span><span class=line><span class=ln> 45</span><span class=cl>        <span class=nf>PyCapsule_New</span><span class=p>(</span><span class=n>point</span><span class=p>,</span> <span class=s>&#34;point._Point&#34;</span><span class=p>,</span> <span class=n>point_capsule_destructor</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 46</span><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>capsule</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 47</span><span class=cl>      <span class=nf>c_delete_point</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 48</span><span class=cl>      <span class=nf>Py_DECREF</span><span class=p>(</span><span class=n>self</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 49</span><span class=cl>      <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 50</span><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=ln> 51</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 52</span><span class=cl>  <span class=k>return</span> <span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=p>)</span><span class=n>self</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 53</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 54</span><span class=cl>
</span></span><span class=line><span class=ln> 55</span><span class=cl><span class=cm>/* Getter for the &#39;x&#39; attribute */</span>
</span></span><span class=line><span class=ln> 56</span><span class=cl><span class=k>static</span> <span class=n>PyObject</span> <span class=o>*</span><span class=nf>PyPoint_getx</span><span class=p>(</span><span class=n>PyPointObject</span> <span class=o>*</span><span class=n>self</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>closure</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 57</span><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>point</span> <span class=o>=</span> <span class=nf>PyCapsule_GetPointer</span><span class=p>(</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>capsule</span><span class=p>,</span> <span class=s>&#34;point._Point&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 58</span><span class=cl>  <span class=kt>double</span> <span class=n>x</span> <span class=o>=</span> <span class=nf>c_get_x</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 59</span><span class=cl>  <span class=k>return</span> <span class=nf>PyFloat_FromDouble</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 60</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 61</span><span class=cl>
</span></span><span class=line><span class=ln> 62</span><span class=cl><span class=cm>/* Setter for the &#39;x&#39; attribute */</span>
</span></span><span class=line><span class=ln> 63</span><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>PyPoint_setx</span><span class=p>(</span><span class=n>PyPointObject</span> <span class=o>*</span><span class=n>self</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>value</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>closure</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 64</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>value</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 65</span><span class=cl>    <span class=nf>PyErr_SetString</span><span class=p>(</span><span class=n>PyExc_TypeError</span><span class=p>,</span> <span class=s>&#34;Cannot delete the x attribute&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 66</span><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 67</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 68</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>PyFloat_Check</span><span class=p>(</span><span class=n>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 69</span><span class=cl>    <span class=nf>PyErr_SetString</span><span class=p>(</span><span class=n>PyExc_TypeError</span><span class=p>,</span> <span class=s>&#34;The x attribute value must be a float&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 70</span><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 71</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 72</span><span class=cl>  <span class=kt>double</span> <span class=n>x</span> <span class=o>=</span> <span class=nf>PyFloat_AsDouble</span><span class=p>(</span><span class=n>value</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 73</span><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>point</span> <span class=o>=</span> <span class=nf>PyCapsule_GetPointer</span><span class=p>(</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>capsule</span><span class=p>,</span> <span class=s>&#34;point._Point&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 74</span><span class=cl>  <span class=nf>c_set_x</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>,</span> <span class=n>x</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 75</span><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 76</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 77</span><span class=cl>
</span></span><span class=line><span class=ln> 78</span><span class=cl><span class=cm>/* Getter for the &#39;y&#39; attribute */</span>
</span></span><span class=line><span class=ln> 79</span><span class=cl><span class=k>static</span> <span class=n>PyObject</span> <span class=o>*</span><span class=nf>PyPoint_gety</span><span class=p>(</span><span class=n>PyPointObject</span> <span class=o>*</span><span class=n>self</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>closure</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 80</span><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>point</span> <span class=o>=</span> <span class=nf>PyCapsule_GetPointer</span><span class=p>(</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>capsule</span><span class=p>,</span> <span class=s>&#34;point._Point&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 81</span><span class=cl>  <span class=kt>double</span> <span class=n>y</span> <span class=o>=</span> <span class=nf>c_get_y</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 82</span><span class=cl>  <span class=k>return</span> <span class=nf>PyFloat_FromDouble</span><span class=p>(</span><span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 83</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 84</span><span class=cl>
</span></span><span class=line><span class=ln> 85</span><span class=cl><span class=cm>/* Setter for the &#39;y&#39; attribute */</span>
</span></span><span class=line><span class=ln> 86</span><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=nf>PyPoint_sety</span><span class=p>(</span><span class=n>PyPointObject</span> <span class=o>*</span><span class=n>self</span><span class=p>,</span> <span class=n>PyObject</span> <span class=o>*</span><span class=n>value</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>closure</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 87</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>value</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 88</span><span class=cl>    <span class=nf>PyErr_SetString</span><span class=p>(</span><span class=n>PyExc_TypeError</span><span class=p>,</span> <span class=s>&#34;Cannot delete the y attribute&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 89</span><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 90</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 91</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>PyFloat_Check</span><span class=p>(</span><span class=n>value</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 92</span><span class=cl>    <span class=nf>PyErr_SetString</span><span class=p>(</span><span class=n>PyExc_TypeError</span><span class=p>,</span> <span class=s>&#34;The y attribute value must be a float&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 93</span><span class=cl>    <span class=k>return</span> <span class=o>-</span><span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 94</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 95</span><span class=cl>  <span class=kt>double</span> <span class=n>y</span> <span class=o>=</span> <span class=nf>PyFloat_AsDouble</span><span class=p>(</span><span class=n>value</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 96</span><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>point</span> <span class=o>=</span> <span class=nf>PyCapsule_GetPointer</span><span class=p>(</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>capsule</span><span class=p>,</span> <span class=s>&#34;point._Point&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 97</span><span class=cl>  <span class=nf>c_set_y</span><span class=p>(</span><span class=o>&amp;</span><span class=n>point</span><span class=p>,</span> <span class=n>y</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 98</span><span class=cl>  <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 99</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>100</span><span class=cl>
</span></span><span class=line><span class=ln>101</span><span class=cl><span class=cm>/* Define the properties of the Point type */</span>
</span></span><span class=line><span class=ln>102</span><span class=cl><span class=k>static</span> <span class=n>PyGetSetDef</span> <span class=n>PyPoint_getseters</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>103</span><span class=cl>    <span class=p>{</span><span class=s>&#34;x&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>getter</span><span class=p>)</span><span class=n>PyPoint_getx</span><span class=p>,</span> <span class=p>(</span><span class=n>setter</span><span class=p>)</span><span class=n>PyPoint_setx</span><span class=p>,</span> <span class=s>&#34;x coordinate&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>},</span>
</span></span><span class=line><span class=ln>104</span><span class=cl>    <span class=p>{</span><span class=s>&#34;y&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>getter</span><span class=p>)</span><span class=n>PyPoint_gety</span><span class=p>,</span> <span class=p>(</span><span class=n>setter</span><span class=p>)</span><span class=n>PyPoint_sety</span><span class=p>,</span> <span class=s>&#34;y coordinate&#34;</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>},</span>
</span></span><span class=line><span class=ln>105</span><span class=cl>    <span class=p>{</span><span class=nb>NULL</span><span class=p>}</span> <span class=cm>/* Sentinel */</span>
</span></span><span class=line><span class=ln>106</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>107</span><span class=cl>
</span></span><span class=line><span class=ln>108</span><span class=cl><span class=cm>/* Initializes the PyPointType object */</span>
</span></span><span class=line><span class=ln>109</span><span class=cl><span class=k>static</span> <span class=n>PyTypeObject</span> <span class=n>PyPointType</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>110</span><span class=cl>    <span class=nf>PyVarObject_HEAD_INIT</span><span class=p>(</span><span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>).</span><span class=n>tp_name</span> <span class=o>=</span> <span class=s>&#34;point.Point&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>111</span><span class=cl>    <span class=p>.</span><span class=n>tp_doc</span> <span class=o>=</span> <span class=s>&#34;Point objects&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>112</span><span class=cl>    <span class=p>.</span><span class=n>tp_basicsize</span> <span class=o>=</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>PyPointObject</span><span class=p>),</span>
</span></span><span class=line><span class=ln>113</span><span class=cl>    <span class=p>.</span><span class=n>tp_itemsize</span> <span class=o>=</span> <span class=mi>0</span><span class=p>,</span>
</span></span><span class=line><span class=ln>114</span><span class=cl>    <span class=p>.</span><span class=n>tp_flags</span> <span class=o>=</span> <span class=n>Py_TPFLAGS_DEFAULT</span> <span class=o>|</span> <span class=n>Py_TPFLAGS_BASETYPE</span><span class=p>,</span>
</span></span><span class=line><span class=ln>115</span><span class=cl>    <span class=p>.</span><span class=n>tp_new</span> <span class=o>=</span> <span class=n>PyPoint_new</span><span class=p>,</span>
</span></span><span class=line><span class=ln>116</span><span class=cl>    <span class=p>.</span><span class=n>tp_dealloc</span> <span class=o>=</span> <span class=p>(</span><span class=n>destructor</span><span class=p>)</span><span class=n>PyPoint_dealloc</span><span class=p>,</span>
</span></span><span class=line><span class=ln>117</span><span class=cl>    <span class=p>.</span><span class=n>tp_getset</span> <span class=o>=</span> <span class=n>PyPoint_getseters</span><span class=p>,</span>
</span></span><span class=line><span class=ln>118</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>119</span><span class=cl>
</span></span><span class=line><span class=ln>120</span><span class=cl><span class=k>static</span> <span class=n>PyMethodDef</span> <span class=n>point_methods</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>121</span><span class=cl>    <span class=p>{</span><span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>}</span> <span class=cm>/* Sentinel */</span>
</span></span><span class=line><span class=ln>122</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>123</span><span class=cl>
</span></span><span class=line><span class=ln>124</span><span class=cl><span class=cm>/* Initializes the point module */</span>
</span></span><span class=line><span class=ln>125</span><span class=cl><span class=k>static</span> <span class=n>PyModuleDef</span> <span class=n>pointmodule</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>126</span><span class=cl>    <span class=n>PyModuleDef_HEAD_INIT</span><span class=p>,</span>
</span></span><span class=line><span class=ln>127</span><span class=cl>    <span class=p>.</span><span class=n>m_name</span> <span class=o>=</span> <span class=s>&#34;point&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>128</span><span class=cl>    <span class=p>.</span><span class=n>m_doc</span> <span class=o>=</span> <span class=s>&#34;Module that provides a Point object.&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>129</span><span class=cl>    <span class=p>.</span><span class=n>m_size</span> <span class=o>=</span> <span class=o>-</span><span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=ln>130</span><span class=cl>    <span class=p>.</span><span class=n>m_methods</span> <span class=o>=</span> <span class=n>point_methods</span><span class=p>,</span>
</span></span><span class=line><span class=ln>131</span><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=ln>132</span><span class=cl>
</span></span><span class=line><span class=ln>133</span><span class=cl><span class=n>PyMODINIT_FUNC</span> <span class=nf>PyInit_point</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>134</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>PyType_Ready</span><span class=p>(</span><span class=o>&amp;</span><span class=n>PyPointType</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>135</span><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln>136</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>137</span><span class=cl>
</span></span><span class=line><span class=ln>138</span><span class=cl>  <span class=n>PyObject</span> <span class=o>*</span><span class=n>m</span> <span class=o>=</span> <span class=nf>PyModule_Create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>pointmodule</span><span class=p>);</span>
</span></span><span class=line><span class=ln>139</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=n>m</span> <span class=o>==</span> <span class=nb>NULL</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>140</span><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln>141</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>142</span><span class=cl>
</span></span><span class=line><span class=ln>143</span><span class=cl>  <span class=nf>Py_INCREF</span><span class=p>(</span><span class=o>&amp;</span><span class=n>PyPointType</span><span class=p>);</span>
</span></span><span class=line><span class=ln>144</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>PyModule_AddObject</span><span class=p>(</span><span class=n>m</span><span class=p>,</span> <span class=s>&#34;Point&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>PyObject</span> <span class=o>*</span><span class=p>)</span><span class=o>&amp;</span><span class=n>PyPointType</span><span class=p>)</span> <span class=o>&lt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>145</span><span class=cl>    <span class=nf>Py_DECREF</span><span class=p>(</span><span class=o>&amp;</span><span class=n>PyPointType</span><span class=p>);</span>
</span></span><span class=line><span class=ln>146</span><span class=cl>    <span class=nf>Py_DECREF</span><span class=p>(</span><span class=n>m</span><span class=p>);</span>
</span></span><span class=line><span class=ln>147</span><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln>148</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>149</span><span class=cl>
</span></span><span class=line><span class=ln>150</span><span class=cl>  <span class=k>return</span> <span class=n>m</span><span class=p>;</span>
</span></span><span class=line><span class=ln>151</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Which needs some additions to the <code>meson.build</code> <sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-meson data-lang=meson><span class=line><span class=ln> 1</span><span class=cl><span class=n>py_mod</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nn>import</span><span class=p>(</span><span class=s>&#39;python&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=w></span><span class=n>py3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>py_mod</span><span class=p>.</span><span class=n>find_installation</span><span class=p>(</span><span class=s>&#39;python3&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln> 3</span><span class=cl><span class=w></span><span class=n>py3_dep</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>py3</span><span class=p>.</span><span class=n>dependency</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=w></span><span class=nb>message</span><span class=p>(</span><span class=n>py3</span><span class=p>.</span><span class=n>path</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=w></span><span class=nb>message</span><span class=p>(</span><span class=n>py3</span><span class=p>.</span><span class=n>get_install_dir</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=w>
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=w></span><span class=c># Python Class Representation</span><span class=w>
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=w></span><span class=n>py3</span><span class=p>.</span><span class=n>extension_module</span><span class=p>(</span><span class=s>&#39;point&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=w>           </span><span class=s>&#39;point.f90&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=w>           </span><span class=s>&#39;cwrappers.f90&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=w>           </span><span class=s>&#39;pointcapsule.c&#39;</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=w>           </span><span class=n>dependencies</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>py3_dep</span><span class=p>,</span><span class=w>
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=w>           </span><span class=n>install</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>With a simple <code>pytest</code> in <code>tests/test_simple.py</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln>1</span><span class=cl><span class=kn>from</span> <span class=nn>point</span> <span class=kn>import</span> <span class=n>Point</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=k>def</span> <span class=nf>test_point</span><span class=p>():</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>    <span class=k>assert</span> <span class=n>p</span><span class=o>.</span><span class=n>x</span> <span class=o>==</span> <span class=mi>1</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>    <span class=k>assert</span> <span class=n>p</span><span class=o>.</span><span class=n>y</span> <span class=o>==</span> <span class=mi>2</span>
</span></span><span class=line><span class=ln>7</span><span class=cl>    <span class=k>assert</span> <span class=n>p</span> <span class=o>!=</span> <span class=n>Point</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span></code></pre></div><p>Can be compiled and run with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>meson compile -C bbdir
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=nb>export</span> <span class=nv>PYTHONPATH</span><span class=o>=</span><span class=nv>$PYTHONPATH</span>:<span class=k>$(</span><span class=nb>pwd</span><span class=k>)</span>/bbdir
</span></span><span class=line><span class=ln>3</span><span class=cl>pytest
</span></span></code></pre></div><p>Note that we have not (yet) defined any type bound proceedures, so there
are no operations defined between <code>Point</code> objects or anything else.</p><h2 id=binding-type-bound-proceedures>Binding type bound proceedures</h2><p>Given the structure discussed so far, adding a type bound proceedure is
nearly seamless. We need to modify the type definition.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln>1</span><span class=cl><span class=k>type</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>Point</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>   </span><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>x</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>   </span><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w></span><span class=k>contains</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>   </span><span class=k>procedure</span><span class=p>,</span><span class=w> </span><span class=k>pass</span><span class=p>(</span><span class=n>self</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>euclidean_distance</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>type</span><span class=w> </span><span class=n>Point</span><span class=w>
</span></span></span></code></pre></div><p>Followed by adding a &ldquo;handle&rdquo; for it:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln>1</span><span class=cl><span class=k>real</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span><span class=w> </span><span class=k>function</span><span class=w> </span><span class=n>euclidean_distance</span><span class=p>(</span><span class=n>self</span><span class=p>,</span><span class=w> </span><span class=n>other</span><span class=p>)</span><span class=w> </span><span class=k>result</span><span class=p>(</span><span class=n>distance</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>   </span><span class=k>class</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>self</span><span class=p>,</span><span class=w> </span><span class=n>other</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>   </span><span class=n>distance</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=nb>sqrt</span><span class=p>((</span><span class=n>self</span><span class=p>%</span><span class=n>x</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>other</span><span class=p>%</span><span class=n>x</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=p>(</span><span class=n>self</span><span class=p>%</span><span class=n>y</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>other</span><span class=p>%</span><span class=n>y</span><span class=p>)</span><span class=o>**</span><span class=mi>2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>function</span><span class=w> </span><span class=n>euclidean_distance</span><span class=w>
</span></span></span></code></pre></div><p>Along with a wrapper:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fortran data-lang=fortran><span class=line><span class=ln>1</span><span class=cl><span class=k>function</span><span class=w> </span><span class=n>c_euclidean_distance</span><span class=p>(</span><span class=n>this_cptr</span><span class=p>,</span><span class=w> </span><span class=n>other_cptr</span><span class=p>)</span><span class=w> </span><span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span><span class=w> </span><span class=k>result</span><span class=p>(</span><span class=n>y</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=w>   </span><span class=k>type</span><span class=p>(</span><span class=k>c_ptr</span><span class=p>),</span><span class=w> </span><span class=k>value</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>this_cptr</span><span class=p>,</span><span class=w> </span><span class=n>other_cptr</span><span class=w>
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=w>   </span><span class=k>real</span><span class=p>(</span><span class=k>c_double</span><span class=p>)</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>y</span><span class=w>
</span></span></span><span class=line><span class=ln>4</span><span class=cl><span class=w>   </span><span class=k>type</span><span class=p>(</span><span class=n>Point</span><span class=p>),</span><span class=w> </span><span class=k>pointer</span><span class=w> </span><span class=kd>::</span><span class=w> </span><span class=n>p1</span><span class=p>,</span><span class=w> </span><span class=n>p2</span><span class=w>
</span></span></span><span class=line><span class=ln>5</span><span class=cl><span class=w>   </span><span class=k>call</span><span class=w> </span><span class=nb>c_f_pointer</span><span class=p>(</span><span class=n>this_cptr</span><span class=p>,</span><span class=w> </span><span class=n>p1</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>6</span><span class=cl><span class=w>   </span><span class=k>call</span><span class=w> </span><span class=nb>c_f_pointer</span><span class=p>(</span><span class=n>other_cptr</span><span class=p>,</span><span class=w> </span><span class=n>p2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=w>   </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>p1</span><span class=p>%</span><span class=n>euclidean_distance</span><span class=p>(</span><span class=n>p2</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=ln>8</span><span class=cl><span class=w></span><span class=k>end</span><span class=w> </span><span class=k>function</span><span class=w> </span><span class=n>c_euclidean_distance</span><span class=w>
</span></span></span></code></pre></div><p>Which can be called from <code>C</code> via:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=k>extern</span> <span class=kt>double</span> <span class=nf>c_euclidean_distance</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=n>p1</span><span class=p>,</span> <span class=kt>void</span> <span class=o>*</span><span class=n>p2</span><span class=p>);</span>
</span></span></code></pre></div><p>Finally the <code>python-C</code> code requires only the direct addition of the
method:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln> 1</span><span class=cl><span class=k>static</span> <span class=n>PyObject</span> <span class=o>*</span><span class=nf>PyPoint_euclidean_distance</span><span class=p>(</span><span class=n>PyPointObject</span> <span class=o>*</span><span class=n>self</span><span class=p>,</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>                                            <span class=n>PyObject</span> <span class=o>*</span><span class=n>args</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=n>PyObject</span> <span class=o>*</span><span class=n>other</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>PyArg_ParseTuple</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=s>&#34;O&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>other</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl>  <span class=cm>/* Check if &#39;other&#39; is a PyPointObject instance by comparing type names */</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=nf>strcmp</span><span class=p>(</span><span class=n>other</span><span class=o>-&gt;</span><span class=n>ob_type</span><span class=o>-&gt;</span><span class=n>tp_name</span><span class=p>,</span> <span class=s>&#34;point.Point&#34;</span><span class=p>)</span> <span class=o>!=</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=nf>PyErr_SetString</span><span class=p>(</span><span class=n>PyExc_TypeError</span><span class=p>,</span> <span class=s>&#34;Argument must be a Point instance&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl>  <span class=cm>/* Ensure &#39;other&#39; is a capsule before getting the pointer */</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=nf>PyCapsule_CheckExact</span><span class=p>(((</span><span class=n>PyPointObject</span> <span class=o>*</span><span class=p>)</span><span class=n>other</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>capsule</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=nf>PyErr_SetString</span><span class=p>(</span><span class=n>PyExc_TypeError</span><span class=p>,</span> <span class=s>&#34;Argument is not a Point capsule&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>
</span></span><span class=line><span class=ln>20</span><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>self_point</span> <span class=o>=</span> <span class=nf>PyCapsule_GetPointer</span><span class=p>(</span><span class=n>self</span><span class=o>-&gt;</span><span class=n>capsule</span><span class=p>,</span> <span class=s>&#34;point._Point&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>  <span class=kt>void</span> <span class=o>*</span><span class=n>other_point</span> <span class=o>=</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>      <span class=nf>PyCapsule_GetPointer</span><span class=p>(((</span><span class=n>PyPointObject</span> <span class=o>*</span><span class=p>)</span><span class=n>other</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>capsule</span><span class=p>,</span> <span class=s>&#34;point._Point&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>
</span></span><span class=line><span class=ln>24</span><span class=cl>  <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>self_point</span> <span class=o>||</span> <span class=o>!</span><span class=n>other_point</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>    <span class=nf>PyErr_SetString</span><span class=p>(</span><span class=n>PyExc_RuntimeError</span><span class=p>,</span> <span class=s>&#34;Failed to get Point from capsule&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>    <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>
</span></span><span class=line><span class=ln>29</span><span class=cl>  <span class=kt>double</span> <span class=n>distance</span> <span class=o>=</span> <span class=nf>c_euclidean_distance</span><span class=p>(</span><span class=n>self_point</span><span class=p>,</span> <span class=n>other_point</span><span class=p>);</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>  <span class=k>return</span> <span class=nf>PyFloat_FromDouble</span><span class=p>(</span><span class=n>distance</span><span class=p>);</span>
</span></span><span class=line><span class=ln>31</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>
</span></span><span class=line><span class=ln>33</span><span class=cl><span class=cm>/* Define the methods */</span>
</span></span><span class=line><span class=ln>34</span><span class=cl><span class=k>static</span> <span class=n>PyMethodDef</span> <span class=n>point_methods</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>    <span class=p>{</span><span class=s>&#34;euclidean_distance&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>PyCFunction</span><span class=p>)</span><span class=n>PyPoint_euclidean_distance</span><span class=p>,</span>
</span></span><span class=line><span class=ln>36</span><span class=cl>     <span class=n>METH_VARARGS</span><span class=p>,</span> <span class=s>&#34;Calculate the Euclidean distance to another Point&#34;</span><span class=p>},</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>    <span class=p>{</span><span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>}</span> <span class=cm>/* Sentinel */</span>
</span></span><span class=line><span class=ln>38</span><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>This can now be used to pass a more stringent set of tests:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=kn>from</span> <span class=nn>point</span> <span class=kn>import</span> <span class=n>Point</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=k>def</span> <span class=nf>test_point</span><span class=p>():</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=k>assert</span> <span class=n>p</span><span class=o>.</span><span class=n>x</span> <span class=o>==</span> <span class=mi>1</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=k>assert</span> <span class=n>p</span><span class=o>.</span><span class=n>y</span> <span class=o>==</span> <span class=mi>2</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=k>assert</span> <span class=n>p</span> <span class=o>!=</span> <span class=n>Point</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=k>def</span> <span class=nf>test_point_euclid</span><span class=p>():</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>    <span class=n>p2</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=mi>2</span><span class=p>,</span> <span class=mi>5</span><span class=p>)</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>    <span class=k>assert</span> <span class=n>p</span><span class=o>.</span><span class=n>euclidean_distance</span><span class=p>(</span><span class=n>p2</span><span class=p>)</span> <span class=o>==</span> <span class=mf>3.1622776601683795</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=k>def</span> <span class=nf>test_fails</span><span class=p>():</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=n>p</span> <span class=o>=</span> <span class=n>Point</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span> <span class=mi>2</span><span class=p>)</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=k>with</span> <span class=n>pytest</span><span class=o>.</span><span class=n>raises</span><span class=p>(</span><span class=ne>TypeError</span><span class=p>)</span> <span class=k>as</span> <span class=n>e_info</span><span class=p>:</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>        <span class=n>p</span><span class=o>.</span><span class=n>euclidean_distance</span><span class=p>(</span><span class=mi>1</span><span class=p>)</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=k>assert</span> <span class=nb>str</span><span class=p>(</span><span class=n>e_info</span><span class=o>.</span><span class=n>value</span><span class=p>)</span> <span class=o>==</span> <span class=s2>&#34;Argument must be a Point instance&#34;</span>
</span></span></code></pre></div><h2 id=towards-allocatable-components-and-f2py-support>Towards allocatable components and <code>f2py</code> support</h2><p>So far we have not really covered new ground compared to the previous
iteration using <code>C</code> compatible <code>struct</code> information. The remarkable
extensibility of the pointer approach really shines when we consider
adding a new type, with an allocatable component<sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>.</p><p>That being said, there is more to be done over on the <code>f2py</code> side before
it makes sense to delve too deeply into enhancements on the
<code>Fortran-C-Python</code> pipeline. The biggest blocker at the moment is:</p><ul><li>Suport for <code>C_PTR</code> in <code>f2py</code><ul><li>This includes <code>void*</code> handling</li></ul></li></ul><p>The exact details shall be covered later, mostly because the Python-C
code gets a little rough. It is easier with <code>f2py</code> which provides
efficient routines to and from <code>C</code> and Python via <code>numpy</code> arrays but
still too long to be in the same post.</p><h2 id=conclusions>Conclusions</h2><p>More examples notwithstanding, the design discussed here is generic
enough to form a more coherent and pragmatic basis for further
improvements. Some of these are enumerated below for a future attempt:</p><ul><li>Circumventing the need to copy data from Python / <code>C</code> to
Fortran <sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup><ul><li>Either by careful usage of <code>transfer</code> or just via <code>c_loc</code> with
compatible types</li></ul></li><li>Using the <code>CFI</code> descriptors to operate efficiently on discontinous
memory <sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup><ul><li>Actually generally using the <code>CFI</code> descriptors more, since 2018
Reid (<a href=#ref-reidNewFeaturesFortran2018>2018</a>), some of the
pointer highjinks are enshrined as cannon<ul><li><code>c_loc</code> and <code>c_funloc</code> may have non-interoperable arguments
Metcalf, Reid, and Cohen
(<a href=#ref-metcalfModernFortranExplained2018>2018</a>)</li></ul></li></ul></li></ul><p>All that being said, with <code>meson</code> support in <code>f2py</code> from <code>1.26</code>
(<a href=https://github.com/numpy/numpy/pull/24532>npgh-24532</a>), basic types
based modern Fortran <a href=https://github.com/HaoZeke/GaussJacobiQuad#f2py-generated-interface>can already be
used</a>,
so the future remains bright.</p><h2 id=references>References</h2><div id=refs class="references csl-bib-body hanging-indent"><div id=ref-metcalfModernFortranExplained2018 class=csl-entry><p>Metcalf, Michael, John Ker Reid, and Malcolm Cohen. 2018. <em>Modern
Fortran Explained: Incorporating Fortran 2018</em>. Numerical Mathematics
and Scientific Computation. Oxford [England]: Oxford University Press.</p></div><div id=ref-pletzerExposingFortranDerived2008 class=csl-entry><p>Pletzer, Alexander, Douglas McCune, Stefan Muszala, Srinath Vadlamani,
and Scott Kruger. 2008. &ldquo;Exposing Fortran Derived Types to C and Other
Languages.&rdquo; <em>Computing in Science Engineering</em> 10 (4): 86&ndash;92.
<a href=https://doi.org/10.1109/MCSE.2008.94>https://doi.org/10.1109/MCSE.2008.94</a>.</p></div><div id=ref-reidNewFeaturesFortran2018 class=csl-entry><p>Reid, John. 2018. &ldquo;The New Features of Fortran 2018.&rdquo;
<a href=https://doi.org/10.1145/3206214.3206215>https://doi.org/10.1145/3206214.3206215</a>.</p></div></div><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Pun intended&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>Hence <code>real(8)</code> over the more <a href="https://fortran-lang.discourse.group/t/best-way-to-declare-a-double-precision-in-fortran/69/21?u=rgoswami">explicit
alternatives</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>It is at this point (linking, handling dependencies) that
<code>meson</code> pays off over hand compilation&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4><p>This Fortran-Lang <a href="https://fortran-lang.discourse.group/t/allocate-interoperability-and-c-descriptors/5088/9?u=rgoswami">discourse
thread</a>
includes examples from Ivan Pribec demonstrating this&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5><p>This Fortran-Lang <a href="https://fortran-lang.discourse.group/t/allocate-interoperability-and-c-descriptors/5088/9?u=rgoswami">discourse
thread</a>
includes examples from Ivan Pribec demonstrating this&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6><p>A popular NumPy usage pattern, and a visible bottleneck in
interactive workflows&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><hr><div class=post-series-bottom><h2>Series info</h2><h3>Bridging Fortran & Python series</h3><ol><li><a href=https://rgoswami.me/posts/numpy-meson-f2py/>NumPy, Meson and f2py</a></li><li><a href=https://rgoswami.me/posts/cython-derivedtype-f2py/>Simple Fortran Derived Types and Python</a></li><li><a href=https://rgoswami.me/posts/iso-c-type-bound-fortran/>Exploring ISO_C_BINDING and type-bound procedures</a></li><li><a href=https://rgoswami.me/posts/fortran-oop-python/>Fortran OOP and Python</a></li><li><b>Types from Fortran to Python via Opaque Pointers</b> &lt;-- You are here!</li></ol></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=/tags/python>python</a></span><span class=tag><a href=/tags/fortran>fortran</a></span><span class=tag><a href=/tags/numpy>numpy</a></span><span class=tag><a href=/tags/f2py>f2py</a></span><span class=tag><a href=/tags/ramblings>ramblings</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>3562 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Posted: <time class=dt-published>2023-11-12 23:36 +0000</time></p><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frgoswami.me%2fposts%2ftypes-fortran-python-opaque%2f" target=_blank rel=noopener aria-label=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15.84 9.5H13.5V8.48c0-.53.35-.65.6-.65h1.4v-2.3h-2.35c-2.3.0-2.65 1.7-2.65 2.8V9.5h-2v2h2v7h3v-7h2.1l.24-2z"/></svg></div>Facebook</div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=%22Types%20from%20Fortran%20to%20Python%20via%20Opaque%20Pointers%22%20seems%20like%20an%20interesting%20read%20from%20%40rg0swami&amp;url=https%3a%2f%2frgoswami.me%2fposts%2ftypes-fortran-python-opaque%2f" target=_blank rel=noopener aria-label=Twitter><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.5 7.4l-2 .2c-.4-.5-1-.8-2-.8C13.3 6.8 12 8 12 9.4v.6c-2 0-4-1-5.4-2.7-.2.4-.3.8-.3 1.3.0 1 .4 1.7 1.2 2.2-.5.0-1 0-1.2-.3.0 1.3 1 2.3 2 2.6-.3.4-.7.4-1 0 .2 1.4 1.2 2 2.3 2-1 1-2.5 1.4-4 1 1.3 1 2.7 1.4 4.2 1.4 4.8.0 7.5-4 7.5-7.5v-.4c.5-.4.8-1.5 1.2-2z"/><circle cx="12" cy="12" r="11.5"/></svg></div>Twitter</div></a><a class=resp-sharing-button__link href="mailto:?subject=%22Types%20from%20Fortran%20to%20Python%20via%20Opaque%20Pointers%22%20seems%20interesting...&amp;body=https%3a%2f%2frgoswami.me%2fposts%2ftypes-fortran-python-opaque%2f" target=_self rel=noopener aria-label=E-Mail><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.5 16c0 .8-.7 1.5-1.5 1.5H6c-.8.0-1.5-.7-1.5-1.5V8c0-.8.7-1.5 1.5-1.5h12c.8.0 1.5.7 1.5 1.5v8zm-2-7.5L12 13 6.5 8.5m11 6-4-2.5m-7 2.5 4-2.5"/><circle cx="12" cy="12" r="11.5"/></svg></div>E-Mail</div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frgoswami.me%2fposts%2ftypes-fortran-python-opaque%2f&amp;title=%22Types%20from%20Fortran%20to%20Python%20via%20Opaque%20Pointers%22%20seems%20interesting...&amp;summary=%22Types%20from%20Fortran%20to%20Python%20via%20Opaque%20Pointers%22%20seems%20interesting...&amp;source=https%3a%2f%2frgoswami.me%2fposts%2ftypes-fortran-python-opaque%2f" target=_blank rel=noopener aria-label=LinkedIn><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15 12.5c-.28.0-.5.22-.5.5v3.5h-3s.03-6.48.0-7h3v.83s.46-.75 1.7-.75c1.56.0 2.3 1.12 2.3 3.3v3.62h-3V13c0-.28-.23-.5-.5-.5zm-7.5-3h2v7h-2z"/><circle cx="8.5" cy="6.5" r="1"/></svg></div>LinkedIn</div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2frgoswami.me%2fposts%2ftypes-fortran-python-opaque%2f&amp;resubmit=true&amp;title=%22Types%20from%20Fortran%20to%20Python%20via%20Opaque%20Pointers%22%20seems%20interesting..." target=_blank rel=noopener aria-label=Reddit><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><ellipse cx="12" cy="14.37" rx="6.2" ry="4.24"/><path d="M14.3 16.25c-.62.36-1.42.57-2.3.57s-1.7-.2-2.32-.58"/><circle cx="14.61" cy="13.39" r=".98"/><circle cx="9.39" cy="13.39" r=".98"/><path d="M16.4 11.38c.26-.55.82-.92 1.47-.92.9.0 1.63.73 1.63 1.63.0.8-.6 1.47-1.38 1.6"/><circle cx="17.22" cy="7.52" r="1.63"/><path d="M7.6 11.38c-.26-.54-.82-.92-1.47-.92-.9.0-1.63.73-1.63 1.63.0.8.6 1.47 1.38 1.6M12 10.12s-.08-4.82 3.6-2.6"/></svg></div>Reddit</div></a><a class=resp-sharing-button__link href="whatsapp://send?text=%22Types%20from%20Fortran%20to%20Python%20via%20Opaque%20Pointers%22%20seems%20interesting...%20https%3a%2f%2frgoswami.me%2fposts%2ftypes-fortran-python-opaque%2f" target=_blank rel=noopener aria-label=WhatsApp><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle xmlns="http://www.w3.org/2000/svg" cx="12" cy="12" r="11.5"/><path stroke-width="1" d="M17.6 6.2c-1.5-1.5-3.4-2.3-5.5-2.3-4.3.0-7.8 3.5-7.8 7.8.0 1.4.4 2.7 1 3.9l-1.1 4 4.1-1.1c1.1.6 2.4.9 3.7.9 4.3.0 7.8-3.5 7.8-7.8.1-2-.7-3.9-2.2-5.4zm-5.5 11.9c-1.2.0-2.3-.3-3.3-.9l-.2-.1-2.4.6.7-2.4-.2-.2c-.6-1-1-2.2-1-3.4.0-3.6 2.9-6.5 6.5-6.5 1.7.0 3.3.7 4.6 1.9 1.2 1.2 1.9 2.8 1.9 4.6-.1 3.5-3 6.4-6.6 6.4zm3.5-4.8c-.2-.1-1.1-.6-1.3-.6-.2-.1-.3-.1-.4.1s-.5.6-.6.8c-.1.1-.2.1-.4.0s-.8-.3-1.6-1c-.6-.5-1-1.2-1.1-1.3-.1-.2.0-.3.1-.4l.3-.3s.1-.2.2-.3c.1-.1.0-.2.0-.3s-.4-1.1-.6-1.4c-.2-.4-.3-.3-.4-.3h-.4s-.3.0-.5.2-.7.7-.7 1.6c0 1 .7 1.9.8 2s1.4 2.1 3.3 2.9c.5.2.8.3 1.1.4.5.1.9.1 1.2.1.4-.1 1.1-.5 1.3-.9.2-.5.2-.8.1-.9.0-.2-.2-.3-.4-.4z"/></svg></div>WhatsApp</div></a></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://rgoswami.me/posts/writing-r-packages/><span class=button__text>Writing R Packages</span>
<span class=button__icon>→</span></a></span></div></div><div id=comments class=thin><div class=pagination__title><span class=pagination__title-h>Comments</span><hr></div><script src=https://utteranc.es/client.js repo=haozeke/haozeke.github.io issue-term=pathname theme=photon-dark label="Utterance 💬" crossorigin=anonymous async></script></div></main><footer class=footer><p>&copy; 2024
<span><a href=https://rgoswami.me/>Rohit Goswami (HaoZeke)</a></span>
<a href=/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a><br><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a>.
Powered by <a href=http://gohugo.io><u>Hugo</u></a> and <a href=https://github.com/HaoZeke/hugo-theme-hello-friend-ng-hz><u>this theme</u></a>.</br>Hosted with <u><a href=https://www.netlify.com/>Netlify</a></u>.</br><script src=https://liberapay.com/rohit/widgets/button.js></script><noscript><a href=https://liberapay.com/rohit/donate><img alt="Donate using Liberapay" src=https://liberapay.com/assets/widgets/donate.svg></a></noscript></p></footer></div><script src=/bundle.min.5fae9992ea406007408dc33b0b3a8376d61e2f1d6ac50ba1dad7580ac50afb5199bcef3bbc3677e77553a9980bf882cf71edc2f755687dd7725f12ece4304ac2.js></script><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-109503488-16","auto"),ga("send","pageview")</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","3z2xvwqu4u")</script><script data-goatcounter=https://rgoswami.goatcounter.com/count async src=//gc.zgo.at/count.js></script><script>var clicky_site_ids=clicky_site_ids||[];clicky_site_ids.push("101265002")</script><script async src=https://static.getclicky.com/js></script><script src=https://cdn.jsdelivr.net/npm/readmore-js@3.0.0-beta-1/dist/readmore.min.js></script><script src=/js/codefold.min.f0790269b87613b3bcff64022840fe1991eee3ea384e874c78a24022c9936bd888a3c14a05a10955881eebb1558e4fcf37576dac120cd0bf4ebaf7aca27b35b1.js></script><script src=/js/copyClipboard.min.1c92539aea398296101add0e80508ad94cb59fb37f946f06ec9ca1c7558a961b8de0c5595a921aed70aa91eb94d24db35e5a01243bc625f8b1814b17928f478b.js></script></body></html>