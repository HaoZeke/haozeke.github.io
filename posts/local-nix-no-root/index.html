<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="[Rohit Goswami]"><meta name=description content="Monkeying around with nix for HPC systems which have no root access and NFS filesystems.
Background Nix is not well known for being friendly to users without root access. This is typically made worse by the &amp;ldquo;exotic&amp;rdquo; filesystem attributes common to HPC networks (this also plagues hermes). An earlier post details how and why proot failed. The short pitch is simply:
Figure 1: Does your HPC look like this?"><meta name=keywords content="personal,workflow,projects,hpc,nix,tools"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://rgoswami.me/posts/local-nix-no-root/><meta name=generator content="Wooframework"><title>Local Nix without Root :: Rohit Goswami — Reflections
</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.min.054e30538b054b321af6575a7659f551cec63e1cef6bbd674acccadf856d3aff.css><meta itemprop=name content="Local Nix without Root"><meta itemprop=description content="Monkeying around with nix for HPC systems which have no root access and NFS filesystems.
Background Nix is not well known for being friendly to users without root access. This is typically made worse by the &ldquo;exotic&rdquo; filesystem attributes common to HPC networks (this also plagues hermes). An earlier post details how and why proot failed. The short pitch is simply:
Figure 1: Does your HPC look like this?"><meta itemprop=datePublished content="2020-09-07T18:30:00+00:00"><meta itemprop=dateModified content="2020-09-07T18:30:00+00:00"><meta itemprop=wordCount content="2147"><meta itemprop=image content="https://rgoswami.me/images/RG.png"><meta itemprop=keywords content="workflow,projects,hpc,nix,tools,"><meta property="og:title" content="Local Nix without Root"><meta property="og:description" content="Monkeying around with nix for HPC systems which have no root access and NFS filesystems.
Background Nix is not well known for being friendly to users without root access. This is typically made worse by the &ldquo;exotic&rdquo; filesystem attributes common to HPC networks (this also plagues hermes). An earlier post details how and why proot failed. The short pitch is simply:
Figure 1: Does your HPC look like this?"><meta property="og:type" content="article"><meta property="og:url" content="https://rgoswami.me/posts/local-nix-no-root/"><meta property="og:image" content="https://rgoswami.me/images/RG.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-07T18:30:00+00:00"><meta property="article:modified_time" content="2020-09-07T18:30:00+00:00"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rgoswami.me/images/RG.png"><meta name=twitter:title content="Local Nix without Root"><meta name=twitter:description content="Monkeying around with nix for HPC systems which have no root access and NFS filesystems.
Background Nix is not well known for being friendly to users without root access. This is typically made worse by the &ldquo;exotic&rdquo; filesystem attributes common to HPC networks (this also plagues hermes). An earlier post details how and why proot failed. The short pitch is simply:
Figure 1: Does your HPC look like this?"><meta property="article:section" content="programming"><meta property="article:published_time" content="2020-09-07 18:30:00 +0000 UTC"></head><body class=dark-theme><div class=container><header class=header><div class=header__inner><div class=header__left><div class=logo><a href=/ style=text-decoration:none><img src=/images/home.png alt></a></div></div><div class=header__mid><button class=button><div class=button__text><a href=https://rgoswami.me//search>Search</a></div></button></div><div class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about>About</a></li><li><a href=/posts>Blog</a></li><li><a href=/series>Series</a></li></ul><ul class=menu__inner><li><a href=/categories>Categories</a></li><li><a href=/snippets>Snippets</a></li><li><a href=/tags>Tags</a></li></ul></nav><button id=toggleMenu><div class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></div></button>
<button class=theme-toggle id=toggleTheme><svg class="theme-toggler" width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></button></div></div></header><script src=/js/mathjax-config.js></script><script id=MathJax-script async src=https://unpkg.com/mathjax@3/es5/tex-chtml.js></script><aside class=sidebar><div class=hideTOC><button id=tocTog>TOC</button><div class="sideTOC m-fadeOut"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#setup>Setup</a><ul><li><a href=#patches>Patches</a></li><li><a href=#user-build>User Build</a></li></ul></li><li><a href=#rebuilding-natively>Rebuilding Natively</a></li><li><a href=#usage>Usage</a><ul><li><a href=#flakes-and-devshells>Flakes and DevShells</a></li><li><a href=#basic-packages>Basic Packages</a></li><li><a href=#ruby-caveats>Ruby Caveats</a></li><li><a href=#dotfiles>Dotfiles</a></li><li><a href=#misc-nfs>Misc NFS</a></li></ul></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></div></div></aside><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>11 minutes<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Written: 2020-09-07 18:30 +0000</p></p></div><article class=h-entry><h1 class="post-title p-name"><a class=u-url href=https://rgoswami.me/posts/local-nix-no-root/>Local Nix without Root</a></h1><div class=post-info><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pen-tool"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg><span class="author u-author p-author"><a href=/author/rohit-goswami>Rohit Goswami</a></span></div><hr><aside id=toc class=sidebar><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#setup>Setup</a><ul><li><a href=#patches>Patches</a></li><li><a href=#user-build>User Build</a></li></ul></li><li><a href=#rebuilding-natively>Rebuilding Natively</a></li><li><a href=#usage>Usage</a><ul><li><a href=#flakes-and-devshells>Flakes and DevShells</a></li><li><a href=#basic-packages>Basic Packages</a></li><li><a href=#ruby-caveats>Ruby Caveats</a></li><li><a href=#dotfiles>Dotfiles</a></li><li><a href=#misc-nfs>Misc NFS</a></li></ul></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></aside><hr><div class="post-content e-content"><blockquote><p>Monkeying around with <code>nix</code> for HPC systems which have no root access and NFS filesystems.</p></blockquote><h2 id=background>Background</h2><p>Nix is not well known for being friendly to users without root access. This is typically made worse by the &ldquo;exotic&rdquo; filesystem attributes common to HPC networks (this also plagues <a href=https://github.com/andrewchambers/hermes/issues/75>hermes</a>). An <a href=/posts/prov-dots/>earlier post</a> details how and why <code>proot</code> failed.
The short pitch is simply:</p><figure><img src=/ox-hugo/2020-09-07_17-34-25_screenshot.png alt="Figure 1: Does your HPC look like this?"><figcaption><p><span class=figure-number>Figure 1: </span>Does your HPC look like this?</p></figcaption></figure><figure><img src=/ox-hugo/2020-09-07_17-37-28_screenshot.png alt="Figure 2: It really is an HPC"><figcaption><p><span class=figure-number>Figure 2: </span>It really is an HPC</p></figcaption></figure><p>If your HPC doesn&rsquo;t look that swanky and you&rsquo;d like it to, then read on. Note that there are all the obvious benefits of <code>nix</code> as well, but this is a more eye-catchy pitch.</p><h2 id=setup>Setup</h2><blockquote><p>The basic concept is to install <code>nix</code> from source, with appropriate patches, and then mess around with paths until it is ready and willing to work with stores which are not <code>/nix</code> <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup></p></blockquote><p>This concept is strongly influenced by the work <a href=https://github.com/jefdaj/nix-no-root>described in this repo</a>. The premise is similar to my earlier post <a href=/posts/hpc-dots-lmod/>on HPC Dotfiles</a>. For the purposes of this post, we will assume that all the packages in the <a href=/posts/hpc-dots-lmod/>previous post</a>
exist. <code>lmod</code> is not required, feel free to use an alternative path management system, or even just <code>$HOME/.local</code> but if <code>lmod</code> is present, it is highly recommended <sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>. We <strong>will need</strong> the following:</p><dl><dt>Pinned set of nixpkgs</dt><dd>We would like to be able to modify a lot of paths, which is normally a bad practice, but then we don&rsquo;t normally rebuild all packages either. Grab a copy of the <code>nixpkgs</code> by following the instructions below. Now is also the time to fork the repo if you&rsquo;d like to keep track of your changes.</dd></dl><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>mkdir -p <span class=nv>$HOME</span>/Git/Github
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=nb>cd</span> <span class=nv>$HOME</span>/Git/Github
</span></span><span class=line><span class=ln>3</span><span class=cl>git clone https://github.com/NixOS/nixpkgs
</span></span></code></pre></div><dl><dt>dotgit</dt><dd>We use the older, bash version of <a href=https://github.com/kobus-v-schoor/dotgit/>the excellent dotgit</a> since <code>python</code> is not always present in HPC environments.</dd></dl><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>git clone https://github.com/kobus-v-schoor/dotgit/
</span></span><span class=line><span class=ln>2</span><span class=cl>mkdir -p <span class=nv>$HOME</span>/.local/bin
</span></span><span class=line><span class=ln>3</span><span class=cl>cp dotgit/old/bin/bash_completion dotgit/old/bin/dotgit dotgit/old/bin/dotgit_headers dotgit/old/bin/fish_completion.fish <span class=nv>$HOME</span>/.local/bin/ -r
</span></span></code></pre></div><dl><dt>lmod packages</dt><dd>If you do not or cannot use modulefiles as <a href=/posts/hpc-dots-lmod/>described in the earlier post</a>, inspect the module-files being loaded and set paths accordingly.</dd></dl><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=nb>cd</span> <span class=nv>$HOME</span>/Git/Github
</span></span><span class=line><span class=ln>2</span><span class=cl>git clone https://github.com/HaoZeke/hzHPC_lmod
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=nb>cd</span> hzHPC_lmod
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=nv>$HOME</span>/.local/bin/dotgit restore hzhpc
</span></span></code></pre></div><p>Now we can start by obtaining the <code>nix</code> sources.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl><span class=nv>myprefix</span><span class=o>=</span><span class=nv>$HOME</span>/.hpc/nix/nix-boot
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=nv>nixdir</span><span class=o>=</span><span class=nv>$HOME</span>/.nix
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=nv>nix_version</span><span class=o>=</span>2.3.7
</span></span><span class=line><span class=ln> 4</span><span class=cl>ml load gcc/9.2.0 flex bison
</span></span><span class=line><span class=ln> 5</span><span class=cl>ml load boost
</span></span><span class=line><span class=ln> 6</span><span class=cl>ml load editline
</span></span><span class=line><span class=ln> 7</span><span class=cl>ml load brotli/1.0.1
</span></span><span class=line><span class=ln> 8</span><span class=cl>ml load libseccomp/2.4.4
</span></span><span class=line><span class=ln> 9</span><span class=cl>ml load bdwgc/8.0.4
</span></span><span class=line><span class=ln>10</span><span class=cl>ml load bzip2/1.0.8
</span></span><span class=line><span class=ln>11</span><span class=cl>ml load sqlite
</span></span><span class=line><span class=ln>12</span><span class=cl>ml load patch xz
</span></span><span class=line><span class=ln>13</span><span class=cl>wget http://nixos.org/releases/nix/nix-<span class=si>${</span><span class=nv>nix_version</span><span class=si>}</span>/nix-<span class=si>${</span><span class=nv>nix_version</span><span class=si>}</span>.tar.bz2
</span></span><span class=line><span class=ln>14</span><span class=cl>tar xfv nix-2.3.7.tar.bz2
</span></span><span class=line><span class=ln>15</span><span class=cl><span class=nb>cd</span> nix-2.3.7
</span></span></code></pre></div><p>Before actually configuring and installing from source, we need some patches.</p><h3 id=patches>Patches</h3><p>I suggest carefully typing out the patches, though leave a comment if you want a repo with these changes (if you must star something in the meantime, <a href=https://github.com/d-SEAMS/seams-core>star this</a>).</p><ul><li>Start with <a href=https://github.com/NixOS/nix/pull/1584/files>this patch</a></li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>wget https://github.com/NixOS/nix/commit/8d3cb66d22f348341d7afa626acfa53b40584fdd.patch
</span></span><span class=line><span class=ln>2</span><span class=cl>git apply 8d3cb66d22f348341d7afa626acfa53b40584fdd.patch
</span></span></code></pre></div><ul><li>Also <a href=https://nixos.wiki/wiki/Nix_Installation_Guide>this one</a></li></ul><p>Remove the following <code>ifdef</code> stuff from <code>src/libutil/compression.cc</code>, leaving only the contents of the <code>else</code> statement.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c++ data-lang=c++><span class=line><span class=ln> 1</span><span class=cl><span class=cp>#ifdef HAVE_LZMA_MT
</span></span></span><span class=line><span class=ln> 2</span><span class=cl><span class=cp></span>            <span class=n>lzma_mt</span> <span class=n>mt_options</span> <span class=o>=</span> <span class=p>{};</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>            <span class=n>mt_options</span><span class=p>.</span><span class=n>flags</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>            <span class=n>mt_options</span><span class=p>.</span><span class=n>timeout</span> <span class=o>=</span> <span class=mi>300</span><span class=p>;</span> <span class=c1>// Using the same setting as the xz cmd line
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=c1></span>            <span class=n>mt_options</span><span class=p>.</span><span class=n>preset</span> <span class=o>=</span> <span class=n>LZMA_PRESET_DEFAULT</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>            <span class=n>mt_options</span><span class=p>.</span><span class=n>filters</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>            <span class=n>mt_options</span><span class=p>.</span><span class=n>check</span> <span class=o>=</span> <span class=n>LZMA_CHECK_CRC64</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>            <span class=n>mt_options</span><span class=p>.</span><span class=n>threads</span> <span class=o>=</span> <span class=n>lzma_cputhreads</span><span class=p>();</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>            <span class=n>mt_options</span><span class=p>.</span><span class=n>block_size</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>mt_options</span><span class=p>.</span><span class=n>threads</span> <span class=o>==</span> <span class=mi>0</span><span class=p>)</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>                <span class=n>mt_options</span><span class=p>.</span><span class=n>threads</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>            <span class=c1>// FIXME: maybe use lzma_stream_encoder_mt_memusage() to control the
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=c1></span>            <span class=c1>// number of threads.
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=c1></span>            <span class=n>ret</span> <span class=o>=</span> <span class=n>lzma_stream_encoder_mt</span><span class=p>(</span><span class=o>&amp;</span><span class=n>strm</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>mt_options</span><span class=p>);</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>            <span class=n>done</span> <span class=o>=</span> <span class=nb>true</span><span class=p>;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=cp></span>            <span class=n>printMsg</span><span class=p>(</span><span class=n>lvlError</span><span class=p>,</span> <span class=s>&#34;warning: parallel XZ compression requested but not supported, falling back to single-threaded compression&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>18</span><span class=cl><span class=cp>#endif
</span></span></span></code></pre></div><p>If there is trouble with the bzip2 library, set <code>$HOME/.hpc/bzip2/1.0.8/include/bzlib.h</code> in <code>src/libutil/compression.cc</code>, but expand <code>$HOME</code>.</p><p>Finally, you will need edit <code>nixpkgs</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=ln>1</span><span class=cl><span class=c1># vim pkgs/os-specific/linux/busybox/default.nix</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>  <span class=n>debianName</span> <span class=err>=</span> <span class=s2>&#34;busybox_1.30.1-6&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>  <span class=n>debianTarball</span> <span class=err>=</span> <span class=n>fetchzip</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>    <span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;http://deb.debian.org/debian/pool/main/b/busybox/</span><span class=si>${</span><span class=n>debianName</span><span class=si>}</span><span class=s2>.debian.tar.xz&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>    <span class=n>sha256</span> <span class=o>=</span> <span class=s2>&#34;05n6mxc8n4zsli4dijrr2x5c9ggwi223i5za4n0xwhgd4lkhqymw&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>  <span class=p>};</span>
</span></span></code></pre></div><h3 id=user-build>User Build</h3><p>We can now complete the build.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>ml load openssl curl
</span></span><span class=line><span class=ln>2</span><span class=cl>./configure  --enable-gc --prefix<span class=o>=</span><span class=nv>$myprefix</span> --with-store-dir<span class=o>=</span><span class=nv>$nixdir</span>/store --localstatedir<span class=o>=</span><span class=nv>$nixdir</span>/var --with-boost<span class=o>=</span><span class=nv>$BOOST_ROOT</span> --disable-seccomp-sandboxing --disable-doc-gen --with-sandbox-shell<span class=o>=</span>/usr/bin/sh <span class=nv>CPPFLAGS</span><span class=o>=</span><span class=s2>&#34;-I</span><span class=nv>$HOME</span><span class=s2>/.hpc/bzip2/1.0.8/include&#34;</span> <span class=nv>LDFLAGS</span><span class=o>=</span><span class=s2>&#34;-L</span><span class=nv>$HOME</span><span class=s2>/.hpc/bzip2/1.0.8/lib -Wl,-R</span><span class=nv>$HOME</span><span class=s2>/.hpc/bzip2/1.0.8/lib&#34;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>make -j <span class=k>$(</span>nproc<span class=k>)</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>make install
</span></span><span class=line><span class=ln>5</span><span class=cl>ml load nix/user <span class=c1># Hooray!</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>ml unload openssl curl
</span></span></code></pre></div><p>Now we still need to set a profile. Inspect <code>.hpc/nix/nix-boot/etc/profile.d/nix.sh</code> and check the value of <code>NIX_PROFILES</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>chmod +x .hpc/nix/nix-boot/etc/profile.d/nix.sh
</span></span><span class=line><span class=ln>2</span><span class=cl>./.hpc/nix/nix-boot/etc/profile.d/nix.sh
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=c1># OR, and this is better</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>nix-env --switch-profile .nix/var/nix/profiles/default
</span></span><span class=line><span class=ln>5</span><span class=cl>mkdir -p  ~/.nix/var/nix/profiles
</span></span></code></pre></div><p>The reason why we need to switch profiles is because by default <code>nix-env --switch-profile</code> will use <code>/nix/var/nix/profiles/per-user/$USER/profile</code> in a multi-user setup, and it is better to keep this where we have control as well.</p><p>We also need to kill the sandbox for now, as also seen in the <a href="https://aur.archlinux.org/packages/nix/?O=10&amp;PP=10">AUR package</a> (and <a href=https://github.com/NixOS/nix/issues/3337#issuecomment-579363583>here</a>).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=ln>1</span><span class=cl><span class=c1># ~/.config/nix/nix.conf</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=na>sandbox</span> <span class=o>=</span> <span class=s>false</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=na>substituters</span> <span class=o>=</span> <span class=s>https://cache.nixos.org https://all-hies.cachix.org</span>
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=na>trusted-public-keys</span> <span class=o>=</span> <span class=s>cache.nixos.org-1:6NCHdD59X431o0gWypbMrAURkbJ16ZPMQFGspcDShjY= all-hies.cachix.org-1:JjrzAOEUsD9ZMt8fdFbzo3jNAyEWlPAwdVuHw4RD43k=</span>
</span></span></code></pre></div><p>Now we can test this before moving forward:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>nix-channel --update
</span></span><span class=line><span class=ln>2</span><span class=cl>nix-shell -p hello
</span></span></code></pre></div><h2 id=rebuilding-natively>Rebuilding Natively</h2><p>The astute reader will have noticed that we glibly monkeyed around with the <code>nix</code> source in the previous section, but all will be made well since we can rebuild to use <code>nix</code> with itself. Do <strong>replace the variable with the corresponding path</strong>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=ln>1</span><span class=cl><span class=n>storeDir</span> <span class=err>=</span> <span class=s2>&#34;$HOME/.nix/store&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=n>stateDir</span> <span class=err>=</span> <span class=s2>&#34;$HOME/.nix/var&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=n>confDif</span> <span class=err>=</span> <span class=s2>&#34;$HOME/.nix/etc&#34;</span><span class=p>;</span>
</span></span></code></pre></div><p>Essentially, the <code>$HOME/.config/nixpkgs/config.nix</code> should look like (incorporating both the patches and also the full directory we will be using):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=ln> 1</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=n>packageOverrides</span> <span class=o>=</span> <span class=n>pkgs</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>      <span class=n>autogen</span> <span class=o>=</span> <span class=n>autogen</span><span class=o>.</span><span class=n>overrideAttrs</span> <span class=p>(</span><span class=n>oldAttrs</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>        <span class=n>postInstall</span> <span class=o>=</span> <span class=s1>&#39;&#39;
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=s1>          mkdir -p $dev/bin
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=s1>          mv $bin/bin/autoopts-config $dev/bin
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=s1>          for f in $lib/lib/autogen/tpl-config.tlib $out/share/autogen/tpl-config.tlib; do
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=s1>            sed -e &#34;s|$dev/include|/no-such-autogen-include-path|&#34; -i $f
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=s1>            sed -e &#34;s|$bin/bin|/no-such-autogen-bin-path|&#34; -i $f
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=s1>            sed -e &#34;s|$lib/lib|/no-such-autogen-lib-path|&#34; -i $f
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=s1>          done
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=s1>          # remove /tmp/** from RPATHs
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=s1>          for f in &#34;$bin&#34;/bin/*; do
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=s1>            local nrp=&#34;$(patchelf --print-rpath &#34;$f&#34; | sed -E &#39;s@(:|^)/tmp/[^:]*:@\1@g&#39;)&#34;
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=s1>            patchelf --set-rpath &#34;$nrp&#34; &#34;$f&#34;
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=s1>          done
</span></span></span><span class=line><span class=ln>18</span><span class=cl><span class=s1>        &#39;&#39;</span> <span class=o>+</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>optionalString</span> <span class=p>(</span><span class=o>!</span><span class=n>stdenv</span><span class=o>.</span><span class=n>hostPlatform</span><span class=o>.</span><span class=n>isDarwin</span><span class=p>)</span> <span class=s1>&#39;&#39;
</span></span></span><span class=line><span class=ln>19</span><span class=cl><span class=s1>          # remove /build/** from RPATHs
</span></span></span><span class=line><span class=ln>20</span><span class=cl><span class=s1>          for f in &#34;$bin&#34;/bin/*; do
</span></span></span><span class=line><span class=ln>21</span><span class=cl><span class=s1>            local nrp=&#34;$(patchelf --print-rpath &#34;$f&#34; | sed -E &#39;s@(:|^)/build/[^:]*:@\1@g&#39;)&#34;
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=s1>            patchelf --set-rpath &#34;$nrp&#34; &#34;$f&#34;
</span></span></span><span class=line><span class=ln>23</span><span class=cl><span class=s1>          done
</span></span></span><span class=line><span class=ln>24</span><span class=cl><span class=s1>        &#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>      <span class=n>nix</span> <span class=o>=</span> <span class=n>nix</span><span class=o>.</span><span class=n>overrideAttrs</span> <span class=p>(</span><span class=n>oldAttrs</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>        <span class=n>storeDir</span> <span class=o>=</span> <span class=s2>&#34;/users/home/jdoe/.nix/store&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>        <span class=n>stateDir</span> <span class=o>=</span> <span class=s2>&#34;/users/home/jdoe/.nix/var&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>        <span class=n>confDif</span> <span class=o>=</span> <span class=s2>&#34;/users/home/jdoe/.nix/etc&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>        <span class=n>doCheck</span> <span class=o>=</span> <span class=no>false</span><span class=p>;</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>        <span class=n>doInstallCheck</span> <span class=o>=</span> <span class=no>false</span><span class=p>;</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>        <span class=n>prePatch</span> <span class=o>=</span> <span class=s1>&#39;&#39;
</span></span></span><span class=line><span class=ln>33</span><span class=cl><span class=s1>          substituteInPlace src/libstore/local-store.cc \
</span></span></span><span class=line><span class=ln>34</span><span class=cl><span class=s1>            --replace &#39;(eaName == &#34;security.selinux&#34;)&#39; \
</span></span></span><span class=line><span class=ln>35</span><span class=cl><span class=s1>                      &#39;(eaName == &#34;security.selinux&#34; || eaName == &#34;system.nfs4_acl&#34;)&#39;
</span></span></span><span class=line><span class=ln>36</span><span class=cl><span class=s1>          substituteInPlace src/libstore/gc.cc \
</span></span></span><span class=line><span class=ln>37</span><span class=cl><span class=s1>            --replace &#39;auto mapLines =&#39; \
</span></span></span><span class=line><span class=ln>38</span><span class=cl><span class=s1>                      &#39;continue; auto mapLines =&#39;
</span></span></span><span class=line><span class=ln>39</span><span class=cl><span class=s1>          substituteInPlace src/libstore/sqlite.cc \
</span></span></span><span class=line><span class=ln>40</span><span class=cl><span class=s1>            --replace &#39;SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE, 0) != SQLITE_OK)&#39; \
</span></span></span><span class=line><span class=ln>41</span><span class=cl><span class=s1>                      &#39;SQLITE_OPEN_READWRITE | SQLITE_OPEN_CREATE, &#34;unix-dotfile&#34;) != SQLITE_OK)&#39;
</span></span></span><span class=line><span class=ln>42</span><span class=cl><span class=s1>        &#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>43</span><span class=cl>      <span class=p>});</span>
</span></span><span class=line><span class=ln>44</span><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=ln>45</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We can &ldquo;speed up&rdquo; our build by disabling all tests. Go to the copy of <code>nixpkgs</code> and run:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>find pkgs  -type f -name <span class=s1>&#39;default.nix&#39;</span> <span class=p>|</span> xargs sed -i <span class=s1>&#39;s/doCheck = true/doCheck = false/&#39;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>mkdir -p <span class=nv>$HOME</span>/.nix/var/nix/profiles/
</span></span><span class=line><span class=ln>2</span><span class=cl>nix-env -i nix -f <span class=nv>$HOME</span>/Git/Github/nixpkgs -j<span class=k>$(</span>nproc<span class=k>)</span> --keep-going --show-trace -v --cores <span class=m>4</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>|</span> tee nix-no-root.log
</span></span><span class=line><span class=ln>3</span><span class=cl>ml load nix/bootstrapped
</span></span></code></pre></div><p>This will still take a couple of hours at least. Around 3-4 hours. Try to set this up on a lazy weekend to evade sysadmins.</p><p>If <code>curl 429</code> rate limits are encountered for <code>musl</code> sources, the solution is to replace the source (put the following in a file, say <code>no429.patch</code>):</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=ln> 1</span><span class=cl><span class=n>diff</span> <span class=err>--</span><span class=n>git</span> <span class=sr>a/pkgs/os-specific/linux/musl/default.nix</span> <span class=sr>b/pkgs/os-specific/linux/musl/default.nix</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=n>index</span> <span class=n>ae175a3</span><span class=o>..</span><span class=err>1</span><span class=n>a6f6c7</span> <span class=mi>100644</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=err>---</span> <span class=sr>a/pkgs/os-specific/linux/musl/default.nix</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=o>+++</span> <span class=sr>b/pkgs/os-specific/linux/musl/default.nix</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=o>@@</span> <span class=mi>-4</span><span class=err>,</span><span class=mi>12</span> <span class=o>+</span><span class=mi>4</span><span class=err>,</span><span class=mi>12</span> <span class=o>@@</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl> <span class=err>}</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl> <span class=k>let</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>   <span class=n>cdefs_h</span> <span class=o>=</span> <span class=n>fetchurl</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=err>-</span>    <span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;http://git.alpinelinux.org/cgit/aports/plain/main/libc-dev/sys-cdefs.h&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=o>+</span>    <span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;https://raw.githubusercontent.com/akadata/aports/master/main/libc-dev/sys-cdefs.h&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>     <span class=n>sha256</span> <span class=o>=</span> <span class=s2>&#34;16l3dqnfq0f20rzbkhc38v74nqcsh9n3f343bpczqq8b1rz6vfrh&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>   <span class=p>};</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>   <span class=n>queue_h</span> <span class=o>=</span> <span class=n>fetchurl</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=err>-</span>    <span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;http://git.alpinelinux.org/cgit/aports/plain/main/libc-dev/sys-queue.h&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl><span class=err>-</span>    <span class=n>sha256</span> <span class=o>=</span> <span class=s2>&#34;12qm82id7zys92a1qh2l1qf2wqgq6jr4qlbjmqyfffz3s3nhfd61&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=o>+</span>    <span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;https://raw.githubusercontent.com/akadata/aports/master/main/libc-dev/sys-queue.h&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=o>+</span>    <span class=n>sha256</span> <span class=o>=</span> <span class=s2>&#34;049pd547ckrsky72s18a649mz660yph14wdrlw9gnbk903skdnz4&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>   <span class=p>};</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>   <span class=n>tree_h</span> <span class=o>=</span> <span class=n>fetchurl</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>     <span class=n>url</span> <span class=o>=</span> <span class=s2>&#34;http://git.alpinelinux.org/cgit/aports/plain/main/libc-dev/sys-tree.h&#34;</span><span class=p>;</span>
</span></span></code></pre></div><p>This can be applied with <code>git apply</code>.</p><h2 id=usage>Usage</h2><p>We have finally obtained a bootstrapped <code>nix</code> which is bound to our set of <code>nixpkgs</code>. To ensure its use:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>ml use <span class=nv>$HOME</span>/Modulefiles
</span></span><span class=line><span class=ln>2</span><span class=cl>ml purge
</span></span><span class=line><span class=ln>3</span><span class=cl>ml load nix/bootstrapped
</span></span><span class=line><span class=ln>4</span><span class=cl>ml save
</span></span></code></pre></div><h3 id=flakes-and-devshells>Flakes and DevShells</h3><p>Newer versions of <code>nix</code> depend on <code>mdbook</code> which is meant for generating the documentation. Unfortunately, the <code>cargo256</code> hashes are path dependent. A quick fix is to remove the dependency on <code>mdbook</code> and disable documentation generation with the following ugly patch:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=ln> 1</span><span class=cl><span class=n>diff</span> <span class=err>--</span><span class=n>git</span> <span class=sr>a/pkgs/tools/package-management/nix/default.nix</span> <span class=sr>b/pkgs/tools/package-management/nix/default.nix</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=n>index</span> <span class=err>7</span><span class=n>eda5ae</span><span class=o>..</span><span class=err>91</span><span class=n>bf1b8</span> <span class=mi>100644</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=err>---</span> <span class=sr>a/pkgs/tools/package-management/nix/default.nix</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=o>+++</span> <span class=sr>b/pkgs/tools/package-management/nix/default.nix</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=o>@@</span> <span class=mi>-14</span><span class=err>,</span><span class=mi>7</span> <span class=o>+</span><span class=mi>14</span><span class=err>,</span><span class=mi>7</span> <span class=o>@@</span> <span class=n>common</span> <span class=err>=</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>   <span class=err>,</span> <span class=n>pkg-config</span><span class=err>,</span> <span class=n>boehmgc</span><span class=err>,</span> <span class=n>libsodium</span><span class=err>,</span> <span class=n>brotli</span><span class=err>,</span> <span class=n>boost</span><span class=err>,</span> <span class=n>editline</span><span class=err>,</span> <span class=n>nlohmann_json</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>   <span class=err>,</span> <span class=n>autoreconfHook</span><span class=err>,</span> <span class=n>autoconf-archive</span><span class=err>,</span> <span class=n>bison</span><span class=err>,</span> <span class=n>flex</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>   <span class=err>,</span> <span class=n>jq</span><span class=err>,</span> <span class=n>libarchive</span><span class=err>,</span> <span class=n>libcpuid</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=err>-</span>  <span class=err>,</span> <span class=n>lowdown</span><span class=err>,</span> <span class=n>mdbook</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=o>+</span>  <span class=err>,</span> <span class=n>lowdown</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>   <span class=c1># Used by tests</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>   <span class=err>,</span> <span class=n>gtest</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>   <span class=err>,</span> <span class=n>busybox-sandbox-shell</span>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=o>@@</span> <span class=mi>-36</span><span class=err>,</span><span class=mi>7</span> <span class=o>+</span><span class=mi>36</span><span class=err>,</span><span class=mi>7</span> <span class=o>@@</span> <span class=n>common</span> <span class=err>=</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl>       <span class=n>VERSION_SUFFIX</span> <span class=err>=</span> <span class=n>suffix</span><span class=p>;</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>
</span></span><span class=line><span class=ln>18</span><span class=cl><span class=err>-</span>      <span class=n>outputs</span> <span class=err>=</span> <span class=p>[</span> <span class=s2>&#34;out&#34;</span> <span class=s2>&#34;dev&#34;</span> <span class=s2>&#34;man&#34;</span> <span class=s2>&#34;doc&#34;</span> <span class=p>];</span>
</span></span><span class=line><span class=ln>19</span><span class=cl><span class=o>+</span>      <span class=n>outputs</span> <span class=err>=</span> <span class=p>[</span> <span class=s2>&#34;out&#34;</span> <span class=s2>&#34;dev&#34;</span> <span class=p>];</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>
</span></span><span class=line><span class=ln>21</span><span class=cl>       <span class=n>nativeBuildInputs</span> <span class=err>=</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>         <span class=p>[</span> <span class=n>pkg-config</span> <span class=p>]</span>
</span></span><span class=line><span class=ln>23</span><span class=cl><span class=o>@@</span> <span class=mi>-45</span><span class=err>,</span><span class=mi>7</span> <span class=o>+</span><span class=mi>45</span><span class=err>,</span><span class=mi>6</span> <span class=o>@@</span> <span class=n>common</span> <span class=err>=</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>           <span class=p>[</span> <span class=n>autoreconfHook</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>             <span class=n>autoconf-archive</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>             <span class=n>bison</span> <span class=n>flex</span>
</span></span><span class=line><span class=ln>27</span><span class=cl><span class=err>-</span>            <span class=p>(</span><span class=n>lib</span><span class=o>.</span><span class=n>getBin</span> <span class=n>lowdown</span><span class=p>)</span> <span class=n>mdbook</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>             <span class=n>jq</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>            <span class=p>];</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>
</span></span><span class=line><span class=ln>31</span><span class=cl><span class=o>@@</span> <span class=mi>-119</span><span class=err>,</span><span class=mi>8</span> <span class=o>+</span><span class=mi>118</span><span class=err>,</span><span class=mi>8</span> <span class=o>@@</span> <span class=n>common</span> <span class=err>=</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>         <span class=p>[</span> <span class=s2>&#34;--with-store-dir=</span><span class=si>${</span><span class=n>storeDir</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>           <span class=s2>&#34;--localstatedir=</span><span class=si>${</span><span class=n>stateDir</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>           <span class=s2>&#34;--sysconfdir=</span><span class=si>${</span><span class=n>confDir</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln>35</span><span class=cl><span class=err>-</span>          <span class=s2>&#34;--disable-init-state&#34;</span>
</span></span><span class=line><span class=ln>36</span><span class=cl>           <span class=s2>&#34;--enable-gc&#34;</span>
</span></span><span class=line><span class=ln>37</span><span class=cl><span class=o>+</span>          <span class=s2>&#34;--disable-doc-gen&#34;</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>         <span class=p>]</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>         <span class=o>++</span> <span class=n>lib</span><span class=o>.</span><span class=n>optionals</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>isLinux</span> <span class=p>[</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>           <span class=s2>&#34;--with-sandbox-shell=</span><span class=si>${</span><span class=n>sh</span><span class=si>}</span><span class=s2>/bin/busybox&#34;</span>
</span></span><span class=line><span class=ln>41</span><span class=cl><span class=o>@@</span> <span class=mi>-136</span><span class=err>,</span><span class=mi>7</span> <span class=o>+</span><span class=mi>135</span><span class=err>,</span><span class=mi>8</span> <span class=o>@@</span> <span class=n>common</span> <span class=err>=</span>
</span></span><span class=line><span class=ln>42</span><span class=cl>
</span></span><span class=line><span class=ln>43</span><span class=cl>       <span class=n>installFlags</span> <span class=err>=</span> <span class=p>[</span> <span class=s2>&#34;sysconfdir=$(out)/etc&#34;</span> <span class=p>];</span>
</span></span><span class=line><span class=ln>44</span><span class=cl>
</span></span><span class=line><span class=ln>45</span><span class=cl><span class=err>-</span>      <span class=n>doInstallCheck</span> <span class=err>=</span> <span class=no>true</span><span class=p>;</span> <span class=c1># not cross</span>
</span></span><span class=line><span class=ln>46</span><span class=cl><span class=o>+</span>      <span class=n>doInstallCheck</span> <span class=err>=</span> <span class=no>false</span><span class=p>;</span> <span class=c1># not cross</span>
</span></span><span class=line><span class=ln>47</span><span class=cl><span class=o>+</span>      <span class=n>doCheck</span> <span class=err>=</span> <span class=no>false</span><span class=p>;</span>
</span></span><span class=line><span class=ln>48</span><span class=cl>
</span></span><span class=line><span class=ln>49</span><span class=cl>       <span class=c1># socket path becomes too long otherwise</span>
</span></span><span class=line><span class=ln>50</span><span class=cl>       <span class=n>preInstallCheck</span> <span class=err>=</span> <span class=n>lib</span><span class=o>.</span><span class=n>optionalString</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>isDarwin</span> <span class=s1>&#39;&#39;
</span></span></span><span class=line><span class=ln>51</span><span class=cl><span class=s1>@@ -160,7 +160,7 @@ common =
</span></span></span><span class=line><span class=ln>52</span><span class=cl><span class=s1>         license = lib.licenses.lgpl2Plus;
</span></span></span><span class=line><span class=ln>53</span><span class=cl><span class=s1>         maintainers = [ lib.maintainers.eelco ];
</span></span></span><span class=line><span class=ln>54</span><span class=cl><span class=s1>         platforms = lib.platforms.unix;
</span></span></span><span class=line><span class=ln>55</span><span class=cl><span class=s1>-        outputsToInstall = [ &#34;out&#34; &#34;man&#34; ];
</span></span></span><span class=line><span class=ln>56</span><span class=cl><span class=s1>+        outputsToInstall = [ &#34;out&#34; ];
</span></span></span><span class=line><span class=ln>57</span><span class=cl><span class=s1>       };
</span></span></span><span class=line><span class=ln>58</span><span class=cl><span class=s1>
</span></span></span><span class=line><span class=ln>59</span><span class=cl><span class=s1>       passthru = {
</span></span></span></code></pre></div><p>We also need to update our <code>config.nix</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=ln> 1</span><span class=cl><span class=n>nixUnstable</span> <span class=err>=</span> <span class=n>nixUnstable</span><span class=o>.</span><span class=n>overrideAttrs</span> <span class=p>(</span><span class=n>oldAttrs</span><span class=p>:</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=n>storeDir</span> <span class=o>=</span> <span class=s2>&#34;/users/home/rog32/.nix/store&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>    <span class=n>stateDir</span> <span class=o>=</span> <span class=s2>&#34;/users/home/rog32/.nix/var&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=n>confDif</span> <span class=o>=</span> <span class=s2>&#34;/users/home/rog32/.nix/etc&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=n>doCheck</span> <span class=o>=</span> <span class=no>false</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=n>doInstallCheck</span> <span class=o>=</span> <span class=no>false</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=n>prePatch</span> <span class=o>=</span> <span class=s1>&#39;&#39;
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=s1>      substituteInPlace src/libstore/local-store.cc \
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=s1>        --replace &#39;(eaName == &#34;security.selinux&#34;)&#39; \
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=s1>                  &#39;(eaName == &#34;security.selinux&#34; || eaName == &#34;system.nfs4_acl&#34;)&#39;
</span></span></span><span class=line><span class=ln>11</span><span class=cl><span class=s1>      substituteInPlace src/libstore/gc.cc \
</span></span></span><span class=line><span class=ln>12</span><span class=cl><span class=s1>        --replace &#39;auto mapLines =&#39; \
</span></span></span><span class=line><span class=ln>13</span><span class=cl><span class=s1>                  &#39;continue; auto mapLines =&#39;
</span></span></span><span class=line><span class=ln>14</span><span class=cl><span class=s1>     &#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>   <span class=p>});</span>
</span></span></code></pre></div><p>Now we can finally get to the installation of a newer version. I prefer to live life on the edge:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>nix-env -iA nixUnstable -f <span class=nv>$HOME</span>/Git/Github/nixpkgs -j<span class=k>$(</span>nproc<span class=k>)</span> --keep-going --show-trace --cores <span class=m>4</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>|</span> tee nix-install-base.log
</span></span></code></pre></div><p>We are now able activate flakes and other features like <code>nix shell</code> (note the space!).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cfg data-lang=cfg><span class=line><span class=ln>1</span><span class=cl><span class=c1># ~/.config/nix/nix.conf</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=na>experimental-features</span> <span class=o>=</span> <span class=s>nix-command flakes</span>
</span></span></code></pre></div><h4 id=bonus-fixing-documentation>Bonus: Fixing Documentation</h4><p>In order to get the original derivation working, we need to essentially modify the <code>cargo256</code> hashes. Thankfully the <code>nix</code> build log is rather verbose.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>installing
</span></span><span class=line><span class=ln>2</span><span class=cl>error: <span class=nb>hash</span> mismatch in fixed-output derivation <span class=s1>&#39;/users/home/jdoen/.nix/sto$
</span></span></span><span class=line><span class=ln>3</span><span class=cl><span class=s1>e/n71nkimlbazmq1vpyyavqcxzg9c86brs-mdbook-0.4.7-vendor.tar.gz.drv&#39;</span>:
</span></span><span class=line><span class=ln>4</span><span class=cl>         specified: sha256-2kBJcImytsSd7Q0kj1bsP/NXxyy2Pr8gHb8iNf6h3/4<span class=o>=</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>            got:    sha256-4bYLrmyI7cPUes6DYREiIB9gDze0KO2jMP/jPzvWbwQ<span class=o>=</span>
</span></span><span class=line><span class=ln>6</span><span class=cl>error: <span class=m>1</span> dependencies of derivation <span class=s1>&#39;/users/home/jdoen/.nix/store/wr31pgva8a
</span></span></span><span class=line><span class=ln>7</span><span class=cl><span class=s1>zn9jvvpa4bshykv80xf5qi-mdbook-0.4.7.drv&#39;</span> failed to build
</span></span><span class=line><span class=ln>8</span><span class=cl>error: <span class=m>1</span> dependencies of derivation <span class=s1>&#39;/users/home/jdoen/.nix/store/y8pkc0hhgz
</span></span></span><span class=line><span class=ln>9</span><span class=cl><span class=s1>rvxgrj7c00mmsy50plya6p-nix-2.4pre20210326_dd77f71.drv&#39;</span> failed to build
</span></span></code></pre></div><p>We need to modify <code>pkgs/tools/text/mdbook/default.nix</code> to update the hash; and then:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>nix-env -iA nixUnstable -f <span class=nv>$HOME</span>/Git/Github/nixpkgs -j<span class=k>$(</span>nproc<span class=k>)</span> --keep-going --show-trace --cores <span class=m>4</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>|</span> tee nix-install-base.log
</span></span><span class=line><span class=ln>2</span><span class=cl>ml load nix/bootstrapped
</span></span><span class=line><span class=ln>3</span><span class=cl>nix-shell --help <span class=c1># Works</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>nix-shell -p hello <span class=c1># Also works</span>
</span></span></code></pre></div><h4 id=channels>Channels</h4><p>We would like to move away from having to constantly pass our cloned set of packages.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>nix-channel --add https://nixos.org/channels/nixpkgs-unstable nixpkgs
</span></span><span class=line><span class=ln>2</span><span class=cl>nix-channel --update
</span></span></code></pre></div><h3 id=basic-packages>Basic Packages</h3><p>Now we can get some basic stuff too.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>nix-env -i tmux zsh lsof pv git -f <span class=nv>$HOME</span>/Git/Github/nixpkgs -j<span class=k>$(</span>nproc<span class=k>)</span> --keep-going --show-trace --cores <span class=m>4</span> 2&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>|</span> tee nix-install-base.log
</span></span></code></pre></div><h3 id=ruby-caveats>Ruby Caveats</h3><blockquote><p>No longer relevant as of April 2020</p></blockquote><p>While installing packages which depend on <code>ruby</code>, there will be permission errors inside the build folder. These can be &ldquo;fixed&rdquo; by setting very permissive controls on the <strong>build-directory</strong> in question. <strong>Do not</strong> set permissions directly on the <code>.nix/store/$HASH</code> folder, as doing so will make <code>nix</code> reject the build artifact.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># neovim depends on ruby</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>nix-env -i neovim -v -f <span class=nv>$HOME</span>/Git/Github/nixpkgs
</span></span></code></pre></div><p>A more elegant way to fix permissions involves a slightly more convoluted approach. We can note where the build is occurring (e.g. <code>/tmp</code>) and run a <code>watch</code> command to fix permissions.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>watch -n1 -x chmod <span class=m>777</span> -R /tmp/nix-build-ruby-2.6.6.drv-0/source/lib/
</span></span></code></pre></div><p>Naturally this must be run in a separate window.</p><h3 id=dotfiles>Dotfiles</h3><p>Feel free to set up <code>dotfiles</code> (<a href=https://github.com/HaoZeke/Dotfiles>mine</a>, perhaps) to profit even further. We will consider the process of obtaining my set below.
Minimally, we will want to obtain <code>tmux</code> and <code>zsh</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>nix-env -i tmux zsh -v -f <span class=nv>$HOME</span>/Git/Github/nixpkgs
</span></span></code></pre></div><p>Now we can set the <code>dotfiles</code> up.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>git clone https://github.com/HaoZeke/Dotfiles
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=nb>cd</span> Dotfiles
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=nv>$HOME</span>/.local/bin/dotgit restore hzhpc
</span></span></code></pre></div><p>The final installation configures <code>neovim</code> and <code>tmux</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>zsh
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=c1># Should install things with zinit</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>tmux
</span></span><span class=line><span class=ln>4</span><span class=cl><span class=c1># CTRL+b --&gt; SHIFT+I to install</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>nvim
</span></span></code></pre></div><h3 id=misc-nfs>Misc NFS</h3><p>For issues concerning NFS lock files, consider simply moving the problematic file and let things sort themselves out. Consider:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>nix-build
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=c1># something about a .nfs lockfile in some .nix/$HASH-pkg/.nfs0234234</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>mv .nix/<span class=nv>$HASH</span>-pkg/ .diePKGs/
</span></span><span class=line><span class=ln>4</span><span class=cl>nix-build <span class=c1># profit</span>
</span></span></code></pre></div><p>The right way to deal with this is of course:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>nix-build
</span></span><span class=line><span class=ln>2</span><span class=cl>lsof +D .nix/<span class=nv>$HASH</span>-pkg/.nfs0234234
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=nb>kill</span> <span class=nv>$whatever_blocks</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>nix-build <span class=c1># profit</span>
</span></span></code></pre></div><h2 id=conclusions>Conclusions</h2><p>Though this is slow and seems like an inefficient use of cluster resources, the benefits of reproducible environments typically outweighs the cost. Also it is much more pleasant to have a proper package manager which can work with Dotfiles.</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>Note that this will of course entail rebuilding everything from scratch, every time, which means no binary caches. Thus there is no reasonable defence for trying this out without access to a high powered limited access machine&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>The rest of the post assumes we are on the same page and working towards the same end-goal, substitute and remix at will&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=/tags/workflow>workflow</a></span><span class=tag><a href=/tags/projects>projects</a></span><span class=tag><a href=/tags/hpc>hpc</a></span><span class=tag><a href=/tags/nix>nix</a></span><span class=tag><a href=/tags/tools>tools</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>2147 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Posted: <time class=dt-published>2020-09-07 18:30 +0000</time></p><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frgoswami.me%2fposts%2flocal-nix-no-root%2f" target=_blank rel=noopener aria-label=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15.84 9.5H13.5V8.48c0-.53.35-.65.6-.65h1.4v-2.3h-2.35c-2.3.0-2.65 1.7-2.65 2.8V9.5h-2v2h2v7h3v-7h2.1l.24-2z"/></svg></div>Facebook</div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=%22Local%20Nix%20without%20Root%22%20seems%20like%20an%20interesting%20read%20from%20%40rg0swami&amp;url=https%3a%2f%2frgoswami.me%2fposts%2flocal-nix-no-root%2f" target=_blank rel=noopener aria-label=Twitter><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.5 7.4l-2 .2c-.4-.5-1-.8-2-.8C13.3 6.8 12 8 12 9.4v.6c-2 0-4-1-5.4-2.7-.2.4-.3.8-.3 1.3.0 1 .4 1.7 1.2 2.2-.5.0-1 0-1.2-.3.0 1.3 1 2.3 2 2.6-.3.4-.7.4-1 0 .2 1.4 1.2 2 2.3 2-1 1-2.5 1.4-4 1 1.3 1 2.7 1.4 4.2 1.4 4.8.0 7.5-4 7.5-7.5v-.4c.5-.4.8-1.5 1.2-2z"/><circle cx="12" cy="12" r="11.5"/></svg></div>Twitter</div></a><a class=resp-sharing-button__link href="mailto:?subject=%22Local%20Nix%20without%20Root%22%20seems%20interesting...&amp;body=https%3a%2f%2frgoswami.me%2fposts%2flocal-nix-no-root%2f" target=_self rel=noopener aria-label=E-Mail><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.5 16c0 .8-.7 1.5-1.5 1.5H6c-.8.0-1.5-.7-1.5-1.5V8c0-.8.7-1.5 1.5-1.5h12c.8.0 1.5.7 1.5 1.5v8zm-2-7.5L12 13 6.5 8.5m11 6-4-2.5m-7 2.5 4-2.5"/><circle cx="12" cy="12" r="11.5"/></svg></div>E-Mail</div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frgoswami.me%2fposts%2flocal-nix-no-root%2f&amp;title=%22Local%20Nix%20without%20Root%22%20seems%20interesting...&amp;summary=%22Local%20Nix%20without%20Root%22%20seems%20interesting...&amp;source=https%3a%2f%2frgoswami.me%2fposts%2flocal-nix-no-root%2f" target=_blank rel=noopener aria-label=LinkedIn><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15 12.5c-.28.0-.5.22-.5.5v3.5h-3s.03-6.48.0-7h3v.83s.46-.75 1.7-.75c1.56.0 2.3 1.12 2.3 3.3v3.62h-3V13c0-.28-.23-.5-.5-.5zm-7.5-3h2v7h-2z"/><circle cx="8.5" cy="6.5" r="1"/></svg></div>LinkedIn</div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2frgoswami.me%2fposts%2flocal-nix-no-root%2f&amp;resubmit=true&amp;title=%22Local%20Nix%20without%20Root%22%20seems%20interesting..." target=_blank rel=noopener aria-label=Reddit><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><ellipse cx="12" cy="14.37" rx="6.2" ry="4.24"/><path d="M14.3 16.25c-.62.36-1.42.57-2.3.57s-1.7-.2-2.32-.58"/><circle cx="14.61" cy="13.39" r=".98"/><circle cx="9.39" cy="13.39" r=".98"/><path d="M16.4 11.38c.26-.55.82-.92 1.47-.92.9.0 1.63.73 1.63 1.63.0.8-.6 1.47-1.38 1.6"/><circle cx="17.22" cy="7.52" r="1.63"/><path d="M7.6 11.38c-.26-.54-.82-.92-1.47-.92-.9.0-1.63.73-1.63 1.63.0.8.6 1.47 1.38 1.6M12 10.12s-.08-4.82 3.6-2.6"/></svg></div>Reddit</div></a><a class=resp-sharing-button__link href="whatsapp://send?text=%22Local%20Nix%20without%20Root%22%20seems%20interesting...%20https%3a%2f%2frgoswami.me%2fposts%2flocal-nix-no-root%2f" target=_blank rel=noopener aria-label=WhatsApp><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle xmlns="http://www.w3.org/2000/svg" cx="12" cy="12" r="11.5"/><path stroke-width="1" d="M17.6 6.2c-1.5-1.5-3.4-2.3-5.5-2.3-4.3.0-7.8 3.5-7.8 7.8.0 1.4.4 2.7 1 3.9l-1.1 4 4.1-1.1c1.1.6 2.4.9 3.7.9 4.3.0 7.8-3.5 7.8-7.8.1-2-.7-3.9-2.2-5.4zm-5.5 11.9c-1.2.0-2.3-.3-3.3-.9l-.2-.1-2.4.6.7-2.4-.2-.2c-.6-1-1-2.2-1-3.4.0-3.6 2.9-6.5 6.5-6.5 1.7.0 3.3.7 4.6 1.9 1.2 1.2 1.9 2.8 1.9 4.6-.1 3.5-3 6.4-6.6 6.4zm3.5-4.8c-.2-.1-1.1-.6-1.3-.6-.2-.1-.3-.1-.4.1s-.5.6-.6.8c-.1.1-.2.1-.4.0s-.8-.3-1.6-1c-.6-.5-1-1.2-1.1-1.3-.1-.2.0-.3.1-.4l.3-.3s.1-.2.2-.3c.1-.1.0-.2.0-.3s-.4-1.1-.6-1.4c-.2-.4-.3-.3-.4-.3h-.4s-.3.0-.5.2-.7.7-.7 1.6c0 1 .7 1.9.8 2s1.4 2.1 3.3 2.9c.5.2.8.3 1.1.4.5.1.9.1 1.2.1.4-.1 1.1-.5 1.3-.9.2-.5.2-.8.1-.9.0-.2-.2-.3-.4-.4z"/></svg></div>WhatsApp</div></a></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://rgoswami.me/posts/doc-cpp-dox-sph-exhale/><span class=button__icon>←</span>
<span class=button__text>Documenting C++ with Doxygen and Sphinx - Exhale</span>
</a></span><span class="button next"><a href=https://rgoswami.me/posts/mach-nix-niv-python/><span class=button__text>Niv and Mach-Nix for Nix Python</span>
<span class=button__icon>→</span></a></span></div></div><div id=comments class=thin><div class=pagination__title><span class=pagination__title-h>Comments</span><hr></div><script src=https://utteranc.es/client.js repo=haozeke/haozeke.github.io issue-term=pathname theme=photon-dark label="Utterance 💬" crossorigin=anonymous async></script></div></main><footer class=footer><p>&copy; 2024
<span><a href=https://rgoswami.me/>Rohit Goswami (HaoZeke)</a></span>
<a href=/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a><br><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a>.
Powered by <a href=http://gohugo.io><u>Hugo</u></a> and <a href=https://github.com/HaoZeke/hugo-theme-hello-friend-ng-hz><u>this theme</u></a>.</br>Hosted with <u><a href=https://www.netlify.com/>Netlify</a></u>.</br><script src=https://liberapay.com/rohit/widgets/button.js></script><noscript><a href=https://liberapay.com/rohit/donate><img alt="Donate using Liberapay" src=https://liberapay.com/assets/widgets/donate.svg></a></noscript></p></footer></div><script src=/bundle.min.5fae9992ea406007408dc33b0b3a8376d61e2f1d6ac50ba1dad7580ac50afb5199bcef3bbc3677e77553a9980bf882cf71edc2f755687dd7725f12ece4304ac2.js></script><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-109503488-16","auto"),ga("send","pageview")</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","3z2xvwqu4u")</script><script data-goatcounter=https://rgoswami.goatcounter.com/count async src=//gc.zgo.at/count.js></script><script>var clicky_site_ids=clicky_site_ids||[];clicky_site_ids.push("101265002")</script><script async src=https://static.getclicky.com/js></script><script src=https://cdn.jsdelivr.net/npm/readmore-js@3.0.0-beta-1/dist/readmore.min.js></script><script src=/js/codefold.min.f0790269b87613b3bcff64022840fe1991eee3ea384e874c78a24022c9936bd888a3c14a05a10955881eebb1558e4fcf37576dac120cd0bf4ebaf7aca27b35b1.js></script><script src=/js/copyClipboard.min.1c92539aea398296101add0e80508ad94cb59fb37f946f06ec9ca1c7558a961b8de0c5595a921aed70aa91eb94d24db35e5a01243bc625f8b1814b17928f478b.js></script></body></html>