<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="[Rohit Goswami]"><meta name=description content="Exploring meson for interfacing fortran and python via f2py and standard techniques, with benchmarks.
 Background A recent post gauging community interest in f2py brought to light (among other aspects) the fact that the build systems of f2py are rather opaque to the end user. There are good reasons for this, since many of the tools discussed in this post were not around / in any shape to be used during the active development of f2py1."><meta name=keywords content=",python,fortran,rambling"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://rgoswami.me/posts/numpy-meson-f2py/><title>NumPy, Meson and f2py :: Rohit Goswami — Reflections</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.min.b6dbce0fdf6c61563a0c2226e857d5dadd8e5afa2c4f73ec9ea55abd831f9a72.css><meta itemprop=name content="NumPy, Meson and f2py"><meta itemprop=description content="Exploring meson for interfacing fortran and python via f2py and standard techniques, with benchmarks.
 Background A recent post gauging community interest in f2py brought to light (among other aspects) the fact that the build systems of f2py are rather opaque to the end user. There are good reasons for this, since many of the tools discussed in this post were not around / in any shape to be used during the active development of f2py1."><meta itemprop=datePublished content="2021-09-23T05:45:00+00:00"><meta itemprop=dateModified content="2021-09-23T05:45:00+00:00"><meta itemprop=wordCount content="2170"><meta itemprop=image content="https://rgoswami.me/images/RG.png"><meta itemprop=keywords content="python,fortran,rambling,"><meta property="og:title" content="NumPy, Meson and f2py"><meta property="og:description" content="Exploring meson for interfacing fortran and python via f2py and standard techniques, with benchmarks.
 Background A recent post gauging community interest in f2py brought to light (among other aspects) the fact that the build systems of f2py are rather opaque to the end user. There are good reasons for this, since many of the tools discussed in this post were not around / in any shape to be used during the active development of f2py1."><meta property="og:type" content="article"><meta property="og:url" content="https://rgoswami.me/posts/numpy-meson-f2py/"><meta property="og:image" content="https://rgoswami.me/images/RG.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-09-23T05:45:00+00:00"><meta property="article:modified_time" content="2021-09-23T05:45:00+00:00"><meta property="og:site_name" content="Rohit Goswami"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rgoswami.me/images/RG.png"><meta name=twitter:title content="NumPy, Meson and f2py"><meta name=twitter:description content="Exploring meson for interfacing fortran and python via f2py and standard techniques, with benchmarks.
 Background A recent post gauging community interest in f2py brought to light (among other aspects) the fact that the build systems of f2py are rather opaque to the end user. There are good reasons for this, since many of the tools discussed in this post were not around / in any shape to be used during the active development of f2py1."><meta property="article:section" content="notes"><meta property="article:published_time" content="2021-09-23 05:45:00 +0000 UTC"></head><body><div class=container><header class=header><div class=header__inner><div class=header__left><div class=logo><a href=/ style=text-decoration:none><img src=/images/home.png alt></a></div></div><div class=header__mid><button class=button><div class=button__text><a href=https://rgoswami.me//search>Search</a></div></button></div><div class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://rgoswami.me/about>About</a></li><li><a href=https://rgoswami.me/posts>Blog</a></li></ul><ul class=menu__inner><li><a href=https://rgoswami.me/categories>Categories</a></li><li><a href=https://rgoswami.me/tags>Tags</a></li></ul></nav><button id=toggleMenu><div class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></div></button>
<button class=theme-toggle id=toggleTheme><svg class="theme-toggler" width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></button></div></div></header><script src=https://rgoswami.me/js/mathjax-config.js></script><script id=MathJax-script async src=https://unpkg.com/mathjax@3/es5/tex-chtml.js></script><aside class=sidebar><div class=hideTOC><button id=tocTog>TOC</button><div class="sideTOC m-fadeOut"><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#the-fibonacci-example>The Fibonacci example</a></li><li><a href=#numpy-distutils>NumPy Distutils</a></li><li><a href=#meson-and-f2py>Meson and F2PY</a></li><li><a href=#standard-bindings>Standard Bindings</a><ul><li><a href=#ctypes-wrapper><code>ctypes</code> Wrapper</a></li><li><a href=#cython-wrapper>Cython wrapper</a></li><li><a href=#python-c-api>Python-C API</a></li></ul></li><li><a href=#benchmarks>Benchmarks</a></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></div></div></aside><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>11 minutes<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Written: 2021-09-23 05:45 +0000</p></p></div><article class=h-entry><h1 class="post-title p-name"><a class=u-url href=https://rgoswami.me/posts/numpy-meson-f2py/>NumPy, Meson and f2py</a></h1><div class=post-info><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pen-tool"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg><span class="author u-author p-author"><a href=https://rgoswami.me/author/rohit-goswami>Rohit Goswami</a></span></div><hr><aside id=toc class=sidebar><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#background>Background</a></li><li><a href=#the-fibonacci-example>The Fibonacci example</a></li><li><a href=#numpy-distutils>NumPy Distutils</a></li><li><a href=#meson-and-f2py>Meson and F2PY</a></li><li><a href=#standard-bindings>Standard Bindings</a><ul><li><a href=#ctypes-wrapper><code>ctypes</code> Wrapper</a></li><li><a href=#cython-wrapper>Cython wrapper</a></li><li><a href=#python-c-api>Python-C API</a></li></ul></li><li><a href=#benchmarks>Benchmarks</a></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></aside><hr><div class="post-content e-content"><blockquote><p>Exploring <code>meson</code> for interfacing <code>fortran</code> and <code>python</code> via <code>f2py</code> and standard techniques, with benchmarks.</p></blockquote><h2 id=background>Background</h2><p>A <a href=https://fortran-lang.discourse.group/t/about-f2py-ipc-and-wrappers/1838>recent post</a> gauging community interest in <code>f2py</code> brought to light (among other
aspects) the fact that the build systems of <code>f2py</code> are rather opaque to the end
user. There are good reasons for this, since many of the tools discussed in this
post were not around / in any shape to be used during the active development of
<code>f2py</code><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. Nevertheless, build systems have come a long way from the early 2000s
and the next two decades of <code>f2py</code>, will certainly involve less dependence on
the soon-to-be-gone <code>numpy.distutils</code> approach to building extension modules.</p><h2 id=the-fibonacci-example>The Fibonacci example</h2><p>Though rather contrived and overused<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>, for the rest of this post I will assume the following Fortran program, in a variety of guises.</p><div class=highlight><pre class=chroma><code class=language-fortran data-lang=fortran><span class=n>C</span> <span class=k>FILE</span><span class=p>:</span> <span class=n>FIB1</span><span class=p>.</span><span class=n>F</span>
      <span class=k>SUBROUTINE </span><span class=n>FIB</span><span class=p>(</span><span class=n>A</span><span class=p>,</span><span class=n>N</span><span class=p>)</span>
<span class=n>C</span>
<span class=n>C</span>     <span class=n>CALCULATE</span> <span class=n>FIRST</span> <span class=n>N</span> <span class=n>FIBONACCI</span> <span class=n>NUMBERS</span>
<span class=n>C</span>
      <span class=kt>INTEGER </span><span class=n>N</span>
      <span class=kt>REAL</span><span class=o>*</span><span class=mi>8</span> <span class=n>A</span><span class=p>(</span><span class=n>N</span><span class=p>)</span>
      <span class=k>DO </span><span class=n>I</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span><span class=n>N</span>
         <span class=k>IF</span> <span class=p>(</span><span class=n>I</span><span class=p>.</span><span class=n>EQ</span><span class=p>.</span><span class=mi>1</span><span class=p>)</span> <span class=k>THEN
</span><span class=k>            </span><span class=n>A</span><span class=p>(</span><span class=n>I</span><span class=p>)</span> <span class=o>=</span> <span class=mf>0.0D0</span>
         <span class=n>ELSEIF</span> <span class=p>(</span><span class=n>I</span><span class=p>.</span><span class=n>EQ</span><span class=p>.</span><span class=mi>2</span><span class=p>)</span> <span class=k>THEN
</span><span class=k>            </span><span class=n>A</span><span class=p>(</span><span class=n>I</span><span class=p>)</span> <span class=o>=</span> <span class=mf>1.0D0</span>
         <span class=k>ELSE
</span><span class=k>            </span><span class=n>A</span><span class=p>(</span><span class=n>I</span><span class=p>)</span> <span class=o>=</span> <span class=n>A</span><span class=p>(</span><span class=n>I</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>A</span><span class=p>(</span><span class=n>I</span><span class=o>-</span><span class=mi>2</span><span class=p>)</span>
         <span class=n>ENDIF</span>
      <span class=n>ENDDO</span>
      <span class=k>END
</span><span class=k></span><span class=n>C</span> <span class=k>END FILE </span><span class=n>FIB1</span><span class=p>.</span><span class=n>F</span>
</code></pre></div><p>Keeping in mind the fact that the fixed form syntax is deprecated, we will also consider the more standard compliant and modern form:</p><div class=highlight><pre class=chroma><code class=language-f90 data-lang=f90><span class=k>module </span><span class=n>fib1</span>
  <span class=k>implicit none
</span><span class=k>  contains
</span><span class=k>    subroutine </span><span class=n>fib</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=n>n</span><span class=p>)</span>
      <span class=kt>integer</span><span class=p>,</span> <span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>)</span> <span class=kd>::</span> <span class=n>n</span>
      <span class=kt>integer</span> <span class=kd>::</span> <span class=n>i</span>
      <span class=kt>real</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=kd>::</span> <span class=n>a</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
      <span class=k>do </span><span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>n</span>
         <span class=k>if</span> <span class=p>(</span><span class=n>i</span><span class=o>==</span><span class=mi>1</span><span class=p>)</span> <span class=k>then
</span><span class=k>            </span><span class=n>a</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=mf>0.0d0</span>
         <span class=k>else if</span> <span class=p>(</span><span class=n>i</span><span class=o>==</span><span class=mi>2</span><span class=p>)</span> <span class=k>then
</span><span class=k>            </span><span class=n>a</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=mf>1.0d0</span>
        <span class=k>else
</span><span class=k>            </span><span class=n>a</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=n>a</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>a</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>2</span><span class=p>)</span>
         <span class=k>end if
</span><span class=k>      end do
</span><span class=k>      end subroutine
</span><span class=k>end module </span><span class=n>fib1</span>
</code></pre></div><p>Note that this program in its current form is not really an executable, as it is essentially a subprogram; and needs to be coupled to a <code>main</code> program to work from <code>fortran</code>. This does not concern us really since we will be primarily using <code>python</code> to drive user interaction. However, for completeness (<code>gfortran main.f fib1.f</code>):</p><div class=highlight><pre class=chroma><code class=language-fortran data-lang=fortran><span class=k>PROGRAM </span><span class=n>MAIN</span>
<span class=kt>INTEGER</span><span class=p>,</span> <span class=k>PARAMETER</span> <span class=kd>::</span> <span class=n>N</span><span class=o>=</span><span class=mi>7</span>
<span class=kt>REAL</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=kd>::</span> <span class=n>A</span><span class=p>(</span><span class=n>N</span><span class=p>)</span>
<span class=k>CALL </span><span class=n>FIB</span><span class=p>(</span><span class=n>A</span><span class=p>,</span><span class=n>N</span><span class=p>)</span>
<span class=k>PRINT</span><span class=o>*</span><span class=p>,</span> <span class=n>A</span>
<span class=k>END PROGRAM</span>
</code></pre></div><p>Along with the non-scream-case version (<code>gfortran main.f90 fib1.f90</code>):</p><div class=highlight><pre class=chroma><code class=language-f90 data-lang=f90><span class=k>program </span><span class=n>main</span>
  <span class=k>use </span><span class=n>fib1</span><span class=p>,</span> <span class=n>only</span><span class=p>:</span> <span class=n>fib</span>
  <span class=k>implicit none
</span><span class=k>  </span><span class=kt>integer</span><span class=p>,</span> <span class=k>parameter</span> <span class=kd>::</span> <span class=n>n</span> <span class=o>=</span> <span class=mi>7</span>
  <span class=kt>real</span><span class=p>(</span><span class=mi>8</span><span class=p>)</span> <span class=kd>::</span> <span class=n>a</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
  <span class=k>call </span><span class=n>fib</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=n>n</span><span class=p>)</span>
  <span class=k>print</span><span class=o>*</span><span class=p>,</span> <span class=n>a</span>
<span class=k>end program </span><span class=n>main</span>
</code></pre></div><h2 id=numpy-distutils>NumPy Distutils</h2><p>It would be remiss to not cover the most basic example of working with this. We can compile and try this out with the following:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>f2py -m fib -c fib1.f
python -c <span class=s2>&#34;import fib; import numpy as np; a=np.zeros(7); fib.fib(a); print(a); exit();&#34;</span>
</code></pre></div><p>This is good enough, and there are standard extensions to expose more information to the binding, detailed <a href=https://numpy.org/devdocs/f2py/f2py.getting-started.html>in the documentation</a>. That, however isn&rsquo;t the point. The <code>-c</code> flag, convenient in many ways though it is, is a proxy for a rather more involved set of files.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>mkdir blah
f2py -m fib -c fib1.f --build-dir blah
tree blah
blah
├── blah
│   └── src.macosx-10.9-x86_64-3.9
│       ├── blah
│       │   └── src.macosx-10.9-x86_64-3.9
│       │       ├── fortranobject.o
│       │       └── fortranobject.o.d
│       ├── fibmodule.o
│       └── fibmodule.o.d
├── fib1.o
└── src.macosx-10.9-x86_64-3.9
    ├── blah
    │   └── src.macosx-10.9-x86_64-3.9
    │       ├── fortranobject.c
    │       └── fortranobject.h
    └── fibmodule.c

<span class=m>7</span> directories, <span class=m>8</span> files
</code></pre></div><p>Indeed, the standard usage is to use a <code>setup.py</code>:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>numpy.distutils.core</span> <span class=kn>import</span> <span class=n>Extension</span><span class=p>,</span> <span class=n>setup</span>
<span class=n>fibby</span> <span class=o>=</span> <span class=n>Extension</span><span class=p>(</span><span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;fib&#39;</span><span class=p>,</span>
                  <span class=n>sources</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;fib1.f&#39;</span><span class=p>])</span>
<span class=k>if</span> <span class=vm>__name__</span> <span class=o>==</span> <span class=s2>&#34;__main__&#34;</span><span class=p>:</span>
    <span class=n>setup</span><span class=p>(</span><span class=n>name</span> <span class=o>=</span> <span class=s1>&#39;fib&#39;</span><span class=p>,</span> <span class=n>ext_modules</span> <span class=o>=</span> <span class=p>[</span> <span class=n>fibby</span> <span class=p>])</span>
</code></pre></div><p>Which can then be built simply with:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>python setup.py build
ag -g .so
<span class=c1># build/lib.macosx-10.9-x86_64-3.9/fib.cpython-39-darwin.so</span>
</code></pre></div><p>However this does not scale very well with more general build systems, though a
custom command approach for <code>CMake</code> and <code>scikit-build</code> is a <a href=https://github.com/Nicholaswogan/skbuild-f2py-examples>nice workaround by
Nick Wogan</a>.</p><h2 id=meson-and-f2py>Meson and F2PY</h2><p>As <code>scipy</code> <a href=https://labs.quansight.org/blog/2021/07/moving-scipy-to-meson/>moves towards meson</a> mainly driven by <a href=https://rgommers.github.io/>Ralf Gommers</a>, it makes sense to look into its use to drive the compilation of an extension module as well. We start by generating the files for the interface.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>f2py fib1.f -m fib
Reading fortran codes...
      Reading file <span class=s1>&#39;fib1.f&#39;</span> <span class=o>(</span>format:fix,strict<span class=o>)</span>
Post-processing...
      Block: fib
                      Block: FIB
Post-processing <span class=o>(</span>stage 2<span class=o>)</span>...
Building modules...
      Building module <span class=s2>&#34;fib&#34;</span>...
              Constructing wrapper <span class=k>function</span> <span class=s2>&#34;FIB&#34;</span>...
                FIB<span class=o>(</span>A,<span class=o>[</span>N<span class=o>])</span>
      Wrote C/API module <span class=s2>&#34;fib&#34;</span> to file <span class=s2>&#34;./fibmodule.c&#34;</span>
</code></pre></div><p>Before we can compile this with <code>meson</code> we need to make a few changes:</p><ul><li>Replace <code>FIB</code> with <code>fib</code> in <code>fibmodule.c</code> (since <code>C</code> is case-sensitive)</li><li>Copy <code>f2py</code>&rsquo;s Fortran-C-Python translation unit and header files <code>fortranobject.{c,h}</code></li></ul><p>With these in place, we can now setup our <code>meson.build</code>.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>project(&#39;test_builds&#39;, &#39;c&#39;,
  version : &#39;0.1&#39;,
  default_options : [&#39;warning_level=3&#39;])

add_languages(&#39;fortran&#39;)

# https://mesonbuild.com/Python-module.html
# requires atleast 0.46.0
py_mod = import(&#39;python&#39;)
py3 = py_mod.find_installation()
py3_dep = py3.dependency()

incdir_numpy = run_command(py3,
  [&#39;-c&#39;, &#39;import os; os.chdir(&#34;..&#34;); import numpy; print(numpy.get_include())&#39;],
  check : true
).stdout().strip()

inc_np = include_directories(incdir_numpy)

py3.extension_module(&#39;fib1&#39;,
           &#39;fib1.f&#39;,
           &#39;fib1module.c&#39;,
           &#39;fortranobject.c&#39;,
           include_directories: inc_np,
           dependencies : py3_dep,
           install : true)
</code></pre></div><p>Now we&rsquo;re all set.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>meson setup builddir
meson compile -C builddir
<span class=nb>cd</span> builddir
python -c <span class=s2>&#34;import fib1; import numpy as np; a=np.empty(7); fib1.fib(a); print(a); exit();&#34;</span>
</code></pre></div><p>This makes for a far more pleasant experience, since <code>meson</code> works well with larger projects as well. However, note the sizes (and complexities) of the <code>C</code> portions.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>wc -l fortranobject.c fortranobject.h fibmodule.c
    <span class=m>1107</span> fortranobject.c
     <span class=m>132</span> fortranobject.h
     <span class=m>372</span> fibmodule.c
    <span class=m>1611</span> total
</code></pre></div><p>Not something we&rsquo;d probably like to mess around with. Standardization reduces the burden of user-code, as we will see in the next section.</p><h2 id=standard-bindings>Standard Bindings</h2><p>The standard compliant approach was aptly covered almost a decade ago by <a href=https://ondrejcertik.com/>Ondřej Čertík</a> and codified in <a href=https://www.fortran90.org/src/best-practices.html#python-interface>fortran90&rsquo;s best practices guide</a>. We start by updating our free-form code to be compliant with newer <code>ISO_C_BINDING</code> guidelines.</p><div class=highlight><pre class=chroma><code class=language-f90 data-lang=f90><span class=k>module </span><span class=n>fib1</span>
  <span class=k>use </span><span class=nb>iso_c_binding
</span><span class=nb>  </span><span class=k>implicit none
</span><span class=k>  contains
</span><span class=k>    subroutine </span><span class=n>fib</span><span class=p>(</span><span class=n>a</span><span class=p>,</span><span class=n>n</span><span class=p>)</span> <span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>,</span><span class=n>name</span><span class=o>=</span><span class=s1>&#39;c_fib&#39;</span><span class=p>)</span>
      <span class=kt>integer</span><span class=p>(</span><span class=kt>c_int</span><span class=p>),</span> <span class=k>intent</span><span class=p>(</span><span class=n>in</span><span class=p>),</span> <span class=k>value</span> <span class=kd>::</span> <span class=n>n</span>
      <span class=kt>integer</span><span class=p>(</span><span class=kt>c_int</span><span class=p>)</span> <span class=kd>::</span> <span class=n>i</span>
      <span class=kt>real</span><span class=p>(</span><span class=kt>c_double</span><span class=p>)</span> <span class=kd>::</span> <span class=n>a</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
      <span class=k>do </span><span class=n>i</span><span class=o>=</span><span class=mi>1</span><span class=p>,</span> <span class=n>n</span>
         <span class=k>if</span> <span class=p>(</span><span class=n>i</span><span class=o>==</span><span class=mi>1</span><span class=p>)</span> <span class=k>then
</span><span class=k>            </span><span class=n>a</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=mf>0.0d0</span>
         <span class=k>else if</span> <span class=p>(</span><span class=n>i</span><span class=o>==</span><span class=mi>2</span><span class=p>)</span> <span class=k>then
</span><span class=k>            </span><span class=n>a</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=mf>1.0d0</span>
        <span class=k>else
</span><span class=k>            </span><span class=n>a</span><span class=p>(</span><span class=n>i</span><span class=p>)</span> <span class=o>=</span> <span class=n>a</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>1</span><span class=p>)</span> <span class=o>+</span> <span class=n>a</span><span class=p>(</span><span class=n>i</span><span class=o>-</span><span class=mi>2</span><span class=p>)</span>
         <span class=k>end if
</span><span class=k>      end do
</span><span class=k>      end subroutine
</span><span class=k>end module </span><span class=n>fib1</span>
</code></pre></div><p>The key differences are the <code>c_type</code> declarations and the <code>bind(c,name='blah')</code> attribute. Also, to reduce the number of pointers for easy to copy types, we used <code>value</code>; which causes behavior similar to the pass-by-value paradigm. With this, the a <code>C</code> driver can be as simple as:</p><div class=highlight><pre class=chroma><code class=language-C data-lang=C><span class=cm>/* fibby.c */</span>
<span class=cp>#include</span><span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span><span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>void</span> <span class=nf>c_fib</span><span class=p>(</span><span class=kt>double</span> <span class=o>*</span><span class=n>a</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>);</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[</span><span class=n>argc</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span> <span class=p>{</span>
    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;Fortran fib from C:&#34;</span><span class=p>);</span>
    <span class=kt>int</span> <span class=n>n</span><span class=o>=</span><span class=mi>7</span><span class=p>;</span>
    <span class=kt>double</span> <span class=n>a</span><span class=p>[</span><span class=n>n</span><span class=p>];</span>
    <span class=n>c_fib</span><span class=p>(</span><span class=o>&amp;</span><span class=n>a</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>
    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%f &#34;</span><span class=p>,</span><span class=n>a</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
    <span class=p>};</span>
    <span class=k>return</span> <span class=n>EXIT_SUCCESS</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>This can now be built via:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>gfortran -c fib1.f90
gcc fibby.c fib1.o
</code></pre></div><h3 id=ctypes-wrapper><code>ctypes</code> Wrapper</h3><p>To wrap this over to <code>python</code> we have a few options. We can omit <code>main</code> altogether and rely on <code>ctypes</code>. So with:</p><div class=highlight><pre class=chroma><code class=language-C data-lang=C><span class=cm>/* cfib.c */</span>
<span class=kt>void</span> <span class=nf>c_fib</span><span class=p>(</span><span class=kt>double</span> <span class=o>*</span><span class=n>a</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>);</span>
</code></pre></div><p>Followed by:</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>gfortran -c fib1.f90
gcc -fPIC -shared -o libfib.so cfib.c fib1.o
</code></pre></div><p>We can work with this in <code>python</code> as:</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>from</span> <span class=nn>ctypes</span> <span class=kn>import</span> <span class=n>CDLL</span><span class=p>,</span> <span class=n>POINTER</span><span class=p>,</span> <span class=n>c_int</span><span class=p>,</span> <span class=n>c_double</span>
<span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>
<span class=n>fibby</span> <span class=o>=</span> <span class=n>CDLL</span><span class=p>(</span><span class=s2>&#34;libfib.so&#34;</span><span class=p>)</span>
<span class=n>a</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=mi>7</span><span class=p>)</span>
<span class=n>fibby</span><span class=o>.</span><span class=n>c_fib</span><span class=p>(</span><span class=n>a</span><span class=o>.</span><span class=n>ctypes</span><span class=o>.</span><span class=n>data_as</span><span class=p>(</span><span class=n>POINTER</span><span class=p>(</span><span class=n>c_double</span><span class=p>)),</span> <span class=n>c_int</span><span class=p>(</span><span class=mi>7</span><span class=p>))</span>
<span class=nb>print</span><span class=p>(</span><span class=n>a</span><span class=p>)</span>
</code></pre></div><p>Which works in the same exact way as the previous approaches.</p><blockquote><p>We have gone from over a \(1000\) lines of <code>C</code> to <strong>one line</strong><sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup></p></blockquote><h3 id=cython-wrapper>Cython wrapper</h3><p>However, we can skip even the one line of <code>C</code>, by using <code>cython</code>.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=c1># fibby.pyx</span>
<span class=kn>from</span> <span class=nn>numpy</span> <span class=n>cimport</span> <span class=n>ndarray</span>
<span class=kn>import</span> <span class=nn>numpy</span> <span class=k>as</span> <span class=nn>np</span>

<span class=n>cdef</span> <span class=n>extern</span><span class=p>:</span>
    <span class=n>void</span> <span class=n>c_fib</span><span class=p>(</span><span class=n>double</span> <span class=o>*</span><span class=n>a</span><span class=p>,</span> <span class=nb>int</span> <span class=n>n</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>fib</span><span class=p>(</span><span class=n>double</span> <span class=n>a</span><span class=p>,</span> <span class=nb>int</span> <span class=n>n</span><span class=p>):</span>
    <span class=n>cdef</span> <span class=n>ndarray</span><span class=p>[</span><span class=n>double</span><span class=p>,</span> <span class=n>mode</span><span class=o>=</span><span class=s2>&#34;c&#34;</span><span class=p>]</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>np</span><span class=o>.</span><span class=n>zeros</span><span class=p>(</span><span class=n>n</span><span class=p>)</span>
    <span class=n>c_fib</span><span class=p>(</span><span class=o>&amp;</span><span class=n>ret</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span><span class=n>n</span><span class=p>)</span>
    <span class=k>return</span> <span class=n>ret</span>
</code></pre></div><p>This however, is closer to <code>f2py</code> in the sense that the <code>C</code> code is simply hidden. It requires a compilation step typically done via <code>setuptools.py</code>, however this is much nicer with <code>meson</code> since from <code>0.59.0</code>, <a href=https://mesonbuild.com/Cython.html%20>Cython is supported</a>.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>project</span><span class=p>(</span><span class=s1>&#39;test_builds&#39;</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>,</span>
  <span class=n>version</span> <span class=p>:</span> <span class=s1>&#39;0.1&#39;</span><span class=p>,</span>
  <span class=n>default_options</span> <span class=p>:</span> <span class=p>[</span><span class=s1>&#39;warning_level=3&#39;</span><span class=p>])</span>

<span class=n>add_languages</span><span class=p>(</span><span class=s1>&#39;fortran&#39;</span><span class=p>,</span> <span class=s1>&#39;cython&#39;</span><span class=p>)</span>

<span class=n>py_mod</span> <span class=o>=</span> <span class=n>import</span><span class=p>(</span><span class=s1>&#39;python&#39;</span><span class=p>)</span>
<span class=n>py3</span> <span class=o>=</span> <span class=n>py_mod</span><span class=o>.</span><span class=n>find_installation</span><span class=p>()</span>
<span class=n>py3_dep</span> <span class=o>=</span> <span class=n>py3</span><span class=o>.</span><span class=n>dependency</span><span class=p>()</span>

<span class=n>py3</span><span class=o>.</span><span class=n>extension_module</span><span class=p>(</span><span class=s1>&#39;fibby&#39;</span><span class=p>,</span>
  <span class=s1>&#39;fibby.pyx&#39;</span><span class=p>,</span>
  <span class=n>dependencies</span> <span class=p>:</span> <span class=n>py3_dep</span>
<span class=p>)</span>
</code></pre></div><p>As before.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>meson setup bdircython
meson compile -C bdircython
<span class=nb>cd</span> bdircython
python -c <span class=s2>&#34;import fibby; import numpy as np; a=np.empty(15); fibby.fib(a[0],15); print(a); exit();&#34;</span>
</code></pre></div><p>Note the difference in the calling semantics here. Also, recall that <code>.pyx</code> files are actually used to generate <code>C</code> code.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>cython fibby.pyx
wc -l fibby.c
    <span class=m>6376</span> fibby.c
</code></pre></div><p>This is vastly more code compared to the <code>f2py</code> generated wrapper code; which
seems pretty unattractive.</p><h3 id=python-c-api>Python-C API</h3><p>Neither <code>ctypes</code> nor <code>cpython</code> is as friendly/clean as loading an extension
module, so it makes more sense to actually write a proper <code>Python-C</code>
extension module for a more fair comparison. This however, involves quite some
reference counting and familiarity with the <a href=https://numpy.org/devdocs/user/c-info.how-to-extend.html>NumPy-C API</a>. Actually it is not too
bad for the function we are considering. Even a well commented and naive hand crafted
version clocks in below 90 lines of code.</p><div class=highlight><pre class=chroma><code class=language-C data-lang=C><span class=cp>#ifndef PY_SSIZE_T_CLEAN
</span><span class=cp>#define PY_SSIZE_T_CLEAN
</span><span class=cp>#endif </span><span class=cm>/* PY_SSIZE_T_CLEAN */</span><span class=cp>
</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&#34;Python.h&#34;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&#34;numpy/ndarrayobject.h&#34;</span><span class=cp>
</span><span class=cp>#include</span> <span class=cpf>&#34;numpy/ufuncobject.h&#34;</span><span class=cp>
</span><span class=cp></span>
<span class=k>static</span> <span class=n>PyMethodDef</span> <span class=n>FibbyMethods</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
        <span class=p>{</span><span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>}</span>
<span class=p>};</span>

<span class=kt>void</span> <span class=nf>c_fib</span><span class=p>(</span><span class=kt>double</span> <span class=o>*</span><span class=n>a</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>);</span>

<span class=cm>/* The loop definition must precede the PyMODINIT_FUNC. */</span>

<span class=k>static</span> <span class=kt>void</span> <span class=nf>double_fib</span><span class=p>(</span><span class=kt>char</span> <span class=o>**</span><span class=n>args</span><span class=p>,</span> <span class=n>npy_intp</span> <span class=o>*</span><span class=n>dimensions</span><span class=p>,</span>
                            <span class=n>npy_intp</span><span class=o>*</span> <span class=n>steps</span><span class=p>,</span> <span class=kt>void</span><span class=o>*</span> <span class=n>data</span><span class=p>)</span>
<span class=p>{</span>
    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span> <span class=c1>// Standard integer is fine here
</span><span class=c1></span>    <span class=n>npy_intp</span> <span class=n>n</span> <span class=o>=</span> <span class=n>dimensions</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
    <span class=kt>char</span> <span class=o>*</span><span class=n>in</span> <span class=o>=</span> <span class=n>args</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=o>*</span><span class=n>out</span> <span class=o>=</span> <span class=n>args</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
    <span class=n>npy_intp</span> <span class=n>in_step</span> <span class=o>=</span> <span class=n>steps</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span> <span class=n>out_step</span> <span class=o>=</span> <span class=n>steps</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>

    <span class=kt>double</span> <span class=n>apointer</span><span class=p>[</span><span class=n>n</span><span class=p>];</span>

    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=n>apointer</span><span class=p>[</span><span class=n>i</span><span class=p>]</span><span class=o>=</span><span class=p>(</span><span class=kt>double</span><span class=p>)</span><span class=n>in</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
    <span class=p>}</span>

    <span class=c1>// Call the Fortran function
</span><span class=c1></span>    <span class=n>c_fib</span><span class=p>(</span><span class=n>apointer</span><span class=p>,</span> <span class=n>n</span><span class=p>);</span>

    <span class=k>for</span> <span class=p>(</span><span class=n>i</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
        <span class=cm>/*BEGIN main ufunc computation*/</span>
        <span class=o>*</span><span class=p>((</span><span class=kt>double</span> <span class=o>*</span><span class=p>)</span><span class=n>out</span><span class=p>)</span> <span class=o>=</span> <span class=n>apointer</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
        <span class=cm>/*END main ufunc computation*/</span>

        <span class=n>in</span> <span class=o>+=</span> <span class=n>in_step</span><span class=p>;</span>
        <span class=n>out</span> <span class=o>+=</span> <span class=n>out_step</span><span class=p>;</span>
    <span class=p>}</span>
<span class=p>}</span>

<span class=cm>/*This a pointer to the above function*/</span>
<span class=n>PyUFuncGenericFunction</span> <span class=n>funcs</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=o>&amp;</span><span class=n>double_fib</span><span class=p>};</span>

<span class=cm>/* These are the input and return dtypes of fib.*/</span>
<span class=k>static</span> <span class=kt>char</span> <span class=n>types</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=n>NPY_DOUBLE</span><span class=p>,</span> <span class=n>NPY_DOUBLE</span><span class=p>};</span>

<span class=k>static</span> <span class=kt>void</span> <span class=o>*</span><span class=n>data</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span><span class=nb>NULL</span><span class=p>};</span>

<span class=k>static</span> <span class=k>struct</span> <span class=n>PyModuleDef</span> <span class=n>moduledef</span> <span class=o>=</span> <span class=p>{</span>
    <span class=n>PyModuleDef_HEAD_INIT</span><span class=p>,</span>
    <span class=s>&#34;fibby&#34;</span><span class=p>,</span>
    <span class=nb>NULL</span><span class=p>,</span>
    <span class=o>-</span><span class=mi>1</span><span class=p>,</span>
    <span class=n>FibbyMethods</span><span class=p>,</span>
    <span class=nb>NULL</span><span class=p>,</span>
    <span class=nb>NULL</span><span class=p>,</span>
    <span class=nb>NULL</span><span class=p>,</span>
    <span class=nb>NULL</span>
<span class=p>};</span>

<span class=n>PyMODINIT_FUNC</span> <span class=nf>PyInit_fibby</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>m</span><span class=p>,</span> <span class=o>*</span><span class=n>fib</span><span class=p>,</span> <span class=o>*</span><span class=n>d</span><span class=p>;</span>
    <span class=n>m</span> <span class=o>=</span> <span class=n>PyModule_Create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>moduledef</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>m</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=n>import_array</span><span class=p>();</span>
    <span class=n>import_umath</span><span class=p>();</span>

    <span class=n>fib</span> <span class=o>=</span> <span class=n>PyUFunc_FromFuncAndData</span><span class=p>(</span><span class=n>funcs</span><span class=p>,</span> <span class=n>data</span><span class=p>,</span> <span class=n>types</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span>
                                    <span class=n>PyUFunc_None</span><span class=p>,</span> <span class=s>&#34;fib&#34;</span><span class=p>,</span>
                                    <span class=s>&#34;Calls the fib.f90 Fibonacci subroutine&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>

    <span class=n>d</span> <span class=o>=</span> <span class=n>PyModule_GetDict</span><span class=p>(</span><span class=n>m</span><span class=p>);</span>

    <span class=n>PyDict_SetItemString</span><span class=p>(</span><span class=n>d</span><span class=p>,</span> <span class=s>&#34;fib&#34;</span><span class=p>,</span> <span class=n>fib</span><span class=p>);</span>
    <span class=n>Py_DECREF</span><span class=p>(</span><span class=n>fib</span><span class=p>);</span>

    <span class=k>return</span> <span class=n>m</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>Compiling this with <code>meson</code> is a snap.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=n>project</span><span class=p>(</span><span class=s1>&#39;test_builds&#39;</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>,</span>
  <span class=n>version</span> <span class=p>:</span> <span class=s1>&#39;0.1&#39;</span><span class=p>,</span>
  <span class=n>default_options</span> <span class=p>:</span> <span class=p>[</span><span class=s1>&#39;warning_level=3&#39;</span><span class=p>])</span>

<span class=n>add_languages</span><span class=p>(</span><span class=s1>&#39;fortran&#39;</span><span class=p>,</span> <span class=s1>&#39;cython&#39;</span><span class=p>)</span>

<span class=n>py_mod</span> <span class=o>=</span> <span class=n>import</span><span class=p>(</span><span class=s1>&#39;python&#39;</span><span class=p>)</span>
<span class=n>py3</span> <span class=o>=</span> <span class=n>py_mod</span><span class=o>.</span><span class=n>find_installation</span><span class=p>()</span>
<span class=n>py3_dep</span> <span class=o>=</span> <span class=n>py3</span><span class=o>.</span><span class=n>dependency</span><span class=p>()</span>

<span class=n>incdir_numpy</span> <span class=o>=</span> <span class=n>run_command</span><span class=p>(</span><span class=n>py3</span><span class=p>,</span>
  <span class=p>[</span><span class=s1>&#39;-c&#39;</span><span class=p>,</span> <span class=s1>&#39;import os; os.chdir(&#34;..&#34;); import numpy; print(numpy.get_include())&#39;</span><span class=p>],</span>
  <span class=n>check</span> <span class=p>:</span> <span class=n>true</span>
<span class=p>)</span><span class=o>.</span><span class=n>stdout</span><span class=p>()</span><span class=o>.</span><span class=n>strip</span><span class=p>()</span>

<span class=n>inc_np</span> <span class=o>=</span> <span class=n>include_directories</span><span class=p>(</span><span class=n>incdir_numpy</span><span class=p>)</span>

<span class=n>py3</span><span class=o>.</span><span class=n>extension_module</span><span class=p>(</span><span class=s1>&#39;fibby&#39;</span><span class=p>,</span>
  <span class=s1>&#39;fib1.f90&#39;</span><span class=p>,</span>
  <span class=s1>&#39;fibbyhand.c&#39;</span><span class=p>,</span>
  <span class=n>include_directories</span><span class=p>:</span> <span class=n>inc_np</span><span class=p>,</span>
  <span class=n>dependencies</span> <span class=p>:</span> <span class=n>py3_dep</span>
<span class=p>)</span>
</code></pre></div><p>We can compile this much the same as the others.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>meson setup bdircythonhand
meson compile -C bdircythonhand
<span class=nb>cd</span> bdircythonhand
python -c <span class=s2>&#34;import fibby; import numpy as np; a=np.empty(7); b=fibby.fib(a); print(b); exit();&#34;</span>
</code></pre></div><p>This has the lowest lines of code too.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>wc -l fibbyhand.c
      <span class=m>85</span> fibbyhand.c
</code></pre></div><p>It is rather remarkable since the <code>C</code> code here is not optimized in the least.
The twin <code>for</code> loops can almost certainly be handled more efficiently, and also
from the point of view of the Fortran-C interface too, this is lacking.
Nevertheless, it will suffice for our purpose here, which has more to do with
wrapping automatically (and therefore rather naively) than generating optimal
code (but that would be great).</p><h2 id=benchmarks>Benchmarks</h2><p>We can use <a href=https://lib.rs/crates/hyperfine>hyperfine</a> for basic benchmarks.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>hyperfine <span class=s1>&#39;python -c &#34;import fibby; import numpy as np; a=np.empty(7); b=fibby.fib(a); print(b); exit();&#34;&#39;</span> --warmup <span class=m>5</span> -s full -r <span class=m>25</span>
Benchmark <span class=c1>#1: python -c &#34;import fibby; import numpy as np; a=np.empty(7); b=fibby.fib(a); print(b); exit();&#34;</span>
  Time <span class=o>(</span>mean ± σ<span class=o>)</span>:     155.4 ms ±   9.7 ms    <span class=o>[</span>User: 133.1 ms, System: 40.2 ms<span class=o>]</span>
  Range <span class=o>(</span>min … max<span class=o>)</span>:   145.6 ms … 190.4 ms    <span class=m>25</span> runs
</code></pre></div><p>Results for the various approaches are collected below in Table <a href=#table--tbl:bench>tbl:bench</a>.</p><p><a id=table--tbl:bench></a></p><div class=table-caption><span class=table-number><a href=#table--tbl:bench>Table 1</a></span>:
The results are for 25 runs with 5 warmup for <code>np.empty(7)</code> as the input</div><table><thead><tr><th><strong>Command</strong></th><th><strong>Mean [ms]</strong></th><th><strong>Min [ms]</strong></th><th><strong>Max [ms]</strong></th></tr></thead><tbody><tr><td><strong>Handwritten NumPy-C-Fortran</strong></td><td><strong>146.6 ± 8.9</strong></td><td><strong>125.8</strong></td><td><strong>155.0</strong></td></tr><tr><td>F2PY (F77)</td><td>149.3 ± 1.7</td><td>146.1</td><td>152.7</td></tr><tr><td>Cython</td><td>150.0 ± 13.1</td><td>141.6</td><td>198.0</td></tr><tr><td>F2PY (F90)</td><td>150.2 ± 2.4</td><td>145.3</td><td>155.1</td></tr><tr><td>ctypes</td><td>150.5 ± 2.8</td><td>147.1</td><td>158.8</td></tr></tbody></table><p>As expected, <code>ctypes</code> is the slowest, since it requires the most massaging of
inputs on the Python side. Surprisingly, loading the free form file with <code>f2py</code>
was quite a bit slower than the <code>f77</code> file. Given the complexity of the files
involved, it is actually surprising that the handwritten wrapper shows a rather
clear gain in performance; given its implementation; but nonetheless it supports
the hypothesis that advances in the NumPy-C API and the Fortran-C
interoperability has improved significantly over time.</p><h2 id=conclusions>Conclusions</h2><p><code>f2py</code>, like <code>Fortran</code>, is here to stay. As the standards strive towards better
compliance with <code>C</code> however, it also gets larger and rather more
complicated <sup id=fnref:4><a href=#fn:4 class=footnote-ref role=doc-noteref>4</a></sup>. One thing which was not covered here was the
actual <code>ISO_Fortran_binding.h</code><sup id=fnref:5><a href=#fn:5 class=footnote-ref role=doc-noteref>5</a></sup> and other modifications to the <code>C</code>
code while interpolating with Fortran itself.</p><p>To hold its place in the larger ecosystem, <code>f2py</code>
will be essential in protecting the average user from the standard itself,
automatically providing optimal bindings for users as initially planned by <a href=https://github.com/pearu>Pearu
Peterson</a>. Modernization efforts with <a href=https://melissawm.github.io/about-me/>Melissa Weber Mendonça</a> and others at
Quansight (including <a href=https://rgoswami.me/about>me</a>) are sure to gravitate towards generating better, more
reliable interfaces to bridge the gaps between Fortran and Python as supported
by the NumPy core developers<sup id=fnref:6><a href=#fn:6 class=footnote-ref role=doc-noteref>6</a></sup>. Clearly, the way forward is to work in lockstep with the NumPy-C API and recent Fortran standards.</p><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p><code>Make</code>, <code>autotools</code> and the like are definitely worse than <code>np.distutils</code>&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2 role=doc-endnote><p>It is the first example from the <a href=https://numpy.org/devdocs/f2py/f2py.getting-started.html>canonical reference</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3 role=doc-endnote><p>This is a bit unfair, the complexity has been offloaded to the compiler, and they&rsquo;re notorious for not supporting newer Fortran standards&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:4 role=doc-endnote><p>Though it is and will remain far more svelte compared to <code>C++</code>&#160;<a href=#fnref:4 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:5 role=doc-endnote><p>Some examples from the community <a href=https://fortran-lang.discourse.group/t/iso-c-binding-pass-an-array-from-c-to-fortran-edit-python-interop-content/514>are here</a>&#160;<a href=#fnref:5 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:6 role=doc-endnote><p>Including a special shout out to <a href=https://github.com/charris>Charles Harris</a> for reviewing unreasonably large DOC PRs&#160;<a href=#fnref:6 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://rgoswami.me/tags/python>python</a></span><span class=tag><a href=https://rgoswami.me/tags/fortran>fortran</a></span><span class=tag><a href=https://rgoswami.me/tags/rambling>rambling</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>2170 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Posted: <time class=dt-published>2021-09-23 05:45 +0000</time></p><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frgoswami.me%2fposts%2fnumpy-meson-f2py%2f" target=_blank rel=noopener aria-label=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15.84 9.5H13.5V8.48c0-.53.35-.65.6-.65h1.4v-2.3h-2.35c-2.3.0-2.65 1.7-2.65 2.8V9.5h-2v2h2v7h3v-7h2.1l.24-2z"/></svg></div>Facebook</div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=%22NumPy%2c%20Meson%20and%20f2py%22%20seems%20like%20an%20interesting%20read%20from%20%40rg0swami&url=https%3a%2f%2frgoswami.me%2fposts%2fnumpy-meson-f2py%2f" target=_blank rel=noopener aria-label=Twitter><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.5 7.4l-2 .2c-.4-.5-1-.8-2-.8C13.3 6.8 12 8 12 9.4v.6c-2 0-4-1-5.4-2.7-.2.4-.3.8-.3 1.3.0 1 .4 1.7 1.2 2.2-.5.0-1 0-1.2-.3.0 1.3 1 2.3 2 2.6-.3.4-.7.4-1 0 .2 1.4 1.2 2 2.3 2-1 1-2.5 1.4-4 1 1.3 1 2.7 1.4 4.2 1.4 4.8.0 7.5-4 7.5-7.5v-.4c.5-.4.8-1.5 1.2-2z"/><circle cx="12" cy="12" r="11.5"/></svg></div>Twitter</div></a><a class=resp-sharing-button__link href="mailto:?subject=%22NumPy%2c%20Meson%20and%20f2py%22%20seems%20interesting...&body=https%3a%2f%2frgoswami.me%2fposts%2fnumpy-meson-f2py%2f" target=_self rel=noopener aria-label=E-Mail><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.5 16c0 .8-.7 1.5-1.5 1.5H6c-.8.0-1.5-.7-1.5-1.5V8c0-.8.7-1.5 1.5-1.5h12c.8.0 1.5.7 1.5 1.5v8zm-2-7.5L12 13 6.5 8.5m11 6-4-2.5m-7 2.5 4-2.5"/><circle cx="12" cy="12" r="11.5"/></svg></div>E-Mail</div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2frgoswami.me%2fposts%2fnumpy-meson-f2py%2f&title=%22NumPy%2c%20Meson%20and%20f2py%22%20seems%20interesting...&summary=%22NumPy%2c%20Meson%20and%20f2py%22%20seems%20interesting...&source=https%3a%2f%2frgoswami.me%2fposts%2fnumpy-meson-f2py%2f" target=_blank rel=noopener aria-label=LinkedIn><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15 12.5c-.28.0-.5.22-.5.5v3.5h-3s.03-6.48.0-7h3v.83s.46-.75 1.7-.75c1.56.0 2.3 1.12 2.3 3.3v3.62h-3V13c0-.28-.23-.5-.5-.5zm-7.5-3h2v7h-2z"/><circle cx="8.5" cy="6.5" r="1"/></svg></div>LinkedIn</div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2frgoswami.me%2fposts%2fnumpy-meson-f2py%2f&resubmit=true&title=%22NumPy%2c%20Meson%20and%20f2py%22%20seems%20interesting..." target=_blank rel=noopener aria-label=Reddit><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><ellipse cx="12" cy="14.37" rx="6.2" ry="4.24"/><path d="M14.3 16.25c-.62.36-1.42.57-2.3.57s-1.7-.2-2.32-.58"/><circle cx="14.61" cy="13.39" r=".98"/><circle cx="9.39" cy="13.39" r=".98"/><path d="M16.4 11.38c.26-.55.82-.92 1.47-.92.9.0 1.63.73 1.63 1.63.0.8-.6 1.47-1.38 1.6"/><circle cx="17.22" cy="7.52" r="1.63"/><path d="M7.6 11.38c-.26-.54-.82-.92-1.47-.92-.9.0-1.63.73-1.63 1.63.0.8.6 1.47 1.38 1.6M12 10.12s-.08-4.82 3.6-2.6"/></svg></div>Reddit</div></a><a class=resp-sharing-button__link href="whatsapp://send?text=%22NumPy%2c%20Meson%20and%20f2py%22%20seems%20interesting...%20https%3a%2f%2frgoswami.me%2fposts%2fnumpy-meson-f2py%2f" target=_blank rel=noopener aria-label=WhatsApp><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle xmlns="http://www.w3.org/2000/svg" cx="12" cy="12" r="11.5"/><path stroke-width="1" d="M17.6 6.2c-1.5-1.5-3.4-2.3-5.5-2.3-4.3.0-7.8 3.5-7.8 7.8.0 1.4.4 2.7 1 3.9l-1.1 4 4.1-1.1c1.1.6 2.4.9 3.7.9 4.3.0 7.8-3.5 7.8-7.8.1-2-.7-3.9-2.2-5.4zm-5.5 11.9c-1.2.0-2.3-.3-3.3-.9l-.2-.1-2.4.6.7-2.4-.2-.2c-.6-1-1-2.2-1-3.4.0-3.6 2.9-6.5 6.5-6.5 1.7.0 3.3.7 4.6 1.9 1.2 1.2 1.9 2.8 1.9 4.6-.1 3.5-3 6.4-6.6 6.4zm3.5-4.8c-.2-.1-1.1-.6-1.3-.6-.2-.1-.3-.1-.4.1s-.5.6-.6.8c-.1.1-.2.1-.4.0s-.8-.3-1.6-1c-.6-.5-1-1.2-1.1-1.3-.1-.2.0-.3.1-.4l.3-.3s.1-.2.2-.3c.1-.1.0-.2.0-.3s-.4-1.1-.6-1.4c-.2-.4-.3-.3-.4-.3h-.4s-.3.0-.5.2-.7.7-.7 1.6c0 1 .7 1.9.8 2s1.4 2.1 3.3 2.9c.5.2.8.3 1.1.4.5.1.9.1 1.2.1.4-.1 1.1-.5 1.3-.9.2-.5.2-.8.1-.9.0-.2-.2-.3-.4-.4z"/></svg></div>WhatsApp</div></a></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://rgoswami.me/posts/leshouches-2021-meta/><span class=button__text>Presentation Supplements for Greens Function School</span>
<span class=button__icon>→</span></a></span></div></div><div id=comments class=thin><div class=pagination__title><span class=pagination__title-h>Comments</span><hr></div><div id=remarkbox-div><noscript><iframe id=remarkbox-iframe src="https://my.remarkbox.com/embed?nojs=true" style=height:600px;width:100%;border:none!important tabindex=0></iframe></noscript></div><script src=https://my.remarkbox.com/static/js/iframe-resizer/iframeResizer.min.js></script><script>var rb_owner_key="8e660759-e7e6-11ea-9711-040140774501",thread_uri=window.location.href,thread_title=window.document.title,thread_fragment=window.location.hash,rb_src="https://my.remarkbox.com/embed?rb_owner_key="+rb_owner_key+"&thread_title="+encodeURI(thread_title)+"&thread_uri="+encodeURIComponent(thread_uri)+thread_fragment;function create_remarkbox_iframe(){var a=document.createElement("iframe");a.setAttribute("id","remarkbox-iframe"),a.setAttribute("scrolling","no"),a.setAttribute("src",rb_src),a.setAttribute("frameborder","0"),a.setAttribute("tabindex","0"),a.setAttribute("title","Remarkbox"),a.style.width="100%",document.getElementById("remarkbox-div").appendChild(a)}create_remarkbox_iframe(),iFrameResize({checkOrigin:["https://my.remarkbox.com"],inPageLinks:!0,initCallback:function(a){a.iFrameResizer.moveToAnchor(thread_fragment)}},document.getElementById("remarkbox-iframe"))</script></div></main><footer class=footer><p>&copy; 2021
<span><a href=https://rgoswami.me/>Rohit Goswami (HaoZeke)</a></span>
<a href=https://rgoswami.me/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a><br><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a>.
Powered by <a href=http://gohugo.io><u>Hugo</u></a> and <a href=https://github.com/HaoZeke/hugo-theme-hello-friend-ng-hz><u>this theme</u></a>.</br>Hosted with <u><a href=https://www.netlify.com/>Netlify</a></u>.</br><script src=https://liberapay.com/rohit/widgets/button.js></script><noscript><a href=https://liberapay.com/rohit/donate><img alt="Donate using Liberapay" src=https://liberapay.com/assets/widgets/donate.svg></a></noscript></p></footer></div><script src=/bundle.min.5fae9992ea406007408dc33b0b3a8376d61e2f1d6ac50ba1dad7580ac50afb5199bcef3bbc3677e77553a9980bf882cf71edc2f755687dd7725f12ece4304ac2.js></script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-109503488-16','auto'),ga('send','pageview')</script><script type=text/javascript>(function(a,e,b,f,g,c,d){a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},c=e.createElement(f),c.async=1,c.src="https://www.clarity.ms/tag/"+g,d=e.getElementsByTagName(f)[0],d.parentNode.insertBefore(c,d)})(window,document,"clarity","script","3z2xvwqu4u")</script><script data-goatcounter=https://rgoswami.goatcounter.com/count async src=//gc.zgo.at/count.js></script><script>var clicky_site_ids=clicky_site_ids||[];clicky_site_ids.push("101265002")</script><script async src=https://static.getclicky.com/js></script><script src=https://cdn.jsdelivr.net/npm/readmore-js@3.0.0-beta-1/dist/readmore.min.js></script><script src=/js/codefold.min.4a43062cb83308b55227adf937c91be79ff6d95df8bb821dfd71805ce54629ff8cffed3ae81d70fdee5f324fa0f39c5280ae785f165801885db074551a993a21.js></script></body></html>