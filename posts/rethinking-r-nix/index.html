<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=UTF-8><meta http-equiv=X-UA-Compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="[Rohit Goswami]"><meta name=description content="This post describes how to set up a transparent automated setup for reproducible R workflows using nixpkgs, niv, and lorri. The explanatory example used throughout the post is one of setting up the rethinking package and running some examples from the excellent second edition of &amp;ldquo;Statistical Rethinking&amp;rdquo; by Richard McElreath.
Background As detailed in an earlier post1, I had set up Nix to work with non-CRAN packages. If the rest of this section is unclear, please refer back to the earlier post."><meta name=keywords content="personal,tools,nix,workflow,R"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://rgoswami.me/posts/rethinking-r-nix/><meta name=generator content="Wooframework"><title>Statistical Rethinking and Nix :: Rohit Goswami — Reflections
</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.min.054e30538b054b321af6575a7659f551cec63e1cef6bbd674acccadf856d3aff.css><meta itemprop=name content="Statistical Rethinking and Nix"><meta itemprop=description content="This post describes how to set up a transparent automated setup for reproducible R workflows using nixpkgs, niv, and lorri. The explanatory example used throughout the post is one of setting up the rethinking package and running some examples from the excellent second edition of &ldquo;Statistical Rethinking&rdquo; by Richard McElreath.
Background As detailed in an earlier post1, I had set up Nix to work with non-CRAN packages. If the rest of this section is unclear, please refer back to the earlier post."><meta itemprop=datePublished content="2020-06-07T04:24:00+00:00"><meta itemprop=dateModified content="2020-06-07T04:24:00+00:00"><meta itemprop=wordCount content="2487"><meta itemprop=image content="https://rgoswami.me/images/RG.png"><meta itemprop=keywords content="tools,nix,workflow,R,"><meta property="og:title" content="Statistical Rethinking and Nix"><meta property="og:description" content="This post describes how to set up a transparent automated setup for reproducible R workflows using nixpkgs, niv, and lorri. The explanatory example used throughout the post is one of setting up the rethinking package and running some examples from the excellent second edition of &ldquo;Statistical Rethinking&rdquo; by Richard McElreath.
Background As detailed in an earlier post1, I had set up Nix to work with non-CRAN packages. If the rest of this section is unclear, please refer back to the earlier post."><meta property="og:type" content="article"><meta property="og:url" content="https://rgoswami.me/posts/rethinking-r-nix/"><meta property="og:image" content="https://rgoswami.me/images/RG.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-06-07T04:24:00+00:00"><meta property="article:modified_time" content="2020-06-07T04:24:00+00:00"><meta property="og:see_also" content="https://rgoswami.me/posts/emacs-nix-r/"><meta property="og:see_also" content="https://rgoswami.me/posts/nix-r-devtools/"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rgoswami.me/images/RG.png"><meta name=twitter:title content="Statistical Rethinking and Nix"><meta name=twitter:description content="This post describes how to set up a transparent automated setup for reproducible R workflows using nixpkgs, niv, and lorri. The explanatory example used throughout the post is one of setting up the rethinking package and running some examples from the excellent second edition of &ldquo;Statistical Rethinking&rdquo; by Richard McElreath.
Background As detailed in an earlier post1, I had set up Nix to work with non-CRAN packages. If the rest of this section is unclear, please refer back to the earlier post."><meta property="article:section" content="programming"><meta property="article:published_time" content="2020-06-07 04:24:00 +0000 UTC"></head><body class=dark-theme><div class=container><header class=header><div class=header__inner><div class=header__left><div class=logo><a href=/ style=text-decoration:none><img src=/images/home.png alt></a></div></div><div class=header__mid><button class=button><div class=button__text><a href=https://rgoswami.me//search>Search</a></div></button></div><div class=header__right><nav class=menu><ul class=menu__inner><li><a href=/about>About</a></li><li><a href=/posts>Blog</a></li><li><a href=/series>Series</a></li></ul><ul class=menu__inner><li><a href=/categories>Categories</a></li><li><a href=/snippets>Snippets</a></li><li><a href=/tags>Tags</a></li></ul></nav><button id=toggleMenu><div class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></div></button>
<button class=theme-toggle id=toggleTheme><svg class="theme-toggler" width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></button></div></div></header><script src=/js/mathjax-config.js></script><script id=MathJax-script async src=https://unpkg.com/mathjax@3/es5/tex-chtml.js></script><aside class=sidebar><div class=hideTOC><button id=tocTog>TOC</button><div class="sideTOC m-fadeOut"><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#setup>Setup</a></li><li><a href=#introspection>Introspection</a></li></ul></li><li><a href=#towards-reproducible-environments>Towards Reproducible Environments</a><ul><li><a href=#niv-and-pinning>Niv and Pinning</a></li><li><a href=#lorri-and-direnv>Lorri and Direnv</a></li></ul></li><li><a href=#rethinking>Rethinking</a></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></div></div></aside><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>12 minutes<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Written: 2020-06-07 04:24 +0000</p></p></div><article class=h-entry><h1 class="post-title p-name"><a class=u-url href=https://rgoswami.me/posts/rethinking-r-nix/>Statistical Rethinking and Nix</a></h1><div class=post-info><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pen-tool"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg><span class="author u-author p-author"><a href=/author/rohit-goswami>Rohit Goswami</a></span></div><hr><aside id=toc class=sidebar><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#setup>Setup</a></li><li><a href=#introspection>Introspection</a></li></ul></li><li><a href=#towards-reproducible-environments>Towards Reproducible Environments</a><ul><li><a href=#niv-and-pinning>Niv and Pinning</a></li><li><a href=#lorri-and-direnv>Lorri and Direnv</a></li></ul></li><li><a href=#rethinking>Rethinking</a></li><li><a href=#conclusions>Conclusions</a></li></ul></nav></aside><hr><div class="post-content e-content"><div class="notice--info post-series-top"><p>This post is part of the &lt;a href="https://rgoswami.me/series/r-x-nix-nexus-crafting-cohesive-environments/">R x Nix Nexus: Crafting Cohesive Environments&lt;/a> series.</p></div><blockquote><p>This post describes how to set up a transparent automated setup for reproducible
<code>R</code> workflows using <code>nixpkgs</code>, <code>niv</code>, and <code>lorri</code>. The explanatory example used
throughout the post is one of setting up the <code>rethinking</code> package and running
some examples
from the <a href=https://xcelab.net/rm/statistical-rethinking/>excellent second edition</a> of &ldquo;Statistical
Rethinking&rdquo; by <a href=https://twitter.com/rlmcelreath>Richard McElreath</a>.</p></blockquote><h2 id=background>Background</h2><p>As detailed <a href=/posts/nix-r-devtools/>in an earlier post</a><sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>, I had set up Nix to work with
non-CRAN packages. If the rest of this section is unclear, please refer back to <a href=/posts/nix-r-devtools/>the earlier post</a>.</p><h3 id=setup>Setup</h3><p>For the remainder of the post, we will set up a basic project structure:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>mkdir tryRnix/
</span></span></code></pre></div><p>Now we will create a <code>shell.nix</code> as<sup id=fnref:2><a href=#fn:2 class=footnote-ref role=doc-noteref>2</a></sup>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=ln> 1</span><span class=cl><span class=c1># shell.nix</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=p>{</span> <span class=n>pkgs</span> <span class=o>?</span> <span class=kn>import</span> <span class=sr>&lt;nixpkgs&gt;</span> <span class=p>{</span> <span class=p>}</span> <span class=p>}:</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>  <span class=n>my-r-pkgs</span> <span class=o>=</span> <span class=n>rWrapper</span><span class=o>.</span><span class=n>override</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=n>packages</span> <span class=o>=</span> <span class=k>with</span> <span class=n>rPackages</span><span class=p>;</span> <span class=p>[</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>      <span class=n>ggplot2</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>      <span class=n>tidyverse</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>      <span class=n>tidybayes</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>      <span class=n>tidybayes</span><span class=o>.</span><span class=n>rethinking</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>      <span class=p>(</span><span class=n>buildRPackage</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>        <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;rethinking&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>        <span class=n>src</span> <span class=o>=</span> <span class=n>fetchFromGitHub</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>          <span class=n>owner</span> <span class=o>=</span> <span class=s2>&#34;rmcelreath&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>          <span class=n>repo</span> <span class=o>=</span> <span class=s2>&#34;rethinking&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>          <span class=n>rev</span> <span class=o>=</span> <span class=s2>&#34;d0978c7f8b6329b94efa2014658d750ae12b1fa2&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>          <span class=n>sha256</span> <span class=o>=</span> <span class=s2>&#34;1qip6x3f6j9lmcmck6sjrj50a5azqfl6rfhp4fdj7ddabpb8n0z0&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>        <span class=p>};</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>        <span class=n>propagatedBuildInputs</span> <span class=o>=</span> <span class=p>[</span> <span class=n>coda</span> <span class=n>MASS</span> <span class=n>mvtnorm</span> <span class=n>loo</span> <span class=n>shape</span> <span class=n>rstan</span> <span class=n>dagitty</span> <span class=p>];</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>      <span class=p>})</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>23</span><span class=cl><span class=k>in</span> <span class=n>mkShell</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>  <span class=n>buildInputs</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>[</span> <span class=n>git</span> <span class=n>glibcLocales</span> <span class=n>openssl</span> <span class=n>which</span> <span class=n>openssh</span> <span class=n>curl</span> <span class=n>wget</span> <span class=p>];</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>  <span class=n>inputsFrom</span> <span class=o>=</span> <span class=p>[</span> <span class=n>my-r-pkgs</span> <span class=p>];</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>  <span class=n>shellHook</span> <span class=o>=</span> <span class=s1>&#39;&#39;
</span></span></span><span class=line><span class=ln>27</span><span class=cl><span class=s1>    mkdir -p &#34;$(pwd)/_libs&#34;
</span></span></span><span class=line><span class=ln>28</span><span class=cl><span class=s1>    export R_LIBS_USER=&#34;$(pwd)/_libs&#34;
</span></span></span><span class=line><span class=ln>29</span><span class=cl><span class=s1>  &#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>  <span class=n>GIT_SSL_CAINFO</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=n>cacert</span><span class=si>}</span><span class=s2>/etc/ssl/certs/ca-bundle.crt&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>  <span class=n>LOCALE_ARCHIVE</span> <span class=o>=</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>optionalString</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>isLinux</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>    <span class=s2>&#34;</span><span class=si>${</span><span class=n>glibcLocales</span><span class=si>}</span><span class=s2>/lib/locale/locale-archive&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>33</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>So we have:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>tree tryRnix
</span></span></code></pre></div><table><thead><tr><th>tryRnix</th><th></th><th></th><th></th></tr></thead><tbody><tr><td>└──</td><td>shell.nix</td><td></td><td></td></tr><tr><td>0</td><td>directories,</td><td>1</td><td>file</td></tr></tbody></table><h3 id=introspection>Introspection</h3><p>At this point:</p><ul><li>I was able to install packages (system and <code>R</code>) arbitrarily</li><li>I was able to use project specific folders</li><li>Unlike <code>npm</code>, <code>pipenv</code>, <code>poetry</code>, <code>conda</code> and friends, my system was not bloated by downloading and setting up the same packages every-time I used them in different projects</li></ul><p>However, though this is a major step up from being chained to RStudio and my
system package manager, it is still perhaps not immediately obvious how this
workflow is reproducible. Admittedly, I have defined my packages in a nice
functional manner; but someone else might have a different upstream channel they
are tracking, and thus will have different packages. Indeed the only packages
which I could be sure of were the <code>R</code> packages I built from Github, since those
were tied to a hash. Finally, the setup described for each project is pretty
onerous, and it is not immediately clear how to leverage fantastic tools like
<code>direnv</code> for working through this.</p><h2 id=towards-reproducible-environments>Towards Reproducible Environments</h2><p>The astute reader will have noticed that I mentioned that the <code>R</code> packages were
reproducible since they were tied to a <strong>hash</strong>, and might reasonable argue that
the entire Nix ecosystem is about <strong>hashing</strong> in the first place. Once we realize
that, the rest is relatively simple<sup id=fnref:3><a href=#fn:3 class=footnote-ref role=doc-noteref>3</a></sup>.</p><h3 id=niv-and-pinning>Niv and Pinning</h3><p><a href=https://github.com/nmattia/niv/>Niv</a> essentially keeps track of the channel from which all the packages are installed. Setup is pretty minimal.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=nb>cd</span> tryRnix/
</span></span><span class=line><span class=ln>2</span><span class=cl>nix-env -i niv
</span></span><span class=line><span class=ln>3</span><span class=cl>niv init
</span></span></code></pre></div><p>At this point, we have:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>tree tryRnix
</span></span></code></pre></div><table><thead><tr><th>tryRnix</th><th></th><th></th><th></th></tr></thead><tbody><tr><td>├──</td><td>nix</td><td></td><td></td></tr><tr><td>│  </td><td>├──</td><td>sources.json</td><td></td></tr><tr><td>│  </td><td>└──</td><td>sources.nix</td><td></td></tr><tr><td>└──</td><td>shell.nix</td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>1</td><td>directory,</td><td>3</td><td>files</td></tr></tbody></table><p>We will have to update our <code>shell.nix</code> to use the new sources.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=ln> 1</span><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>  <span class=n>sources</span> <span class=o>=</span> <span class=kn>import</span> <span class=sr>./nix/sources.nix</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=n>pkgs</span> <span class=o>=</span> <span class=kn>import</span> <span class=n>sources</span><span class=o>.</span><span class=n>nixpkgs</span> <span class=p>{</span> <span class=p>};</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=n>stdenv</span> <span class=o>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>stdenv</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>  <span class=n>my-r-pkgs</span> <span class=o>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>rWrapper</span><span class=o>.</span><span class=n>override</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=n>packages</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>rPackages</span><span class=p>;</span> <span class=p>[</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>      <span class=n>ggplot2</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>      <span class=n>tidyverse</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>      <span class=n>tidybayes</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=k>in</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>mkShell</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>  <span class=n>buildInputs</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=p>;[</span> <span class=n>git</span> <span class=n>glibcLocales</span> <span class=n>openssl</span> <span class=n>which</span> <span class=n>openssh</span> <span class=n>curl</span> <span class=n>wget</span> <span class=n>my-r-pkgs</span> <span class=p>];</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>  <span class=n>shellHook</span> <span class=o>=</span> <span class=s1>&#39;&#39;
</span></span></span><span class=line><span class=ln>15</span><span class=cl><span class=s1>    mkdir -p &#34;$(pwd)/_libs&#34;
</span></span></span><span class=line><span class=ln>16</span><span class=cl><span class=s1>    export R_LIBS_USER=&#34;$(pwd)/_libs&#34;
</span></span></span><span class=line><span class=ln>17</span><span class=cl><span class=s1>  &#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>  <span class=n>GIT_SSL_CAINFO</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=n>pkgs</span><span class=o>.</span><span class=n>cacert</span><span class=si>}</span><span class=s2>/etc/ssl/certs/ca-bundle.crt&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>  <span class=n>LOCALE_ARCHIVE</span> <span class=o>=</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>optionalString</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>isLinux</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>    <span class=s2>&#34;</span><span class=si>${</span><span class=n>pkgs</span><span class=o>.</span><span class=n>glibcLocales</span><span class=si>}</span><span class=s2>/lib/locale/locale-archive&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>21</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>We could inspect and edit these sources by hand, but it is much more convenient
to simply use <code>niv</code> again when we need to update these.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=nb>cd</span> tryRnix/
</span></span><span class=line><span class=ln>2</span><span class=cl>niv update nixpkgs -b nixpkgs-unstable
</span></span></code></pre></div><p>At this stage we have a reproducible set of packages ready to use. However it is
still pretty annoying to have to go through the trouble of writing <code>nix-shell</code>
and also waiting while it rebuilds when we change things.</p><h3 id=lorri-and-direnv>Lorri and Direnv</h3><p><a href=/posts/poetry-direnv/>In the past</a>, I have made my admiration for <code>direnv</code> very clear (especially for
<code>python-poetry</code>). However, though <code>direnv</code> does allow us to include arbitrary <code>bash</code> logic into our projects, it would be nice to have something which has some defaults for nix. Thankfully, the folks at TweagIO developed <a href=https://github.com/target/lorri>lorri</a> to scratch that itch.</p><p>The basic setup is simple:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>nix-env -i lorri
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=nb>cd</span> tryRnix/
</span></span><span class=line><span class=ln>3</span><span class=cl>lorri init
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>tree -a tryRnix/
</span></span></code></pre></div><table><thead><tr><th>tryRnix/</th><th></th><th></th><th></th></tr></thead><tbody><tr><td>├──</td><td>.envrc</td><td></td><td></td></tr><tr><td>├──</td><td>nix</td><td></td><td></td></tr><tr><td>│  </td><td>├──</td><td>sources.json</td><td></td></tr><tr><td>│  </td><td>└──</td><td>sources.nix</td><td></td></tr><tr><td>└──</td><td>shell.nix</td><td></td><td></td></tr><tr><td></td><td></td><td></td><td></td></tr><tr><td>1</td><td>directory,</td><td>4</td><td>files</td></tr></tbody></table><p>We can and should inspect the environment <code>lorri</code> wants us to load with <code>direnv</code> file:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>cat tryRnix/.envrc
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=line><span class=ln>1</span><span class=cl>$(lorri direnv)
</span></span></code></pre></div><p>In and of itself that is not too descriptive, so we should run that on our own first.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>  1</span><span class=cl><span class=nv>EVALUATION_ROOT</span><span class=o>=</span><span class=s2>&#34;</span><span class=nv>$HOME</span><span class=s2>/.cache/lorri/gc_roots/407bd4df60fbda6e3a656c39f81c03c2/gc_root/shell_gc_root&#34;</span>
</span></span><span class=line><span class=ln>  2</span><span class=cl>
</span></span><span class=line><span class=ln>  3</span><span class=cl>watch_file <span class=s2>&#34;/run/user/1000/lorri/daemon.socket&#34;</span>
</span></span><span class=line><span class=ln>  4</span><span class=cl>watch_file <span class=s2>&#34;</span><span class=nv>$EVALUATION_ROOT</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln>  5</span><span class=cl>
</span></span><span class=line><span class=ln>  6</span><span class=cl><span class=c1>#!/usr/bin/env bash</span>
</span></span><span class=line><span class=ln>  7</span><span class=cl><span class=c1># ^ shebang is unused as this file is sourced, but present for editor</span>
</span></span><span class=line><span class=ln>  8</span><span class=cl><span class=c1># integration. Note: Direnv guarantees it *will* be parsed using bash.</span>
</span></span><span class=line><span class=ln>  9</span><span class=cl>
</span></span><span class=line><span class=ln> 10</span><span class=cl><span class=k>function</span> punt <span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=ln> 11</span><span class=cl>    :
</span></span><span class=line><span class=ln> 12</span><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=ln> 13</span><span class=cl>
</span></span><span class=line><span class=ln> 14</span><span class=cl><span class=c1># move &#34;origPreHook&#34; &#34;preHook&#34; &#34;$@&#34;;;</span>
</span></span><span class=line><span class=ln> 15</span><span class=cl>move<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=ln> 16</span><span class=cl>    <span class=nv>srcvarname</span><span class=o>=</span><span class=nv>$1</span> <span class=c1># example: varname might contain the string &#34;origPATH&#34;</span>
</span></span><span class=line><span class=ln> 17</span><span class=cl>    <span class=c1># drop off the source variable name</span>
</span></span><span class=line><span class=ln> 18</span><span class=cl>    <span class=nb>shift</span>
</span></span><span class=line><span class=ln> 19</span><span class=cl>
</span></span><span class=line><span class=ln> 20</span><span class=cl>    <span class=nv>destvarname</span><span class=o>=</span><span class=nv>$1</span> <span class=c1># example: destvarname might contain the string &#34;PATH&#34;</span>
</span></span><span class=line><span class=ln> 21</span><span class=cl>    <span class=c1># drop off the destination variable name</span>
</span></span><span class=line><span class=ln> 22</span><span class=cl>    <span class=nb>shift</span>
</span></span><span class=line><span class=ln> 23</span><span class=cl>
</span></span><span class=line><span class=ln> 24</span><span class=cl>    <span class=c1># like: export origPATH=&#34;...some-value...&#34;</span>
</span></span><span class=line><span class=ln> 25</span><span class=cl>    <span class=nb>export</span> <span class=s2>&#34;</span><span class=si>${</span><span class=p>@?</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 26</span><span class=cl>
</span></span><span class=line><span class=ln> 27</span><span class=cl>    <span class=c1># set $original to the contents of the variable $srcvarname</span>
</span></span><span class=line><span class=ln> 28</span><span class=cl>    <span class=c1># refers to</span>
</span></span><span class=line><span class=ln> 29</span><span class=cl>    <span class=nb>eval</span> <span class=s2>&#34;</span><span class=nv>$destvarname</span><span class=s2>=\&#34;</span><span class=si>${</span><span class=p>!srcvarname</span><span class=si>}</span><span class=s2>\&#34;&#34;</span>
</span></span><span class=line><span class=ln> 30</span><span class=cl>
</span></span><span class=line><span class=ln> 31</span><span class=cl>    <span class=c1># mark the destvarname as exported so direnv picks it up</span>
</span></span><span class=line><span class=ln> 32</span><span class=cl>    <span class=c1># (shellcheck: we do want to export the content of destvarname!)</span>
</span></span><span class=line><span class=ln> 33</span><span class=cl>    <span class=c1># shellcheck disable=SC2163</span>
</span></span><span class=line><span class=ln> 34</span><span class=cl>    <span class=nb>export</span> <span class=s2>&#34;</span><span class=nv>$destvarname</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln> 35</span><span class=cl>
</span></span><span class=line><span class=ln> 36</span><span class=cl>    <span class=c1># remove the export from above, ie: export origPATH...</span>
</span></span><span class=line><span class=ln> 37</span><span class=cl>    <span class=nb>unset</span> <span class=s2>&#34;</span><span class=nv>$srcvarname</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln> 38</span><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=ln> 39</span><span class=cl>
</span></span><span class=line><span class=ln> 40</span><span class=cl><span class=k>function</span> prepend<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=ln> 41</span><span class=cl>    <span class=nv>varname</span><span class=o>=</span><span class=nv>$1</span> <span class=c1># example: varname might contain the string &#34;PATH&#34;</span>
</span></span><span class=line><span class=ln> 42</span><span class=cl>
</span></span><span class=line><span class=ln> 43</span><span class=cl>    <span class=c1># drop off the varname</span>
</span></span><span class=line><span class=ln> 44</span><span class=cl>    <span class=nb>shift</span>
</span></span><span class=line><span class=ln> 45</span><span class=cl>
</span></span><span class=line><span class=ln> 46</span><span class=cl>    <span class=nv>separator</span><span class=o>=</span><span class=nv>$1</span> <span class=c1># example: separator would usually be the string &#34;:&#34;</span>
</span></span><span class=line><span class=ln> 47</span><span class=cl>
</span></span><span class=line><span class=ln> 48</span><span class=cl>    <span class=c1># drop off the separator argument, so the remaining arguments</span>
</span></span><span class=line><span class=ln> 49</span><span class=cl>    <span class=c1># are the arguments to export</span>
</span></span><span class=line><span class=ln> 50</span><span class=cl>    <span class=nb>shift</span>
</span></span><span class=line><span class=ln> 51</span><span class=cl>
</span></span><span class=line><span class=ln> 52</span><span class=cl>    <span class=c1># set $original to the contents of the the variable $varname</span>
</span></span><span class=line><span class=ln> 53</span><span class=cl>    <span class=c1># refers to</span>
</span></span><span class=line><span class=ln> 54</span><span class=cl>    <span class=nv>original</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=p>!varname</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln> 55</span><span class=cl>
</span></span><span class=line><span class=ln> 56</span><span class=cl>    <span class=c1># effectfully accept the new variable&#39;s contents</span>
</span></span><span class=line><span class=ln> 57</span><span class=cl>    <span class=nb>export</span> <span class=s2>&#34;</span><span class=si>${</span><span class=p>@?</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 58</span><span class=cl>
</span></span><span class=line><span class=ln> 59</span><span class=cl>    <span class=c1># re-set $varname&#39;s variable to the contents of varname&#39;s</span>
</span></span><span class=line><span class=ln> 60</span><span class=cl>    <span class=c1># reference, plus the current (updated on the export) contents.</span>
</span></span><span class=line><span class=ln> 61</span><span class=cl>    <span class=c1># however, exclude the ${separator} unless ${original} starts</span>
</span></span><span class=line><span class=ln> 62</span><span class=cl>    <span class=c1># with a value</span>
</span></span><span class=line><span class=ln> 63</span><span class=cl>    <span class=nb>eval</span> <span class=s2>&#34;</span><span class=nv>$varname</span><span class=s2>=</span><span class=si>${</span><span class=p>!varname</span><span class=si>}${</span><span class=nv>original</span><span class=p>:+</span><span class=si>${</span><span class=nv>separator</span><span class=si>}${</span><span class=nv>original</span><span class=si>}}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln> 64</span><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=ln> 65</span><span class=cl>
</span></span><span class=line><span class=ln> 66</span><span class=cl><span class=k>function</span> append<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=ln> 67</span><span class=cl>    <span class=nv>varname</span><span class=o>=</span><span class=nv>$1</span> <span class=c1># example: varname might contain the string &#34;PATH&#34;</span>
</span></span><span class=line><span class=ln> 68</span><span class=cl>
</span></span><span class=line><span class=ln> 69</span><span class=cl>    <span class=c1># drop off the varname</span>
</span></span><span class=line><span class=ln> 70</span><span class=cl>    <span class=nb>shift</span>
</span></span><span class=line><span class=ln> 71</span><span class=cl>
</span></span><span class=line><span class=ln> 72</span><span class=cl>    <span class=nv>separator</span><span class=o>=</span><span class=nv>$1</span> <span class=c1># example: separator would usually be the string &#34;:&#34;</span>
</span></span><span class=line><span class=ln> 73</span><span class=cl>    <span class=c1># drop off the separator argument, so the remaining arguments</span>
</span></span><span class=line><span class=ln> 74</span><span class=cl>    <span class=c1># are the arguments to export</span>
</span></span><span class=line><span class=ln> 75</span><span class=cl>    <span class=nb>shift</span>
</span></span><span class=line><span class=ln> 76</span><span class=cl>
</span></span><span class=line><span class=ln> 77</span><span class=cl>
</span></span><span class=line><span class=ln> 78</span><span class=cl>    <span class=c1># set $original to the contents of the the variable $varname</span>
</span></span><span class=line><span class=ln> 79</span><span class=cl>    <span class=c1># refers to</span>
</span></span><span class=line><span class=ln> 80</span><span class=cl>    <span class=nv>original</span><span class=o>=</span><span class=s2>&#34;</span><span class=si>${</span><span class=p>!varname</span><span class=k>:-</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln> 81</span><span class=cl>
</span></span><span class=line><span class=ln> 82</span><span class=cl>    <span class=c1># effectfully accept the new variable&#39;s contents</span>
</span></span><span class=line><span class=ln> 83</span><span class=cl>    <span class=nb>export</span> <span class=s2>&#34;</span><span class=si>${</span><span class=p>@?</span><span class=si>}</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 84</span><span class=cl>
</span></span><span class=line><span class=ln> 85</span><span class=cl>    <span class=c1># re-set $varname&#39;s variable to the contents of varname&#39;s</span>
</span></span><span class=line><span class=ln> 86</span><span class=cl>    <span class=c1># reference, plus the current (updated on the export) contents.</span>
</span></span><span class=line><span class=ln> 87</span><span class=cl>    <span class=c1># however, exclude the ${separator} unless ${original} starts</span>
</span></span><span class=line><span class=ln> 88</span><span class=cl>    <span class=c1># with a value</span>
</span></span><span class=line><span class=ln> 89</span><span class=cl>    <span class=nb>eval</span> <span class=s2>&#34;</span><span class=nv>$varname</span><span class=s2>=</span><span class=si>${</span><span class=nv>original</span><span class=p>:+</span><span class=si>${</span><span class=nv>original</span><span class=si>}${</span><span class=nv>separator</span><span class=si>}}${</span><span class=p>!varname</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln> 90</span><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=ln> 91</span><span class=cl>
</span></span><span class=line><span class=ln> 92</span><span class=cl>varmap<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=ln> 93</span><span class=cl>    <span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$EVALUATION_ROOT</span><span class=s2>/varmap-v1&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=ln> 94</span><span class=cl>        <span class=c1># Capture the name of the variable being set</span>
</span></span><span class=line><span class=ln> 95</span><span class=cl>        <span class=nv>IFS</span><span class=o>=</span><span class=s2>&#34;=&#34;</span> <span class=nb>read</span> -r -a cur_varname <span class=o>&lt;&lt;&lt;</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln> 96</span><span class=cl>
</span></span><span class=line><span class=ln> 97</span><span class=cl>        <span class=c1># With IFS=&#39;&#39; and the `read` delimiter being &#39;&#39;, we achieve</span>
</span></span><span class=line><span class=ln> 98</span><span class=cl>        <span class=c1># splitting on \0 bytes while also preserving leading</span>
</span></span><span class=line><span class=ln> 99</span><span class=cl>        <span class=c1># whitespace:</span>
</span></span><span class=line><span class=ln>100</span><span class=cl>        <span class=c1>#</span>
</span></span><span class=line><span class=ln>101</span><span class=cl>        <span class=c1>#    bash-3.2$ printf &#39; &lt;- leading space\0bar\0baz\0&#39; \</span>
</span></span><span class=line><span class=ln>102</span><span class=cl>        <span class=c1>#                  | (while IFS=&#39;&#39; read -d $&#39;\0&#39; -r x; do echo &#34;&gt;$x&lt;&#34;; done)</span>
</span></span><span class=line><span class=ln>103</span><span class=cl>        <span class=c1>#    &gt; &lt;- leading space&lt;</span>
</span></span><span class=line><span class=ln>104</span><span class=cl>        <span class=c1>#    &gt;bar&lt;</span>
</span></span><span class=line><span class=ln>105</span><span class=cl>        <span class=c1>#    &gt;baz&lt;```</span>
</span></span><span class=line><span class=ln>106</span><span class=cl>        <span class=k>while</span> <span class=nv>IFS</span><span class=o>=</span><span class=s1>&#39;&#39;</span> <span class=nb>read</span> -r -d <span class=s1>&#39;&#39;</span> map_instruction <span class=se>\
</span></span></span><span class=line><span class=ln>107</span><span class=cl><span class=se></span>           <span class=o>&amp;&amp;</span> <span class=nv>IFS</span><span class=o>=</span><span class=s1>&#39;&#39;</span> <span class=nb>read</span> -r -d <span class=s1>&#39;&#39;</span> map_variable <span class=se>\
</span></span></span><span class=line><span class=ln>108</span><span class=cl><span class=se></span>           <span class=o>&amp;&amp;</span> <span class=nv>IFS</span><span class=o>=</span><span class=s1>&#39;&#39;</span> <span class=nb>read</span> -r -d <span class=s1>&#39;&#39;</span> map_separator<span class=p>;</span> <span class=k>do</span>
</span></span><span class=line><span class=ln>109</span><span class=cl>            <span class=nb>unset</span> IFS
</span></span><span class=line><span class=ln>110</span><span class=cl>
</span></span><span class=line><span class=ln>111</span><span class=cl>            <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$map_variable</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;</span><span class=si>${</span><span class=nv>cur_varname</span><span class=p>[0]</span><span class=si>}</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=ln>112</span><span class=cl>                <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$map_instruction</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;append&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=ln>113</span><span class=cl>                    append <span class=s2>&#34;</span><span class=nv>$map_variable</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$map_separator</span><span class=s2>&#34;</span> <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln>114</span><span class=cl>                    <span class=k>return</span>
</span></span><span class=line><span class=ln>115</span><span class=cl>                <span class=k>fi</span>
</span></span><span class=line><span class=ln>116</span><span class=cl>            <span class=k>fi</span>
</span></span><span class=line><span class=ln>117</span><span class=cl>        <span class=k>done</span> &lt; <span class=s2>&#34;</span><span class=nv>$EVALUATION_ROOT</span><span class=s2>/varmap-v1&#34;</span>
</span></span><span class=line><span class=ln>118</span><span class=cl>    <span class=k>fi</span>
</span></span><span class=line><span class=ln>119</span><span class=cl>
</span></span><span class=line><span class=ln>120</span><span class=cl>
</span></span><span class=line><span class=ln>121</span><span class=cl>    <span class=nb>export</span> <span class=s2>&#34;</span><span class=si>${</span><span class=p>@?</span><span class=si>}</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln>122</span><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=ln>123</span><span class=cl>
</span></span><span class=line><span class=ln>124</span><span class=cl><span class=k>function</span> declare<span class=o>()</span> <span class=o>{</span>
</span></span><span class=line><span class=ln>125</span><span class=cl>    <span class=k>if</span> <span class=o>[</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> <span class=o>==</span> <span class=s2>&#34;-x&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span> shift<span class=p>;</span> <span class=k>fi</span>
</span></span><span class=line><span class=ln>126</span><span class=cl>
</span></span><span class=line><span class=ln>127</span><span class=cl>    <span class=c1># Some variables require special handling.</span>
</span></span><span class=line><span class=ln>128</span><span class=cl>    <span class=c1>#</span>
</span></span><span class=line><span class=ln>129</span><span class=cl>    <span class=c1># - punt:    don&#39;t set the variable at all</span>
</span></span><span class=line><span class=ln>130</span><span class=cl>    <span class=c1># - prepend: take the new value, and put it before the current value.</span>
</span></span><span class=line><span class=ln>131</span><span class=cl>    <span class=k>case</span> <span class=s2>&#34;</span><span class=nv>$1</span><span class=s2>&#34;</span> in
</span></span><span class=line><span class=ln>132</span><span class=cl>        <span class=c1># vars from: https://github.com/NixOS/nix/blob/92d08c02c84be34ec0df56ed718526c382845d1a/src/nix-build/nix-build.cc#L100</span>
</span></span><span class=line><span class=ln>133</span><span class=cl>        <span class=s2>&#34;HOME=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>134</span><span class=cl>        <span class=s2>&#34;USER=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>135</span><span class=cl>        <span class=s2>&#34;LOGNAME=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>136</span><span class=cl>        <span class=s2>&#34;DISPLAY=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>137</span><span class=cl>        <span class=s2>&#34;PATH=&#34;</span>*<span class=o>)</span> prepend <span class=s2>&#34;PATH&#34;</span> <span class=s2>&#34;:&#34;</span> <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span><span class=p>;;</span>
</span></span><span class=line><span class=ln>138</span><span class=cl>        <span class=s2>&#34;TERM=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>139</span><span class=cl>        <span class=s2>&#34;IN_NIX_SHELL=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>140</span><span class=cl>        <span class=s2>&#34;TZ=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>141</span><span class=cl>        <span class=s2>&#34;PAGER=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>142</span><span class=cl>        <span class=s2>&#34;NIX_BUILD_SHELL=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>143</span><span class=cl>        <span class=s2>&#34;SHLVL=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>144</span><span class=cl>
</span></span><span class=line><span class=ln>145</span><span class=cl>        <span class=c1># vars from: https://github.com/NixOS/nix/blob/92d08c02c84be34ec0df56ed718526c382845d1a/src/nix-build/nix-build.cc#L385</span>
</span></span><span class=line><span class=ln>146</span><span class=cl>        <span class=s2>&#34;TEMPDIR=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>147</span><span class=cl>        <span class=s2>&#34;TMPDIR=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>148</span><span class=cl>        <span class=s2>&#34;TEMP=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>149</span><span class=cl>        <span class=s2>&#34;TMP=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>150</span><span class=cl>
</span></span><span class=line><span class=ln>151</span><span class=cl>        <span class=c1># vars from: https://github.com/NixOS/nix/blob/92d08c02c84be34ec0df56ed718526c382845d1a/src/nix-build/nix-build.cc#L421</span>
</span></span><span class=line><span class=ln>152</span><span class=cl>        <span class=s2>&#34;NIX_ENFORCE_PURITY=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>153</span><span class=cl>
</span></span><span class=line><span class=ln>154</span><span class=cl>        <span class=c1># vars from: https://www.gnu.org/software/bash/manual/html_node/Bash-Variables.html (last checked: 2019-09-26)</span>
</span></span><span class=line><span class=ln>155</span><span class=cl>        <span class=c1># reported in https://github.com/target/lorri/issues/153</span>
</span></span><span class=line><span class=ln>156</span><span class=cl>        <span class=s2>&#34;OLDPWD=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>157</span><span class=cl>        <span class=s2>&#34;PWD=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>158</span><span class=cl>        <span class=s2>&#34;SHELL=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>159</span><span class=cl>
</span></span><span class=line><span class=ln>160</span><span class=cl>        <span class=c1># https://github.com/target/lorri/issues/97</span>
</span></span><span class=line><span class=ln>161</span><span class=cl>        <span class=s2>&#34;preHook=&#34;</span>*<span class=o>)</span> punt<span class=p>;;</span>
</span></span><span class=line><span class=ln>162</span><span class=cl>        <span class=s2>&#34;origPreHook=&#34;</span>*<span class=o>)</span> move <span class=s2>&#34;origPreHook&#34;</span> <span class=s2>&#34;preHook&#34;</span> <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span><span class=p>;;</span>
</span></span><span class=line><span class=ln>163</span><span class=cl>
</span></span><span class=line><span class=ln>164</span><span class=cl>        *<span class=o>)</span> varmap <span class=s2>&#34;</span><span class=nv>$@</span><span class=s2>&#34;</span> <span class=p>;;</span>
</span></span><span class=line><span class=ln>165</span><span class=cl>    <span class=k>esac</span>
</span></span><span class=line><span class=ln>166</span><span class=cl><span class=o>}</span>
</span></span><span class=line><span class=ln>167</span><span class=cl>
</span></span><span class=line><span class=ln>168</span><span class=cl><span class=nb>export</span> <span class=nv>IN_NIX_SHELL</span><span class=o>=</span>impure
</span></span><span class=line><span class=ln>169</span><span class=cl>
</span></span><span class=line><span class=ln>170</span><span class=cl><span class=k>if</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$EVALUATION_ROOT</span><span class=s2>/bash-export&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=ln>171</span><span class=cl>    <span class=c1># shellcheck disable=SC1090</span>
</span></span><span class=line><span class=ln>172</span><span class=cl>    . <span class=s2>&#34;</span><span class=nv>$EVALUATION_ROOT</span><span class=s2>/bash-export&#34;</span>
</span></span><span class=line><span class=ln>173</span><span class=cl><span class=k>elif</span> <span class=o>[</span> -f <span class=s2>&#34;</span><span class=nv>$EVALUATION_ROOT</span><span class=s2>&#34;</span> <span class=o>]</span><span class=p>;</span> <span class=k>then</span>
</span></span><span class=line><span class=ln>174</span><span class=cl>    <span class=c1># shellcheck disable=SC1090</span>
</span></span><span class=line><span class=ln>175</span><span class=cl>    . <span class=s2>&#34;</span><span class=nv>$EVALUATION_ROOT</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln>176</span><span class=cl><span class=k>fi</span>
</span></span><span class=line><span class=ln>177</span><span class=cl>
</span></span><span class=line><span class=ln>178</span><span class=cl><span class=nb>unset</span> <span class=nb>declare</span>
</span></span><span class=line><span class=ln>179</span><span class=cl>
</span></span><span class=line><span class=ln>180</span><span class=cl>Jun <span class=m>06</span> 19:02:32.368 INFO lorri has not completed an evaluation <span class=k>for</span> this project yet, expr: <span class=nv>$HOME</span>/Git/Github/WebDev/Mine/haozeke.github.io/content-org/tryRnix/shell.nix
</span></span><span class=line><span class=ln>181</span><span class=cl>Jun <span class=m>06</span> 19:02:32.368 WARN <span class=sb>`</span>lorri direnv<span class=sb>`</span> should be executed by direnv from within an <span class=sb>`</span>.envrc<span class=sb>`</span> file, expr: <span class=nv>$HOME</span>/Git/Github/WebDev/Mine/haozeke.github.io/content-org/tryRnix/shell.nix
</span></span></code></pre></div><p>Upon inspection, that seems to check out. So now we can enable this.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>direnv allow
</span></span></code></pre></div><p>Additionally, we will need to stick to using a pure environment as much as
possible to prevent unexpected situations. So we set:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl><span class=c1># .envrc</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=nb>eval</span> <span class=s2>&#34;</span><span class=k>$(</span>lorri direnv<span class=k>)</span><span class=s2>&#34;</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>nix-shell --run bash --pure
</span></span></code></pre></div><p>There&rsquo;s still a catch though. We need to have <code>lorri daemon</code> running to make
sure the packages are built automatically without us having to exit the shell
and re-run things. We can <a href=https://github.com/target/lorri/blob/master/contrib/daemon.md>turn to the documentation</a> for this. Essentially, we
need to have a user-level systemd socket file and service for <code>lorri</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl><span class=c1># ~/.config/systemd/user/lorri.socket</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=nv>Description</span><span class=o>=</span>Socket <span class=k>for</span> Lorri Daemon
</span></span><span class=line><span class=ln> 4</span><span class=cl>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=o>[</span>Socket<span class=o>]</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=nv>ListenStream</span><span class=o>=</span>%t/lorri/daemon.socket
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=nv>RuntimeDirectory</span><span class=o>=</span>lorri
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=o>[</span>Install<span class=o>]</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=nv>WantedBy</span><span class=o>=</span>sockets.target
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl><span class=c1># ~/.config/systemd/user/lorri.service</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=o>[</span>Unit<span class=o>]</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=nv>Description</span><span class=o>=</span>Lorri Daemon
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=nv>Requires</span><span class=o>=</span>lorri.socket
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=nv>After</span><span class=o>=</span>lorri.socket
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=o>[</span>Service<span class=o>]</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=nv>ExecStart</span><span class=o>=</span>%h/.nix-profile/bin/lorri daemon
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=nv>PrivateTmp</span><span class=o>=</span><span class=nb>true</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=nv>ProtectSystem</span><span class=o>=</span>strict
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=nv>ProtectHome</span><span class=o>=</span>read-only
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=nv>Restart</span><span class=o>=</span>on-failure
</span></span></code></pre></div><p>With that we are finally ready to start working with our auto-managed,
reproducible environments.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>systemctl --user daemon-reload <span class=o>&amp;&amp;</span> <span class=se>\
</span></span></span><span class=line><span class=ln>2</span><span class=cl><span class=se></span>systemctl --user <span class=nb>enable</span> --now lorri.socket
</span></span></code></pre></div><h2 id=rethinking>Rethinking</h2><p>As promised, we will first test the setup to see that everything is working. Now
is also a good time to try the <code>tidybayes.rethinking</code> package. In order to use
it, we will need to define the <code>rethinking</code> package in a way so we can pass it
to the <code>buildInputs</code> for <code>tidybayes.rethinking</code>. We will modify new <code>shell.nix</code>
as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-nix data-lang=nix><span class=line><span class=ln> 1</span><span class=cl><span class=c1># shell.nix</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=k>let</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=n>sources</span> <span class=o>=</span> <span class=kn>import</span> <span class=sr>./nix/sources.nix</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>  <span class=n>pkgs</span> <span class=o>=</span> <span class=kn>import</span> <span class=n>sources</span><span class=o>.</span><span class=n>nixpkgs</span> <span class=p>{</span> <span class=p>};</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>  <span class=n>stdenv</span> <span class=o>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>stdenv</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=n>rethinking</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>rPackages</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=n>buildRPackage</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>      <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;rethinking&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>      <span class=n>src</span> <span class=o>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>fetchFromGitHub</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>        <span class=n>owner</span> <span class=o>=</span> <span class=s2>&#34;rmcelreath&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>        <span class=n>repo</span> <span class=o>=</span> <span class=s2>&#34;rethinking&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>        <span class=n>rev</span> <span class=o>=</span> <span class=s2>&#34;d0978c7f8b6329b94efa2014658d750ae12b1fa2&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>        <span class=n>sha256</span> <span class=o>=</span> <span class=s2>&#34;1qip6x3f6j9lmcmck6sjrj50a5azqfl6rfhp4fdj7ddabpb8n0z0&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>      <span class=n>propagatedBuildInputs</span> <span class=o>=</span> <span class=p>[</span> <span class=n>coda</span> <span class=n>MASS</span> <span class=n>mvtnorm</span> <span class=n>loo</span> <span class=n>shape</span> <span class=n>rstan</span> <span class=n>dagitty</span> <span class=p>];</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>  <span class=n>tidybayes_rethinking</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>rPackages</span><span class=p>;</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>    <span class=n>buildRPackage</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>      <span class=n>name</span> <span class=o>=</span> <span class=s2>&#34;tidybayes.rethinking&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>      <span class=n>src</span> <span class=o>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>fetchFromGitHub</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>        <span class=n>owner</span> <span class=o>=</span> <span class=s2>&#34;mjskay&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>        <span class=n>repo</span> <span class=o>=</span> <span class=s2>&#34;tidybayes.rethinking&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>        <span class=n>rev</span> <span class=o>=</span> <span class=s2>&#34;df903c88f4f4320795a47c616eef24a690b433a4&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>        <span class=n>sha256</span> <span class=o>=</span> <span class=s2>&#34;1jl3189zdddmwm07z1mk58hcahirqrwx211ms0i1rzbx5y4zak0c&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>      <span class=p>};</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>      <span class=n>propagatedBuildInputs</span> <span class=o>=</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>        <span class=p>[</span> <span class=n>dplyr</span> <span class=n>tibble</span> <span class=n>rlang</span> <span class=n>MASS</span> <span class=n>tidybayes</span> <span class=n>rethinking</span> <span class=n>rstan</span> <span class=p>];</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>    <span class=p>};</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>  <span class=n>rEnv</span> <span class=o>=</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>rWrapper</span><span class=o>.</span><span class=n>override</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>30</span><span class=cl>    <span class=n>packages</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>rPackages</span><span class=p>;</span> <span class=p>[</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>      <span class=n>ggplot2</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>      <span class=n>tidyverse</span>
</span></span><span class=line><span class=ln>33</span><span class=cl>      <span class=n>tidybayes</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>      <span class=n>devtools</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>      <span class=n>modelr</span>
</span></span><span class=line><span class=ln>36</span><span class=cl>      <span class=n>cowplot</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>      <span class=n>ggrepel</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>      <span class=n>RColorBrewer</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>      <span class=n>purrr</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>      <span class=n>forcats</span>
</span></span><span class=line><span class=ln>41</span><span class=cl>      <span class=n>rstan</span>
</span></span><span class=line><span class=ln>42</span><span class=cl>      <span class=n>rethinking</span>
</span></span><span class=line><span class=ln>43</span><span class=cl>      <span class=n>tidybayes_rethinking</span>
</span></span><span class=line><span class=ln>44</span><span class=cl>    <span class=p>];</span>
</span></span><span class=line><span class=ln>45</span><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=ln>46</span><span class=cl><span class=k>in</span> <span class=n>pkgs</span><span class=o>.</span><span class=n>mkShell</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>47</span><span class=cl>  <span class=n>buildInputs</span> <span class=o>=</span> <span class=k>with</span> <span class=n>pkgs</span><span class=p>;</span> <span class=p>[</span> <span class=n>git</span> <span class=n>glibcLocales</span> <span class=n>which</span> <span class=p>];</span>
</span></span><span class=line><span class=ln>48</span><span class=cl>  <span class=n>inputsFrom</span> <span class=o>=</span> <span class=p>[</span> <span class=n>rEnv</span> <span class=p>];</span>
</span></span><span class=line><span class=ln>49</span><span class=cl>  <span class=n>shellHook</span> <span class=o>=</span> <span class=s1>&#39;&#39;
</span></span></span><span class=line><span class=ln>50</span><span class=cl><span class=s1>    mkdir -p &#34;$(pwd)/_libs&#34;
</span></span></span><span class=line><span class=ln>51</span><span class=cl><span class=s1>    export R_LIBS_USER=&#34;$(pwd)/_libs&#34;
</span></span></span><span class=line><span class=ln>52</span><span class=cl><span class=s1>  &#39;&#39;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>53</span><span class=cl>  <span class=n>GIT_SSL_CAINFO</span> <span class=o>=</span> <span class=s2>&#34;</span><span class=si>${</span><span class=n>pkgs</span><span class=o>.</span><span class=n>cacert</span><span class=si>}</span><span class=s2>/etc/ssl/certs/ca-bundle.crt&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>54</span><span class=cl>  <span class=n>LOCALE_ARCHIVE</span> <span class=o>=</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>lib</span><span class=o>.</span><span class=n>optionalString</span> <span class=n>stdenv</span><span class=o>.</span><span class=n>isLinux</span>
</span></span><span class=line><span class=ln>55</span><span class=cl>    <span class=s2>&#34;</span><span class=si>${</span><span class=n>pkgs</span><span class=o>.</span><span class=n>glibcLocales</span><span class=si>}</span><span class=s2>/lib/locale/locale-archive&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>56</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>The main thing to note here is that we need the output of the derivation we
create here, i.e. we need to use <code>inputsFrom</code> and NOT <code>buildInputs</code> for <code>rEnv</code>.</p><p>Let us try to get a nice graphic for the conclusion.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-R data-lang=R><span class=line><span class=ln> 1</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>magrittr</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>dplyr</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>purrr</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>forcats</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>tidyr</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>modelr</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>tidybayes</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>tidybayes.rethinking</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>ggplot2</span><span class=p>)</span>
</span></span><span class=line><span class=ln>10</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>cowplot</span><span class=p>)</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>rstan</span><span class=p>)</span>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>rethinking</span><span class=p>)</span>
</span></span><span class=line><span class=ln>13</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>ggrepel</span><span class=p>)</span>
</span></span><span class=line><span class=ln>14</span><span class=cl><span class=nf>library</span><span class=p>(</span><span class=n>RColorBrewer</span><span class=p>)</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl><span class=nf>theme_set</span><span class=p>(</span><span class=nf>theme_tidybayes</span><span class=p>())</span>
</span></span><span class=line><span class=ln>17</span><span class=cl><span class=nf>rstan_options</span><span class=p>(</span><span class=n>auto_write</span> <span class=o>=</span> <span class=kc>TRUE</span><span class=p>)</span>
</span></span><span class=line><span class=ln>18</span><span class=cl><span class=nf>options</span><span class=p>(</span><span class=n>mc.cores</span> <span class=o>=</span> <span class=n>parallel</span><span class=o>::</span><span class=nf>detectCores</span><span class=p>())</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>
</span></span><span class=line><span class=ln>20</span><span class=cl>
</span></span><span class=line><span class=ln>21</span><span class=cl><span class=nf>set.seed</span><span class=p>(</span><span class=m>5</span><span class=p>)</span>
</span></span><span class=line><span class=ln>22</span><span class=cl><span class=n>n</span> <span class=o>=</span> <span class=m>10</span>
</span></span><span class=line><span class=ln>23</span><span class=cl><span class=n>n_condition</span> <span class=o>=</span> <span class=m>5</span>
</span></span><span class=line><span class=ln>24</span><span class=cl><span class=n>ABC</span> <span class=o>=</span>
</span></span><span class=line><span class=ln>25</span><span class=cl>  <span class=nf>tibble</span><span class=p>(</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>    <span class=n>condition</span> <span class=o>=</span> <span class=nf>factor</span><span class=p>(</span><span class=nf>rep</span><span class=p>(</span><span class=nf>c</span><span class=p>(</span><span class=s>&#34;A&#34;</span><span class=p>,</span><span class=s>&#34;B&#34;</span><span class=p>,</span><span class=s>&#34;C&#34;</span><span class=p>,</span><span class=s>&#34;D&#34;</span><span class=p>,</span><span class=s>&#34;E&#34;</span><span class=p>),</span> <span class=n>n</span><span class=p>)),</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>    <span class=n>response</span> <span class=o>=</span> <span class=nf>rnorm</span><span class=p>(</span><span class=n>n</span> <span class=o>*</span> <span class=m>5</span><span class=p>,</span> <span class=nf>c</span><span class=p>(</span><span class=m>0</span><span class=p>,</span><span class=m>1</span><span class=p>,</span><span class=m>2</span><span class=p>,</span><span class=m>1</span><span class=p>,</span><span class=m>-1</span><span class=p>),</span> <span class=m>0.5</span><span class=p>)</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>  <span class=p>)</span>
</span></span><span class=line><span class=ln>29</span><span class=cl>
</span></span><span class=line><span class=ln>30</span><span class=cl><span class=n>mtcars_clean</span> <span class=o>=</span> <span class=n>mtcars</span> <span class=o>%&gt;%</span>
</span></span><span class=line><span class=ln>31</span><span class=cl>  <span class=nf>mutate</span><span class=p>(</span><span class=n>cyl</span> <span class=o>=</span> <span class=nf>factor</span><span class=p>(</span><span class=n>cyl</span><span class=p>))</span>
</span></span><span class=line><span class=ln>32</span><span class=cl>
</span></span><span class=line><span class=ln>33</span><span class=cl><span class=n>m_cyl</span> <span class=o>=</span> <span class=nf>ulam</span><span class=p>(</span><span class=nf>alist</span><span class=p>(</span>
</span></span><span class=line><span class=ln>34</span><span class=cl>    <span class=n>cyl</span> <span class=o>~</span> <span class=nf>dordlogit</span><span class=p>(</span><span class=n>phi</span><span class=p>,</span> <span class=n>cutpoint</span><span class=p>),</span>
</span></span><span class=line><span class=ln>35</span><span class=cl>    <span class=n>phi</span> <span class=o>&lt;-</span> <span class=n>b_mpg</span><span class=o>*</span><span class=n>mpg</span><span class=p>,</span>
</span></span><span class=line><span class=ln>36</span><span class=cl>    <span class=n>b_mpg</span> <span class=o>~</span> <span class=nf>student_t</span><span class=p>(</span><span class=m>3</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=m>10</span><span class=p>),</span>
</span></span><span class=line><span class=ln>37</span><span class=cl>    <span class=n>cutpoint</span> <span class=o>~</span> <span class=nf>student_t</span><span class=p>(</span><span class=m>3</span><span class=p>,</span> <span class=m>0</span><span class=p>,</span> <span class=m>10</span><span class=p>)</span>
</span></span><span class=line><span class=ln>38</span><span class=cl>  <span class=p>),</span>
</span></span><span class=line><span class=ln>39</span><span class=cl>  <span class=n>data</span> <span class=o>=</span> <span class=n>mtcars_clean</span><span class=p>,</span>
</span></span><span class=line><span class=ln>40</span><span class=cl>  <span class=n>chains</span> <span class=o>=</span> <span class=m>4</span><span class=p>,</span>
</span></span><span class=line><span class=ln>41</span><span class=cl>  <span class=n>cores</span> <span class=o>=</span> <span class=n>parallel</span><span class=o>::</span><span class=nf>detectCores</span><span class=p>(),</span>
</span></span><span class=line><span class=ln>42</span><span class=cl>  <span class=n>iter</span> <span class=o>=</span> <span class=m>2000</span>
</span></span><span class=line><span class=ln>43</span><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=ln>44</span><span class=cl>
</span></span><span class=line><span class=ln>45</span><span class=cl><span class=n>cutpoints</span> <span class=o>=</span> <span class=n>m_cyl</span> <span class=o>%&gt;%</span>
</span></span><span class=line><span class=ln>46</span><span class=cl>  <span class=nf>recover_types</span><span class=p>(</span><span class=n>mtcars_clean</span><span class=p>)</span> <span class=o>%&gt;%</span>
</span></span><span class=line><span class=ln>47</span><span class=cl>  <span class=nf>spread_draws</span><span class=p>(</span><span class=n>cutpoint[cyl]</span><span class=p>)</span>
</span></span><span class=line><span class=ln>48</span><span class=cl>
</span></span><span class=line><span class=ln>49</span><span class=cl><span class=c1># define the last cutpoint</span>
</span></span><span class=line><span class=ln>50</span><span class=cl><span class=n>last_cutpoint</span> <span class=o>=</span> <span class=nf>tibble</span><span class=p>(</span>
</span></span><span class=line><span class=ln>51</span><span class=cl>  <span class=n>.draw</span> <span class=o>=</span> <span class=m>1</span><span class=o>:</span><span class=nf>max</span><span class=p>(</span><span class=n>cutpoints</span><span class=o>$</span><span class=n>.draw</span><span class=p>),</span>
</span></span><span class=line><span class=ln>52</span><span class=cl>  <span class=n>cyl</span> <span class=o>=</span> <span class=s>&#34;8&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>53</span><span class=cl>  <span class=n>cutpoint</span> <span class=o>=</span> <span class=kc>Inf</span>
</span></span><span class=line><span class=ln>54</span><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=ln>55</span><span class=cl>
</span></span><span class=line><span class=ln>56</span><span class=cl><span class=n>cutpoints</span> <span class=o>=</span> <span class=nf>bind_rows</span><span class=p>(</span><span class=n>cutpoints</span><span class=p>,</span> <span class=n>last_cutpoint</span><span class=p>)</span> <span class=o>%&gt;%</span>
</span></span><span class=line><span class=ln>57</span><span class=cl>  <span class=c1># define the previous cutpoint (cutpoint_{j-1})</span>
</span></span><span class=line><span class=ln>58</span><span class=cl>  <span class=nf>group_by</span><span class=p>(</span><span class=n>.draw</span><span class=p>)</span> <span class=o>%&gt;%</span>
</span></span><span class=line><span class=ln>59</span><span class=cl>  <span class=nf>arrange</span><span class=p>(</span><span class=n>cyl</span><span class=p>)</span> <span class=o>%&gt;%</span>
</span></span><span class=line><span class=ln>60</span><span class=cl>  <span class=nf>mutate</span><span class=p>(</span><span class=n>prev_cutpoint</span> <span class=o>=</span> <span class=nf>lag</span><span class=p>(</span><span class=n>cutpoint</span><span class=p>,</span> <span class=n>default</span> <span class=o>=</span> <span class=o>-</span><span class=kc>Inf</span><span class=p>))</span>
</span></span><span class=line><span class=ln>61</span><span class=cl>
</span></span><span class=line><span class=ln>62</span><span class=cl><span class=n>fitted_cyl_probs</span> <span class=o>=</span> <span class=n>mtcars_clean</span> <span class=o>%&gt;%</span>
</span></span><span class=line><span class=ln>63</span><span class=cl>  <span class=nf>data_grid</span><span class=p>(</span><span class=n>mpg</span> <span class=o>=</span> <span class=nf>seq_range</span><span class=p>(</span><span class=n>mpg</span><span class=p>,</span> <span class=n>n</span> <span class=o>=</span> <span class=m>101</span><span class=p>))</span> <span class=o>%&gt;%</span>
</span></span><span class=line><span class=ln>64</span><span class=cl>  <span class=nf>add_fitted_draws</span><span class=p>(</span><span class=n>m_cyl</span><span class=p>)</span> <span class=o>%&gt;%</span>
</span></span><span class=line><span class=ln>65</span><span class=cl>  <span class=nf>inner_join</span><span class=p>(</span><span class=n>cutpoints</span><span class=p>,</span> <span class=n>by</span> <span class=o>=</span> <span class=s>&#34;.draw&#34;</span><span class=p>)</span> <span class=o>%&gt;%</span>
</span></span><span class=line><span class=ln>66</span><span class=cl>  <span class=nf>mutate</span><span class=p>(</span><span class=nf>`P</span><span class=p>(</span><span class=n>cyl</span> <span class=o>|</span> <span class=n>mpg</span><span class=p>)</span><span class=n>` =
</span></span></span><span class=line><span class=ln>67</span><span class=cl><span class=n>    # this part is logit^-1(cutpoint_j - beta*x) - logit^-1(cutpoint_{j-1} - beta*x)
</span></span></span><span class=line><span class=ln>68</span><span class=cl><span class=n>    plogis(cutpoint - .value) - plogis(prev_cutpoint - .value)
</span></span></span><span class=line><span class=ln>69</span><span class=cl><span class=n>  )
</span></span></span><span class=line><span class=ln>70</span><span class=cl><span class=n>
</span></span></span><span class=line><span class=ln>71</span><span class=cl><span class=n>
</span></span></span><span class=line><span class=ln>72</span><span class=cl><span class=n>data_plot = mtcars_clean %&gt;%
</span></span></span><span class=line><span class=ln>73</span><span class=cl><span class=n>  ggplot(aes(x = mpg, y = cyl, color = cyl)) +
</span></span></span><span class=line><span class=ln>74</span><span class=cl><span class=n>  geom_point() +
</span></span></span><span class=line><span class=ln>75</span><span class=cl><span class=n>  scale_color_brewer(palette = &#34;Dark2&#34;, name = &#34;cyl&#34;)
</span></span></span><span class=line><span class=ln>76</span><span class=cl><span class=n>
</span></span></span><span class=line><span class=ln>77</span><span class=cl><span class=n>fit_plot = fitted_cyl_probs %&gt;%
</span></span></span><span class=line><span class=ln>78</span><span class=cl><span class=n>  ggplot(aes(x = mpg, y = `</span><span class=nf>P</span><span class=p>(</span><span class=n>cyl</span> <span class=o>|</span> <span class=n>mpg</span><span class=p>)</span><span class=n>`</span><span class=p>,</span> <span class=n>color</span> <span class=o>=</span> <span class=n>cyl</span><span class=p>))</span> <span class=o>+</span>
</span></span><span class=line><span class=ln>79</span><span class=cl>  <span class=nf>stat_lineribbon</span><span class=p>(</span><span class=nf>aes</span><span class=p>(</span><span class=n>fill</span> <span class=o>=</span> <span class=n>cyl</span><span class=p>),</span> <span class=n>alpha</span> <span class=o>=</span> <span class=m>1</span><span class=o>/</span><span class=m>5</span><span class=p>)</span> <span class=o>+</span>
</span></span><span class=line><span class=ln>80</span><span class=cl>  <span class=nf>scale_color_brewer</span><span class=p>(</span><span class=n>palette</span> <span class=o>=</span> <span class=s>&#34;Dark2&#34;</span><span class=p>)</span> <span class=o>+</span>
</span></span><span class=line><span class=ln>81</span><span class=cl>  <span class=nf>scale_fill_brewer</span><span class=p>(</span><span class=n>palette</span> <span class=o>=</span> <span class=s>&#34;Dark2&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>82</span><span class=cl>
</span></span><span class=line><span class=ln>83</span><span class=cl><span class=nf>png</span><span class=p>(</span><span class=n>filename</span><span class=o>=</span><span class=s>&#34;../images/rethinking.png&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>84</span><span class=cl><span class=nf>plot_grid</span><span class=p>(</span><span class=n>ncol</span> <span class=o>=</span> <span class=m>1</span><span class=p>,</span> <span class=n>align</span> <span class=o>=</span> <span class=s>&#34;v&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=ln>85</span><span class=cl>  <span class=n>data_plot</span><span class=p>,</span>
</span></span><span class=line><span class=ln>86</span><span class=cl>  <span class=n>fit_plot</span>
</span></span><span class=line><span class=ln>87</span><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=ln>88</span><span class=cl><span class=n>dev.off</span>
</span></span></code></pre></div><p>Finally we will run this in our environment.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>Rscript tesPlot.R
</span></span></code></pre></div><figure><img src=/ox-hugo/rethinking.png></figure><h2 id=conclusions>Conclusions</h2><p>This post was really more of an exploratory follow up to the previous post, and
does not really work in isolation. Then again, at this point everything seems to
have worked out well. <code>R</code> with Nix has finally become a truly viable combination
for any and every analysis under the sun. Some parts of the workflow are still a
bit janky, but will probably resolve themselves over time.</p><p><strong>Update:</strong> There is <a href=/posts/emacs-nix-r/>a final part</a> detailing automated ways of reloading the system configuration</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>My motivations were laid out in the <a href=/posts/nix-r-devtools/>aforementioned post</a>, and will not be repeated&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:2><p>For why these are the way they are see the this is written, see the <a href=/posts/nix-r-devtools/>aforementioned post</a>&#160;<a href=#fnref:2 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li><li id=fn:3><p>Christine Dodrill <a href=https://christine.website/blog/how-i-start-nix-2020-03-08>has a great write up</a> on using these tools as well&#160;<a href=#fnref:3 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div><hr><div class=post-series-bottom><h2>Series info</h2><h3>R x Nix Nexus: Crafting Cohesive Environments series</h3><ol><li><a href=https://rgoswami.me/posts/nix-r-devtools/>Nix with R and devtools</a></li><li><b>Statistical Rethinking and Nix</b> &lt;-- You are here!</li><li><a href=https://rgoswami.me/posts/emacs-nix-r/>Emacs for Nix-R</a></li></ol></div></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=/tags/tools>tools</a></span><span class=tag><a href=/tags/nix>nix</a></span><span class=tag><a href=/tags/workflow>workflow</a></span><span class=tag><a href=/tags/r>R</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>2487 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Posted: <time class=dt-published>2020-06-07 04:24 +0000</time></p><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f" target=_blank rel=noopener aria-label=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15.84 9.5H13.5V8.48c0-.53.35-.65.6-.65h1.4v-2.3h-2.35c-2.3.0-2.65 1.7-2.65 2.8V9.5h-2v2h2v7h3v-7h2.1l.24-2z"/></svg></div>Facebook</div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=%22Statistical%20Rethinking%20and%20Nix%22%20seems%20like%20an%20interesting%20read%20from%20%40rg0swami&amp;url=https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f" target=_blank rel=noopener aria-label=Twitter><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.5 7.4l-2 .2c-.4-.5-1-.8-2-.8C13.3 6.8 12 8 12 9.4v.6c-2 0-4-1-5.4-2.7-.2.4-.3.8-.3 1.3.0 1 .4 1.7 1.2 2.2-.5.0-1 0-1.2-.3.0 1.3 1 2.3 2 2.6-.3.4-.7.4-1 0 .2 1.4 1.2 2 2.3 2-1 1-2.5 1.4-4 1 1.3 1 2.7 1.4 4.2 1.4 4.8.0 7.5-4 7.5-7.5v-.4c.5-.4.8-1.5 1.2-2z"/><circle cx="12" cy="12" r="11.5"/></svg></div>Twitter</div></a><a class=resp-sharing-button__link href="mailto:?subject=%22Statistical%20Rethinking%20and%20Nix%22%20seems%20interesting...&amp;body=https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f" target=_self rel=noopener aria-label=E-Mail><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.5 16c0 .8-.7 1.5-1.5 1.5H6c-.8.0-1.5-.7-1.5-1.5V8c0-.8.7-1.5 1.5-1.5h12c.8.0 1.5.7 1.5 1.5v8zm-2-7.5L12 13 6.5 8.5m11 6-4-2.5m-7 2.5 4-2.5"/><circle cx="12" cy="12" r="11.5"/></svg></div>E-Mail</div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f&amp;title=%22Statistical%20Rethinking%20and%20Nix%22%20seems%20interesting...&amp;summary=%22Statistical%20Rethinking%20and%20Nix%22%20seems%20interesting...&amp;source=https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f" target=_blank rel=noopener aria-label=LinkedIn><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15 12.5c-.28.0-.5.22-.5.5v3.5h-3s.03-6.48.0-7h3v.83s.46-.75 1.7-.75c1.56.0 2.3 1.12 2.3 3.3v3.62h-3V13c0-.28-.23-.5-.5-.5zm-7.5-3h2v7h-2z"/><circle cx="8.5" cy="6.5" r="1"/></svg></div>LinkedIn</div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f&amp;resubmit=true&amp;title=%22Statistical%20Rethinking%20and%20Nix%22%20seems%20interesting..." target=_blank rel=noopener aria-label=Reddit><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><ellipse cx="12" cy="14.37" rx="6.2" ry="4.24"/><path d="M14.3 16.25c-.62.36-1.42.57-2.3.57s-1.7-.2-2.32-.58"/><circle cx="14.61" cy="13.39" r=".98"/><circle cx="9.39" cy="13.39" r=".98"/><path d="M16.4 11.38c.26-.55.82-.92 1.47-.92.9.0 1.63.73 1.63 1.63.0.8-.6 1.47-1.38 1.6"/><circle cx="17.22" cy="7.52" r="1.63"/><path d="M7.6 11.38c-.26-.54-.82-.92-1.47-.92-.9.0-1.63.73-1.63 1.63.0.8.6 1.47 1.38 1.6M12 10.12s-.08-4.82 3.6-2.6"/></svg></div>Reddit</div></a><a class=resp-sharing-button__link href="whatsapp://send?text=%22Statistical%20Rethinking%20and%20Nix%22%20seems%20interesting...%20https%3a%2f%2frgoswami.me%2fposts%2frethinking-r-nix%2f" target=_blank rel=noopener aria-label=WhatsApp><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle xmlns="http://www.w3.org/2000/svg" cx="12" cy="12" r="11.5"/><path stroke-width="1" d="M17.6 6.2c-1.5-1.5-3.4-2.3-5.5-2.3-4.3.0-7.8 3.5-7.8 7.8.0 1.4.4 2.7 1 3.9l-1.1 4 4.1-1.1c1.1.6 2.4.9 3.7.9 4.3.0 7.8-3.5 7.8-7.8.1-2-.7-3.9-2.2-5.4zm-5.5 11.9c-1.2.0-2.3-.3-3.3-.9l-.2-.1-2.4.6.7-2.4-.2-.2c-.6-1-1-2.2-1-3.4.0-3.6 2.9-6.5 6.5-6.5 1.7.0 3.3.7 4.6 1.9 1.2 1.2 1.9 2.8 1.9 4.6-.1 3.5-3 6.4-6.6 6.4zm3.5-4.8c-.2-.1-1.1-.6-1.3-.6-.2-.1-.3-.1-.4.1s-.5.6-.6.8c-.1.1-.2.1-.4.0s-.8-.3-1.6-1c-.6-.5-1-1.2-1.1-1.3-.1-.2.0-.3.1-.4l.3-.3s.1-.2.2-.3c.1-.1.0-.2.0-.3s-.4-1.1-.6-1.4c-.2-.4-.3-.3-.4-.3h-.4s-.3.0-.5.2-.7.7-.7 1.6c0 1 .7 1.9.8 2s1.4 2.1 3.3 2.9c.5.2.8.3 1.1.4.5.1.9.1 1.2.1.4-.1 1.1-.5 1.3-.9.2-.5.2-.8.1-.9.0-.2-.2-.3-.4-.4z"/></svg></div>WhatsApp</div></a></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://rgoswami.me/posts/emacs-nix-r/><span class=button__icon>←</span>
<span class=button__text>Emacs for Nix-R</span>
</a></span><span class="button next"><a href=https://rgoswami.me/posts/sr2-ch2-ch3-ch4/><span class=button__text>"SR2 :: Solutions for Chapters {2,3,4}"
</span><span class=button__icon>→</span></a></span></div></div><div id=comments class=thin><div class=pagination__title><span class=pagination__title-h>Comments</span><hr></div><script src=https://utteranc.es/client.js repo=haozeke/haozeke.github.io issue-term=pathname theme=photon-dark label="Utterance 💬" crossorigin=anonymous async></script></div></main><footer class=footer><p>&copy; 2023
<a href=/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a><br><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a>.
Powered by <a href=http://gohugo.io><u>Hugo</u></a> and <a href=https://github.com/HaoZeke/hugo-theme-hello-friend-ng-hz><u>this theme</u></a>.</br>Hosted with <u><a href=https://www.netlify.com/>Netlify</a></u>.</br><script src=https://liberapay.com/rohit/widgets/button.js></script><noscript><a href=https://liberapay.com/rohit/donate><img alt="Donate using Liberapay" src=https://liberapay.com/assets/widgets/donate.svg></a></noscript></p></footer></div><script src=/bundle.min.5fae9992ea406007408dc33b0b3a8376d61e2f1d6ac50ba1dad7580ac50afb5199bcef3bbc3677e77553a9980bf882cf71edc2f755687dd7725f12ece4304ac2.js></script><script>(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-109503488-16","auto"),ga("send","pageview")</script><script type=text/javascript>(function(e,t,n,s,o,i,a){e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(s),i.async=1,i.src="https://www.clarity.ms/tag/"+o,a=t.getElementsByTagName(s)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","3z2xvwqu4u")</script><script data-goatcounter=https://rgoswami.goatcounter.com/count async src=//gc.zgo.at/count.js></script><script>var clicky_site_ids=clicky_site_ids||[];clicky_site_ids.push("101265002")</script><script async src=https://static.getclicky.com/js></script><script src=https://cdn.jsdelivr.net/npm/readmore-js@3.0.0-beta-1/dist/readmore.min.js></script><script src=/js/codefold.min.f0790269b87613b3bcff64022840fe1991eee3ea384e874c78a24022c9936bd888a3c14a05a10955881eebb1558e4fcf37576dac120cd0bf4ebaf7aca27b35b1.js></script><script src=/js/copyClipboard.min.1c92539aea398296101add0e80508ad94cb59fb37f946f06ec9ca1c7558a961b8de0c5595a921aed70aa91eb94d24db35e5a01243bc625f8b1814b17928f478b.js></script></body></html>