<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=author content="[Rohit Goswami]"><meta name=description content="Moving simple Fortran derived types to Python and back via C
 Background Object oriented programming has been part of Fortran for longer than I have been alive 1. Fortran has derived types now. They&amp;rsquo;ve been around for around for over three decades. The standards at the same time, have been supporting more and more interoperable operations. Details of these pleasant historical improvements are pretty much the most the Fortran standards committee have managed to date in the 21st century."><meta name=keywords content=",python,fortran,numpy,f2py,rambling"><meta name=robots content="noodp"><meta name=theme-color content><link rel=canonical href=https://rgoswami.me/posts/cython-derivedtype-f2py/><title>Simple Fortran Derived Types and Python :: Rohit Goswami — Reflections</title><link href=https://cdnjs.cloudflare.com/ajax/libs/flag-icon-css/3.2.1/css/flag-icon.min.css rel=stylesheet type=text/css><link rel=stylesheet href=/main.min.b6dbce0fdf6c61563a0c2226e857d5dadd8e5afa2c4f73ec9ea55abd831f9a72.css><meta itemprop=name content="Simple Fortran Derived Types and Python"><meta itemprop=description content="Moving simple Fortran derived types to Python and back via C
 Background Object oriented programming has been part of Fortran for longer than I have been alive 1. Fortran has derived types now. They&rsquo;ve been around for around for over three decades. The standards at the same time, have been supporting more and more interoperable operations. Details of these pleasant historical improvements are pretty much the most the Fortran standards committee have managed to date in the 21st century."><meta itemprop=datePublished content="2021-10-02T04:19:00+00:00"><meta itemprop=dateModified content="2021-10-02T04:19:00+00:00"><meta itemprop=wordCount content="1695"><meta itemprop=image content="https://rgoswami.me/images/RG.png"><meta itemprop=keywords content="python,fortran,numpy,f2py,rambling,"><meta property="og:title" content="Simple Fortran Derived Types and Python"><meta property="og:description" content="Moving simple Fortran derived types to Python and back via C
 Background Object oriented programming has been part of Fortran for longer than I have been alive 1. Fortran has derived types now. They&rsquo;ve been around for around for over three decades. The standards at the same time, have been supporting more and more interoperable operations. Details of these pleasant historical improvements are pretty much the most the Fortran standards committee have managed to date in the 21st century."><meta property="og:type" content="article"><meta property="og:url" content="https://rgoswami.me/posts/cython-derivedtype-f2py/"><meta property="og:image" content="https://rgoswami.me/images/RG.png"><meta property="article:section" content="posts"><meta property="article:published_time" content="2021-10-02T04:19:00+00:00"><meta property="article:modified_time" content="2021-10-02T04:19:00+00:00"><meta property="og:site_name" content="Rohit Goswami"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rgoswami.me/images/RG.png"><meta name=twitter:title content="Simple Fortran Derived Types and Python"><meta name=twitter:description content="Moving simple Fortran derived types to Python and back via C
 Background Object oriented programming has been part of Fortran for longer than I have been alive 1. Fortran has derived types now. They&rsquo;ve been around for around for over three decades. The standards at the same time, have been supporting more and more interoperable operations. Details of these pleasant historical improvements are pretty much the most the Fortran standards committee have managed to date in the 21st century."><meta property="article:section" content="notes"><meta property="article:published_time" content="2021-10-02 04:19:00 +0000 UTC"></head><body><div class=container><header class=header><div class=header__inner><div class=header__left><div class=logo><a href=/ style=text-decoration:none><img src=/images/home.png alt></a></div></div><div class=header__mid><button class=button><div class=button__text><a href=https://rgoswami.me//search>Search</a></div></button></div><div class=header__right><nav class=menu><ul class=menu__inner><li><a href=https://rgoswami.me/about>About</a></li><li><a href=https://rgoswami.me/posts>Blog</a></li></ul><ul class=menu__inner><li><a href=https://rgoswami.me/categories>Categories</a></li><li><a href=https://rgoswami.me/tags>Tags</a></li></ul></nav><button id=toggleMenu><div class=menu-trigger><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M0 0h24v24H0z" fill="none"/><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></div></button>
<button class=theme-toggle id=toggleTheme><svg class="theme-toggler" width="32" height="32" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 41c10.4934.0 19-8.5066 19-19C41 11.5066 32.4934 3 22 3 11.5066 3 3 11.5066 3 22s8.5066 19 19 19zM7 22C7 13.7157 13.7157 7 22 7V37C13.7157 37 7 30.2843 7 22z"/></svg></button></div></div></header><script src=https://rgoswami.me/js/mathjax-config.js></script><script id=MathJax-script async src=https://unpkg.com/mathjax@3/es5/tex-chtml.js></script><aside class=sidebar><div class=hideTOC><button id=tocTog>TOC</button><div class="sideTOC m-fadeOut"><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#series>Series</a></li></ul></li><li><a href=#c-structures-and-derived-types-i>C Structures and Derived Types - I</a><ul><li><a href=#c-and-fortran>C and Fortran</a></li><li><a href=#cython-and-fortran>Cython and Fortran</a></li><li><a href=#python-c-and-fortran>Python-C and Fortran</a></li></ul></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#references>References</a></li></ul></nav></div></div></aside><main class=post><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>8 minutes<p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Written: 2021-10-02 04:19 +0000</p></p></div><article class=h-entry><h1 class="post-title p-name"><a class=u-url href=https://rgoswami.me/posts/cython-derivedtype-f2py/>Simple Fortran Derived Types and Python</a></h1><div class=post-info><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-pen-tool"><path d="M12 19l7-7 3 3-7 7-3-3z"/><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/><path d="M2 2l7.586 7.586"/><circle cx="11" cy="11" r="2"/></svg><span class="author u-author p-author"><a href=https://rgoswami.me/author/rohit-goswami>Rohit Goswami</a></span></div><hr><aside id=toc class=sidebar><div class=toc-title>Table of Contents</div><nav id=TableOfContents><ul><li><a href=#background>Background</a><ul><li><a href=#series>Series</a></li></ul></li><li><a href=#c-structures-and-derived-types-i>C Structures and Derived Types - I</a><ul><li><a href=#c-and-fortran>C and Fortran</a></li><li><a href=#cython-and-fortran>Cython and Fortran</a></li><li><a href=#python-c-and-fortran>Python-C and Fortran</a></li></ul></li><li><a href=#conclusions>Conclusions</a></li><li><a href=#references>References</a></li></ul></nav></aside><hr><div class="post-content e-content"><blockquote><p>Moving simple Fortran derived types to Python and back via C</p></blockquote><h2 id=background>Background</h2><p>Object oriented programming has been part of Fortran for longer than I
have been alive <sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>. Fortran has derived types now. They&rsquo;ve been
around for around for over three decades. The standards at the same
time, have been supporting more and more interoperable operations.
Details of these pleasant historical improvements are pretty much the
most the Fortran standards committee have managed to date in the 21st
century. The point of this exploration is to design interfaces to
<code>Python</code>, mostly for the long term advancement of <code>f2py</code>, and just for
the heck of it. Simple in the context of the title means that we
consider only derived types whose members have direct <code>C</code> equivalents as
defined in the Fortran 2003 <a href=#ref-reidNewFeaturesFortran2003>Reid</a>
(<a href=#ref-reidNewFeaturesFortran2003>2003</a>) standard.</p><h3 id=series>Series</h3><p>Without intending it to be so, it appears that a series has been
established, though not in strict order, the progression of the
standards and their modern equivalents for Fortran-Python can be traced
as seen in:</p><ol><li>NumPy Meson Fortran</li></ol><h2 id=c-structures-and-derived-types-i>C Structures and Derived Types - I</h2><p>Consider, first an example of what shall be a rather simple collection
of records, the prototypical darling of most simulations, the point in
Euclidean space, \(\mathbb{R}^{3}\).</p><div class=highlight><pre class=chroma><code class=language-f90 data-lang=f90><span class=k>type</span><span class=p>,</span> <span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span> <span class=kd>::</span> <span class=n>cartesian</span>
   <span class=kt>real</span><span class=p>(</span><span class=kt>c_double</span><span class=p>)</span> <span class=kd>::</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>z</span>
<span class=k>end type </span><span class=n>cartesian</span>
</code></pre></div><p>Now by definition, ever since the <code>ISO_C_BINDING</code> of the Fortran 2003
<a href=#ref-reidNewFeaturesFortran2003>Reid</a>
(<a href=#ref-reidNewFeaturesFortran2003>2003</a>) standard, we know this is
equivalent to:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
  <span class=kt>double</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>z</span><span class=p>;</span>
<span class=p>}</span> <span class=n>cartesian</span><span class=p>;</span>
</code></pre></div><p>To try this out, we need to have a procedure which operates on the type,
due to a chronic lack of imagination, let us simply take a point and add
one to each axis.</p><div class=highlight><pre class=chroma><code class=language-f90 data-lang=f90><span class=k>subroutine </span><span class=n>unit_move</span><span class=p>(</span><span class=n>cartpoint</span><span class=p>)</span> <span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
  <span class=k>type</span><span class=p>(</span><span class=n>cartesian</span><span class=p>),</span> <span class=k>intent</span><span class=p>(</span><span class=n>inout</span><span class=p>)</span> <span class=kd>::</span> <span class=n>cartpoint</span>
  <span class=k>print</span><span class=o>*</span><span class=p>,</span> <span class=s2>&#34;Modifying the derived type now!&#34;</span>
  <span class=n>cartpoint</span><span class=p>%</span><span class=n>x</span><span class=o>=</span><span class=n>cartpoint</span><span class=p>%</span><span class=n>x</span><span class=o>+</span><span class=mi>1</span>
  <span class=n>cartpoint</span><span class=p>%</span><span class=n>y</span><span class=o>=</span><span class=n>cartpoint</span><span class=p>%</span><span class=n>y</span><span class=o>+</span><span class=mi>1</span>
  <span class=n>cartpoint</span><span class=p>%</span><span class=n>z</span><span class=o>=</span><span class=n>cartpoint</span><span class=p>%</span><span class=n>z</span><span class=o>+</span><span class=mi>1</span>
<span class=k>end subroutine </span><span class=n>unit_move</span>
</code></pre></div><p>Now we can wrap these into a nice little module:</p><div class=highlight><pre class=chroma><code class=language-f90 data-lang=f90><span class=k>module </span><span class=n>vec</span>
  <span class=k>use</span><span class=p>,</span> <span class=k>intrinsic</span> <span class=kd>::</span> <span class=nb>iso_c_binding
</span><span class=nb>  </span><span class=k>implicit none
</span><span class=k>
</span><span class=k>  type</span><span class=p>,</span> <span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span> <span class=kd>::</span> <span class=n>cartesian</span>
     <span class=kt>real</span><span class=p>(</span><span class=kt>c_double</span><span class=p>)</span> <span class=kd>::</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>z</span>
  <span class=k>end type </span><span class=n>cartesian</span>

  <span class=k>contains
</span><span class=k>
</span><span class=k>  subroutine </span><span class=n>unit_move</span><span class=p>(</span><span class=k>array</span><span class=p>)</span> <span class=k>bind</span><span class=p>(</span><span class=n>c</span><span class=p>)</span>
    <span class=k>type</span><span class=p>(</span><span class=n>cartesian</span><span class=p>),</span> <span class=k>intent</span><span class=p>(</span><span class=n>inout</span><span class=p>)</span> <span class=kd>::</span> <span class=k>array
</span><span class=k>    print</span><span class=o>*</span><span class=p>,</span> <span class=s2>&#34;Modifying the derived type now!&#34;</span>
    <span class=k>array</span><span class=p>%</span><span class=n>x</span><span class=o>=</span><span class=k>array</span><span class=p>%</span><span class=n>x</span><span class=o>+</span><span class=mi>1</span>
    <span class=k>array</span><span class=p>%</span><span class=n>y</span><span class=o>=</span><span class=k>array</span><span class=p>%</span><span class=n>y</span><span class=o>+</span><span class=mi>1</span>
    <span class=k>array</span><span class=p>%</span><span class=n>z</span><span class=o>=</span><span class=k>array</span><span class=p>%</span><span class=n>z</span><span class=o>+</span><span class=mi>1</span>
  <span class=k>end subroutine </span><span class=n>unit_move</span>

<span class=k>end module </span><span class=n>vec</span>
</code></pre></div><p>Call it with a simple <code>main</code>.</p><div class=highlight><pre class=chroma><code class=language-f90 data-lang=f90><span class=c>! main.f90
</span><span class=c></span><span class=k>program </span><span class=n>main</span>
  <span class=k>use</span><span class=p>,</span> <span class=k>intrinsic</span> <span class=kd>::</span> <span class=nb>iso_c_binding
</span><span class=nb>  </span><span class=k>use </span><span class=n>vec</span>
  <span class=k>implicit none
</span><span class=k>  type</span><span class=p>(</span><span class=n>cartesian</span><span class=p>)</span> <span class=kd>::</span> <span class=n>cartvec</span>
  <span class=n>cartvec</span> <span class=o>=</span> <span class=n>cartesian</span><span class=p>(</span><span class=mf>0.2</span><span class=p>,</span><span class=mf>0.5</span><span class=p>,</span><span class=mf>0.3</span><span class=p>)</span>
  <span class=k>print</span><span class=o>*</span><span class=p>,</span> <span class=n>cartvec</span>
  <span class=k>call </span><span class=n>unit_move</span><span class=p>(</span><span class=n>cartvec</span><span class=p>)</span>
  <span class=k>print</span><span class=o>*</span><span class=p>,</span> <span class=n>cartvec</span>
<span class=k>end program </span><span class=n>main</span>
</code></pre></div><p>Finally we need a build system, lets say <code>meson</code>.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback># meson.build
project(&#39;fcbase&#39;, &#39;fortran&#39;,
  version : &#39;0.1&#39;,
  default_options : [&#39;warning_level=3&#39;])

executable(&#39;fcbase&#39;,
           &#39;vec.f90&#39;,
           &#39;main.f90&#39;,
           install : true)
</code></pre></div><p>Now we can finally try this out.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>meson setup testfc
meson compile -C testfc
./testfc/fcbase
  0.20000000298023224       0.50000000000000000       0.30000001192092896
 Modifying the derived <span class=nb>type</span> now!
   1.2000000029802322        1.5000000000000000        1.3000000119209290
</code></pre></div><p>This probably surprised no one. So let&rsquo;s get to something more
interesting.</p><h3 id=c-and-fortran>C and Fortran</h3><p>We can start with a simple <code>C</code> header.</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#ifndef VECFC_H
</span><span class=cp>#define VECFC_H
</span><span class=cp></span>
<span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
  <span class=kt>double</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>z</span><span class=p>;</span>
<span class=p>}</span> <span class=n>cartesian</span><span class=p>;</span>

<span class=cp>#endif </span><span class=cm>/* VECFC_H */</span><span class=cp>
</span></code></pre></div><p>Along with its associated translation unit.</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cm>/* vecfc.c */</span>
<span class=cp>#include</span><span class=cpf>&lt;stdlib.h&gt;</span><span class=cp>
</span><span class=cp>#include</span><span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#include</span><span class=cpf>&lt;vecfc.h&gt;</span><span class=cp>
</span><span class=cp></span>
<span class=kt>void</span><span class=o>*</span> <span class=nf>unit_move</span><span class=p>(</span><span class=n>cartesian</span> <span class=o>*</span><span class=n>word</span><span class=p>);</span>

<span class=kt>int</span> <span class=nf>main</span><span class=p>(</span><span class=kt>int</span> <span class=n>argc</span><span class=p>,</span> <span class=kt>char</span><span class=o>*</span> <span class=n>argv</span><span class=p>[</span><span class=n>argc</span><span class=o>+</span><span class=mi>1</span><span class=p>])</span> <span class=p>{</span>
    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;Initializing the struct&#34;</span><span class=p>);</span>
    <span class=n>cartesian</span> <span class=n>a</span><span class=o>=</span><span class=p>{</span><span class=mf>3.0</span><span class=p>,</span> <span class=mf>2.5</span><span class=p>,</span> <span class=mf>6.2</span><span class=p>};</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%f %f %f&#34;</span><span class=p>,</span><span class=n>a</span><span class=p>.</span><span class=n>x</span><span class=p>,</span><span class=n>a</span><span class=p>.</span><span class=n>y</span><span class=p>,</span><span class=n>a</span><span class=p>.</span><span class=n>z</span><span class=p>);</span>
    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Fortran function with derived type from C:&#34;</span><span class=p>);</span>
    <span class=n>unit_move</span><span class=p>(</span><span class=o>&amp;</span><span class=n>a</span><span class=p>);</span>
    <span class=n>puts</span><span class=p>(</span><span class=s>&#34;</span><span class=se>\n</span><span class=s>Returned from Fortran&#34;</span><span class=p>);</span>
    <span class=n>printf</span><span class=p>(</span><span class=s>&#34;%f %f %f&#34;</span><span class=p>,</span><span class=n>a</span><span class=p>.</span><span class=n>x</span><span class=p>,</span><span class=n>a</span><span class=p>.</span><span class=n>y</span><span class=p>,</span><span class=n>a</span><span class=p>.</span><span class=n>z</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>EXIT_SUCCESS</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>The function declaration is straightforward, but for the fact that since
we are passing something both in and out of the function, it must be a
pointer, and as we have no real error propagation or feasible return
type, <code>void *</code> makes sense too. The calling semantics are equally
transparent, creating an instance of the <code>struct</code> and then passing it by
reference.</p><p>The meson extension is fairly trivial, we only need to add the right
file and declare the project language correctly.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>project(&#39;cderived&#39;, &#39;c&#39;, &#39;fortran&#39;,
  version : &#39;0.1&#39;,
  default_options : [&#39;warning_level=3&#39;])

executable(&#39;cderived&#39;,
           &#39;vec.f90&#39;,
           # &#39;vecfc.c&#39;,
           # &#39;vecfc.h&#39;,
           &#39;main.f90&#39;,
           install : true)
</code></pre></div><p>This seems to work.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>meson setup testfc
meson compile -C testfc
./testfc/fcbase
Initializing the struct
3.000000 2.500000 6.200000
Fortran <span class=k>function</span> with derived <span class=nb>type</span> from C:
 Modifying the derived <span class=nb>type</span> now!

Returned from Fortran
4.000000 3.500000 7.200000%
</code></pre></div><h3 id=cython-and-fortran>Cython and Fortran</h3><p>So far so good. Let&rsquo;s get to something slightly more interesting.
Although in the long run <code>cython</code> isn&rsquo;t really the approach <code>numpy</code> is
going towards at the moment, it still makes sense to give it a shot as a
first approximation.</p><div class=highlight><pre class=chroma><code class=language-cython data-lang=cython><span class=k>cdef</span> <span class=k>struct</span> <span class=nf>cartesian</span><span class=p>:</span>
    <span class=n>double</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>z</span>

<span class=k>cdef</span> <span class=kr>extern</span><span class=p>:</span>
    <span class=n>void</span><span class=o>*</span> <span class=n>unit_move</span><span class=p>(</span><span class=n>cartesian</span> <span class=o>*</span><span class=n>word</span><span class=p>)</span>

<span class=k>def</span> <span class=nf>unitmv</span><span class=p>(</span><span class=n>dpt</span><span class=o>=</span><span class=p>{</span><span class=s>&#39;x&#39;</span><span class=p>:</span><span class=mf>0</span><span class=p>,</span><span class=s>&#39;y&#39;</span><span class=p>:</span><span class=mf>0</span><span class=p>,</span><span class=s>&#39;z&#39;</span><span class=p>:</span><span class=mf>0</span><span class=p>}):</span>
    <span class=k>cdef</span> <span class=kt>cartesian</span> <span class=nf>A</span><span class=o>=</span><span class=n>dpt</span>
    <span class=n>unit_move</span><span class=p>(</span><span class=o>&amp;</span><span class=n>A</span><span class=p>)</span>
    <span class=k>return</span><span class=p>(</span><span class=n>A</span><span class=p>)</span>
</code></pre></div><p>The most interesting aspect is that, having defined our <code>C</code> structure
and the external function, we need something to offer to <code>Python</code>. Since
<code>cython</code> structures can be mapped from simple <code>python</code> dictionaries, we
take an input of one, construct the <code>structure</code> on the fly in the
function and then use our Fortran subroutine. The return type can also
be coerced into a list, and that&rsquo;s what can be printed or manipulated
further. This isn&rsquo;t the most efficient way to work with this, but it
will do for now.</p><p>The <code>meson</code> update follows from the explanation in the previous post,
namely, that we need to include our <code>Python</code> sources.</p><div class=highlight><pre class=chroma><code class=language-fallback data-lang=fallback>project(&#39;pointeuc&#39;, &#39;c&#39;, &#39;fortran&#39;,
  version : &#39;0.1&#39;,
  default_options : [&#39;warning_level=3&#39;])

add_languages(&#39;cython&#39;)

py_mod = import(&#39;python&#39;)
py3 = py_mod.find_installation()
py3_dep = py3.dependency()

incdir_numpy = run_command(py3,
  [&#39;-c&#39;, &#39;import os; os.chdir(&#34;..&#34;); import numpy; print(numpy.get_include())&#39;],
  check : true
).stdout().strip()

inc_np = include_directories(incdir_numpy)

py3.extension_module(&#39;veccyf&#39;,
                     &#39;veccyf.pyx&#39;,
                     &#39;vec.f90&#39;,
                     include_directories: inc_np,
                     dependencies : py3_dep)
</code></pre></div><p>The <code>NumPy</code> dependency in this situation is really optional, but makes
for a more interoperable structure. Now we&rsquo;re ready to try this out in
an interactive manner.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>meson setup testcpyth
meson compile -C testcpyth
<span class=nb>cd</span> testcpyth
python -c <span class=s2>&#34;import veccyf; A=veccyf.unitmv({&#39;x&#39;:3.3,&#39;y&#39;:5.2,&#39;z&#39;:2.6}); print(A)&#34;</span>
 Modifying the derived <span class=nb>type</span> now!
<span class=o>{</span><span class=s1>&#39;x&#39;</span>: 4.3, <span class=s1>&#39;y&#39;</span>: 6.2, <span class=s1>&#39;z&#39;</span>: 3.6<span class=o>}</span>
</code></pre></div><p>Taking this a bit slower, it is still as neat as ever.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=kn>import</span> <span class=nn>veccyf</span>
<span class=n>point</span> <span class=o>=</span> <span class=p>{</span><span class=s1>&#39;x&#39;</span><span class=p>:</span> <span class=mf>4.3</span><span class=p>,</span>
         <span class=s1>&#39;y&#39;</span><span class=p>:</span> <span class=mf>2.6</span><span class=p>,</span>
         <span class=s1>&#39;z&#39;</span><span class=p>:</span> <span class=mf>6.4</span><span class=p>}</span>
<span class=n>opoint</span> <span class=o>=</span> <span class=n>veccyf</span><span class=o>.</span><span class=n>unitmv</span><span class=p>(</span><span class=n>point</span><span class=p>)</span>
<span class=nb>print</span><span class=p>(</span><span class=n>opoint</span><span class=p>)</span>
</code></pre></div><p>Aside from the output string, this works as expected, and is pretty
neat, all things considered. This might feed into an <code>f2py</code> workflow,
but then, it adds a layer of indirection which seems overly circuitous.
The design could have also been far improved by using a
<code>bind(c, name=uniquname)</code> as well.</p><p>Note that a much more rational approach would have been to generate a
class in Python.</p><h4 id=prognosis-for-f2py>Prognosis for F2PY</h4><p>The essential information used from the <code>fortran</code> code for the <code>cython</code>
types (and <code>C</code> structures) was essentially:</p><ul><li>The types of each variable for the derived type<ul><li><code>double</code> for every one of them in this case</li></ul></li><li>The names of each variable<ul><li><code>x</code>, <code>y</code>, and <code>z</code> here</li></ul></li></ul><p>Apart from this, for functions which operate on aforementioned types,we
require:</p><ul><li>The external declaration (due to the <code>iso_c_binding</code>)</li><li>A mapping from structure to a python object, typically a dictionary</li></ul><p>It so happens that much of the information needed for generation of the
relevant <code>C</code> code is already present in <code>f2py</code>, and can be inspected via
the <code>crackfortran</code> module.</p><div class=highlight><pre class=chroma><code class=language-python data-lang=python><span class=c1># python -m numpy.f2py.crackfortran vec.f90 -show</span>
<span class=n>Reading</span> <span class=n>fortran</span> <span class=n>codes</span><span class=o>...</span>
      <span class=n>Reading</span> <span class=n>file</span> <span class=s1>&#39;vec.f90&#39;</span> <span class=p>(</span><span class=nb>format</span><span class=p>:</span><span class=n>free</span><span class=p>)</span>
<span class=p>{</span><span class=s1>&#39;before&#39;</span><span class=p>:</span> <span class=s1>&#39;&#39;</span><span class=p>,</span> <span class=s1>&#39;this&#39;</span><span class=p>:</span> <span class=s1>&#39;use&#39;</span><span class=p>,</span> <span class=s1>&#39;after&#39;</span><span class=p>:</span> <span class=s1>&#39;, intrinsic :: iso_c_binding &#39;</span><span class=p>}</span>
<span class=n>Line</span> <span class=c1>#2 in vec.f90:&#34;  use, intrinsic :: iso_c_binding &#34;</span>
      <span class=n>analyzeline</span><span class=p>:</span> <span class=n>Could</span> <span class=ow>not</span> <span class=n>crack</span> <span class=n>the</span> <span class=n>use</span> <span class=n>statement</span><span class=o>.</span>
<span class=n>Line</span> <span class=c1>#5 in vec.f90:&#34;  type, bind(c) :: cartesian &#34;</span>
      <span class=n>analyzeline</span><span class=p>:</span> <span class=n>No</span> <span class=n>name</span><span class=o>/</span><span class=n>args</span> <span class=n>pattern</span> <span class=n>found</span> <span class=k>for</span> <span class=n>line</span><span class=o>.</span>
<span class=n>Post</span><span class=o>-</span><span class=n>processing</span><span class=o>...</span>
      <span class=n>Block</span><span class=p>:</span> <span class=n>vec</span>
              <span class=n>Block</span><span class=p>:</span> <span class=n>unknown_type</span>
              <span class=n>Block</span><span class=p>:</span> <span class=n>unit_move</span>
<span class=n>Post</span><span class=o>-</span><span class=n>processing</span> <span class=p>(</span><span class=n>stage</span> <span class=mi>2</span><span class=p>)</span><span class=o>...</span>
<span class=p>[{</span><span class=s1>&#39;args&#39;</span><span class=p>:</span> <span class=p>[],</span>
  <span class=s1>&#39;block&#39;</span><span class=p>:</span> <span class=s1>&#39;module&#39;</span><span class=p>,</span>
  <span class=s1>&#39;body&#39;</span><span class=p>:</span> <span class=p>[{</span><span class=s1>&#39;args&#39;</span><span class=p>:</span> <span class=p>[],</span>
            <span class=s1>&#39;block&#39;</span><span class=p>:</span> <span class=s1>&#39;type&#39;</span><span class=p>,</span>
            <span class=s1>&#39;body&#39;</span><span class=p>:</span> <span class=p>[],</span>
            <span class=s1>&#39;entry&#39;</span><span class=p>:</span> <span class=p>{},</span>
            <span class=s1>&#39;externals&#39;</span><span class=p>:</span> <span class=p>[],</span>
            <span class=s1>&#39;from&#39;</span><span class=p>:</span> <span class=s1>&#39;vec.f90:vec&#39;</span><span class=p>,</span>
            <span class=s1>&#39;interfaced&#39;</span><span class=p>:</span> <span class=p>[],</span>
            <span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;unknown_type&#39;</span><span class=p>,</span>
            <span class=s1>&#39;parent_block&#39;</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>Recursion</span> <span class=n>on</span> <span class=nb>dict</span> <span class=k>with</span> <span class=nb>id</span><span class=o>=</span><span class=mi>4500228096</span><span class=o>&gt;</span><span class=p>,</span>
            <span class=s1>&#39;sortvars&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;x&#39;</span><span class=p>,</span> <span class=s1>&#39;y&#39;</span><span class=p>,</span> <span class=s1>&#39;z&#39;</span><span class=p>],</span>
            <span class=s1>&#39;varnames&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;x&#39;</span><span class=p>,</span> <span class=s1>&#39;y&#39;</span><span class=p>,</span> <span class=s1>&#39;z&#39;</span><span class=p>],</span>
            <span class=s1>&#39;vars&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;x&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;kindselector&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;kind&#39;</span><span class=p>:</span> <span class=s1>&#39;c_double&#39;</span><span class=p>},</span>
                           <span class=s1>&#39;typespec&#39;</span><span class=p>:</span> <span class=s1>&#39;real&#39;</span><span class=p>},</span>
                     <span class=s1>&#39;y&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;kindselector&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;kind&#39;</span><span class=p>:</span> <span class=s1>&#39;c_double&#39;</span><span class=p>},</span>
                           <span class=s1>&#39;typespec&#39;</span><span class=p>:</span> <span class=s1>&#39;real&#39;</span><span class=p>},</span>
                     <span class=s1>&#39;z&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;kindselector&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;kind&#39;</span><span class=p>:</span> <span class=s1>&#39;c_double&#39;</span><span class=p>},</span>
                           <span class=s1>&#39;typespec&#39;</span><span class=p>:</span> <span class=s1>&#39;real&#39;</span><span class=p>}}},</span>
           <span class=p>{</span><span class=s1>&#39;args&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;array&#39;</span><span class=p>],</span>
            <span class=s1>&#39;block&#39;</span><span class=p>:</span> <span class=s1>&#39;subroutine&#39;</span><span class=p>,</span>
            <span class=s1>&#39;body&#39;</span><span class=p>:</span> <span class=p>[],</span>
            <span class=s1>&#39;entry&#39;</span><span class=p>:</span> <span class=p>{},</span>
            <span class=s1>&#39;externals&#39;</span><span class=p>:</span> <span class=p>[],</span>
            <span class=s1>&#39;from&#39;</span><span class=p>:</span> <span class=s1>&#39;vec.f90:vec&#39;</span><span class=p>,</span>
            <span class=s1>&#39;interfaced&#39;</span><span class=p>:</span> <span class=p>[],</span>
            <span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;unit_move&#39;</span><span class=p>,</span>
            <span class=s1>&#39;parent_block&#39;</span><span class=p>:</span> <span class=o>&lt;</span><span class=n>Recursion</span> <span class=n>on</span> <span class=nb>dict</span> <span class=k>with</span> <span class=nb>id</span><span class=o>=</span><span class=mi>4500228096</span><span class=o>&gt;</span><span class=p>,</span>
            <span class=s1>&#39;saved_interface&#39;</span><span class=p>:</span> <span class=s1>&#39;</span><span class=se>\n</span><span class=s1>&#39;</span>
                               <span class=s1>&#39;      subroutine unit_move(array) </span><span class=se>\n</span><span class=s1>&#39;</span>
                               <span class=s1>&#39;          type(cartesian), intent(inout) :: &#39;</span>
                               <span class=s1>&#39;array</span><span class=se>\n</span><span class=s1>&#39;</span>
                               <span class=s1>&#39;      end subroutine unit_move&#39;</span><span class=p>,</span>
            <span class=s1>&#39;sortvars&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;array&#39;</span><span class=p>],</span>
            <span class=s1>&#39;vars&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;array&#39;</span><span class=p>:</span> <span class=p>{</span><span class=s1>&#39;attrspec&#39;</span><span class=p>:</span> <span class=p>[],</span>
                               <span class=s1>&#39;intent&#39;</span><span class=p>:</span> <span class=p>[</span><span class=s1>&#39;inout&#39;</span><span class=p>],</span>
                               <span class=s1>&#39;typename&#39;</span><span class=p>:</span> <span class=s1>&#39;cartesian&#39;</span><span class=p>,</span>
                               <span class=s1>&#39;typespec&#39;</span><span class=p>:</span> <span class=s1>&#39;type&#39;</span><span class=p>}}}],</span>
  <span class=s1>&#39;entry&#39;</span><span class=p>:</span> <span class=p>{},</span>
  <span class=s1>&#39;externals&#39;</span><span class=p>:</span> <span class=p>[],</span>
  <span class=s1>&#39;from&#39;</span><span class=p>:</span> <span class=s1>&#39;vec.f90&#39;</span><span class=p>,</span>
  <span class=s1>&#39;implicit&#39;</span><span class=p>:</span> <span class=kc>None</span><span class=p>,</span>
  <span class=s1>&#39;interfaced&#39;</span><span class=p>:</span> <span class=p>[],</span>
  <span class=s1>&#39;name&#39;</span><span class=p>:</span> <span class=s1>&#39;vec&#39;</span><span class=p>,</span>
  <span class=s1>&#39;sortvars&#39;</span><span class=p>:</span> <span class=p>[],</span>
  <span class=s1>&#39;vars&#39;</span><span class=p>:</span> <span class=p>{}}]</span>
</code></pre></div><p>The information is clearly present, which brings us to the next phase.</p><h3 id=python-c-and-fortran>Python-C and Fortran</h3><p>The most natural way to feed into <code>f2py</code> would be to directly write out
an equivalent <code>Python-C</code> API which effectively mimics the extension
module of the last section.</p><p>The crucial definition essentially takes a dictionary, unrolls into a
list, creates the <code>C</code> structure, then passes it through Fortran and then
back.</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=k>static</span> <span class=n>PyObject</span><span class=o>*</span> <span class=nf>eucli_unitinc</span><span class=p>(</span><span class=n>PyObject</span><span class=o>*</span> <span class=n>self</span><span class=p>,</span> <span class=n>PyObject</span><span class=o>*</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>cartesian</span> <span class=n>a</span><span class=p>;</span>
    <span class=n>PyObject</span><span class=o>*</span> <span class=n>dict</span><span class=p>;</span>
    <span class=n>PyArg_ParseTuple</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=s>&#34;O&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>dict</span><span class=p>);</span>
    <span class=n>PyObject</span><span class=o>*</span> <span class=n>vals</span> <span class=o>=</span> <span class=n>PyDict_Values</span><span class=p>(</span><span class=n>dict</span><span class=p>);</span>
    <span class=n>a</span><span class=p>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>PyFloat_AsDouble</span><span class=p>(</span><span class=n>PyList_GetItem</span><span class=p>(</span><span class=n>vals</span><span class=p>,</span><span class=mi>0</span><span class=p>));</span>
    <span class=n>a</span><span class=p>.</span><span class=n>y</span> <span class=o>=</span> <span class=n>PyFloat_AsDouble</span><span class=p>(</span><span class=n>PyList_GetItem</span><span class=p>(</span><span class=n>vals</span><span class=p>,</span><span class=mi>1</span><span class=p>));</span>
    <span class=n>a</span><span class=p>.</span><span class=n>z</span> <span class=o>=</span> <span class=n>PyFloat_AsDouble</span><span class=p>(</span><span class=n>PyList_GetItem</span><span class=p>(</span><span class=n>vals</span><span class=p>,</span><span class=mi>2</span><span class=p>));</span>
    <span class=c1>// Call Fortran on it
</span><span class=c1></span>    <span class=n>unit_move</span><span class=p>(</span><span class=o>&amp;</span><span class=n>a</span><span class=p>);</span>
    <span class=c1>//
</span><span class=c1></span>    <span class=n>PyObject</span><span class=o>*</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>Py_BuildValue</span><span class=p>(</span><span class=s>&#34;{s:f,s:f,s:f}&#34;</span><span class=p>,</span>
                         <span class=s>&#34;x&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>
                         <span class=s>&#34;y&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>.</span><span class=n>y</span><span class=p>,</span>
                         <span class=s>&#34;z&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>.</span><span class=n>z</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><p>This also works well enough with minor modifications to <code>meson</code>.</p><div class=highlight><pre class=chroma><code class=language-bash data-lang=bash>python -c <span class=s2>&#34;import eucli; A=eucli.unitinc({&#39;x&#39;:3.3,&#39;y&#39;:5.2,&#39;z&#39;:2.6}); print(A)&#34;</span>
 Modifying the derived <span class=nb>type</span> now!
<span class=o>{</span><span class=s1>&#39;x&#39;</span>: 4.3, <span class=s1>&#39;y&#39;</span>: 6.2, <span class=s1>&#39;z&#39;</span>: 3.6<span class=o>}</span>
</code></pre></div><h4 id=boilerplate>Boilerplate</h4><p>The rest of the hand written wrapper is boilerplate, but the full file
is reproduced here:</p><div class=highlight><pre class=chroma><code class=language-c data-lang=c><span class=cp>#ifndef PY_SSIZE_T_CLEAN
</span><span class=cp>#define PY_SSIZE_T_CLEAN
</span><span class=cp>#include</span> <span class=cpf>&lt;stdio.h&gt;</span><span class=cp>
</span><span class=cp>#endif </span><span class=cm>/* PY_SSIZE_T_CLEAN */</span><span class=cp>
</span><span class=cp></span>
<span class=cp>#include</span> <span class=cpf>&#34;Python.h&#34;</span><span class=cp>
</span><span class=cp></span>
<span class=c1>// Fortran-C stuff
</span><span class=c1></span>
<span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
  <span class=kt>double</span> <span class=n>x</span><span class=p>,</span><span class=n>y</span><span class=p>,</span><span class=n>z</span><span class=p>;</span>
<span class=p>}</span> <span class=n>cartesian</span><span class=p>;</span>

<span class=kt>void</span><span class=o>*</span> <span class=nf>unit_move</span><span class=p>(</span><span class=n>cartesian</span> <span class=o>*</span><span class=n>word</span><span class=p>);</span>

<span class=c1>// Python-C stuff
</span><span class=c1></span>
<span class=k>static</span> <span class=n>PyObject</span><span class=o>*</span> <span class=nf>eucli_unitinc</span><span class=p>(</span><span class=n>PyObject</span><span class=o>*</span> <span class=n>self</span><span class=p>,</span> <span class=n>PyObject</span><span class=o>*</span> <span class=n>args</span><span class=p>)</span> <span class=p>{</span>
    <span class=n>cartesian</span> <span class=n>a</span><span class=p>;</span>
    <span class=n>PyObject</span><span class=o>*</span> <span class=n>dict</span><span class=p>;</span>
    <span class=n>PyArg_ParseTuple</span><span class=p>(</span><span class=n>args</span><span class=p>,</span> <span class=s>&#34;O&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>dict</span><span class=p>);</span>
    <span class=n>PyObject</span><span class=o>*</span> <span class=n>vals</span> <span class=o>=</span> <span class=n>PyDict_Values</span><span class=p>(</span><span class=n>dict</span><span class=p>);</span>
    <span class=n>a</span><span class=p>.</span><span class=n>x</span> <span class=o>=</span> <span class=n>PyFloat_AsDouble</span><span class=p>(</span><span class=n>PyList_GetItem</span><span class=p>(</span><span class=n>vals</span><span class=p>,</span><span class=mi>0</span><span class=p>));</span>
    <span class=n>a</span><span class=p>.</span><span class=n>y</span> <span class=o>=</span> <span class=n>PyFloat_AsDouble</span><span class=p>(</span><span class=n>PyList_GetItem</span><span class=p>(</span><span class=n>vals</span><span class=p>,</span><span class=mi>1</span><span class=p>));</span>
    <span class=n>a</span><span class=p>.</span><span class=n>z</span> <span class=o>=</span> <span class=n>PyFloat_AsDouble</span><span class=p>(</span><span class=n>PyList_GetItem</span><span class=p>(</span><span class=n>vals</span><span class=p>,</span><span class=mi>2</span><span class=p>));</span>
    <span class=c1>// Call Fortran on it
</span><span class=c1></span>    <span class=n>unit_move</span><span class=p>(</span><span class=o>&amp;</span><span class=n>a</span><span class=p>);</span>
    <span class=c1>//
</span><span class=c1></span>    <span class=n>PyObject</span><span class=o>*</span> <span class=n>ret</span> <span class=o>=</span> <span class=n>Py_BuildValue</span><span class=p>(</span><span class=s>&#34;{s:f,s:f,s:f}&#34;</span><span class=p>,</span>
                         <span class=s>&#34;x&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>.</span><span class=n>x</span><span class=p>,</span>
                         <span class=s>&#34;y&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>.</span><span class=n>y</span><span class=p>,</span>
                         <span class=s>&#34;z&#34;</span><span class=p>,</span> <span class=n>a</span><span class=p>.</span><span class=n>z</span><span class=p>);</span>
    <span class=k>return</span> <span class=n>ret</span><span class=p>;</span>
<span class=p>}</span>

<span class=k>static</span> <span class=n>PyMethodDef</span> <span class=n>EucliMethods</span><span class=p>[]</span> <span class=o>=</span> <span class=p>{</span>
    <span class=p>{</span><span class=s>&#34;unitinc&#34;</span><span class=p>,</span> <span class=p>(</span><span class=n>PyCFunction</span><span class=p>)</span><span class=n>eucli_unitinc</span><span class=p>,</span> <span class=n>METH_VARARGS</span><span class=p>,</span>
     <span class=s>&#34;Add 1 to the axes of a point&#34;</span><span class=p>},</span>
    <span class=p>{</span><span class=nb>NULL</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span><span class=p>}</span>        <span class=cm>/* Sentinel */</span>
<span class=p>};</span>

<span class=k>static</span> <span class=k>struct</span> <span class=n>PyModuleDef</span> <span class=n>eucli_module</span> <span class=o>=</span> <span class=p>{</span>
   <span class=n>PyModuleDef_HEAD_INIT</span><span class=p>,</span>
   <span class=s>&#34;eucli&#34;</span><span class=p>,</span>
   <span class=s>&#34;blah&#34;</span><span class=p>,</span>
   <span class=o>-</span><span class=mi>1</span><span class=p>,</span>
   <span class=n>EucliMethods</span>
<span class=p>};</span>

<span class=n>PyMODINIT_FUNC</span> <span class=nf>PyInit_eucli</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
<span class=p>{</span>
    <span class=n>PyObject</span> <span class=o>*</span><span class=n>m</span><span class=p>;</span>
    <span class=n>m</span> <span class=o>=</span> <span class=n>PyModule_Create</span><span class=p>(</span><span class=o>&amp;</span><span class=n>eucli_module</span><span class=p>);</span>
    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>m</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>return</span> <span class=nb>NULL</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>return</span> <span class=n>m</span><span class=p>;</span>
<span class=p>}</span>
</code></pre></div><h2 id=conclusions>Conclusions</h2><p>Slowly but surely, compilers have caught up with to the standards, and
soon, with some support, <code>numpy</code> shall too. A subsequent post shall
cover more exotic derived types, typically (until 2018) treated by
non-portable opaque pointer tricks. There are still some rather awkward
design decisions in this case; including things like considering the
mapping and their interoperability with <code>NumPy</code> arrays, but by and large
this would depend on the functions which use these. In terms of derived
types of simple structures, without allocatable arrays, the extensions
appear to be straightforward.</p><h2 id=references>References</h2><div id=refs class="references csl-bib-body hanging-indent"><div></div><div id=ref-reidNewFeaturesFortran2003 class=csl-entry><div></div><p>Reid, John. 2003. &ldquo;The New Features of Fortran 2003,&rdquo; 38.</p></div></div><section class=footnotes role=doc-endnotes><hr><ol><li id=fn:1 role=doc-endnote><p>This is more surprising with each passing year&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></section></div></article><hr><div class=post-info><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag meta-icon"><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7" y2="7"/></svg><span class=tag><a href=https://rgoswami.me/tags/python>python</a></span><span class=tag><a href=https://rgoswami.me/tags/fortran>fortran</a></span><span class=tag><a href=https://rgoswami.me/tags/numpy>numpy</a></span><span class=tag><a href=https://rgoswami.me/tags/f2py>f2py</a></span><span class=tag><a href=https://rgoswami.me/tags/rambling>rambling</a></span></p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file-text"><path d="M14 2H6A2 2 0 004 4v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>1695 Words</p><p><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Posted: <time class=dt-published>2021-10-02 04:19 +0000</time></p><a class=resp-sharing-button__link href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2frgoswami.me%2fposts%2fcython-derivedtype-f2py%2f" target=_blank rel=noopener aria-label=Facebook><div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15.84 9.5H13.5V8.48c0-.53.35-.65.6-.65h1.4v-2.3h-2.35c-2.3.0-2.65 1.7-2.65 2.8V9.5h-2v2h2v7h3v-7h2.1l.24-2z"/></svg></div>Facebook</div></a><a class=resp-sharing-button__link href="https://twitter.com/intent/tweet/?text=%22Simple%20Fortran%20Derived%20Types%20and%20Python%22%20seems%20like%20an%20interesting%20read%20from%20%40rg0swami&url=https%3a%2f%2frgoswami.me%2fposts%2fcython-derivedtype-f2py%2f" target=_blank rel=noopener aria-label=Twitter><div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.5 7.4l-2 .2c-.4-.5-1-.8-2-.8C13.3 6.8 12 8 12 9.4v.6c-2 0-4-1-5.4-2.7-.2.4-.3.8-.3 1.3.0 1 .4 1.7 1.2 2.2-.5.0-1 0-1.2-.3.0 1.3 1 2.3 2 2.6-.3.4-.7.4-1 0 .2 1.4 1.2 2 2.3 2-1 1-2.5 1.4-4 1 1.3 1 2.7 1.4 4.2 1.4 4.8.0 7.5-4 7.5-7.5v-.4c.5-.4.8-1.5 1.2-2z"/><circle cx="12" cy="12" r="11.5"/></svg></div>Twitter</div></a><a class=resp-sharing-button__link href="mailto:?subject=%22Simple%20Fortran%20Derived%20Types%20and%20Python%22%20seems%20interesting...&body=https%3a%2f%2frgoswami.me%2fposts%2fcython-derivedtype-f2py%2f" target=_self rel=noopener aria-label=E-Mail><div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19.5 16c0 .8-.7 1.5-1.5 1.5H6c-.8.0-1.5-.7-1.5-1.5V8c0-.8.7-1.5 1.5-1.5h12c.8.0 1.5.7 1.5 1.5v8zm-2-7.5L12 13 6.5 8.5m11 6-4-2.5m-7 2.5 4-2.5"/><circle cx="12" cy="12" r="11.5"/></svg></div>E-Mail</div></a><a class=resp-sharing-button__link href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2frgoswami.me%2fposts%2fcython-derivedtype-f2py%2f&title=%22Simple%20Fortran%20Derived%20Types%20and%20Python%22%20seems%20interesting...&summary=%22Simple%20Fortran%20Derived%20Types%20and%20Python%22%20seems%20interesting...&source=https%3a%2f%2frgoswami.me%2fposts%2fcython-derivedtype-f2py%2f" target=_blank rel=noopener aria-label=LinkedIn><div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><path d="M15 12.5c-.28.0-.5.22-.5.5v3.5h-3s.03-6.48.0-7h3v.83s.46-.75 1.7-.75c1.56.0 2.3 1.12 2.3 3.3v3.62h-3V13c0-.28-.23-.5-.5-.5zm-7.5-3h2v7h-2z"/><circle cx="8.5" cy="6.5" r="1"/></svg></div>LinkedIn</div></a><a class=resp-sharing-button__link href="https://reddit.com/submit/?url=https%3a%2f%2frgoswami.me%2fposts%2fcython-derivedtype-f2py%2f&resubmit=true&title=%22Simple%20Fortran%20Derived%20Types%20and%20Python%22%20seems%20interesting..." target=_blank rel=noopener aria-label=Reddit><div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="11.5"/><ellipse cx="12" cy="14.37" rx="6.2" ry="4.24"/><path d="M14.3 16.25c-.62.36-1.42.57-2.3.57s-1.7-.2-2.32-.58"/><circle cx="14.61" cy="13.39" r=".98"/><circle cx="9.39" cy="13.39" r=".98"/><path d="M16.4 11.38c.26-.55.82-.92 1.47-.92.9.0 1.63.73 1.63 1.63.0.8-.6 1.47-1.38 1.6"/><circle cx="17.22" cy="7.52" r="1.63"/><path d="M7.6 11.38c-.26-.54-.82-.92-1.47-.92-.9.0-1.63.73-1.63 1.63.0.8.6 1.47 1.38 1.6M12 10.12s-.08-4.82 3.6-2.6"/></svg></div>Reddit</div></a><a class=resp-sharing-button__link href="whatsapp://send?text=%22Simple%20Fortran%20Derived%20Types%20and%20Python%22%20seems%20interesting...%20https%3a%2f%2frgoswami.me%2fposts%2fcython-derivedtype-f2py%2f" target=_blank rel=noopener aria-label=WhatsApp><div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--medium"><div aria-hidden=true class="resp-sharing-button__icon resp-sharing-button__icon--circle"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle xmlns="http://www.w3.org/2000/svg" cx="12" cy="12" r="11.5"/><path stroke-width="1" d="M17.6 6.2c-1.5-1.5-3.4-2.3-5.5-2.3-4.3.0-7.8 3.5-7.8 7.8.0 1.4.4 2.7 1 3.9l-1.1 4 4.1-1.1c1.1.6 2.4.9 3.7.9 4.3.0 7.8-3.5 7.8-7.8.1-2-.7-3.9-2.2-5.4zm-5.5 11.9c-1.2.0-2.3-.3-3.3-.9l-.2-.1-2.4.6.7-2.4-.2-.2c-.6-1-1-2.2-1-3.4.0-3.6 2.9-6.5 6.5-6.5 1.7.0 3.3.7 4.6 1.9 1.2 1.2 1.9 2.8 1.9 4.6-.1 3.5-3 6.4-6.6 6.4zm3.5-4.8c-.2-.1-1.1-.6-1.3-.6-.2-.1-.3-.1-.4.1s-.5.6-.6.8c-.1.1-.2.1-.4.0s-.8-.3-1.6-1c-.6-.5-1-1.2-1.1-1.3-.1-.2.0-.3.1-.4l.3-.3s.1-.2.2-.3c.1-.1.0-.2.0-.3s-.4-1.1-.6-1.4c-.2-.4-.3-.3-.4-.3h-.4s-.3.0-.5.2-.7.7-.7 1.6c0 1 .7 1.9.8 2s1.4 2.1 3.3 2.9c.5.2.8.3 1.1.4.5.1.9.1 1.2.1.4-.1 1.1-.5 1.3-.9.2-.5.2-.8.1-.9.0-.2-.2-.3-.4-.4z"/></svg></div>WhatsApp</div></a></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://rgoswami.me/posts/fortrancon-2021-meta/><span class=button__text>Presentation Supplements for FortranCon'21</span>
<span class=button__icon>→</span></a></span></div></div><div id=comments class=thin><div class=pagination__title><span class=pagination__title-h>Comments</span><hr></div><div id=remarkbox-div><noscript><iframe id=remarkbox-iframe src="https://my.remarkbox.com/embed?nojs=true" style=height:600px;width:100%;border:none!important tabindex=0></iframe></noscript></div><script src=https://my.remarkbox.com/static/js/iframe-resizer/iframeResizer.min.js></script><script>var rb_owner_key="8e660759-e7e6-11ea-9711-040140774501",thread_uri=window.location.href,thread_title=window.document.title,thread_fragment=window.location.hash,rb_src="https://my.remarkbox.com/embed?rb_owner_key="+rb_owner_key+"&thread_title="+encodeURI(thread_title)+"&thread_uri="+encodeURIComponent(thread_uri)+thread_fragment;function create_remarkbox_iframe(){var a=document.createElement("iframe");a.setAttribute("id","remarkbox-iframe"),a.setAttribute("scrolling","no"),a.setAttribute("src",rb_src),a.setAttribute("frameborder","0"),a.setAttribute("tabindex","0"),a.setAttribute("title","Remarkbox"),a.style.width="100%",document.getElementById("remarkbox-div").appendChild(a)}create_remarkbox_iframe(),iFrameResize({checkOrigin:["https://my.remarkbox.com"],inPageLinks:!0,initCallback:function(a){a.iFrameResizer.moveToAnchor(thread_fragment)}},document.getElementById("remarkbox-iframe"))</script></div></main><footer class=footer><p>&copy; 2021
<span><a href=https://rgoswami.me/>Rohit Goswami (HaoZeke)</a></span>
<a href=https://rgoswami.me/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 20 20" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a><br><a rel=license href=http://creativecommons.org/licenses/by-nc-sa/4.0/>CC BY-NC-SA 4.0</a>.
Powered by <a href=http://gohugo.io><u>Hugo</u></a> and <a href=https://github.com/HaoZeke/hugo-theme-hello-friend-ng-hz><u>this theme</u></a>.</br>Hosted with <u><a href=https://www.netlify.com/>Netlify</a></u>.</br><script src=https://liberapay.com/rohit/widgets/button.js></script><noscript><a href=https://liberapay.com/rohit/donate><img alt="Donate using Liberapay" src=https://liberapay.com/assets/widgets/donate.svg></a></noscript></p></footer></div><script src=/bundle.min.5fae9992ea406007408dc33b0b3a8376d61e2f1d6ac50ba1dad7580ac50afb5199bcef3bbc3677e77553a9980bf882cf71edc2f755687dd7725f12ece4304ac2.js></script><script>(function(a,e,f,g,b,c,d){a.GoogleAnalyticsObject=b,a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},a[b].l=1*new Date,c=e.createElement(f),d=e.getElementsByTagName(f)[0],c.async=1,c.src=g,d.parentNode.insertBefore(c,d)})(window,document,'script','//www.google-analytics.com/analytics.js','ga'),ga('create','UA-109503488-16','auto'),ga('send','pageview')</script><script type=text/javascript>(function(a,e,b,f,g,c,d){a[b]=a[b]||function(){(a[b].q=a[b].q||[]).push(arguments)},c=e.createElement(f),c.async=1,c.src="https://www.clarity.ms/tag/"+g,d=e.getElementsByTagName(f)[0],d.parentNode.insertBefore(c,d)})(window,document,"clarity","script","3z2xvwqu4u")</script><script data-goatcounter=https://rgoswami.goatcounter.com/count async src=//gc.zgo.at/count.js></script><script>var clicky_site_ids=clicky_site_ids||[];clicky_site_ids.push("101265002")</script><script async src=https://static.getclicky.com/js></script><script src=https://cdn.jsdelivr.net/npm/readmore-js@3.0.0-beta-1/dist/readmore.min.js></script><script src=/js/codefold.min.4a43062cb83308b55227adf937c91be79ff6d95df8bb821dfd71805ce54629ff8cffed3ae81d70fdee5f324fa0f39c5280ae785f165801885db074551a993a21.js></script></body></html>